<!DOCTYPE html><html><head><title>Joys Of Apex | Formula Date Issues</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons%7CMaterial+Icons+Outlined&amp;display=swap" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Formula Date Issues"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Formula Date Issues"><meta name="keywords" content=""><meta property="blog-tags" content=""></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"formula-date-issues.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Formula Date Issues</p></span></h1><script id="Ourk_pMvbq">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("Ourk_pMvbq", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2020-10-26T15:12:03.284Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>Calculating time differences correctly is challenging. With more than two dozen time zones at play on any given day around the world, and yearly / historical fluctuation in time, it's no wonder that Salesforce stores dates in GMT and tries to enforce good practices surrounding time and date calculation by giving you -- the developer -- quality date/time APIs when dealing with them.</p><p>Apex, via the <code>Date</code> and <code>Datetime</code> classes, does a pretty good job of helping us to work with dates. As a counter-example, take JavaScript. For years, frontend frameworks were weighed down by the usage of <code>Moment.js</code>, the library that attempted to restore some Date/time sanity to JS. Weighing in at a whopping 329 KB, Moment is still used on thousands of sites to aid in JS's poor standard library date calculation and formatting attempts. Indeed, for something as simple as formatting the current date to the United States' MM/dd/YYYY date format, look at the vanilla JavaScript solution:</p><pre class=""><code class="js -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// returns a MM/dd/YYYY string" id="code1-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// returns a MM/dd/YYYY string</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// based on today's date" id="code1-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// based on today's date</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="const getTodayString = () => {" id="code1-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">const</span> <span class="token function-variable function">getTodayString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  const today = new Date();" id="code1-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">const</span> today <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // getMonth decided it was a special flower" id="code1-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// getMonth decided it was a special flower</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // and got to be 0-based, even though that" id="code1-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// and got to be 0-based, even though that</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // makes absolutely no sense in the context" id="code1-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// makes absolutely no sense in the context</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // of months. Imagine if JS also chose to be" id="code1-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// of months. Imagine if JS also chose to be</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // 0-based for getDate()!" id="code1-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// 0-based for getDate()!</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  const month = today.getMonth() + 1;" id="code1-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">const</span> month <span class="token operator">=</span> today<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  const day = today.getDate();" id="code1-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">const</span> day <span class="token operator">=</span> today<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  const year = today.getFullYear();" id="code1-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">const</span> year <span class="token operator">=</span> today<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code1-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  return (" id="code1-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> <span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    (month < 10 ? &quot;0&quot; + month : month) +" id="code1-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">(</span>month <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">?</span> <span class="token string">"0"</span> <span class="token operator">+</span> month <span class="token operator">:</span> month<span class="token punctuation">)</span> <span class="token operator">+</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    &quot;/&quot; +" id="code1-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token string">"/"</span> <span class="token operator">+</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    (day < 10 ? &quot;0&quot; + day : day) +" id="code1-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">(</span>day <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">?</span> <span class="token string">"0"</span> <span class="token operator">+</span> day <span class="token operator">:</span> day<span class="token punctuation">)</span> <span class="token operator">+</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    &quot;/&quot; +" id="code1-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token string">"/"</span> <span class="token operator">+</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    year" id="code1-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    year</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  );" id="code1-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="};" id="code1-l21"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div><br></code></pre><p>When presented with the issue of how to best generalize this function to support different formatting strings and country conventions, you can quickly come to appreciate the <a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html">Simple Date Format</a> used in both Apex and Java.</p><p>For those of us in the US, there's an election coming up (vote!) -- wanting to do something specific on a particular date is one of the most common pieces of business logic we end up encapsulating through programming. Whether it's serving up a notification to users in the form of a Salesforce Task, or writing some business-centric term to another field that ends up getting surfaced in daily/aggregated reports, being able to successfully match records based on date-bound criteria is incredibly important. On the subject of the election, imagine if you are trying to serve up reminders to employees spread across the US to vote prior to beginning work on Election Day. Now imagine what would happen if that notification was calculated based on Eastern Standard Time (EST). Your employees working in Pacific Standard Time (PST), three hours behind EST, don't get served the notification till they're well into their workday. Not ideal, not ideal.</p><p>When crafting experiences like Next best offer/action into staff workflows, we quickly come to understand the importance not only of the Date component, but also of how time adds complexities to many simple requirements. Serving somebody a personalized email / call frequently works better during a person's lunch break/off-hours versus trying to contact them or advertise to them during their business day.</p><h2 id="formula-field-date-issues" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Formula Field Date Issues</h2><p>When making decisions based off of <code>Date</code> fields in Apex, you might be tempted to think that you've avoided all of the timezone complexity associated with <code>Date</code>'s more complicated form, <code>Datetime</code>. For the most part, you would be correct. Where things get more complicated is when Apex and formula fields come into play:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="@isTest" id="code2-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private class DateTests {" id="code2-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DateTests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @isTest" id="code2-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  static void a_formula_retrieved_from_the_db_behaves_the_same_as_a_new_date() {" id="code2-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">a_formula_retrieved_from_the_db_behaves_the_same_as_a_new_date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Task t = new Task(" id="code2-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Task</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      ActivityDate = Date.newInstance(2019, 09, 30)," id="code2-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">ActivityDate</span> <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">09</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      Subject = 'Leap year test'" id="code2-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">Subject</span> <span class="token operator">=</span> <span class="token string">'Leap year test'</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    );" id="code2-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    insert t;" id="code2-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    insert t<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //DateTest__c formula: ADDMONTHS(ActivityDate, 15) + 1" id="code2-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//DateTest__c formula: ADDMONTHS(ActivityDate, 15) + 1</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    t = [SELECT ActivityDate, DateTest__c FROM Task];" id="code2-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    t <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">ActivityDate</span><span class="token punctuation">,</span> <span class="token class-name">DateTest__c</span> FROM <span class="token class-name">Task</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    System.assertEquals(" id="code2-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      t.ActivityDate.addMonths(15).addDays(1)," id="code2-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>ActivityDate</span><span class="token punctuation">.</span><span class="token function">addMonths</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      Date.newInstance(2020, 12, 31)" id="code2-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    );" id="code2-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    System.assertEquals(" id="code2-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      Date.newInstance(2020, 12, 31)," id="code2-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      t.DateTest__c," id="code2-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>DateTest__c</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      'oh no! Why, Apex, why?!'" id="code2-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token string">'oh no! Why, Apex, why?!'</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    );" id="code2-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code2-l23"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>You got it, this test fails at the second assertion -- the <code>DateTest__c</code> formula evaluates to 1 Jan 2021! Interestingly (? I thought it was interesting at least), there is no <code>ADDDAYS</code> or <code>ADDYEARS</code> formula function -- just <code>ADDMONTHS</code>. Even when creating a new <code>Date</code> formula field, though, the example that is displayed within the UI would have you believe that adding and subtracting days is easy: <code>Reminder Date = CloseDate - 7</code>. All the examples in the Developer documentation would have you believe that date math is a trivial subject.</p><p>So is the discrepancy between the formula field and what gets calculated via Apex merely the result of 2020 being a leap year? Let's find out:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// this test passes" id="code3-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// this test passes</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Task t = new Task(" id="code3-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Task</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  ActivityDate = Date.newInstance(2019, 01, 31)," id="code3-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">ActivityDate</span> <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Subject = 'Feb month test'" id="code3-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Subject</span> <span class="token operator">=</span> <span class="token string">'Feb month test'</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content=");" id="code3-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="insert t;" id="code3-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>insert t<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="//DateTest__c formula: ADDMONTHS(ActivityDate, 1) + 1" id="code3-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//DateTest__c formula: ADDMONTHS(ActivityDate, 1) + 1</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="t = [SELECT ActivityDate, DateTest__c FROM Task];" id="code3-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>t <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">ActivityDate</span><span class="token punctuation">,</span> <span class="token class-name">DateTest__c</span> FROM <span class="token class-name">Task</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.assertEquals(" id="code3-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  t.ActivityDate.addMonths(1).addDays(1)," id="code3-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>ActivityDate</span><span class="token punctuation">.</span><span class="token function">addMonths</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Date.newInstance(2019, 03, 01)" id="code3-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token punctuation">)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content=");" id="code3-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.assertEquals(" id="code3-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Date.newInstance(2019, 03, 01)," id="code3-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">03</span><span class="token punctuation">,</span> <span class="token number">01</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  t.DateTest__c" id="code3-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>DateTest__c</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content=");" id="code3-l17"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>If we remove the <code>+1</code> from the <code>DateTest__c</code> formula and change the assertions to expect the date being February 28th, the test again passes. This is great! Exactly what we wanted. But glancing at the definition for <code>ADDMONTHS</code>, it's also trivially easy to "break" -- or at least challenge -- this example:</p><blockquote><p>Returns the date that is the indicated number of months before or after a specified date. If the resulting month has fewer days than the start month, then the function returns the last day of the resulting month. Otherwise, the result has the same day component as the specified date.</p></blockquote><p>Merely by changing the initial value of <code>ActivityDate</code> to 30 January, we can break the above test. And, after all, the question is now largely subjective -- what <em>should</em> the value become when adding a month where the resulting month has fewer days than the accumulator? In the statement:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// using t.ActivityDate = Date.newInstance(2019, 01, 30)" id="code4-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// using t.ActivityDate = Date.newInstance(2019, 01, 30)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.assertEquals(" id="code4-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  t.ActivityDate.addMonths(1)," id="code4-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span></span>ActivityDate</span><span class="token punctuation">.</span><span class="token function">addMonths</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Date.newInstance(2019, 02, 27)" id="code4-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">02</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content=");" id="code4-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>Does it make sense that the test now fails because <code>t.ActivityDate.addMonths(1)</code> evaluates to <code>2019-02-28</code>? I honestly couldn't say. I could certainly make the argument that the second-to-last day in one month should always equal the second-to-last day in another month, regardless of how many days those months have ... but that doesn't <em>fix</em> our problem. And the truth is that as long as you're using <code>ADDMONTHS</code>, the formula function, in conjunction with <code>addMonths</code> in Apex, you're likely to occasionally run into mismatches; short of advising against the use of one or the other definitively, there's no easy action item as far as addressing this problem (unless Salesforce decides to fix the root issue). In a world where two identical-seeming functions can produce different results, information is power -- knowing that this <em>can</em> happen gives you helpful insight when it <em>does</em> happen. You can also start to appreciate why new parents frequently refer to their children's age(s) in <em>weeks</em> instead of months. 👼 😁</p><h2 id="paying-credit-where-credit-is-due" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Paying Credit Where Credit Is Due</h2><p>This is an informational post, and <a href="https://growthheroes.com/who-we-are/">Jim Bartek of Growth Heroes</a> is responsible for creating the <a href="https://github.com/GrowthHeroes/apex-formula-tests">astoundingly-detailed repository</a> showcasing many of the formula field / Apex idiosyncracies that could wind up biting you. Jim didn't ask me to write this -- I thought it might be a helpful PSA for the community -- but I wanted to thank him for working hard to show everyone the potential pitfalls of calculating dates using formulas, especially where those dates will be used as comparisons within Apex (though Jim has also included a failing validation rule example which may pique your interest). Because not everyone is browsing Github looking for repos that describe a problem-state they're experiencing, featuring his work here on <a href="/joys-of-apex/">The Joys Of Apex</a> is meant to expand the number of people reached.</p><p>If you haven't already become a member on the <a href="https://join.sfxd.org/">SFXD Discord</a>, you can find helpful souls like Jim around, both on the <code>#dev</code> and <code>#isv</code>-flavored channels. It's people like him that make this the single finest support community for questions related to Salesforce, and while I had previously experienced vagueries associated with Dates in Apex, it was only after seeing Jim's Github writeup that I decided to make a foray into actually reproducing the issues in a digestible way.</p><h2 id="other-fun-date-issues" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Other Fun Date Issues</h2><p>Speaking of fun <code>Date</code> class issues in Apex, this is the <code>git diff</code> from one of my favorite commits from this year:</p><pre class=""><code class="diff -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="- order.FillDate = System.today().addDays(100);" id="code5-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> order.FillDate = System.today().addDays(100);</span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="+ order.FillDate = System.today().addDays(125);" id="code5-l2"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> order.FillDate = System.today().addDays(125);</span></span></div><br></code></pre><p>The commit message? <code>Fixing UTC date issue that fails unit test for order status on deploys after 7pm EST</code>. Turns out if you're deploying after UTC midnight (depending on your Salesforce org's time zone) <em>and</em> you have logic that, say, assigns different statuses based on a specific date range (in this case, an object being within 100 days of today's date, or not), <em>you're gonna have issues</em>. This is something to be mindful of particularly when trying to decouple object setup from testing; while it's good practice to have commonly used <code>SObjects</code> -- and DTO objects like the one shown above -- be initialized from a test data factory. This allows you to standardize required fields with sensible defaults. It's also important, though, to be explicit in your tests! -- if your test(s) requires a date to be outside of a certain range and brooks no exceptions to that rule, explicitly setting your date to something outside of that range within the test(s) helps raise visibility of that expectation, and it aids in debugging if (when?) you run into issues like this one. If you have multiple test methods that require this value, it's fine to use a helper method in a test to set the defaults specific to that test class. Food for thought!</p><p>Worth noting, as well, is that this "issue" can strike with both <code>Date</code> and <code>Datetime</code> fields.</p><h2 id="formula--date-issues-wrap-up" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Formula / Date Issues Wrap Up</h2><p>Programming safely around dates and time isn't always challenging -- but the idiosyncracies of the SFDC platform have to be respected. Moving date issues from an <em>unknown unknown</em> to a <em>known known</em> means you're prepared to explain seemingly arbitrary occurrences in an informed light. Thanks again for reading the <a href="/joys-of-apex/">Joys Of Apex</a>!</p><p>It's been 10 months (or, in light of this post: nearly a year, or 43 weeks and 3 days ...) since I first began writing this series, and I'd invite you to look back at the <a href="/joys-of-apex/intro">intro</a> to remind you how it all began. For more fun with the <code>Date</code> class, be sure to checkout my writeup on the <a href="/joys-of-apex/replacing-dlrs-with-custom-rollup">Custom Rollup solution looking to replace DLRS</a>!</p><p>The original version of <a href="https://www.jamessimone.net/blog/joys-of-apex/formula-date-issues/">Formula Date Issues can be read on my blog.</a></p><div class="contentnav-0-0-7" data-no-search=""><a href="#formula-field-date-issues" class="h2" data-content-highlight="formula-field-date-issues">Formula Field Date Issues</a><a href="#paying-credit-where-credit-is-due" class="h2" data-content-highlight="paying-credit-where-credit-is-due">Paying Credit Where Credit Is Due</a><a href="#other-fun-date-issues" class="h2" data-content-highlight="other-fun-date-issues">Other Fun Date Issues</a><a href="#formula--date-issues-wrap-up" class="h2" data-content-highlight="formula--date-issues-wrap-up">Formula / Date Issues Wrap Up</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/advanced-logging-using-nebula-logger">Advanced Logging Using Nebula Logger</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/formula-date-issues">Formula Date Issues</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/lwc-custom-path">LWC Custom Lead Path</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/refactoring-tips-and-tricks">Refactoring Tips &amp; Tricks</a>
<a href="/joys-of-apex/replacing-dlrs-with-custom-rollup">Replacing DLRS With Custom Rollup</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/set-timeout-and-implementing-delays">setTimeout &amp; Implementing Delays</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/testing-custom-permissions">Testing Custom Permissions</a>
<a href="/joys-of-apex/the-tao-of-apex">The Tao Of Apex</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="dyFmYxHftl">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("dyFmYxHftl", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="oJukfbsaLz">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("oJukfbsaLz", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="LTQHWwznyW">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("LTQHWwznyW", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>