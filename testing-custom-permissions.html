<!DOCTYPE html><html><head><title>Joys Of Apex | Testing Custom Permissions</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Testing Custom Permissions"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Testing Custom Permissions"><meta name="keywords" content=""><meta property="blog-tags" content=""></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"testing-custom-permissions.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Testing Custom Permissions</p></span></h1><script id="EPoTfOHglo">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("EPoTfOHglo", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>Custom Permissions changed the game when it came to creating programmatic checks for feature management within Salesforce. Between Custom Metadata and Custom Permissions, Salesforce as a whole has been trying to <em>gently</em> move people away from permissions management by way of hierarchical custom settings (or, even worse, iterating through Permission Sets!). And there's a lot to love when it comes to Custom Permissions. Since Winter '18, the <code>FeatureManagement.checkPermission</code> method has enabled developers to easily implement permission-based code routing. However ... when it comes time to testing feature-flagged code, how can we easily ensure that our tests remain isolated without polluting our test domain (or, even worse, unnecessarily exposing private methods merely to test the innards of a class)? Join me on the journey toward testing Custom Permissions painlessly!</p><hr><h2 id="intro-feature-based-code-routes" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Intro: Feature-based Code Routes</h2><p>Let's say we have a business requirement that asks for a task to be created based off of Opportunity owners when an API interaction from an external system identifies outreach as the next best step. This integration could be the result of Opportunity Stages being updated by a Sales person; it could be kicked off by an internal cron job; it could come from anywhere. The business would like to gradually roll this feature out to users without fully opting all of them in at once. This is the perfect use-case for Custom Permissions: we can feature flag the logic that creates the task, and opt users from Sales in as we please from a Permission Set with the Custom Permission included:</p><pre class=""><code class="xml -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="<!-- Is_API_Task_Creation_Enabled.customPermission-meta.xml -->" id="code1-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">&lt;!-- Is_API_Task_Creation_Enabled.customPermission-meta.xml --&gt;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="<?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?>" id="code1-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="<CustomPermission xmlns=&quot;http://soap.sforce.com/2006/04/metadata&quot;>" id="code1-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CustomPermission</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://soap.sforce.com/2006/04/metadata<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    <description>Should an API integration trigger the creation of Tasks for Sales users?</description>" id="code1-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Should an API integration trigger the creation of Tasks for Sales users?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    <label>Is API Task Creation Enabled</label>" id="code1-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>Is API Task Creation Enabled<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="</CustomPermission>" id="code1-l6"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CustomPermission</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><p>And the Permission Set:</p><pre class=""><code class="xml -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="<!-- Create_API_Task_For_Sales.permissionset-meta.xml -->" id="code2-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">&lt;!-- Create_API_Task_For_Sales.permissionset-meta.xml --&gt;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="<?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?>" id="code2-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="<PermissionSet xmlns=&quot;http://soap.sforce.com/2006/04/metadata&quot;>" id="code2-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PermissionSet</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://soap.sforce.com/2006/04/metadata<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    <customPermissions>" id="code2-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>customPermissions</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        <enabled>true</enabled>" id="code2-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        <name>Is_API_Task_Creation_Enabled</name>" id="code2-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Is_API_Task_Creation_Enabled<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    </customPermissions>" id="code2-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>customPermissions</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    <hasActivationRequired>false</hasActivationRequired>" id="code2-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hasActivationRequired</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hasActivationRequired</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    <label>Create API Task For Sales</label>" id="code2-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>Create API Task For Sales<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    <license>Salesforce</license>" id="code2-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>license</span><span class="token punctuation">&gt;</span></span>Salesforce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>license</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="</PermissionSet>" id="code2-l11"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PermissionSet</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><p>Some example code, based off the premise that an update to an Opportunity triggers this action. It could be done synchronously, through a <a href="/joys-of-apex/lightweight-trigger-handler">trigger handler</a>, or asynchronously, through a <a href="/joys-of-apex/batchable-and-queueable-apex">Queueable or Batch job</a>. We'll start with the test for the happiest path:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="@isTest" id="code3-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="private class OpportunityTaskHandlerTests {" id="code3-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">OpportunityTaskHandlerTests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code3-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  @isTest" id="code3-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  static void it_should_create_tasks_for_eligible_sales_people() {" id="code3-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_create_tasks_for_eligible_sales_people</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    Opportunity opp = new Opportunity(OwnerId = UserInfo.getUserId());" id="code3-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Opportunity</span> opp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Opportunity</span><span class="token punctuation">(</span><span class="token class-name">OwnerId</span> <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code3-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    new OpportunityTaskHandler().createTasksForEligibleSalespeople(" id="code3-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">new</span> <span class="token class-name">OpportunityTaskHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTasksForEligibleSalespeople</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      new List<Opportunity>{" id="code3-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="          opp" id="code3-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>          opp</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      }" id="code3-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    );" id="code3-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code3-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    Task createdTask = [SELECT Id, OwnerId FROM Task];" id="code3-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Task</span> createdTask <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">OwnerId</span> FROM <span class="token class-name">Task</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    System.assertEquals(opp.OwnerId, createdTask.OwnerId, 'Owner Id didn\'t match for task!');" id="code3-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>opp<span class="token punctuation">.</span><span class="token class-name">OwnerId</span><span class="token punctuation">,</span> createdTask<span class="token punctuation">.</span><span class="token class-name">OwnerId</span><span class="token punctuation">,</span> <span class="token string">'Owner Id didn\'t match for task!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  }" id="code3-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code3-l17"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>We'll get started on that <code>OpportunityTaskHandler</code> object in a second; for now, of course, the test fails with the classic:</p><pre class=""><code class="bash -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="System.QueryException: List has no rows for assignment to SObject" id="code4-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>System.QueryException: List has no rows <span class="token keyword">for</span> assignment to SObject</div><br></code></pre><p>Perfect. You'll note that we are actually getting an additional safety feature right out of the box; because there is no <code>LIMIT</code> command on the SOQL query for <code>createdTask</code>, we're also safe-guarding against future regressions where multiple Tasks might be introduced. With the advent of the Winter '21 release, you'll also note that next week we will be able to take advantage of the <a href="https://releasenotes.docs.salesforce.com/en-us/winter21/release-notes/rn_apex_SafeNavigationOperator.htm">Safe Navigation</a> feature to perform the same query:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="Id actualOwnerId = [SELECT Id, OwnerId FROM Task]?.OwnerId;" id="code5-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Id</span> actualOwnerId <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">OwnerId</span> FROM <span class="token class-name">Task</span><span class="token punctuation">]</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token class-name">OwnerId</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="System.assertEquals(opp.OwnerId, actualOwnerId, 'Owner Id didn\'t match for task!');" id="code5-l2"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>opp<span class="token punctuation">.</span><span class="token class-name">OwnerId</span><span class="token punctuation">,</span> actualOwnerId<span class="token punctuation">,</span> <span class="token string">'Owner Id didn\'t match for task!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>Of course, such syntax sugar only avails us in the event that we only need to assert for one thing, but I point it out here in the event that you haven't checked the release notes recently.</p><h2 id="getting-our-first-custom-permissions-test-to-pass" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Getting Our First Custom Permissions Test To Pass</h2><p>Right now we have a failing test, but we also have zero functionality and no Custom Permissions wired up yet. Let's fix that:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="public without sharing class OpportunityTaskHandler {" id="code6-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> without sharing <span class="token keyword">class</span> <span class="token class-name">OpportunityTaskHandler</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public static final String TASK_SUBJECT = 'You have 10 days to move this sale along!';" id="code6-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TASK_SUBJECT <span class="token operator">=</span> <span class="token string">'You have 10 days to move this sale along!'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code6-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public void createTasksForEligibleSalespeople(List<Opportunity> opps) {" id="code6-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createTasksForEligibleSalespeople</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span> opps<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    // here we will assume the passed in Opps are pre-filtered" id="code6-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">// here we will assume the passed in Opps are pre-filtered</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        if(FeatureManagement.checkPermission('Is_API_Task_Creation_Enabled')) {" id="code6-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">FeatureManagement</span><span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token string">'Is_API_Task_Creation_Enabled'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            this.createTasks(opps);" id="code6-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createTasks</span><span class="token punctuation">(</span>opps<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        }" id="code6-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code6-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code6-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    private void createTasks(List<Opportunity> opps) {" id="code6-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createTasks</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span> opps<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        List<Task> tasksToInsert = new List<Task>();" id="code6-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> tasksToInsert <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        for(Opportunity opp : opps) {" id="code6-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span> opp <span class="token operator">:</span> opps<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            Task t = new Task(" id="code6-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token class-name">Task</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="                ActivityDate = System.today().addDays(10)," id="code6-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token class-name">ActivityDate</span> <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">today</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addDays</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="                OwnerId = opp.OwnerId," id="code6-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token class-name">OwnerId</span> <span class="token operator">=</span> opp<span class="token punctuation">.</span><span class="token class-name">OwnerId</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="                Subject = TASK_SUBJECT," id="code6-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token class-name">Subject</span> <span class="token operator">=</span> TASK_SUBJECT<span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="                WhatId = opp.AccountId," id="code6-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token class-name">WhatId</span> <span class="token operator">=</span> opp<span class="token punctuation">.</span><span class="token class-name">AccountId</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="                WhoId = opp.ContactId" id="code6-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token class-name">WhoId</span> <span class="token operator">=</span> opp<span class="token punctuation">.</span><span class="token class-name">ContactId</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            );" id="code6-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            tasksToInsert.add(t);" id="code6-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            tasksToInsert<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        }" id="code6-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        insert tasksToInsert;" id="code6-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        insert tasksToInsert<span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code6-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code6-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>We'll use a public static <code>String</code> for the Task Subject to aid in testing, but you could just as easily use a Custom Label. The only other design decision to talk about is the routing -- the reference to the Custom Permission itself. In a more complicated ask, and a more sophisticated system, you might also choose to use some form of configuration or metadata to inject the name of the Custom Permission being used; instead of hard-coding <code>Is_API_Task_Creation_Enabled</code>, you'd have the ability to swap Custom Permission(s) dynamically. <a href="https://github.com/tsalb/feature-flag-designs">James Hou has several interesting POCs on how this might be accomplished</a> -- while these feature-flag systems are not production ready, looking through the patterns in that repo might help you in your own search for best practices regarding customizations like this. But I digress -- back to it.</p><p>We've got our functionality -- let's get back to our test! One thing we can do is validate that the test has been setup correctly before touching anything else:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="// in OpportunityTaskHandlerTests" id="code7-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// in OpportunityTaskHandlerTests</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code7-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="@isTest" id="code7-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="static void it_should_create_tasks_for_eligible_sales_people() {" id="code7-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_create_tasks_for_eligible_sales_people</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.assertEquals(false, FeatureManagement.checkPermission('Is_API_Task_Creation_Enabled'));" id="code7-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">FeatureManagement</span><span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token string">'Is_API_Task_Creation_Enabled'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  // ..." id="code7-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// ...</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code7-l7"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>One of a few things I'm not thrilled with concerning the <code>checkPermission</code> method? It should throw an exception, in my opinion, if you pass in a Custom Permission name that doesn't exist. It doesn't do that. This is one of the other reasons I brought up the feature-flagging framework, above -- it's important that you isolate and minimize String-based parameters, both in your tests and in production-level code. It's too easy for misspellings to go unnoticed, especially if you aren't giving yourself the safety net that tests represent. Though it consumes an extra SOQL call, there is some wisdom to be gained in wrapping the <code>checkPermission</code> method to validate that the Custom Permission in question actually exists ... for the moment, we'll hold off on implementing something like that.</p><p>Anyway. The test is still failing. Let's address that. One possible way to do so -- and the method we'll employ first -- is to assign the Permission Set featuring the Custom Permission to our test user. There are ample pitfalls to this approach -- which we'll cover shortly -- but we're head's-down in the "red, green, refactor" TDD methodology at the moment, and the only thing that matters presently is getting that test to pass.</p><p>Permission Sets are metadata; they're retrievable in our tests without having to use the 'seeAllData` test attribute (and you shouldn't be using that attribute anyway). If you aren't familiar with how Users are assigned to Permission Sets within Apex, the process is refreshingly simple:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="@isTest" id="code8-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="static void it_should_create_tasks_for_eligible_sales_people() {" id="code8-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_create_tasks_for_eligible_sales_people</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.assertEquals(false, FeatureManagement.checkPermission('Is_API_Task_Creation_Enabled'));" id="code8-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">FeatureManagement</span><span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token string">'Is_API_Task_Creation_Enabled'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code8-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  PermissionSet ps = [SELECT Id FROM PermissionSet WHERE Name = 'Create_API_Task_For_Sales'];" id="code8-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">PermissionSet</span> ps <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span> FROM <span class="token class-name">PermissionSet</span> WHERE <span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'Create_API_Task_For_Sales'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  PermissionSetAssignment psa = new PermissionSetAssignment(" id="code8-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">PermissionSetAssignment</span> psa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionSetAssignment</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    AssigneeId = UserInfo.getUserId()," id="code8-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">AssigneeId</span> <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    PermissionSetId = ps.Id" id="code8-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">PermissionSetId</span> <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token class-name">Id</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code8-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  //..." id="code8-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//...</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code8-l11"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>Yes! Writing Apex is fun <em>and</em> easy! With any luck, we'll be done with this requirement before lun--</p><pre class=""><code class="bash -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="System.QueryException: List has no rows for assignment to SObject" id="code9-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>System.QueryException: List has no rows <span class="token keyword">for</span> assignment to SObject</div><br></code></pre><p>Wait, what. Why is there still no Task being created? Is there some kind of async process surrounding permissions that is preventing the call to <code>FeatureManagement.checkPermissions</code> from returning true? Sure enough, debugging shows the value has not changed even after the Permission Set has been assigned. Well, that's OK -- we're veterans of async deception in Apex, which means we know wrapping this thing in <code>Test.startTest</code> / <code>Test.stopTest</code> should force all async actions -- including the presumed permissions updating -- to complete. I'm thinking maybe I'll have a caprese sandwi--</p><pre class=""><code class="bash -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="List has no rows for assignment to SObject" id="code10-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>List has no rows <span class="token keyword">for</span> assignment to SObject</div><br></code></pre><p>Hmm. OK, that ... didn't work. I didn't expect that. What about if we wrap the calling code in <code>System.runAs</code>? Even though we're <em>already</em> running the test as ourself, maybe there's something about running the test in another context that will help:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="@isTest" id="code11-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="static void it_should_create_tasks_for_eligible_sales_people() {" id="code11-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_create_tasks_for_eligible_sales_people</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.assertEquals(false, FeatureManagement.checkPermission('Is_API_Task_Creation_Enabled'));" id="code11-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">FeatureManagement</span><span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token string">'Is_API_Task_Creation_Enabled'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code11-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  PermissionSet ps = [SELECT Id FROM PermissionSet WHERE Name = 'Create_API_Task_For_Sales'];" id="code11-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">PermissionSet</span> ps <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span> FROM <span class="token class-name">PermissionSet</span> WHERE <span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'Create_API_Task_For_Sales'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  PermissionSetAssignment psa = new PermissionSetAssignment(" id="code11-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">PermissionSetAssignment</span> psa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionSetAssignment</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    AssigneeId = UserInfo.getUserId()," id="code11-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">AssigneeId</span> <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    PermissionSetId = ps.Id" id="code11-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">PermissionSetId</span> <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token class-name">Id</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code11-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code11-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  // See the repo if you haven't seen" id="code11-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// See the repo if you haven't seen</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  // these Id generators before" id="code11-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// these Id generators before</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  Opportunity opp = new Opportunity(" id="code11-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Opportunity</span> opp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Opportunity</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    AccountId = TestingUtils.generateId(Account.SObjectType)," id="code11-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">AccountId</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    ContactId = TestingUtils.generateId(Contact.SObjectType)," id="code11-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">ContactId</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Contact</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    OwnerId = UserInfo.getUserId()" id="code11-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">OwnerId</span> <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code11-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code11-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code11-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.runAs(new User(Id = UserInfo.getUserId())) {" id="code11-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">runAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    new OpportunityTaskHandler().createTasksForEligibleSalespeople(" id="code11-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">new</span> <span class="token class-name">OpportunityTaskHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTasksForEligibleSalespeople</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      new List<Opportunity>{" id="code11-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="          opp" id="code11-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>          opp</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      }" id="code11-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    );" id="code11-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  }" id="code11-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code11-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  // Added asserts for all the functionality" id="code11-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// Added asserts for all the functionality</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  Task createdTask = [SELECT Id, ActivityDate, OwnerId, WhatId, WhoId FROM Task];" id="code11-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Task</span> createdTask <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">ActivityDate</span><span class="token punctuation">,</span> <span class="token class-name">OwnerId</span><span class="token punctuation">,</span> <span class="token class-name">WhatId</span><span class="token punctuation">,</span> <span class="token class-name">WhoId</span> FROM <span class="token class-name">Task</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.assertEquals(System.today().addDays(10), createdTask.ActivityDate, 'Activity Date didn\'t match for task!');" id="code11-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">today</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addDays</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> createdTask<span class="token punctuation">.</span><span class="token class-name">ActivityDate</span><span class="token punctuation">,</span> <span class="token string">'Activity Date didn\'t match for task!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.assertEquals(opp.OwnerId, createdTask.OwnerId, 'Owner Id didn\'t match for task!');" id="code11-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>opp<span class="token punctuation">.</span><span class="token class-name">OwnerId</span><span class="token punctuation">,</span> createdTask<span class="token punctuation">.</span><span class="token class-name">OwnerId</span><span class="token punctuation">,</span> <span class="token string">'Owner Id didn\'t match for task!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.assertEquals(opp.AccountId, createdTask.WhatId, 'What Id didn\'t match for task!');" id="code11-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>opp<span class="token punctuation">.</span><span class="token class-name">AccountId</span><span class="token punctuation">,</span> createdTask<span class="token punctuation">.</span><span class="token class-name">WhatId</span><span class="token punctuation">,</span> <span class="token string">'What Id didn\'t match for task!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.assertEquals(opp.ContactId, createdTask.WhoId, 'Who Id didn\'t match for task!');" id="code11-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>opp<span class="token punctuation">.</span><span class="token class-name">ContactId</span><span class="token punctuation">,</span> createdTask<span class="token punctuation">.</span><span class="token class-name">WhoId</span><span class="token punctuation">,</span> <span class="token string">'Who Id didn\'t match for task!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code11-l34"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>I'll spare you the drama -- the test is still failing. I'm recreating this experience, step-by-painful-step, as it happened to me when I first went to work on a feature like this. When it <em>was</em> happening to me, in the moment, I'll admit -- I was tempted to give up. I already had a test passing that verified the objects in question (which were not Opportunities for the project I was working on, but the same concept applies) were being filtered correctly. I knew the project's code coverage was high enough that a few untested -- and admittedly simple -- lines were unlikely to arouse suspicion or red flags. But that's not the <strong>Joys Of Apex</strong> way. Indeed, the thought of giving up so galled me that I was driven to continue. Deeper into the mysterious SObjects known as "Setup Objects" we will have to go ...</p><h2 id="working-with-setup-objects-in-apex-tests" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Working With Setup Objects In Apex Tests</h2><p>There are quite a few objects that belong to the "Setup Object" category, which becomes relevant to us since we would like to both manipulate these objects and perform other DML (the Task insertion) within our test. We are typically spoiled when it comes to documentation on the SFDC platform, and <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_dml_non_mix_sobjects.htm">this is no exception</a>. Here are some of the more pertinent objects that I've run into which can generate the dreaded "mixed DML" setup object error when writing unit tests:</p><ul><li>User</li><li>Profile</li><li>PermissionSet</li><li>PermissionSetAssignment</li><li>ObjectPermissions (but, confusingly, not FieldPermissions ?)</li><li>SetupEntityAccess</li></ul><p>It's that last one -- <code>SetupEntityAccess</code> -- which will prove crucial to aiding and abetting our unit tests. It turns out that in addition to the <code>PermissionSetAssignment</code> object, which is still required, we <em>also</em> need to ensure that our Permission Set is correctly set up with the reference for the Custom Permission in order for our test to work. This also forces us to make our test fully independent from the Permission Set that we've created -- which is great. Since Permission Sets can be changed without running all tests, it's possible to remove the Custom Permission we've created from our Permission Set and deploy without anybody being the wiser -- until our unit tests are run the next time a code update is deployed! We'll remove that possible failure point from our codebase and enjoy clean code in the process.</p><p>I'll also mention that even after all of this was pieced together, I still had to do the <code>Test.startTest()</code> / <code>Test.stopTest()</code> song and dance prior to <em>finally</em> having success with just the plain <code>System.runAs(user)</code> method -- only in the <code>runAs</code> context is a User's Custom Permission status successfully re-calculated during testing!</p><p>Here's what creating the full list of objects necessary to tie everything together looks like:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="// in TestingUtils" id="code12-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// in TestingUtils</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="public static void activateCustomPerm(Id userId, String permissionName) {" id="code12-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">activateCustomPerm</span><span class="token punctuation">(</span><span class="token class-name">Id</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> permissionName<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  PermissionSet ps = new PermissionSet(" id="code12-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">PermissionSet</span> ps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionSet</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    Name = 'CustomPermissionEnabled'," id="code12-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'CustomPermissionEnabled'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    Label = 'Custom Permisison Enabled'" id="code12-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Label</span> <span class="token operator">=</span> <span class="token string">'Custom Permisison Enabled'</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    );" id="code12-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  insert ps;" id="code12-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  insert ps<span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code12-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  SetupEntityAccess sea = new SetupEntityAccess(" id="code12-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">SetupEntityAccess</span> sea <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetupEntityAccess</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    ParentId = ps.Id," id="code12-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">ParentId</span> <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    SetupEntityId = [" id="code12-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">SetupEntityId</span> <span class="token operator">=</span> <span class="token punctuation">[</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      SELECT Id" id="code12-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      SELECT <span class="token class-name">Id</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      FROM CustomPermission" id="code12-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      FROM <span class="token class-name">CustomPermission</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      WHERE DeveloperName = :permissionName" id="code12-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      WHERE <span class="token class-name">DeveloperName</span> <span class="token operator">=</span> <span class="token operator">:</span>permissionName</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      LIMIT 1" id="code12-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      LIMIT <span class="token number">1</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    ].Id" id="code12-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token class-name">Id</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code12-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code12-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  PermissionSetAssignment psa = new PermissionSetAssignment(" id="code12-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">PermissionSetAssignment</span> psa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionSetAssignment</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    AssigneeId = userId," id="code12-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">AssigneeId</span> <span class="token operator">=</span> userId<span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    PermissionSetId = ps.Id" id="code12-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">PermissionSetId</span> <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token class-name">Id</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code12-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code12-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  insert new List<SObject>{ sea, psa };" id="code12-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  insert <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> sea<span class="token punctuation">,</span> psa <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code12-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>Putting it all together, our test now looks like:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="@isTest" id="code13-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="static void it_should_create_tasks_for_eligible_sales_people() {" id="code13-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_create_tasks_for_eligible_sales_people</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  TestingUtils.activateCustomPerm(" id="code13-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">activateCustomPerm</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    UserInfo.getUserId()," id="code13-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    'Is_API_Task_Creation_Enabled'" id="code13-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token string">'Is_API_Task_Creation_Enabled'</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code13-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code13-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  Opportunity opp = new Opportunity(" id="code13-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Opportunity</span> opp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Opportunity</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    AccountId = TestingUtils.generateId(Account.SObjectType)," id="code13-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">AccountId</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    ContactId = TestingUtils.generateId(Contact.SObjectType)," id="code13-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">ContactId</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Contact</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    OwnerId = UserInfo.getUserId()" id="code13-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">OwnerId</span> <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code13-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code13-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  // runAs is REQUIRED to recalc the user's permissions" id="code13-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// runAs is REQUIRED to recalc the user's permissions</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.runAs(new User(Id = UserInfo.getUserId())) {" id="code13-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">runAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    new OpportunityTaskHandler().createTasksForEligibleSalespeople(" id="code13-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">new</span> <span class="token class-name">OpportunityTaskHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTasksForEligibleSalespeople</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      new List<Opportunity>{" id="code13-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="          opp" id="code13-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>          opp</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      }" id="code13-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    );" id="code13-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  }" id="code13-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code13-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  Task createdTask = [SELECT Id, ActivityDate, OwnerId, WhatId, WhoId FROM Task];" id="code13-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Task</span> createdTask <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">ActivityDate</span><span class="token punctuation">,</span> <span class="token class-name">OwnerId</span><span class="token punctuation">,</span> <span class="token class-name">WhatId</span><span class="token punctuation">,</span> <span class="token class-name">WhoId</span> FROM <span class="token class-name">Task</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  // mobile friendly asserts" id="code13-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// mobile friendly asserts</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  // sorry desktop users!" id="code13-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// sorry desktop users!</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.assertEquals(" id="code13-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    System.today().addDays(10)," id="code13-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">today</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addDays</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    createdTask.ActivityDate," id="code13-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    createdTask<span class="token punctuation">.</span><span class="token class-name">ActivityDate</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    'Activity Date didn\'t match for task!'" id="code13-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token string">'Activity Date didn\'t match for task!'</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code13-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.assertEquals(" id="code13-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    opp.OwnerId," id="code13-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    opp<span class="token punctuation">.</span><span class="token class-name">OwnerId</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    createdTask.OwnerId," id="code13-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    createdTask<span class="token punctuation">.</span><span class="token class-name">OwnerId</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    'Owner Id didn\'t match for task!'" id="code13-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token string">'Owner Id didn\'t match for task!'</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code13-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.assertEquals(" id="code13-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    opp.AccountId," id="code13-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    opp<span class="token punctuation">.</span><span class="token class-name">AccountId</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    createdTask.WhatId," id="code13-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    createdTask<span class="token punctuation">.</span><span class="token class-name">WhatId</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    'What Id didn\'t match for task!'" id="code13-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token string">'What Id didn\'t match for task!'</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code13-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  System.assertEquals(" id="code13-l41"><span class="lineCounter-0-0-15 -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    opp.ContactId," id="code13-l42"><span class="lineCounter-0-0-15 -codedoc-line-counter">42<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    opp<span class="token punctuation">.</span><span class="token class-name">ContactId</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    createdTask.WhoId," id="code13-l43"><span class="lineCounter-0-0-15 -codedoc-line-counter">43<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    createdTask<span class="token punctuation">.</span><span class="token class-name">WhoId</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    'Who Id didn\'t match for task!'" id="code13-l44"><span class="lineCounter-0-0-15 -codedoc-line-counter">44<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token string">'Who Id didn\'t match for task!'</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code13-l45"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">45<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code13-l46"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">46<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p><em>Now</em> we get a different error:</p><pre class=""><code class="bash -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="INVALID_CROSS_REFERENCE_KEY, invalid cross reference id" id="code14-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>INVALID_CROSS_REFERENCE_KEY, invalid cross reference <span class="token function">id</span></div><br></code></pre><p>This is because the Ids generated by <code>TestingUtils</code> aren't recognized by the database as valid -- because the given Account and Contact records do not exist. This is where dependency injection / use of the Stub API comes into play, going back to the <a href="/joys-of-apex/mocking-dml">Mocking DML article</a>:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="// in OpportunityTaskHandler" id="code15-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// in OpportunityTaskHandler</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="private final ICrud crud;" id="code15-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ICrud</span> crud<span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code15-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="public OpportunityTaskHandler(ICrud crud) {" id="code15-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token class-name">OpportunityTaskHandler</span><span class="token punctuation">(</span><span class="token class-name">ICrud</span> crud<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    this.crud = crud;" id="code15-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span>crud <span class="token operator">=</span> crud<span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code15-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code15-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content=" private void createTasks(List<Opportunity> opps) {" id="code15-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createTasks</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span> opps<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="   List<Task> tasksToInsert = new List<Task>();" id="code15-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> tasksToInsert <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="   // loop through opps" id="code15-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>   <span class="token comment">// loop through opps</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="   // create tasks" id="code15-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>   <span class="token comment">// create tasks</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="   this.crud.doInsert(tasksToInsert);" id="code15-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>   <span class="token keyword">this</span><span class="token punctuation">.</span>crud<span class="token punctuation">.</span><span class="token function">doInsert</span><span class="token punctuation">(</span>tasksToInsert<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content=" }" id="code15-l13"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span> <span class="token punctuation">}</span></div><br></code></pre><p>And in the test:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="System.runAs(new User(Id = UserInfo.getUserId())) {" id="code16-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">runAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  new OpportunityTaskHandler(CrudMock.getMock()).createTasksForEligibleSalespeople(" id="code16-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">new</span> <span class="token class-name">OpportunityTaskHandler</span><span class="token punctuation">(</span><span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token function">getMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTasksForEligibleSalespeople</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    new List<Opportunity>{" id="code16-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        opp" id="code16-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        opp</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code16-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code16-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code16-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code16-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="Task createdTask = (Task)CrudMock.Inserted.Tasks.singleOrDefault;" id="code16-l9"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Task</span> createdTask <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">)</span><span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token class-name">Inserted</span><span class="token punctuation">.</span><span class="token class-name">Tasks</span><span class="token punctuation">.</span>singleOrDefault<span class="token punctuation">;</span></div><br></code></pre><p>Note that the <code>singleOrDefault</code> method throws if more than one element is present -- the same as our old SOQL query safe-guard. Excellent. And the test passes! But maybe you're more into the Stub API these days? This is a great chance to plug <a href="https://github.com/surajp/universalmock">Suraj Pillai's UniversalMock</a> Stub API framework for easy stubbing. There is one critical limitation with the Stub API, however -- you can't mock private methods.</p><p>This means that for mocking DML, you're still "stuck" having a DML wrapper of sorts -- which would then allow you to use the mock like so:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="// In OpportunityTaskHandlerTests" id="code17-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// In OpportunityTaskHandlerTests</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="UniversalMocker mock = UniversalMocker.mock(Crud.class);" id="code17-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">UniversalMocker</span> mock <span class="token operator">=</span> <span class="token class-name">UniversalMocker</span><span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">Crud</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="ICrud crudMock = (ICrud)mock.createStub();" id="code17-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">ICrud</span> crudMock <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ICrud</span><span class="token punctuation">)</span>mock<span class="token punctuation">.</span><span class="token function">createStub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code17-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="System.runAs(new User(Id = UserInfo.getUserId())) {" id="code17-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">runAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  new OpportunityTaskHandler(crudMock).createTasksForEligibleSalespeople(" id="code17-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">new</span> <span class="token class-name">OpportunityTaskHandler</span><span class="token punctuation">(</span>crudMock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTasksForEligibleSalespeople</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    new List<Opportunity>{" id="code17-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        opp" id="code17-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        opp</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code17-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  );" id="code17-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code17-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code17-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="List<Task> createdTasks = (List<Task>)((Map<String, Object>)mock" id="code17-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> createdTasks <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>mock</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  .forMethod('doInsert')" id="code17-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">.</span><span class="token function">forMethod</span><span class="token punctuation">(</span><span class="token string">'doInsert'</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  .getArgumentsMap())" id="code17-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">.</span><span class="token function">getArgumentsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  .get('records');" id="code17-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'records'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="Task createdTask = createdTasks[0];" id="code17-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Task</span> createdTask <span class="token operator">=</span> createdTasks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="// etc with your asserts ..." id="code17-l18"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// etc with your asserts ...</span></div><br></code></pre><p>For mocking DML, I find the use of the Stub API a bit heavy, but it's good to point out its flexibility to people who may not be aware that a whole host of other options are available to them when testing complicated objects.</p><h2 id="wrapping-up-testing-custom-permissions" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Wrapping Up Testing Custom Permissions</h2><p>We've successfully decoupled our tests from any one Permission Set existing, and also shown how to test for the existence of Custom Permissions in isolation. The negative test -- simply verifying that no Task is created if the User does not have the Custom Permission enabled -- is left as a trivial exercise for the reader. The more serious task would be wrapping calls to <code>FeatureManagement</code>, as mentioned earlier, to validate that the Custom Permission exists -- you can afford the extra SOQL call, hopefully, but this also makes the method non-bulk-safe.</p><p>Anyway, we've planted the seed for extensible permissions-based routing. I don't have the answer for how to best dynamically gate functionality ... at the moment, I would probably go the route of Custom Metadata being fed into a system calling <code>FeatureManagement.checkPermission</code>, with sensible defaults. One problem with the dynamic version of feature flagging is that it puts the onus on the business as a whole to eliminate dead code routes when certain features are deprecated; if your tests are properly self-isolating, the only way you would know that code was no longer reachable would be if somebody went and deleted the Custom Permission in question ... otherwise, if it hangs out, without being assigned to any Permission Set, you have no intuitive, in-system, way to validate a feature being deprecated.</p><p>Despite this dead-code issue, I hope that I've given you plenty to think about when it comes to Custom Permissions. Worst case scenario, I'm simply confirming what you already know -- Custom Permissions play nicely within Apex; you just need to be sure your tests are properly decoupled. I've uploaded the <a href="https://github.com/jamessimone/apex-mocks-stress-test/tree/testing-custom-permissions">example code if you want to browse through on Github</a> -- till next time!</p><p><strong>Note</strong> - the original version of this article can be read <a href="https://www.jamessimone.net/blog/joys-of-apex/testing-custom-permissions/">on jamessimone.net</a></p><div class="contentnav-0-0-7" data-no-search=""><a href="#intro-feature-based-code-routes" class="h2" data-content-highlight="intro-feature-based-code-routes">Intro: Feature-based Code Routes</a><a href="#getting-our-first-custom-permissions-test-to-pass" class="h2" data-content-highlight="getting-our-first-custom-permissions-test-to-pass">Getting Our First Custom Permissions Test To Pass</a><a href="#working-with-setup-objects-in-apex-tests" class="h2" data-content-highlight="working-with-setup-objects-in-apex-tests">Working With Setup Objects In Apex Tests</a><a href="#wrapping-up-testing-custom-permissions" class="h2" data-content-highlight="wrapping-up-testing-custom-permissions">Wrapping Up Testing Custom Permissions</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/lwc-custom-path">LWC Custom Lead Path</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/refactoring-tips-and-tricks">Refactoring Tips &amp; Tricks</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/set-timeout-and-implementing-delays">setTimeout &amp; Implementing Delays</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/testing-custom-permissions">Testing Custom Permissions</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="GpRaxbWyZk">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("GpRaxbWyZk", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="zVhVvhBqMY">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("zVhVvhBqMY", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="fJschHduem">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("fJschHduem", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>