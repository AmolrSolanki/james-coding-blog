<!DOCTYPE html><html><head><title>Joys Of Apex | Building A Better Singleton</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Building A Better Singleton"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Building A Better Singleton"></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"building-a-better-singleton.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Building A Better Singleton</p></span></h1><script id="fCvSCVAEOY">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("fCvSCVAEOY", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2020-04-25T15:12:03.284Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>In <a href="/joys-of-apex/picklist-validation/">the last post on Picklist Validation</a>, I touched briefly on my disappointment in being unable to bring to fruition a better pattern for creating singletons -- the perfect way to access constant values like those in a picklist:</p><blockquote><p>I hate writing singleton property accessors, and have spent more hours than I'd care to admit trying to "solve" that problem through a variety of abstract class hacks ... none of which has borne any fruit. That's the nature of progression, though -- failure is a part of the process.</p></blockquote><p>In the ensuing weeks, I spent a considerable portion of time simply spent bulleting out thoughts about the "problem" that I had first introduced in the <a href="/joys-of-apex/idiomatic-salesforce-apex/">Idiomatic Apex</a> post:</p><ul><li>the traditional get/set method for creating singletons takes <em>nine</em> lines of code. NINE. Nine lines! That's way too much.</li><li>because singletons need to be accessed statically (so that you don't have to initialize new objects each time you are calling them), there is an inherent disconnect between the ideal object-oriented solution (which would require the usage of the <code>this</code> keyword, strictly verboten in a static context), and our options on the table.</li><li>we can set static variables in our constructors though .... might that be enough?</li></ul><p>Last night, while winding down, the situation finally resolved itself in a burst of inspiration. Messily implemented first in my notebook (my handwritten braces get progressively worse), I finally figured out how to resolve the static nature of singletons with an object-oriented approach:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/Singleton.cls</span></span><div class="line-0-0-16 " data-content="public abstract class Singleton {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  private static final Map<Type, Singleton> typeToSingleton"><span class="lineCounter-0-0-15">2</span>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">Singleton</span><span class="token punctuation">&gt;</span></span> typeToSingleton</div><br><div class="line-0-0-16 " data-content="    = new Map<Type, Singleton>();"><span class="lineCounter-0-0-15">3</span>    <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">Singleton</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">4</span></div><br><div class="line-0-0-16 " data-content="  public static Singleton getSingleton(Type type) {"><span class="lineCounter-0-0-15 prim">5</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">Type</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    if(typeToSingleton.containsKey(type) == false) {"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>typeToSingleton<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      typeToSingleton.put(type, (Singleton)type.newInstance());"><span class="lineCounter-0-0-15">7</span>      typeToSingleton<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">)</span>type<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">8</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    return typeToSingleton.get(type);"><span class="lineCounter-0-0-15">9</span>    <span class="token keyword">return</span> typeToSingleton<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15 prim">10</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">11</span><span class="token punctuation">}</span></div><br></code></pre><p>Going back to the <code>Picklist</code> class from the <a href="/joys-of-apex/picklist-validation/">previous post</a>, now the base class just needed to extend <code>Singleton</code> so that subclasses could make use of the type:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public abstract class Picklist extends Singleton {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Picklist</span> <span class="token keyword">extends</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  //...etc"><span class="lineCounter-0-0-15">2</span>  <span class="token comment">//...etc</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">3</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">4</span></div><br><div class="line-0-0-16 " data-content="public class AccountIndustries extends Picklist {"><span class="lineCounter-0-0-15 prim">5</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountIndustries</span> <span class="token keyword">extends</span> <span class="token class-name">Picklist</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  public AccountIndustries() {"><span class="lineCounter-0-0-15">6</span>  <span class="token keyword">public</span> <span class="token class-name">AccountIndustries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    super(Account.Industry);"><span class="lineCounter-0-0-15">7</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">Industry</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">8</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">9</span></div><br><div class="line-0-0-16 " data-content="  //the newer invocation"><span class="lineCounter-0-0-15 prim">10</span>  <span class="token comment">//the newer invocation</span></div><br><div class="line-0-0-16 " data-content="  //note that because there isn't a &quot;set&quot;"><span class="lineCounter-0-0-15">11</span>  <span class="token comment">//note that because there isn't a "set"</span></div><br><div class="line-0-0-16 " data-content="  //method, if I wasn't going for mobile"><span class="lineCounter-0-0-15">12</span>  <span class="token comment">//method, if I wasn't going for mobile</span></div><br><div class="line-0-0-16 " data-content="  //friendly code, this could be reduced to a single line"><span class="lineCounter-0-0-15">13</span>  <span class="token comment">//friendly code, this could be reduced to a single line</span></div><br><div class="line-0-0-16 " data-content="  public static AccountIndustries Current {"><span class="lineCounter-0-0-15">14</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AccountIndustries</span> <span class="token class-name">Current</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    get {"><span class="lineCounter-0-0-15 prim">15</span>    get <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      return (AccountIndustries)Singleton.getSingleton(AccountIndustries.class);"><span class="lineCounter-0-0-15">16</span>      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">AccountIndustries</span><span class="token punctuation">)</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">AccountIndustries</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">17</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">18</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">19</span></div><br><div class="line-0-0-16 " data-content="  //the more idiomatic singleton, for testing purposes"><span class="lineCounter-0-0-15 prim">20</span>  <span class="token comment">//the more idiomatic singleton, for testing purposes</span></div><br><div class="line-0-0-16 " data-content="  public static AccountIndustries Instance {"><span class="lineCounter-0-0-15">21</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AccountIndustries</span> <span class="token class-name">Instance</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    get {"><span class="lineCounter-0-0-15">22</span>    get <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      if(Instance == null) {"><span class="lineCounter-0-0-15">23</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Instance</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Instance = new AccountIndustries();"><span class="lineCounter-0-0-15">24</span>        <span class="token class-name">Instance</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountIndustries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      }"><span class="lineCounter-0-0-15 prim">25</span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="      return Instance;"><span class="lineCounter-0-0-15">26</span>      <span class="token keyword">return</span> <span class="token class-name">Instance</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">27</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    private set;"><span class="lineCounter-0-0-15">28</span>    <span class="token keyword">private</span> set<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">29</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">30</span></div><br><div class="line-0-0-16 " data-content="  public String AGRICULTURE { get { return this.getValue('Agriculture'); }}"><span class="lineCounter-0-0-15">31</span>  <span class="token keyword">public</span> <span class="token class-name">String</span> AGRICULTURE <span class="token punctuation">{</span> get <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">'Agriculture'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  public String APPAREL { get { return this.getValue('Apparel'); }}"><span class="lineCounter-0-0-15">32</span>  <span class="token keyword">public</span> <span class="token class-name">String</span> APPAREL <span class="token punctuation">{</span> get <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">'Apparel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">33</span><span class="token punctuation">}</span></div><br></code></pre><p>Of course, it's not enough to simply have code that compiles -- is it performant? Let's do some simple iteration to stress test this new Singleton pattern:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/SingletonStressTests.cls</span></span><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class SingletonStressTests {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SingletonStressTests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  @isTest"><span class="lineCounter-0-0-15">3</span>  <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="  static void it_should_establish_a_baseline_iteration_time() {"><span class="lineCounter-0-0-15">4</span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_establish_a_baseline_iteration_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    runTest(null);"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token function">runTest</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">6</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="  @isTest"><span class="lineCounter-0-0-15">8</span>  <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="  static void it_should_use_idiomatic_singleton() {"><span class="lineCounter-0-0-15">9</span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_use_idiomatic_singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    runTest(new TestIdiomaticSingleton());"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token function">runTest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TestIdiomaticSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">11</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">12</span></div><br><div class="line-0-0-16 " data-content="  @isTest"><span class="lineCounter-0-0-15">13</span>  <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="  static void it_should_use_new_singleton() {"><span class="lineCounter-0-0-15">14</span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_use_new_singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    runTest(new TestNewSingleton());"><span class="lineCounter-0-0-15 prim">15</span>    <span class="token function">runTest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TestNewSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">16</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">17</span></div><br><div class="line-0-0-16 " data-content="  static void runTest(TestFunction function) {"><span class="lineCounter-0-0-15">18</span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runTest</span><span class="token punctuation">(</span><span class="token class-name">TestFunction</span> function<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    for(Integer index = 0; index < 10000; index++) {"><span class="lineCounter-0-0-15">19</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      if(function != null) {"><span class="lineCounter-0-0-15 prim">20</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>function <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        function.call();"><span class="lineCounter-0-0-15">21</span>        function<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      }"><span class="lineCounter-0-0-15">22</span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">23</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">24</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">25</span></div><br><div class="line-0-0-16 " data-content="  private abstract class TestFunction {"><span class="lineCounter-0-0-15">26</span>  <span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">TestFunction</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public abstract void call();"><span class="lineCounter-0-0-15">27</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">28</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">29</span></div><br><div class="line-0-0-16 " data-content="  private class TestIdiomaticSingleton extends TestFunction {"><span class="lineCounter-0-0-15 prim">30</span>  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">TestIdiomaticSingleton</span> <span class="token keyword">extends</span> <span class="token class-name">TestFunction</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public override void call() {"><span class="lineCounter-0-0-15">31</span>    <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      System.debug(AccountIndustries.Instance.AGRICULTURE);"><span class="lineCounter-0-0-15">32</span>      <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">AccountIndustries</span><span class="token punctuation">.</span><span class="token class-name">Instance</span><span class="token punctuation">.</span>AGRICULTURE<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">33</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">34</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">35</span></div><br><div class="line-0-0-16 " data-content="  private class TestNewSingleton extends TestFunction {"><span class="lineCounter-0-0-15">36</span>  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">TestNewSingleton</span> <span class="token keyword">extends</span> <span class="token class-name">TestFunction</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public override void call() {"><span class="lineCounter-0-0-15">37</span>    <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      System.debug(AccountIndustries.Current.AGRICULTURE);"><span class="lineCounter-0-0-15">38</span>      <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">AccountIndustries</span><span class="token punctuation">.</span><span class="token class-name">Current</span><span class="token punctuation">.</span>AGRICULTURE<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">39</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15 prim">40</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">41</span><span class="token punctuation">}</span></div><br></code></pre><p>Woof. Initial results were not promising:</p><table><thead><th>TEST NAME</th><th>OUTCOME</th><th>RUNTIME (MS)</th></thead><tbody><tr><td>SingletonStressTests.itShouldEstablishABaselineIterationTime</td><td>Pass</td><td>23</td></tr><tr><td>SingletonStressTests.itShouldUseIdiomaticSingleton</td><td>Pass</td><td>240</td></tr><tr><td>SingletonStressTests.itShouldUseNewSingleton</td><td>Pass</td><td>1160</td></tr></tbody></table><p>At first, I wondered if perhaps the dynamic <code>Type.newInstance</code>, or perhaps even the usage of the internal Map within the <code>Singleton</code> class was responsible for the slowdown. I would expect that there would be some slowdown, some overhead, in the usage of this more complicated setup ... however, I did not expect that the new method would be <em>six times slower</em>. Of course, in actual usage, such slowdown might not matter for your application ... but that's not the <a href="/joys-of-apex/">Joys Of Apex</a> way. While I was ecstatic at the notion of saving 8 lines of code through the use of this new singleton one-liner, I wasn't about to recommend that to my clients if it meant taking such a big performance hit.</p><p>I tried eliminating the map. I tried passing an actual instance of the class to the <code>getSingleton</code> function (in this case, using <code>new AccountIndustries</code>) instead of dynamically spinning an instance up. Nothing. No changes reduced the runtime appreciably.</p><p>Then it hit me -- the property <code>Current</code> itself was not being cached. Just for kicks, let's switch to the more idiomatic method for instantiating singletons to see if that made up any ground in terms of performance:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/AccountIndustries.cls</span></span><div class="line-0-0-16 " data-content="public static AccountIndustries Current {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AccountIndustries</span> <span class="token class-name">Current</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  get {"><span class="lineCounter-0-0-15">2</span>  get <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    if(Current == null) {"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Current</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      Current = (AccountIndustries)Singleton.getSingleton(AccountIndustries.class);"><span class="lineCounter-0-0-15">4</span>      <span class="token class-name">Current</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AccountIndustries</span><span class="token punctuation">)</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">AccountIndustries</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    return Current;"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">return</span> <span class="token class-name">Current</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">7</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  private set;"><span class="lineCounter-0-0-15">8</span>  <span class="token keyword">private</span> set<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">9</span><span class="token punctuation">}</span></div><br></code></pre><p>The results were fascinating:</p><table><thead><th>TEST NAME</th><th>OUTCOME</th><th>RUNTIME (MS)</th></thead><tbody><tr><td>SingletonStressTests.itShouldEstablishABaselineIterationTime</td><td>Pass</td><td>27</td></tr><tr><td>SingletonStressTests.itShouldUseIdiomaticSingleton</td><td>Pass</td><td>109</td></tr><tr><td>SingletonStressTests.itShouldUseNewSingleton</td><td>Pass</td><td>85</td></tr></tbody></table><p>OK, so the pattern was not itself responsible for the performance slowdown. That was great news. It wasn't great news that it still took 9 lines of code to retrieve a singleton instance. Apex does feature static constructors, but those are no good; was there any way to ensure that the property was only initialized once without all the boilerplate?</p><p>Perhaps you see where this is headed now. There is, of course, one last trick up our sleeves -- the <code>final</code> keyword. Traditionally used to ensure an object's dependencies are set only in the constructor, <code>final</code> is also compatible with static variables and ensures that they are only ever initialized once.</p><p>That makes the <code>AccountIndustries</code> object look pretty svelte indeed:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/AccountIndustries.cls</span></span><div class="line-0-0-16 " data-content="public class AccountIndustries extends Picklist {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountIndustries</span> <span class="token keyword">extends</span> <span class="token class-name">Picklist</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  public AccountIndustries() {"><span class="lineCounter-0-0-15">2</span>  <span class="token keyword">public</span> <span class="token class-name">AccountIndustries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    super(Account.Industry);"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">Industry</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">4</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">5</span></div><br><div class="line-0-0-16 " data-content="  public static final AccountIndustries Current = (AccountIndustries)Singleton.getSingleton(AccountIndustries.class);"><span class="lineCounter-0-0-15">6</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AccountIndustries</span> <span class="token class-name">Current</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AccountIndustries</span><span class="token punctuation">)</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">AccountIndustries</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="  //only keeping this property now to re-run the tests"><span class="lineCounter-0-0-15">8</span>  <span class="token comment">//only keeping this property now to re-run the tests</span></div><br><div class="line-0-0-16 " data-content="  public static final AccountIndustries Instance = new AccountIndustries();"><span class="lineCounter-0-0-15">9</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AccountIndustries</span> <span class="token class-name">Instance</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountIndustries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="  public String AGRICULTURE { get { return this.getValue('Agriculture'); }}"><span class="lineCounter-0-0-15">11</span>  <span class="token keyword">public</span> <span class="token class-name">String</span> AGRICULTURE <span class="token punctuation">{</span> get <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">'Agriculture'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  public String APPAREL { get { return this.getValue('Apparel'); }}"><span class="lineCounter-0-0-15">12</span>  <span class="token keyword">public</span> <span class="token class-name">String</span> APPAREL <span class="token punctuation">{</span> get <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">'Apparel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  //etc, adding constants as is necessary to"><span class="lineCounter-0-0-15">13</span>  <span class="token comment">//etc, adding constants as is necessary to</span></div><br><div class="line-0-0-16 " data-content="  //represent your picklists values in code"><span class="lineCounter-0-0-15">14</span>  <span class="token comment">//represent your picklists values in code</span></div><br><div class="line-0-0-16 " data-content="  //with minimal usage of &quot;magic&quot; strings"><span class="lineCounter-0-0-15 prim">15</span>  <span class="token comment">//with minimal usage of "magic" strings</span></div><br><div class="line-0-0-16 " data-content="  //and the added benefit of intellisense"><span class="lineCounter-0-0-15">16</span>  <span class="token comment">//and the added benefit of intellisense</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">17</span><span class="token punctuation">}</span></div><br></code></pre><p>Running the tests again:</p><table><thead><th>TEST NAME</th><th>OUTCOME</th><th>RUNTIME (MS)</th></thead><tbody><tr><td>SingletonStressTests.itShouldEstablishABaselineIterationTime</td><td>Pass</td><td>23</td></tr><tr><td>SingletonStressTests.itShouldUseIdiomaticSingleton</td><td>Pass</td><td>98</td></tr><tr><td>SingletonStressTests.itShouldUseNewSingleton</td><td>Pass</td><td>90</td></tr></tbody></table><p>Easy peasy. I ran the tests dozens of times -- for whatever reason, the newer method was always a few milliseconds faster than simply caching the instance. One can only surmise that there exists some fairly interesting tail-end optimizations in how the compiler assembles the <code>Type.newInstance</code> code which gives it a slight edge over the use of the <code>new</code> keyword.</p><h2 id="singleton-pattern-conclusion" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Singleton Pattern Conclusion</h2><p>Lessons learned in building a better singleton:</p><ul><li>you can have your object-oriented cake and eat it too</li><li>usage of the <code>final</code> keyword should be considered the idiomatic method for instantiating singletons</li></ul><p>One thing that should be noted with the usage of <code>Type.newInstance()</code> -- it requires the usage of a <em>public</em> zero-argument constructor. That shouldn't come as a surprise for those of you following along from the <a href="/joys-of-apex/dependency-injection-factory-pattern">Factory</a> post. It <em>does</em> however, fly in the face of the more classic singleton pattern (which makes the constructor private in order to force invocation through the public static variable). That's definitely something to consider when making your object design choices. The limitations of the <code>Type</code> class in Apex have frequently proven less-than-ideal in testing, as well, since it requires elevating test classes to public that shouldn't have to have elevated visibility. As always, food for thought.</p><p>I hope that this post proved educational for you. The usage of singletons is fairly common, and knowing that you have some tricks up your sleeve when you need to implement one is always a good thing. Till next time!</p><div class="contentnav-0-0-7" data-no-search=""><a href="#singleton-pattern-conclusion" class="h2" data-content-highlight="singleton-pattern-conclusion">Singleton Pattern Conclusion</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="tdYdtuAlFt">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("tdYdtuAlFt", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="bIUpfrvsFL">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("bIUpfrvsFL", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="gr_zOPqbBR">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("gr_zOPqbBR", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>