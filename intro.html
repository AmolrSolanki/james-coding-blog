<!DOCTYPE html><html><head><title>Joys Of Apex | Introduction &amp; Testing Philosophy</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons%7CMaterial+Icons+Outlined&amp;display=swap" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Introduction &amp; Testing Philosophy"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Introduction &amp; Testing Philosophy"><meta name="keywords" content=""><meta property="blog-tags" content=""></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"intro.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Introduction &amp; Testing Philosophy</p></span></h1><script id="kCS_fUPbeI">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("kCS_fUPbeI", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2019-12-27T15:00:00.000Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>Whether you're a seasoned Salesforce.com vet or somebody just getting into Apex development, it's my hope that this instructional series will prove fruitful for you. But a little background, first — I've been developing on the Salesforce.com (SFDC) ecosystem for more than 5 years, and in that time I went from working on an enormous project, with tens of millions of accounts, to a greenfield project that gradually expanded, to consulting for a variety of small to medium-sized companies.</p><p>Developing Salesforce's Apex code — itself, an interesting subset of Java — leads to many fun and interesting design decisions. Java is not the tersest programming language in the world, and while Apex does offer some extremely helpful shortcuts, it doesn't support lambda functions, and you'll need to jump through hoops to do any kind of "functions as first class citizens" argument passing, as well. With that being said, what Apex <em>does</em> offer:</p><ul><li>built in unit testing capabilities</li><li>built in DML (Data Manipulation Language) capabilities</li><li>hundreds of Salesforce helper functions</li><li><strong>required</strong> code coverage to deploy</li></ul><p>Take a look at that last bullet point: <strong>required code coverage</strong>. This is one of the hallmark characteristics of doing great development on the SFDC platform - writing strict unit tests that ensure your code is doing exactly what the business expects it to do. Indeed, because code coverage of over 75% is required in order to do production level deploys, Salesforce implicitly (and explicitly in its Trailhead articles) encourages Test Driven Development (or TDD).</p><h2 id="what-is-test-driven-development" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>What is Test Driven Development?</h2><p>Test Driven Development means, simply, that you don't write production level code till you have written a failing test asserting the behavior that you'd like to have happen.</p><p>A simple example might be structured like a user story:</p><blockquote><p>As a person in X department, I expect that when I save a phone number to an account, the phone number will be formatted.</p></blockquote><p>In Apex, that might look something like:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="//in a test file annotated with @isTest at the top:" id="code1-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//in a test file annotated with @isTest at the top:</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Account newAccount = new Account(Phone = '1234567890');" id="code1-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Account</span> newAccount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Phone</span> <span class="token operator">=</span> <span class="token string">'1234567890'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="insert newAccount;" id="code1-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>insert newAccount<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code1-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="//change the reference for the Account by re-querying for it to observe" id="code1-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//change the reference for the Account by re-querying for it to observe</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="//whether or not the phone number has changed" id="code1-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//whether or not the phone number has changed</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="//System.assertEquals(expected, actual) is one of many helper functions provided by SFDC" id="code1-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//System.assertEquals(expected, actual) is one of many helper functions provided by SFDC</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="newAccount = [SELECT Phone FROM Account WHERE Id = :newAccount.Id];" id="code1-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>newAccount <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Phone</span> FROM <span class="token class-name">Account</span> WHERE <span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token operator">:</span><span class="token class-name"><span class="token namespace">newAccount<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.assertEquals('123-456-7890', newAccount.Phone);" id="code1-l9"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'123-456-7890'</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">newAccount<span class="token punctuation">.</span></span>Phone</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>Without any custom code, this test will fail. That's great! Failure is your starting point in TDD - and I think that's really quite powerful. We don't start successful - we achieve success by building our way there. TDD is not just a software development philosophy, but a way to approach life humbly.</p><p>To close the example, an EXTREMELY simple and totally jury-rigged way of getting your test to pass:</p><pre class="with-bar"><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span>classes/AccountHandler.cls</span></span><div class="line-0-0-18  -codedoc-code-line" data-content="//assuming you have a trigger written for Account" id="code2-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//assuming you have a trigger written for Account</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="//(more on that later) that references this code:" id="code2-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//(more on that later) that references this code:</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="public void beforeInsert(List<SObject> newRecords) {" id="code2-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeInsert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> newRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    List<Account> newAccounts = (List<Account>) newRecords;" id="code2-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> newAccounts <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> newRecords<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //...processing code here" id="code2-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//...processing code here</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.formatPhoneNumbers(newAccounts);" id="code2-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatPhoneNumbers</span><span class="token punctuation">(</span>newAccounts<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code2-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private void formatPhoneNumbers(List<Account> newAccounts) {" id="code2-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">formatPhoneNumbers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> newAccounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //regex patterns are supported in Apex, but they are cast to strings" id="code2-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//regex patterns are supported in Apex, but they are cast to strings</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    String nonDigits = '[^0-9]';" id="code2-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">String</span> nonDigits <span class="token operator">=</span> <span class="token string">'[^0-9]'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    for(Account account : newAccounts) {" id="code2-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Account</span> account <span class="token operator">:</span> newAccounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        if(String.isNotBlank(account.Phone)) {" id="code2-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">account<span class="token punctuation">.</span></span>Phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="            String onlyDigits = account.Phone.replace(nonDigits, '');" id="code2-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token class-name">String</span> onlyDigits <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">account<span class="token punctuation">.</span></span>Phone</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>nonDigits<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="            if(onlyDigits.length() == 10) {" id="code2-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token keyword">if</span><span class="token punctuation">(</span>onlyDigits<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="                account.Phone = '(' + onlyDigits.substring(0, 3) + ') '" id="code2-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token class-name"><span class="token namespace">account<span class="token punctuation">.</span></span>Phone</span> <span class="token operator">=</span> <span class="token string">'('</span> <span class="token operator">+</span> onlyDigits<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">') '</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="                    + onlyDigits.substring(3, 6) + '-'" id="code2-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                    <span class="token operator">+</span> onlyDigits<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-'</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="                    + onlyDigits.substring(6);" id="code2-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                    <span class="token operator">+</span> onlyDigits<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="            } else if (onlyDigits.length() == 11 &amp;&amp; onlyDigits.substring(0, 1) == '1') {" id="code2-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>onlyDigits<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">11</span> <span class="token operator">&amp;&amp;</span> onlyDigits<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="                account.Phone = + onlyDigits.substring(1, 4) + ') '" id="code2-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token class-name"><span class="token namespace">account<span class="token punctuation">.</span></span>Phone</span> <span class="token operator">=</span> <span class="token operator">+</span> onlyDigits<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">') '</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="                    + onlyDigits.substring(4, 7) + '-'" id="code2-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                    <span class="token operator">+</span> onlyDigits<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-'</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="                    + onlyDigits.substring(7, 11);" id="code2-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                    <span class="token operator">+</span> onlyDigits<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="            }" id="code2-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        }" id="code2-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code2-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code2-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l28"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br></code></pre><p>Remember: this is fast and dirty. I don't recommend deeply nested if statements in Apex, this code doesn't address obvious discrepancies (like the one presented by our test!) in terms of dealing with fake numbers, but despite the example's contrivance, you can well imagine how quickly a code base can become entangled in the pursuit of testing excellence if things start to look like this.</p><hr><h2 id="writing-great-tests" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Writing great tests</h2><p>Writing great tests is not only the hallmark of a succesful Salesforce project, it's satisfying in the extreme. The principles I'm going to teach you can be applied to improve the code quality of an existing codebase, quality of life for you or your developers, and the speed with which a new project gets off the ground. I mention quality of life, in particular, because retaining good talent is one of the principle challenges employers deal with, and nothing impacts the velocity of a project quicker than unhappy or unmotivated developers. A clean code base in Apex exhibits several characteristics which make working in it fun:</p><ul><li>small functions with easily testable inputs and outputs</li><li>fast tests - the quicker the turnaround time on test execution, the quicker devs can iterate</li><li>a good balance between abstraction and implementation</li></ul><p>A good example of how to balance abstraction and implementation is when writing tests: "Don't Repeat Yourself" (DRY) is a motto oft-uttered by developers, but it can be taken to an extreme. When writing Apex unit tests, in particular, it's easy to abstract away the setup of all your Salesforce objects (or SObjects) into helper functions, which can then take a variety of arguments to properly customize how the test is setup. In a code base where you are often making changes to the same few files, good helper functions for SObject creation are essential - but it's easy to take them too far. Don't fall into the trap of making the tests themselves unreadable by abstracting away so much of the essence of the test that, when new functionality is introduced and old tests break, make debugging the tests into a nightmare.</p><h3 id="writing-fast-apex-unit-tests" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Writing FAST Apex Unit Tests</h3><p>The first SFDC project I worked on turned into a nightmare. It's a familiar story: a greenfield project got the go ahead, without a hard deadline, to sunset a legacy CRM system. This is Salesforce's bread and butter, eating into homegrown CRM nightmares and Oracle's marketshare alike by offering out of the box alternatives with easy setup. But then the user requirement gathering begins, the backlog begins to grow, and the team starts to struggle to continue to produce quality code given a deadline that suddenly materializes halfway through the project's beginnings. As new functionality is introduced at breakneck speed, existing unit tests start breaking. Small disruptions to forward progress turn into half-day headscratchers as the team tries to fix the broken tests. Things start getting commented out - after all, code coverage is high enough elsewhere to allow the deploys to continue. Code quality starts to suffer, with confusing conditonals and feature-flagged additions piling on.</p><p>The breaking point at my first job came when the flaky tests started ruining deployments that had gone from minutes to hours. There's nothing more heartbreaking than failing to deploy after watching the tests run for a few hours due to a flaky test. I walked away from that job confused and more than a little heartbroken - I'd poured more than two years of my life into a system that barely worked. What had gone wrong?</p><hr><p>As I said, TDD starts with you failing. I recognized that my previous team's biggest issue boiled down to how long it took to deploy - and how long it took for our tests to run. Much of the lag time for running the tests was occurring because our custom objects were so branched from the standard Salesforce SObjects that it took many database inserts and updates in order to get objects into a workable state for our tests. It got me to wondering ... <em>how could I structure the tests on my next project so that our test time never suffered? Was such a thing possible?</em></p><p>There were four problems with my first SFDC project:</p><ul><li>Tests took a long time to setup</li><li>The database operations took a long time to process</li><li>Flaky tests meant that deployments could fail arbitrarily</li><li>Changes to objects often meant updating SOQL statements in dozens of locations</li></ul><p>I decided to tackle the process of fixing the test time first. I was on a new project and sold my team the notion that our test time was going to be critical to ensure we could continually deliver. I went back to the drawing board with a friend of mine, Jonathan Gillespie, and we began to envision a way to mock the SFDC database in tests. The results were eye-popping! A properly setup environment - which took only a bit of boilerplate - could properly serve up production-ready code while allowing for objects to be easily mocked in our tests.</p><p>In order to simulate high testing loads produced by hundreds of tests running in parallel, we simulated the effects of the old tests by copying some simple tests with many updates (for example, properly setting up some OpportunityContactRole objects ...). Without a mocked database layer, these copied tests took about 45 minutes to run properly.</p><p>With the mocking framework in place, test times were reduced to mere minutes.</p><h3 id="how-we-did-it" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>How we did it</h3><p>How did we get such a drastic reduction in test time? We found all the instances where DML statements like:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="insert newAccounts;" id="code3-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>insert newAccounts<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="update newAccounts;" id="code3-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>update newAccounts<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Database.upsert(newLeads);" id="code3-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">upsert</span><span class="token punctuation">(</span>newLeads<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Database.delete(contacts);" id="code3-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>contacts<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="//and the most heinous statement of all:" id="code3-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//and the most heinous statement of all:</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Database.convertLead(lead);" id="code3-l6"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">convertLead</span><span class="token punctuation">(</span>lead<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>Were used, and we replaced them with statements like this (more on this in the <a href="/joys-of-apex/mocking-dml">Mocking DML</a> post):</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="//in practice, these aren't static classes" id="code4-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//in practice, these aren't static classes</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="//objects requiring DML have a Crud / LeadConverter" id="code4-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//objects requiring DML have a Crud / LeadConverter</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="//passed to them" id="code4-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//passed to them</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code4-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="//insert / update / delete / convert are reserved words in Apex:" id="code4-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//insert / update / delete / convert are reserved words in Apex:</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Crud.doInsert(newAccounts);" id="code4-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Crud</span><span class="token punctuation">.</span><span class="token function">doInsert</span><span class="token punctuation">(</span>newAccounts<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Crud.doUpdate(newAccounts);" id="code4-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Crud</span><span class="token punctuation">.</span><span class="token function">doUpdate</span><span class="token punctuation">(</span>newAccounts<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Crud.doUpsert(newLeads);" id="code4-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Crud</span><span class="token punctuation">.</span><span class="token function">doUpsert</span><span class="token punctuation">(</span>newLeads<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Crud.doDelete(contact);" id="code4-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Crud</span><span class="token punctuation">.</span><span class="token function">doDelete</span><span class="token punctuation">(</span>contact<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="LeadConverter.convertLead(lead);" id="code4-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">LeadConverter</span><span class="token punctuation">.</span><span class="token function">convertLead</span><span class="token punctuation">(</span>lead<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>We also replaced all raw SOQL statements with an object, <a href="/joys-of-apex/repository-pattern"><code>Repository</code></a> that handles all database queries, is easily extended per object, and is easily replaced in tests through its interface. But I'm getting a bit ahead of myself. For now I'll wrap this up.</p><h2 id="make-apex-unit-testing-a-joy" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Make Apex Unit Testing a Joy</h2><p>TDD can either make or break a Salesforce project. Practicing it correctly - and using a testing framework that enforces good traditions and speedy tests - is paramount. I plan to cover in the coming months more info on how to set yourself up for success by explaining my testing framework through detailed code excerpts and fun examples.</p><p>If you enjoyed this introduction to the Joys of Apex, I'd <a href="mailto: james@sheandjim.com">love to hear from you]</a>, even a one-line note. Many thanks if you made it this far!</p><p>The original version of <a href="https://www.jamessimone.net/blog/joys-of-apex/intro/">The Joys Of Apex: Intro can be read on my blog.</a></p><div class="contentnav-0-0-7" data-no-search=""><a href="#what-is-test-driven-development" class="h2" data-content-highlight="what-is-test-driven-development">What is Test Driven Development?</a><a href="#writing-great-tests" class="h2" data-content-highlight="writing-great-tests">Writing great tests</a><a href="#writing-fast-apex-unit-tests" class="h3" data-content-highlight="writing-fast-apex-unit-tests">Writing FAST Apex Unit Tests</a><a href="#how-we-did-it" class="h3" data-content-highlight="how-we-did-it">How we did it</a><a href="#make-apex-unit-testing-a-joy" class="h2" data-content-highlight="make-apex-unit-testing-a-joy">Make Apex Unit Testing a Joy</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/formula-date-issues">Formula Date Issues</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/lwc-custom-path">LWC Custom Lead Path</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/refactoring-tips-and-tricks">Refactoring Tips &amp; Tricks</a>
<a href="/joys-of-apex/replacing-dlrs-with-custom-rollup">Replacing DLRS With Custom Rollup</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/set-timeout-and-implementing-delays">setTimeout &amp; Implementing Delays</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/testing-custom-permissions">Testing Custom Permissions</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="w_VlHxfWpl">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("w_VlHxfWpl", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="asnnxGQdnH">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("asnnxGQdnH", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="KLCfXUzKXU">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("KLCfXUzKXU", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>