<!DOCTYPE html><html><head><title>Joys Of Apex | The Repository Pattern</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | The Repository Pattern"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | The Repository Pattern"></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"repository-pattern.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>The Repository Pattern</p></span></h1><script id="spcPcTxyHd">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("spcPcTxyHd", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2020-01-11T15:12:03.284Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>Welcome back to <a href="/joys-of-apex/">The Joys Of Apex</a>. We've covered some fun ground with <a href="/joys-of-apex/mocking-dml">Mocking DML</a>, but now it's time to take your use of mocks in Apex to the next level. The end goal is to provide you with options when it comes to creating a system structure that allows you to easily get data where you need it and update that data easily in your tests. You can opt-in to this strategy if it works for you and makes sense.</p><p>I say that precisely because one of the reasons that Apex is so great is that the typical hoops you have to jump through in order to interact with a database within an object-oriented programming language have been abstracted away for you, and the existing SOQL (Salesforce Object Query Language) implementation allows for some <em>really</em> powerful things within your codebase. Typically, SOQL usage looks something like this:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="List<Account> accounts = [SELECT Id, Name FROM Account WHERE Name = 'Acme'];"><span class="lineCounter-0-0-15 prim">1</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Name</span> FROM <span class="token class-name">Account</span> WHERE <span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'Acme'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br></code></pre><p>As somebody who also does quite of bit of .net programming, the sheer simplicity of interacting with the database within Apex is refreshing, to say the least. The fact that you can escape out from Apex to inject variables like lists of Salesforce Ids or lists of strings that serve as further filtering criteria is incredible. I'm advising you to not use these features. That's pretty ... polarizing ... within the SFDC community, and I can understand if you don't want to follow me down this road.</p><h2 id="the-problem-with-soql-usage-in-large-codebases" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>The Problem With SOQL Usage In Large Codebases</h2><p>There are two problems with utilizing SOQL like the above example:</p><ul><li>any time your query refers to a field or fields which are changing / being deleted, you now have to update all references to that field prior to proceeding any further. This sounds trivial -- and it should be -- but you have to keep in mind that it's extremely difficult to deprecate fields in a codebase if you don't also control all the Flows, Process Builders, formulas, etc ...</li><li>you're constantly going to be writing queries, and if you're having to constantly do something like create Opportunity Line Items just in order to get test data prepared, you're quickly going to find out that the more DML and querying that you do in your Apex tests to mirror your production level code, the more time your tests are going to take</li></ul><p>But how do we break out from this situation? How do we work towards a place where the tests can easily replicate the expected system data without having to essentially code for two different purposes -- one for testing, and one for the production code? As an example of a method that isn't scalable, here's one possible approach:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="//using the Selector pattern ..."><span class="lineCounter-0-0-15 prim">1</span><span class="token comment">//using the Selector pattern ...</span></div><br><div class="line-0-0-16 " data-content="public virtual class OpportunityLineItemRepo {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">public</span> virtual <span class="token keyword">class</span> <span class="token class-name">OpportunityLineItemRepo</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public virtual List<OpportunityLineItem> getLineItems(Set<Id> oppIds) {"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">public</span> virtual <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLineItems</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span> oppIds<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return ["><span class="lineCounter-0-0-15">4</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span></div><br><div class="line-0-0-16 " data-content="            SELECT Id, Description"><span class="lineCounter-0-0-15 prim">5</span>            SELECT <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Description</span></div><br><div class="line-0-0-16 " data-content="            FROM OpportunityLineItem"><span class="lineCounter-0-0-15">6</span>            FROM <span class="token class-name">OpportunityLineItem</span></div><br><div class="line-0-0-16 " data-content="            WHERE OpportunityId = :oppIds"><span class="lineCounter-0-0-15">7</span>            WHERE <span class="token class-name">OpportunityId</span> <span class="token operator">=</span> <span class="token operator">:</span>oppIds</div><br><div class="line-0-0-16 " data-content="        ];"><span class="lineCounter-0-0-15">8</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">9</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">10</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">11</span></div><br><div class="line-0-0-16 " data-content="//the usage"><span class="lineCounter-0-0-15">12</span><span class="token comment">//the usage</span></div><br><div class="line-0-0-16 " data-content="public class OpportunityUpdater {"><span class="lineCounter-0-0-15">13</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpportunityUpdater</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final OpportunityLineItemRepo oppLineItemRepo;"><span class="lineCounter-0-0-15">14</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OpportunityLineItemRepo</span> oppLineItemRepo<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">15</span></div><br><div class="line-0-0-16 " data-content="    public OpportunityUpdater(OpportunityLineItemRepo oppLineItemRepo) {"><span class="lineCounter-0-0-15">16</span>    <span class="token keyword">public</span> <span class="token class-name">OpportunityUpdater</span><span class="token punctuation">(</span><span class="token class-name">OpportunityLineItemRepo</span> oppLineItemRepo<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.oppLineItemRepo = oppLineItemRepo;"><span class="lineCounter-0-0-15">17</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>oppLineItemRepo <span class="token operator">=</span> oppLineItemRepo<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">18</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">19</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">20</span></div><br><div class="line-0-0-16 " data-content="//and then in your tests..."><span class="lineCounter-0-0-15">21</span><span class="token comment">//and then in your tests...</span></div><br><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15">22</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class OpportunityUpdater_Tests {"><span class="lineCounter-0-0-15">23</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">OpportunityUpdater_Tests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">24</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_update_opportunities_correctly() {"><span class="lineCounter-0-0-15 prim">25</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_update_opportunities_correctly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        //assuming we have all of these objects already initialized"><span class="lineCounter-0-0-15">26</span>        <span class="token comment">//assuming we have all of these objects already initialized</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">27</span></div><br><div class="line-0-0-16 " data-content="        //arrange"><span class="lineCounter-0-0-15">28</span>        <span class="token comment">//arrange</span></div><br><div class="line-0-0-16 " data-content="        List<Opportunity> opps = [SELECT Id, Description FROM Opportunity LIMIT 2];"><span class="lineCounter-0-0-15">29</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span> opps <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Description</span> FROM <span class="token class-name">Opportunity</span> LIMIT <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Opportunity firstOpp = opps[0];"><span class="lineCounter-0-0-15 prim">30</span>        <span class="token class-name">Opportunity</span> firstOpp <span class="token operator">=</span> opps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Opportunity secondOpp = opps[1];"><span class="lineCounter-0-0-15">31</span>        <span class="token class-name">Opportunity</span> secondOpp <span class="token operator">=</span> opps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">32</span></div><br><div class="line-0-0-16 " data-content="        List<OpportunityLineItem> lineItems = new List<OpportunityLineItem>{"><span class="lineCounter-0-0-15">33</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span> lineItems <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            new OpportunityLineItem("><span class="lineCounter-0-0-15">34</span>            <span class="token keyword">new</span> <span class="token class-name">OpportunityLineItem</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="                OpportunityId = firstOpp.Id,"><span class="lineCounter-0-0-15 prim">35</span>                <span class="token class-name">OpportunityId</span> <span class="token operator">=</span> firstOpp<span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="                Description = 'business logic criteria'"><span class="lineCounter-0-0-15">36</span>                <span class="token class-name">Description</span> <span class="token operator">=</span> <span class="token string">'business logic criteria'</span></div><br><div class="line-0-0-16 " data-content="            )"><span class="lineCounter-0-0-15">37</span>            <span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="        };"><span class="lineCounter-0-0-15">38</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">39</span></div><br><div class="line-0-0-16 " data-content="        //act"><span class="lineCounter-0-0-15 prim">40</span>        <span class="token comment">//act</span></div><br><div class="line-0-0-16 " data-content="        OppLineItemRepoMock mock = new OppLineItemRepoMock();"><span class="lineCounter-0-0-15">41</span>        <span class="token class-name">OppLineItemRepoMock</span> mock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OppLineItemRepoMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        mock.LineItems = lineItems;"><span class="lineCounter-0-0-15">42</span>        mock<span class="token punctuation">.</span><span class="token class-name">LineItems</span> <span class="token operator">=</span> lineItems<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        new OpportunityUpdater(mock).updateOppsOnClose(opps);"><span class="lineCounter-0-0-15">43</span>        <span class="token keyword">new</span> <span class="token class-name">OpportunityUpdater</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateOppsOnClose</span><span class="token punctuation">(</span>opps<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">44</span></div><br><div class="line-0-0-16 " data-content="        //assert"><span class="lineCounter-0-0-15 prim">45</span>        <span class="token comment">//assert</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals('Magic Business String', firstOpp.Description);"><span class="lineCounter-0-0-15">46</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'Magic Business String'</span><span class="token punctuation">,</span> firstOpp<span class="token punctuation">.</span><span class="token class-name">Description</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        System.assertNotEquals('Magic Business String', secondOpp.Description);"><span class="lineCounter-0-0-15">47</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertNotEquals</span><span class="token punctuation">(</span><span class="token string">'Magic Business String'</span><span class="token punctuation">,</span> secondOpp<span class="token punctuation">.</span><span class="token class-name">Description</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">48</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">49</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">50</span></div><br><div class="line-0-0-16 " data-content="    private class OppLineItemRepoMock extends OpportunityLineItemRepo {"><span class="lineCounter-0-0-15">51</span>    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">OppLineItemRepoMock</span> <span class="token keyword">extends</span> <span class="token class-name">OpportunityLineItemRepo</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        public List<OpportunityLineItem> LineItems { get; set; }"><span class="lineCounter-0-0-15">52</span>        <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">LineItems</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">53</span></div><br><div class="line-0-0-16 " data-content="        public override List<OpportunityLineItem> getLineItems(Set<Id> oppIds) {"><span class="lineCounter-0-0-15">54</span>        <span class="token keyword">public</span> override <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLineItems</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span> oppIds<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            return LineItems;"><span class="lineCounter-0-0-15 prim">55</span>            <span class="token keyword">return</span> <span class="token class-name">LineItems</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">56</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">57</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">58</span><span class="token punctuation">}</span></div><br></code></pre><p>OK, yikes. That was a lot of code just to prove a point -- namely that going this route (which builds to the Selector pattern, where all your queries are encapsulated by methods that can then be overridden) is unsustainable. You'll need to mock every method that leads to a SOQL query; you'll need many different methods to add different filtering criteria. The Selector pattern requires a different method for each query you require, and if you'd like to override your selector methods, you're going to have your work cut out for you.</p><h2 id="implementing-the-repository-pattern-in-apex" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Implementing the Repository Pattern in Apex</h2><p>Correctly implementing the Repository pattern means that you only need <em>one</em> seam, or spot where your tests do something differently from your production level code. But let's do it in true TDD style -- starting with the tests. We can even start from the same code we already have. Let's assume that over time, in a completely different section of the codebase, we're faced with a request to fetch OpportunityLineItems in order to verify that the correct Order has been created for a customer on a daily basis. If the Order needs to be updated, we want to update the existing Opportunity as well. Management will use the Description field on the Opportunity to filter on (for the purposes of this example, trying to stick to the simplest included fields possible), as they want to keep track of how often the Sales team is incorrectly keying things. This is going to lead to a potential regression in the existing code, as well as balloon the production code to deal with both scenarios. That won't be initially obvious to the team making these changes, though ...</p><p>I normally don't operate this far "down' the Salesforce sales pipeline when doing examples, because most of the "top" part of the funnel is shared between almost all SFDC orgs; whether you're using Person Accounts (sorry), or classic B2B, odds are strong that you use Opportunities, Leads, Accounts, and Contacts (and for Person Accounts, you can imagine that the Contact examples are just the corresponding fields on Person Accounts). For this example, though, I want to show that as a business expands, its business logic oftentimes leads to existing Salesforce objects being accessed in completely different ways. In order to prevent linear code growth -- and the corresponding increase in complexity and understanding that comes with that -- we want to be able to recognize commonalities shared by differing business needs.</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/OrderUpdater.cls</span></span><div class="line-0-0-16 " data-content="public class OrderUpdater {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderUpdater</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final OpportunityLineItemRepo oppLineItemRepo;"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OpportunityLineItemRepo</span> oppLineItemRepo<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="    public OrderUpdater(OpportuniyLineItemRepo oppLineItemRepo) {"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">public</span> <span class="token class-name">OrderUpdater</span><span class="token punctuation">(</span><span class="token class-name">OpportuniyLineItemRepo</span> oppLineItemRepo<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.oppLineItemRepo = oppLineItemRepo;"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>oppLineItemRepo <span class="token operator">=</span> oppLineItemRepo<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">6</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="    public void checkOrders(List<Order> orders) {"><span class="lineCounter-0-0-15">8</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkOrders</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Map<Id, List<Order>> accountIdToOrder = new Map<Id, List<Order>>();"><span class="lineCounter-0-0-15">9</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> accountIdToOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        for(Order order : orders) {"><span class="lineCounter-0-0-15 prim">10</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order <span class="token operator">:</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            if(accountIdToOrder.containsKey(order.AccountId)) {"><span class="lineCounter-0-0-15">11</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>accountIdToOrder<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token class-name">AccountId</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                List<Order> accountOrders = accountIdToOrder.get(order.AccountId);"><span class="lineCounter-0-0-15">12</span>                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> accountOrders <span class="token operator">=</span> accountIdToOrder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token class-name">AccountId</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="                accountOrders.add(order);"><span class="lineCounter-0-0-15">13</span>                accountOrders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            } else {"><span class="lineCounter-0-0-15">14</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                accountIdToOrder.put(order.AccountId, new List<Order>{ order });"><span class="lineCounter-0-0-15 prim">15</span>                accountIdToOrder<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token class-name">AccountId</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> order <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">16</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">17</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        //for now we use the raw SOQL"><span class="lineCounter-0-0-15">18</span>        <span class="token comment">//for now we use the raw SOQL</span></div><br><div class="line-0-0-16 " data-content="        //it's the TDD way!"><span class="lineCounter-0-0-15">19</span>        <span class="token comment">//it's the TDD way!</span></div><br><div class="line-0-0-16 " data-content="        List<Opportunity> associatedOpps = ["><span class="lineCounter-0-0-15 prim">20</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span> associatedOpps <span class="token operator">=</span> <span class="token punctuation">[</span></div><br><div class="line-0-0-16 " data-content="            SELECT Id, Description"><span class="lineCounter-0-0-15">21</span>            SELECT <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Description</span></div><br><div class="line-0-0-16 " data-content="            FROM Opportunity"><span class="lineCounter-0-0-15">22</span>            FROM <span class="token class-name">Opportunity</span></div><br><div class="line-0-0-16 " data-content="            WHERE IsWon = true"><span class="lineCounter-0-0-15">23</span>            WHERE <span class="token class-name">IsWon</span> <span class="token operator">=</span> <span class="token boolean">true</span></div><br><div class="line-0-0-16 " data-content="            AND AccountId = :accountIdToOrder.keySet()"><span class="lineCounter-0-0-15">24</span>            AND <span class="token class-name">AccountId</span> <span class="token operator">=</span> <span class="token operator">:</span>accountIdToOrder<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="        ];"><span class="lineCounter-0-0-15 prim">25</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">26</span></div><br><div class="line-0-0-16 " data-content="        Map<Id, Opportunity> oppIdToOpp = new Map<Id, Opportunity>(associatedOpps);"><span class="lineCounter-0-0-15">27</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span> oppIdToOpp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>associatedOpps<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">28</span></div><br><div class="line-0-0-16 " data-content="        List<OpportunityLineItem> lineItems = this.oppLineItemRepo.getLineItems(oppIdToOpp.keySet());"><span class="lineCounter-0-0-15">29</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span> lineItems <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>oppLineItemRepo<span class="token punctuation">.</span><span class="token function">getLineItems</span><span class="token punctuation">(</span>oppIdToOpp<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        for(OpportunityLineItem lineItem : lineItems) {"><span class="lineCounter-0-0-15 prim">30</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">OpportunityLineItem</span> lineItem <span class="token operator">:</span> lineItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            if(lineItem.Description == 'order related business logic criteria') {"><span class="lineCounter-0-0-15">31</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>lineItem<span class="token punctuation">.</span><span class="token class-name">Description</span> <span class="token operator">==</span> <span class="token string">'order related business logic criteria'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                Opportunity opp = oppIdToOpp.get(lineItem.OpportunityId);"><span class="lineCounter-0-0-15">32</span>                <span class="token class-name">Opportunity</span> opp <span class="token operator">=</span> oppIdToOpp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>lineItem<span class="token punctuation">.</span><span class="token class-name">OpportunityId</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="                opp.Description = 'Order Error';"><span class="lineCounter-0-0-15">33</span>                opp<span class="token punctuation">.</span><span class="token class-name">Description</span> <span class="token operator">=</span> <span class="token string">'Order Error'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">34</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15 prim">35</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        //etc, imagine we update the corresponding order"><span class="lineCounter-0-0-15">36</span>        <span class="token comment">//etc, imagine we update the corresponding order</span></div><br><div class="line-0-0-16 " data-content="        //now that we know something's wrong ..."><span class="lineCounter-0-0-15">37</span>        <span class="token comment">//now that we know something's wrong ...</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">38</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">39</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">40</span></div><br><div class="line-0-0-16 " data-content="//and in your test class ..."><span class="lineCounter-0-0-15">41</span><span class="token comment">//and in your test class ...</span></div><br><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15">42</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class OrderUpdater_Tests {"><span class="lineCounter-0-0-15">43</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">OrderUpdater_Tests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">44</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_identify_correct_orders_based_on_opportunity_line_items() {"><span class="lineCounter-0-0-15 prim">45</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_identify_correct_orders_based_on_opportunity_line_items</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        //assuming things are already setup"><span class="lineCounter-0-0-15">46</span>        <span class="token comment">//assuming things are already setup</span></div><br><div class="line-0-0-16 " data-content="        //arrange"><span class="lineCounter-0-0-15">47</span>        <span class="token comment">//arrange</span></div><br><div class="line-0-0-16 " data-content="        Order order = [SELECT Id, AccountId FROM Order LIMIT 1];"><span class="lineCounter-0-0-15">48</span>        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">AccountId</span> FROM <span class="token class-name">Order</span> LIMIT <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Order.Description = 'Original';"><span class="lineCounter-0-0-15">49</span>        <span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token class-name">Description</span> <span class="token operator">=</span> <span class="token string">'Original'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">50</span></div><br><div class="line-0-0-16 " data-content="        List<OpportunityLineItem> lineItems = new List<OpportunityLineItem>{"><span class="lineCounter-0-0-15">51</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span> lineItems <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            new OpportunityLineItem("><span class="lineCounter-0-0-15">52</span>            <span class="token keyword">new</span> <span class="token class-name">OpportunityLineItem</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="                OpportunityId = firstOpp.Id,"><span class="lineCounter-0-0-15">53</span>                <span class="token class-name">OpportunityId</span> <span class="token operator">=</span> firstOpp<span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="                Description = 'order related business logic criteria'"><span class="lineCounter-0-0-15">54</span>                <span class="token class-name">Description</span> <span class="token operator">=</span> <span class="token string">'order related business logic criteria'</span></div><br><div class="line-0-0-16 " data-content="            )"><span class="lineCounter-0-0-15 prim">55</span>            <span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="        };"><span class="lineCounter-0-0-15">56</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">57</span></div><br><div class="line-0-0-16 " data-content="        //act"><span class="lineCounter-0-0-15">58</span>        <span class="token comment">//act</span></div><br><div class="line-0-0-16 " data-content="        OppLineItemRepoMock mock = new OppLineItemRepoMock();"><span class="lineCounter-0-0-15">59</span>        <span class="token class-name">OppLineItemRepoMock</span> mock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OppLineItemRepoMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        mock.LineItems = lineItems;"><span class="lineCounter-0-0-15 prim">60</span>        mock<span class="token punctuation">.</span><span class="token class-name">LineItems</span> <span class="token operator">=</span> lineItems<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        new OrderUpdater(mock).checkOrders(new List<Order>{ order });"><span class="lineCounter-0-0-15">61</span>        <span class="token keyword">new</span> <span class="token class-name">OrderUpdater</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkOrders</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> order <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">62</span></div><br><div class="line-0-0-16 " data-content="        //assert"><span class="lineCounter-0-0-15">63</span>        <span class="token comment">//assert</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals('Our new status', order.Description);"><span class="lineCounter-0-0-15">64</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'Our new status'</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token class-name">Description</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">65</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">66</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">67</span></div><br><div class="line-0-0-16 " data-content="//uh oh! We need the mock again"><span class="lineCounter-0-0-15">68</span><span class="token comment">//uh oh! We need the mock again</span></div><br><div class="line-0-0-16 " data-content="//for now let's pretend"><span class="lineCounter-0-0-15">69</span><span class="token comment">//for now let's pretend</span></div><br><div class="line-0-0-16 " data-content="//we moved it to its own class"><span class="lineCounter-0-0-15 prim">70</span><span class="token comment">//we moved it to its own class</span></div><br><div class="line-0-0-16 " data-content="public class OppLineItemRepoMock extends OpportunityLineItemRepo {"><span class="lineCounter-0-0-15">71</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OppLineItemRepoMock</span> <span class="token keyword">extends</span> <span class="token class-name">OpportunityLineItemRepo</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public List<OpportunityLineItem> LineItems { get; set; }"><span class="lineCounter-0-0-15">72</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">LineItems</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">73</span></div><br><div class="line-0-0-16 " data-content="    public override List<OpportunityLineItem> getLineItems(Set<Id> oppIds) {"><span class="lineCounter-0-0-15">74</span>    <span class="token keyword">public</span> override <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLineItems</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span> oppIds<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return LineItems;"><span class="lineCounter-0-0-15 prim">75</span>        <span class="token keyword">return</span> <span class="token class-name">LineItems</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">76</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">77</span><span class="token punctuation">}</span></div><br></code></pre><p>Another complicated example, and very contrived. But I hope it helps to show a few things:</p><ol><li>We've introduced the need for another query; we're either going to have to introduce a new class or create a new selector method that's specific to this implementation (to filter for Closed Won opps, or to pull back the line items with the Opportunities as a child of the query). We're going to have to deal with a bunch of messy iterations in our code. Yes, we can hide the specifics by refactoring the inner body of verbose methods like <code>checkOrders</code>, but in the end, the cleanup is only going to add lines of code. As Salesforce developers, we iterate through lists, sets, and maps like crazy. Reducing the number of times we need to do that is going to help; making our database-fetching methods more controllable reduces some of the in-line iteration we need to perform to compare our objects.</li><li>We've introduced a subtle regression in the existing code; a regression that would likely only be detected by the astute manager or salesperson in production. Did you spot it? Now that the <code>OrderUpdater</code> is operating off of the same Description field as the <code>OpportunityUpdater</code>, the value for Description might get out of sync depending on which object fetches the Opportunities first.</li><li>We've had to move OppLineItemRepoMock out to its own class, and we've raised the visibility of the class as a result. One possible way around this is through sharing a Mock class:</li></ol><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/MockFactory.cls</span></span><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="public class MockFactory {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MockFactory</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="    public static OppLineItemRepoMock getLineItemMock() {"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">OppLineItemRepoMock</span> <span class="token function">getLineItemMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return new OppLineItemRepoMock();"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OppLineItemRepoMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">6</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="    private class OppLineItemRepoMock extends OpportunityLineItemRepo {"><span class="lineCounter-0-0-15">8</span>    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">OppLineItemRepoMock</span> <span class="token keyword">extends</span> <span class="token class-name">OpportunityLineItemRepo</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        //inners"><span class="lineCounter-0-0-15">9</span>        <span class="token comment">//inners</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">11</span><span class="token punctuation">}</span></div><br></code></pre><p>But that's only going to help if every test is calling the mock in the same way. If you needed to verify that a query was being made in a particular way on top of the fact that your expected line items were being returned, you're in for a world of refactoring hurt.</p><h3 id="composing-repository-queries" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Composing repository queries</h3><p>We're about to Kent Beck this whole thing. Indeed, this whole example was inspired by Kent Beck's famous "Money" example from <a href="https://www.smile.amazon.com/Test-Driven-Development-Kent-Beck/dp/0321146530">Test Driven Development By Example</a>. Let's start by creating a way to compose SOQL queries. We'd like for our repository to eventually be able to replicate the best of SOQL while remaining strongly typed; setting it up in such a way that no matter how many repositories are in use, there's only one per SObject <strong>and</strong> we only need to flip one switch in our tests in order to gain access to it. Here's a test showing my ideal syntax:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/Repository_Tests.cls</span></span><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class Repository_Tests {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Repository_Tests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">3</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_take_in_a_query() {"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_take_in_a_query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Query basicQuery = new Query(Opportunity.IsWon, Query.Operator.EQUALS, true);"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token class-name">Query</span> basicQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">IsWon</span><span class="token punctuation">,</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>EQUALS<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        IRepository repo = new Repository("><span class="lineCounter-0-0-15">6</span>        <span class="token class-name">IRepository</span> repo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="            Opportunity.SObjectType,"><span class="lineCounter-0-0-15">7</span>            <span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            new List<SObjectField>{"><span class="lineCounter-0-0-15">8</span>            <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                Opportunity.Id"><span class="lineCounter-0-0-15">9</span>                <span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">Id</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15 prim">10</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        );"><span class="lineCounter-0-0-15">11</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">12</span></div><br><div class="line-0-0-16 " data-content="        repo.get(basicQuery);"><span class="lineCounter-0-0-15">13</span>        repo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>basicQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(1, Limits.getQueries());"><span class="lineCounter-0-0-15">14</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Limits</span><span class="token punctuation">.</span><span class="token function">getQueries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">15</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">16</span><span class="token punctuation">}</span></div><br></code></pre><p>As is often the case with TDD, starting with a big problem (in even getting the code to compile), means you have to stub out quite a bit just to get the code to compile.</p><p>First we'll need a way to represent queries ... we want our Query object to be comparable to another query, to consume SObjectFields, and to properly represent a few special cases in SOQL queries:</p><ul><li>lists / sets of Ids or Strings</li><li>booleans</li><li>Entering Datetimes in SOQL sucks. Let's fix that.</li></ul><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class Query_Tests {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Query_Tests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">3</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_encapsulate_sobject_fields_and_values() {"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_encapsulate_sobject_fields_and_values</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Query basicQuery = new Query(Opportunity.IsWon, Query.Operator.EQUALS, true);"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token class-name">Query</span> basicQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">IsWon</span><span class="token punctuation">,</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>EQUALS<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">6</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals('IsWon = true', basicQuery.toString());"><span class="lineCounter-0-0-15">7</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'IsWon = true'</span><span class="token punctuation">,</span> basicQuery<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">8</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">9</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_equal_another_query_with_the_same_values() {"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_equal_another_query_with_the_same_values</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Query basicQuery = new Query(Opportunity.IsWon, Query.Operator.EQUALS, true);"><span class="lineCounter-0-0-15">12</span>        <span class="token class-name">Query</span> basicQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">IsWon</span><span class="token punctuation">,</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>EQUALS<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Query sameQuery = new Query(Opportunity.IsWon, Query.Operator.EQUALS, true);"><span class="lineCounter-0-0-15">13</span>        <span class="token class-name">Query</span> sameQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">IsWon</span><span class="token punctuation">,</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>EQUALS<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(basicQuery, sameQuery);"><span class="lineCounter-0-0-15">14</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>basicQuery<span class="token punctuation">,</span> sameQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">15</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">16</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">17</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_properly_render_datetimes_as_strings() {"><span class="lineCounter-0-0-15">18</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_properly_render_datetimes_as_strings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Datetime sevenDaysAgo = System.now().addDays(-7);"><span class="lineCounter-0-0-15">19</span>        <span class="token class-name">Datetime</span> sevenDaysAgo <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addDays</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Query basicQuery = new Query("><span class="lineCounter-0-0-15 prim">20</span>        <span class="token class-name">Query</span> basicQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="            Opportunity.CreatedDate,"><span class="lineCounter-0-0-15">21</span>            <span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">CreatedDate</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            Query.Operator.GREATER_THAN_OR_EQUAL,"><span class="lineCounter-0-0-15">22</span>            <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>GREATER_THAN_OR_EQUAL<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            sevenDaysAgo"><span class="lineCounter-0-0-15">23</span>            sevenDaysAgo</div><br><div class="line-0-0-16 " data-content="        );"><span class="lineCounter-0-0-15">24</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">25</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals("><span class="lineCounter-0-0-15">26</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="            'CreatedDate >= ' +"><span class="lineCounter-0-0-15">27</span>            <span class="token string">'CreatedDate &gt;= '</span> <span class="token operator">+</span></div><br><div class="line-0-0-16 " data-content="                sevenDaysAgo.format('yyyy-MM-dd\'T\'HH:mm:ss\'Z\'', 'Greenwich Mean Time'),"><span class="lineCounter-0-0-15">28</span>                sevenDaysAgo<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'yyyy-MM-dd\'T\'HH:mm:ss\'Z\''</span><span class="token punctuation">,</span> <span class="token string">'Greenwich Mean Time'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="             basicQuery.toString()"><span class="lineCounter-0-0-15">29</span>             basicQuery<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="        );"><span class="lineCounter-0-0-15 prim">30</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">31</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">32</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">33</span></div><br><div class="line-0-0-16 " data-content="//and then for the Repository ..."><span class="lineCounter-0-0-15">34</span><span class="token comment">//and then for the Repository ...</span></div><br><div class="line-0-0-16 " data-content="@isTest private class Repository_Tests {"><span class="lineCounter-0-0-15 prim">35</span><span class="token annotation punctuation">@isTest</span> <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Repository_Tests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">36</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_take_in_a_query() {"><span class="lineCounter-0-0-15">37</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_take_in_a_query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Query basicQuery = new Query(Opportunity.IsWon, Query.Operator.EQUALS, true);"><span class="lineCounter-0-0-15">38</span>        <span class="token class-name">Query</span> basicQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">IsWon</span><span class="token punctuation">,</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>EQUALS<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        IRepository repo = new Repository(Opportunity.SObjectType, new List<SObjectField>{"><span class="lineCounter-0-0-15">39</span>        <span class="token class-name">IRepository</span> repo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            Opportunity.Id"><span class="lineCounter-0-0-15 prim">40</span>            <span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">Id</span></div><br><div class="line-0-0-16 " data-content="        });"><span class="lineCounter-0-0-15">41</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">42</span></div><br><div class="line-0-0-16 " data-content="        repo.get(basicQuery);"><span class="lineCounter-0-0-15">43</span>        repo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>basicQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(1, Limits.getQueries());"><span class="lineCounter-0-0-15">44</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Limits</span><span class="token punctuation">.</span><span class="token function">getQueries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">45</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">46</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">47</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_handle_lists_and_sets_of_ids_or_strings() {"><span class="lineCounter-0-0-15">48</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_handle_lists_and_sets_of_ids_or_strings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Id accountId = TestingUtils.generateId(Account.SObjectType);"><span class="lineCounter-0-0-15">49</span>        <span class="token class-name">Id</span> accountId <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        List<Id> ids = new List<Id>{ accountId, accountId };"><span class="lineCounter-0-0-15 prim">50</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> accountId<span class="token punctuation">,</span> accountId <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Set<Id> setIds = new Set<Id>(ids);"><span class="lineCounter-0-0-15">51</span>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span> setIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Set<String> oppNames = new Set<String>{ 'Open', 'Closed' };"><span class="lineCounter-0-0-15">52</span>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> oppNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> <span class="token string">'Open'</span><span class="token punctuation">,</span> <span class="token string">'Closed'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">53</span></div><br><div class="line-0-0-16 " data-content="        Query listQuery = new Query(Opportunity.Id, Query.Operator.EQUALS, ids);"><span class="lineCounter-0-0-15">54</span>        <span class="token class-name">Query</span> listQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>EQUALS<span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Query setQuery = new Query(Opportunity.Id, Query.Operator.EQUALS, setIds);"><span class="lineCounter-0-0-15 prim">55</span>        <span class="token class-name">Query</span> setQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>EQUALS<span class="token punctuation">,</span> setIds<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Query setStringQuery = new Query(Opportunity.Name, Query.Operator.EQUALS, oppNames);"><span class="lineCounter-0-0-15">56</span>        <span class="token class-name">Query</span> setStringQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">Name</span><span class="token punctuation">,</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>EQUALS<span class="token punctuation">,</span> oppNames<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">57</span></div><br><div class="line-0-0-16 " data-content="        IRepository repo = new Repository(Opportunity.SObjectType, new List<SObjectField>{"><span class="lineCounter-0-0-15">58</span>        <span class="token class-name">IRepository</span> repo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            Opportunity.Id"><span class="lineCounter-0-0-15">59</span>            <span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">Id</span></div><br><div class="line-0-0-16 " data-content="        });"><span class="lineCounter-0-0-15 prim">60</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">61</span></div><br><div class="line-0-0-16 " data-content="        repo.get(listQuery);"><span class="lineCounter-0-0-15">62</span>        repo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>listQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        repo.get(setQuery);"><span class="lineCounter-0-0-15">63</span>        repo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>setQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        repo.get(setStringQuery);"><span class="lineCounter-0-0-15">64</span>        repo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>setStringQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(3, Limits.getQueries());"><span class="lineCounter-0-0-15 prim">65</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">Limits</span><span class="token punctuation">.</span><span class="token function">getQueries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        //we need to write a special assert for sets with multiple values"><span class="lineCounter-0-0-15">66</span>        <span class="token comment">//we need to write a special assert for sets with multiple values</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals('Name in (\'Closed\',\' Open\')', setStringQuery.toString());"><span class="lineCounter-0-0-15">67</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'Name in (\'Closed\',\' Open\')'</span><span class="token punctuation">,</span> setStringQuery<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">68</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">69</span><span class="token punctuation">}</span></div><br></code></pre><p>This is already going to be a long post. Kent Beck wrote "Test Driven Development By Example" in book format for a reason ... I'd love to hand-write out each iteration of the Query and Repository classes so that you can see how they develop, but we'll have to save that exercise for another time, and you'll be able to see the full code online at the end. I'll cut to the chase and show the rudimentary implementations:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/Query.cls</span></span><div class="line-0-0-16 " data-content="public class Query {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Query</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public enum Operator {"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Operator</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        EQUALS,"><span class="lineCounter-0-0-15">3</span>        EQUALS<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        NOT_EQUALS,"><span class="lineCounter-0-0-15">4</span>        NOT_EQUALS<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        LESS_THAN,"><span class="lineCounter-0-0-15 prim">5</span>        LESS_THAN<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        LESS_THAN_OR_EQUAL,"><span class="lineCounter-0-0-15">6</span>        LESS_THAN_OR_EQUAL<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        GREATER_THAN,"><span class="lineCounter-0-0-15">7</span>        GREATER_THAN<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        GREATER_THAN_OR_EQUAL"><span class="lineCounter-0-0-15">8</span>        GREATER_THAN_OR_EQUAL</div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">9</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="    private final SObjectField field;"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SObjectField</span> field<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private final Operator operator;"><span class="lineCounter-0-0-15">12</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Operator</span> operator<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private final List<Object> predicates;"><span class="lineCounter-0-0-15">13</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> predicates<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">14</span></div><br><div class="line-0-0-16 " data-content="    private static Boolean isSet = false;"><span class="lineCounter-0-0-15 prim">15</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Boolean</span> isSet <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">16</span></div><br><div class="line-0-0-16 " data-content="    public Query(SObjectField field, Operator operator, Object predicate) {"><span class="lineCounter-0-0-15">17</span>    <span class="token keyword">public</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">SObjectField</span> field<span class="token punctuation">,</span> <span class="token class-name">Operator</span> operator<span class="token punctuation">,</span> <span class="token class-name">Object</span> predicate<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this(field, operator, new List<Object>{ predicate });"><span class="lineCounter-0-0-15">18</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> operator<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> predicate <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">19</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">20</span></div><br><div class="line-0-0-16 " data-content="    public Query(SObjectField field, Operator operator, List<Object> predicates) {"><span class="lineCounter-0-0-15">21</span>    <span class="token keyword">public</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">SObjectField</span> field<span class="token punctuation">,</span> <span class="token class-name">Operator</span> operator<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> predicates<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.field = field;"><span class="lineCounter-0-0-15">22</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>field <span class="token operator">=</span> field<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.operator = operator;"><span class="lineCounter-0-0-15">23</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>operator <span class="token operator">=</span> operator<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.predicates = predicates;"><span class="lineCounter-0-0-15">24</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>predicates <span class="token operator">=</span> predicates<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">25</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">26</span></div><br><div class="line-0-0-16 " data-content="    public override String toString() {"><span class="lineCounter-0-0-15">27</span>    <span class="token keyword">public</span> override <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        String fieldName = this.field.getDescribe().getName();"><span class="lineCounter-0-0-15">28</span>        <span class="token class-name">String</span> fieldName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>field<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        String predName = this.getPredicate(this.predicates);"><span class="lineCounter-0-0-15">29</span>        <span class="token class-name">String</span> predName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>predicates<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return fieldName + ' ' + this.getOperator() + ' ' + predName;"><span class="lineCounter-0-0-15 prim">30</span>        <span class="token keyword">return</span> fieldName <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> predName<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">31</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">32</span></div><br><div class="line-0-0-16 " data-content="    public Boolean equals(Object thatObject) {"><span class="lineCounter-0-0-15">33</span>    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> thatObject<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        if(thatObject instanceof Query) {"><span class="lineCounter-0-0-15">34</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>thatObject <span class="token keyword">instanceof</span> <span class="token class-name">Query</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            Query that = (Query) thatObject;"><span class="lineCounter-0-0-15 prim">35</span>            <span class="token class-name">Query</span> that <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Query</span><span class="token punctuation">)</span> thatObject<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            return this.toString() == that.toString();"><span class="lineCounter-0-0-15">36</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> that<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">37</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">38</span></div><br><div class="line-0-0-16 " data-content="        return false;"><span class="lineCounter-0-0-15">39</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">40</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">41</span></div><br><div class="line-0-0-16 " data-content="    private String getOperator() {"><span class="lineCounter-0-0-15">42</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Boolean isList = this.predicates.size() > 1;"><span class="lineCounter-0-0-15">43</span>        <span class="token class-name">Boolean</span> isList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>predicates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        switch on this.operator {"><span class="lineCounter-0-0-15">44</span>        <span class="token keyword">switch</span> on <span class="token keyword">this</span><span class="token punctuation">.</span>operator <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            when EQUALS {"><span class="lineCounter-0-0-15 prim">45</span>            when EQUALS <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                return isList || isSet ? 'in' : '=';"><span class="lineCounter-0-0-15">46</span>                <span class="token keyword">return</span> isList <span class="token operator">||</span> isSet <span class="token operator">?</span> <span class="token string">'in'</span> <span class="token operator">:</span> <span class="token string">'='</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">47</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="            when NOT_EQUALS {"><span class="lineCounter-0-0-15">48</span>            when NOT_EQUALS <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                return isList || isSet ? 'not in' : '!=';"><span class="lineCounter-0-0-15">49</span>                <span class="token keyword">return</span> isList <span class="token operator">||</span> isSet <span class="token operator">?</span> <span class="token string">'not in'</span> <span class="token operator">:</span> <span class="token string">'!='</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15 prim">50</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="            when LESS_THAN {"><span class="lineCounter-0-0-15">51</span>            when LESS_THAN <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                return '<';"><span class="lineCounter-0-0-15">52</span>                <span class="token keyword">return</span> <span class="token string">'&lt;'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">53</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="            when LESS_THAN_OR_EQUAL {"><span class="lineCounter-0-0-15">54</span>            when LESS_THAN_OR_EQUAL <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                return '<=';"><span class="lineCounter-0-0-15 prim">55</span>                <span class="token keyword">return</span> <span class="token string">'&lt;='</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">56</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="            when GREATER_THAN {"><span class="lineCounter-0-0-15">57</span>            when GREATER_THAN <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                return '>';"><span class="lineCounter-0-0-15">58</span>                <span class="token keyword">return</span> <span class="token string">'&gt;'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">59</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="            when GREATER_THAN_OR_EQUAL {"><span class="lineCounter-0-0-15 prim">60</span>            when GREATER_THAN_OR_EQUAL <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                return '>=';"><span class="lineCounter-0-0-15">61</span>                <span class="token keyword">return</span> <span class="token string">'&gt;='</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">62</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="            when else {"><span class="lineCounter-0-0-15">63</span>            when <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                return null;"><span class="lineCounter-0-0-15">64</span>                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15 prim">65</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">66</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">67</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">68</span></div><br><div class="line-0-0-16 " data-content="    private String getPredicate(Object predicate) {"><span class="lineCounter-0-0-15">69</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token class-name">Object</span> predicate<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        if(predicate == null) {"><span class="lineCounter-0-0-15 prim">70</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>predicate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            return 'null';"><span class="lineCounter-0-0-15">71</span>            <span class="token keyword">return</span> <span class="token string">'null'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        } else if(predicate instanceof Datetime) {"><span class="lineCounter-0-0-15">72</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>predicate <span class="token keyword">instanceof</span> <span class="token class-name">Datetime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            //the most annoying one"><span class="lineCounter-0-0-15">73</span>            <span class="token comment">//the most annoying one</span></div><br><div class="line-0-0-16 " data-content="            Datetime dt = (Datetime) predicate;"><span class="lineCounter-0-0-15">74</span>            <span class="token class-name">Datetime</span> dt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Datetime</span><span class="token punctuation">)</span> predicate<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            return dt.format('yyyy-MM-dd\'T\'HH:mm:ss\'Z\'', 'Greenwich Mean Time');"><span class="lineCounter-0-0-15 prim">75</span>            <span class="token keyword">return</span> dt<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'yyyy-MM-dd\'T\'HH:mm:ss\'Z\''</span><span class="token punctuation">,</span> <span class="token string">'Greenwich Mean Time'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        } else if(predicate instanceof List<Object>) {"><span class="lineCounter-0-0-15">76</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>predicate <span class="token keyword">instanceof</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            List<Object> predicates = (List<Object>) predicate;"><span class="lineCounter-0-0-15">77</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> predicates <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> predicate<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            List<String> innerStrings = new List<String>();"><span class="lineCounter-0-0-15">78</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> innerStrings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            for(Object innerPred : predicates) {"><span class="lineCounter-0-0-15">79</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Object</span> innerPred <span class="token operator">:</span> predicates<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                //recurse for string value"><span class="lineCounter-0-0-15 prim">80</span>                <span class="token comment">//recurse for string value</span></div><br><div class="line-0-0-16 " data-content="                String innerString = this.getPredicate(innerPred);"><span class="lineCounter-0-0-15">81</span>                <span class="token class-name">String</span> innerString <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPredicate</span><span class="token punctuation">(</span>innerPred<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="                innerStrings.add(innerString);"><span class="lineCounter-0-0-15">82</span>                innerStrings<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>innerString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">83</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="            String start = innerStrings.size() > 1 ? '(' : '';"><span class="lineCounter-0-0-15">84</span>            <span class="token class-name">String</span> start <span class="token operator">=</span> innerStrings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">'('</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            String ending = innerStrings.size() > 1 ? ')' : '';"><span class="lineCounter-0-0-15 prim">85</span>            <span class="token class-name">String</span> ending <span class="token operator">=</span> innerStrings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">')'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            return start + String.join(innerStrings, ',') + ending;"><span class="lineCounter-0-0-15">86</span>            <span class="token keyword">return</span> start <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>innerStrings<span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span> <span class="token operator">+</span> ending<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        } else if(predicate instanceof String) {"><span class="lineCounter-0-0-15">87</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>predicate <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            String input = (String) predicate;"><span class="lineCounter-0-0-15">88</span>            <span class="token class-name">String</span> input <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> predicate<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            return '\'' + String.escapeSingleQuotes(input) + '\'';"><span class="lineCounter-0-0-15">89</span>            <span class="token keyword">return</span> <span class="token string">'\''</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">escapeSingleQuotes</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\''</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15 prim">90</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">91</span></div><br><div class="line-0-0-16 " data-content="        String predValue = String.valueOf(predicate);"><span class="lineCounter-0-0-15">92</span>        <span class="token class-name">String</span> predValue <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>predicate<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        //fun fact - you can detect a list"><span class="lineCounter-0-0-15">93</span>        <span class="token comment">//fun fact - you can detect a list</span></div><br><div class="line-0-0-16 " data-content="        //but you can't detect a set!"><span class="lineCounter-0-0-15">94</span>        <span class="token comment">//but you can't detect a set!</span></div><br><div class="line-0-0-16 " data-content="        if(predValue.startsWith('{') &amp;&amp; predValue.endsWith('}')) {"><span class="lineCounter-0-0-15 prim">95</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>predValue<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'{'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> predValue<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'}'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            List<String> setInner = predValue.substring(1, predValue.length() -1).split(',');"><span class="lineCounter-0-0-15">96</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> setInner <span class="token operator">=</span> predValue<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> predValue<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            isSet = setInner.size() > 1;"><span class="lineCounter-0-0-15">97</span>            isSet <span class="token operator">=</span> setInner<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            return this.getPredicate(setInner);"><span class="lineCounter-0-0-15">98</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPredicate</span><span class="token punctuation">(</span>setInner<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">99</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        return predValue;"><span class="lineCounter-0-0-15 prim">100</span>        <span class="token keyword">return</span> predValue<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">101</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">102</span><span class="token punctuation">}</span></div><br></code></pre><p>Our Query class will be consumed by the repository and will offer a type-safe method for SOQL query composition before passing a request to the repository. Some of its methods may grow; for example, my own version of <code>getPredicate</code> identifies objects like a <code>DateLiteral</code>, which I've created to encapsulate SOQL queries using values like:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="List<Opportunity> opps = [SELECT Id FROM Opportunity WHERE CreatedDate >= TODAY];"><span class="lineCounter-0-0-15 prim">1</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span> opps <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span> FROM <span class="token class-name">Opportunity</span> WHERE <span class="token class-name">CreatedDate</span> <span class="token operator">&gt;=</span> TODAY<span class="token punctuation">]</span><span class="token punctuation">;</span></div><br></code></pre><p>to something like:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="List<Opportunity> opps = (List<Opportunity>)repo.get(new Query("><span class="lineCounter-0-0-15 prim">1</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span> opps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>repo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="    Opportunity.CreatedDate,"><span class="lineCounter-0-0-15">2</span>    <span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">CreatedDate</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    Query.Operator.GREATER_THAN_OR_EQUAL,"><span class="lineCounter-0-0-15">3</span>    <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>GREATER_THAN_OR_EQUAL<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    DateLiteral.TODAY)"><span class="lineCounter-0-0-15">4</span>    <span class="token class-name">DateLiteral</span><span class="token punctuation">.</span>TODAY<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content=");"><span class="lineCounter-0-0-15 prim">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>I've also collaborated with others on improvements like support for parent-child and child-parent queries. The sky's the limit, really.</p><p>You might find such extensions impractical in your own experience; that being said, you should also be able to see how easy it would be to add features like the use of an optional "OR" flag. Similarly, you're about to see a very basic repository; at the same time, it should also be easy to see how you could short-circuit the query if an empty list is passed in, for example (which you'll be able to see <a href="https://github.com/jamessimone/apex-mocks-stress-test/tree/repository">on Github</a>).</p><h3 id="creating-the-repository" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Creating the Repository</h3><p>The repository will take in a query, or a list of queries, and will execute them by composing the rest of the query. This part is pretty simple:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public interface IRepository {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRepository</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    List<SObject> get(Query query);"><span class="lineCounter-0-0-15">2</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    List<SObject> get(List<Query> queries);"><span class="lineCounter-0-0-15">3</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span> queries<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">4</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">5</span></div><br><div class="line-0-0-16 " data-content="public class Repository implements IRepository {"><span class="lineCounter-0-0-15">6</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Repository</span> <span class="token keyword">implements</span> <span class="token class-name">IRepository</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final Schema.SObjectType repoType;"><span class="lineCounter-0-0-15">7</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span> repoType<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private final List<Schema.SObjectField> queryFields;"><span class="lineCounter-0-0-15">8</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span> queryFields<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">9</span></div><br><div class="line-0-0-16 " data-content="    public Repository(Schema.SObjectType repoType, List<Schema.SObjectField> queryFields) {"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token keyword">public</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span><span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span> repoType<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span> queryFields<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.repoType = repoType;"><span class="lineCounter-0-0-15">11</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>repoType <span class="token operator">=</span> repoType<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.queryFields = queryFields;"><span class="lineCounter-0-0-15">12</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>queryFields <span class="token operator">=</span> queryFields<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">13</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">14</span></div><br><div class="line-0-0-16 " data-content="    public List<SObject> get(Query query) {"><span class="lineCounter-0-0-15 prim">15</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return this.get(new List<Query>{ query });"><span class="lineCounter-0-0-15">16</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> query <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">17</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">18</span></div><br><div class="line-0-0-16 " data-content="    public List<SObject> get(List<Query> queries) {"><span class="lineCounter-0-0-15">19</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span> queries<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        String selectClause = 'SELECT ' + this.addSelectFields();"><span class="lineCounter-0-0-15 prim">20</span>        <span class="token class-name">String</span> selectClause <span class="token operator">=</span> <span class="token string">'SELECT '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addSelectFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        String fromClause = '\nFROM ' + this.repoType;"><span class="lineCounter-0-0-15">21</span>        <span class="token class-name">String</span> fromClause <span class="token operator">=</span> <span class="token string">'\nFROM '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>repoType<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        String whereClause = this.addWheres(queries);"><span class="lineCounter-0-0-15">22</span>        <span class="token class-name">String</span> whereClause <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addWheres</span><span class="token punctuation">(</span>queries<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">23</span></div><br><div class="line-0-0-16 " data-content="        String finalQuery = selectClause + fromClause + whereClause;"><span class="lineCounter-0-0-15">24</span>        <span class="token class-name">String</span> finalQuery <span class="token operator">=</span> selectClause <span class="token operator">+</span> fromClause <span class="token operator">+</span> whereClause<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        System.debug('Query: \n' + finalQuery);"><span class="lineCounter-0-0-15 prim">25</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Query: \n'</span> <span class="token operator">+</span> finalQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> results = Database.query(finalQuery);"><span class="lineCounter-0-0-15">26</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>finalQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        System.debug('Results: \n' + results);"><span class="lineCounter-0-0-15">27</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Results: \n'</span> <span class="token operator">+</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return results;"><span class="lineCounter-0-0-15">28</span>        <span class="token keyword">return</span> results<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">29</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">30</span></div><br><div class="line-0-0-16 " data-content="    private String addSelectFields() {"><span class="lineCounter-0-0-15">31</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">addSelectFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Set<String> fieldStrings = new Set<String>{ 'Id' };"><span class="lineCounter-0-0-15">32</span>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fieldStrings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> <span class="token string">'Id'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        for(SObjectField field : this.queryFields) {"><span class="lineCounter-0-0-15">33</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SObjectField</span> field <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryFields<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            fieldStrings.add(field.getDescribe().getName());"><span class="lineCounter-0-0-15">34</span>            fieldStrings<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15 prim">35</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        return String.join(new List<String>(fieldStrings), ', ');"><span class="lineCounter-0-0-15">36</span>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>fieldStrings<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">37</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">38</span></div><br><div class="line-0-0-16 " data-content="    private String addWheres(List<Query> queries) {"><span class="lineCounter-0-0-15">39</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">addWheres</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span> queries<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<String> wheres = new List<String>();"><span class="lineCounter-0-0-15 prim">40</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> wheres <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        for(Query query : queries) {"><span class="lineCounter-0-0-15">41</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query <span class="token operator">:</span> queries<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            wheres.add(query.toString());"><span class="lineCounter-0-0-15">42</span>            wheres<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">43</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        return '\nWHERE ' + String.join(wheres, '\nAND');"><span class="lineCounter-0-0-15">44</span>        <span class="token keyword">return</span> <span class="token string">'\nWHERE '</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>wheres<span class="token punctuation">,</span> <span class="token string">'\nAND'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">45</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">46</span><span class="token punctuation">}</span></div><br></code></pre><p>In order to not clutter up the <a href="dependency-injection-factory-pattern">Factory class</a>, I like for the Factory to expose the repositories through a <a href="/joys-of-apex/building-a-better-singleton">singleton</a> repository factory:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public virtual class Factory {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> virtual <span class="token keyword">class</span> <span class="token class-name">Factory</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public ICrud Crud { get; private set; }"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">public</span> <span class="token class-name">ICrud</span> <span class="token class-name">Crud</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public RepoFactory RepoFactory { get; private set;}"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">public</span> <span class="token class-name">RepoFactory</span> <span class="token class-name">RepoFactory</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">4</span></div><br><div class="line-0-0-16 " data-content="    private static Factory factory;"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Factory</span> factory<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">6</span></div><br><div class="line-0-0-16 " data-content="    @testVisible"><span class="lineCounter-0-0-15">7</span>    <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-16 " data-content="    protected Factory() {"><span class="lineCounter-0-0-15">8</span>    <span class="token keyword">protected</span> <span class="token class-name">Factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.Crud = new Crud();"><span class="lineCounter-0-0-15">9</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Crud</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Crud</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.RepoFactory = new RepoFactory();"><span class="lineCounter-0-0-15 prim">10</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">RepoFactory</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RepoFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">11</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">12</span></div><br><div class="line-0-0-16 " data-content="    public static Factory getFactory() {"><span class="lineCounter-0-0-15">13</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Factory</span> <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        //production code can only initialize the factory through this method"><span class="lineCounter-0-0-15">14</span>        <span class="token comment">//production code can only initialize the factory through this method</span></div><br><div class="line-0-0-16 " data-content="        if(factory == null) {"><span class="lineCounter-0-0-15 prim">15</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            factory = new Factory();"><span class="lineCounter-0-0-15">16</span>            factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">17</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">18</span></div><br><div class="line-0-0-16 " data-content="        return factory;"><span class="lineCounter-0-0-15">19</span>        <span class="token keyword">return</span> factory<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">20</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">21</span></div><br><div class="line-0-0-16 " data-content="    //factory methods for initializing objects"><span class="lineCounter-0-0-15">22</span>    <span class="token comment">//factory methods for initializing objects</span></div><br><div class="line-0-0-16 " data-content="    @testVisible"><span class="lineCounter-0-0-15">23</span>    <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-16 " data-content="    private Factory withMocks {"><span class="lineCounter-0-0-15">24</span>    <span class="token keyword">private</span> <span class="token class-name">Factory</span> withMocks <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        get {"><span class="lineCounter-0-0-15 prim">25</span>        get <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            this.Crud = new CrudMock();"><span class="lineCounter-0-0-15">26</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Crud</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CrudMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            this.RepoFactory = new RepoFactoryMock();"><span class="lineCounter-0-0-15">27</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">RepoFactory</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RepoFactoryMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            return this;"><span class="lineCounter-0-0-15">28</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">29</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">31</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">32</span></div><br><div class="line-0-0-16 " data-content="public virtual class RepoFactory {"><span class="lineCounter-0-0-15">33</span><span class="token keyword">public</span> virtual <span class="token keyword">class</span> <span class="token class-name">RepoFactory</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public virtual IRepository getOppRepo() {"><span class="lineCounter-0-0-15">34</span>    <span class="token keyword">public</span> virtual <span class="token class-name">IRepository</span> <span class="token function">getOppRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObjectField> queryFields = new List<SObjectField>{"><span class="lineCounter-0-0-15 prim">35</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span> queryFields <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            Opportunity.IsWon,"><span class="lineCounter-0-0-15">36</span>            <span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">IsWon</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            Opportunity.StageName,"><span class="lineCounter-0-0-15">37</span>            <span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">StageName</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            //etc ..."><span class="lineCounter-0-0-15">38</span>            <span class="token comment">//etc ...</span></div><br><div class="line-0-0-16 " data-content="        };"><span class="lineCounter-0-0-15">39</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return new Repository(Opportunity.SObjectType, queryFields);"><span class="lineCounter-0-0-15 prim">40</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">,</span> queryFields<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">41</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">42</span></div><br><div class="line-0-0-16 " data-content="    public virtual IRepository getOppLineItemRepo() {"><span class="lineCounter-0-0-15">43</span>    <span class="token keyword">public</span> virtual <span class="token class-name">IRepository</span> <span class="token function">getOppLineItemRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObjectField> queryFields = new List<SObjectField>{"><span class="lineCounter-0-0-15">44</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span> queryFields <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            OpportunityLineItem.Description,"><span class="lineCounter-0-0-15 prim">45</span>            <span class="token class-name">OpportunityLineItem</span><span class="token punctuation">.</span><span class="token class-name">Description</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            OpportunityLineItem.OpportunityId,"><span class="lineCounter-0-0-15">46</span>            <span class="token class-name">OpportunityLineItem</span><span class="token punctuation">.</span><span class="token class-name">OpportunityId</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            //etc"><span class="lineCounter-0-0-15">47</span>            <span class="token comment">//etc</span></div><br><div class="line-0-0-16 " data-content="        };"><span class="lineCounter-0-0-15">48</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return new Repository(OpportunityLineItem.SObjectType, queryFields);"><span class="lineCounter-0-0-15">49</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">,</span> queryFields<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">50</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">51</span></div><br><div class="line-0-0-16 " data-content="    //etc"><span class="lineCounter-0-0-15">52</span>    <span class="token comment">//etc</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">53</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">54</span></div><br><div class="line-0-0-16 " data-content="public class RepoFactoryMock extends RepoFactory {"><span class="lineCounter-0-0-15 prim">55</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RepoFactoryMock</span> <span class="token keyword">extends</span> <span class="token class-name">RepoFactory</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @testVisible"><span class="lineCounter-0-0-15">56</span>    <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-16 " data-content="    private static List<SObject> QueryResults = new List<SObject>();"><span class="lineCounter-0-0-15">57</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">QueryResults</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    @testVisible"><span class="lineCounter-0-0-15">58</span>    <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-16 " data-content="    private static List<Query> QueriesMade = new List<Query>();"><span class="lineCounter-0-0-15">59</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">QueriesMade</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">60</span></div><br><div class="line-0-0-16 " data-content="    public override IRepository getOppLineItemRepo() {"><span class="lineCounter-0-0-15">61</span>    <span class="token keyword">public</span> override <span class="token class-name">IRepository</span> <span class="token function">getOppLineItemRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> queriedResults = this.getResults(OpportunityLineItem.SObjectType);"><span class="lineCounter-0-0-15">62</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> queriedResults <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getResults</span><span class="token punctuation">(</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return queriedResults.size() > 0 ?"><span class="lineCounter-0-0-15">63</span>        <span class="token keyword">return</span> queriedResults<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span></div><br><div class="line-0-0-16 " data-content="            new RepoMock(queriedResults) :"><span class="lineCounter-0-0-15">64</span>            <span class="token keyword">new</span> <span class="token class-name">RepoMock</span><span class="token punctuation">(</span>queriedResults<span class="token punctuation">)</span> <span class="token operator">:</span></div><br><div class="line-0-0-16 " data-content="            super.getOppLineItemRepo();"><span class="lineCounter-0-0-15 prim">65</span>            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getOppLineItemRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">66</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">67</span></div><br><div class="line-0-0-16 " data-content="    private List<SObject> getResults(SObjectType sobjType) {"><span class="lineCounter-0-0-15">68</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">getResults</span><span class="token punctuation">(</span><span class="token class-name">SObjectType</span> sobjType<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> resultList = new List<SObject>();"><span class="lineCounter-0-0-15">69</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> resultList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        for(SObject potentialResult : QueryResults) {"><span class="lineCounter-0-0-15 prim">70</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> potentialResult <span class="token operator">:</span> <span class="token class-name">QueryResults</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            if(potentialResult.getSObjectType() == sobjType) {"><span class="lineCounter-0-0-15">71</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>potentialResult<span class="token punctuation">.</span><span class="token function">getSObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> sobjType<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                resultList.add(potentialResult);"><span class="lineCounter-0-0-15">72</span>                resultList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>potentialResult<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">73</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">74</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        return resultList;"><span class="lineCounter-0-0-15 prim">75</span>        <span class="token keyword">return</span> resultList<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">76</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">77</span></div><br><div class="line-0-0-16 " data-content="    private class RepoMock implements IRepository {"><span class="lineCounter-0-0-15">78</span>    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">RepoMock</span> <span class="token keyword">implements</span> <span class="token class-name">IRepository</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        private final List<SObject> results;"><span class="lineCounter-0-0-15">79</span>        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">80</span></div><br><div class="line-0-0-16 " data-content="        public RepoMock(List<SObject> results) {"><span class="lineCounter-0-0-15">81</span>        <span class="token keyword">public</span> <span class="token class-name">RepoMock</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            this.results = results;"><span class="lineCounter-0-0-15">82</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>results <span class="token operator">=</span> results<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">83</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">84</span></div><br><div class="line-0-0-16 " data-content="        public List<SObject> get(Query query) {"><span class="lineCounter-0-0-15 prim">85</span>        <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            return this.get(new List<Query>{ query });"><span class="lineCounter-0-0-15">86</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> query <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">87</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">88</span></div><br><div class="line-0-0-16 " data-content="        public List<SObject> get(List<Query> queries) {"><span class="lineCounter-0-0-15">89</span>        <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span> queries<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            QueriesMade.addAll(queries);"><span class="lineCounter-0-0-15 prim">90</span>            <span class="token class-name">QueriesMade</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>queries<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            return this.results;"><span class="lineCounter-0-0-15">91</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>results<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">92</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">93</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">94</span><span class="token punctuation">}</span></div><br></code></pre><p>OK! So let's review the benefits we've gained from this structure and approach so far:</p><ul><li>by use of the Factory pattern, we've implemented a <em>single</em> seam where <strong>only</strong> tests can gain access to repository mocks and our mock Crud implementation</li><li>by use of a few helper methods, we've implemented a single location - <code>RepoFactoryMocks.QueryResult</code> where you can dump your expected query items across a wide swath of SObjects. With minimal boilerplate, the mock then decides per each IRepository override whether or not there are SObject results for each SObjectType and if a real or fake repository needs to be returned</li><li>query fields per SObject are centralized in location, and because they're SObjectFields, we know for sure at deploy time that the given fields for an object exist and that their developer names have not changed. This is a zero-tolerance policy for breaking changes incorporated into your deployment workflow</li><li>overrides in RepoFactoryMock only ever needed to be added per object when stubbing queries is practical; for my purposes, that means for all unit tests, but even if you are only incorporating this pattern gradually, you benefit from the performance increase of preventing database access while in your tests. In the meantime, you have <strong>one</strong> route for production level code to take; all object initialization comes through the Factory or some child class of the Factory. You can examine your code routes from the top-level down easily without having to jump all over the place.</li></ul><p>And let's revisit our original test examples to see how they might look. Note again the use of the helper method to generate SObject Ids. I discussed this in the <a href="/joys-of-apex/mocking-dml">Mocking DML</a> article previously:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public class OpportunityUpdater {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpportunityUpdater</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final IRepository oppLineItemRepo;"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">IRepository</span> oppLineItemRepo<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="    public OpportunityUpdater(Factory factory) {"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">public</span> <span class="token class-name">OpportunityUpdater</span><span class="token punctuation">(</span><span class="token class-name">Factory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.oppLineItemRepo = factory.RepoFactory.getOppLineItemRepo();"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>oppLineItemRepo <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token class-name">RepoFactory</span><span class="token punctuation">.</span><span class="token function">getOppLineItemRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">6</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="    public void updateOppsOnClose(List<Opportunity> updatedOpps) {"><span class="lineCounter-0-0-15">8</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateOppsOnClose</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span> updatedOpps<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Map<Id, Opportunity> idtoUpdatedOpps = new Map<Id, Opportunity>(updatedOpps);"><span class="lineCounter-0-0-15">9</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span> idtoUpdatedOpps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>updatedOpps<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="        Query oppQuery = new Query(Opportunity.Id, Query.Operator.EQUALS, idToUpdatedOpps.keySet());"><span class="lineCounter-0-0-15">11</span>        <span class="token class-name">Query</span> oppQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token class-name">Operator</span><span class="token punctuation">.</span>EQUALS<span class="token punctuation">,</span> idToUpdatedOpps<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        List<OpportunityLineItem> lineItems = (List<OpportunityLineItem>)this.oppLineItemRepo.get("><span class="lineCounter-0-0-15">12</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span> lineItems <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OpportunityLineItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>oppLineItemRepo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="            oppQuery"><span class="lineCounter-0-0-15">13</span>            oppQuery</div><br><div class="line-0-0-16 " data-content="        );"><span class="lineCounter-0-0-15">14</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        for(OpportunityLineItem lineItem : lineItems) {"><span class="lineCounter-0-0-15 prim">15</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">OpportunityLineItem</span> lineItem <span class="token operator">:</span> lineItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            if(lineItem.Description == 'business logic criteria') {"><span class="lineCounter-0-0-15">16</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>lineItem<span class="token punctuation">.</span><span class="token class-name">Description</span> <span class="token operator">==</span> <span class="token string">'business logic criteria'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                Opportunity opp = idToUpdatedOpps.get(lineItem.OpportunityId);"><span class="lineCounter-0-0-15">17</span>                <span class="token class-name">Opportunity</span> opp <span class="token operator">=</span> idToUpdatedOpps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>lineItem<span class="token punctuation">.</span><span class="token class-name">OpportunityId</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="                opp.Description = 'Magic Business String';"><span class="lineCounter-0-0-15">18</span>                opp<span class="token punctuation">.</span><span class="token class-name">Description</span> <span class="token operator">=</span> <span class="token string">'Magic Business String'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">19</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15 prim">20</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        //etc..."><span class="lineCounter-0-0-15">21</span>        <span class="token comment">//etc...</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">22</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">23</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">24</span></div><br><div class="line-0-0-16 " data-content="//in your test class"><span class="lineCounter-0-0-15 prim">25</span><span class="token comment">//in your test class</span></div><br><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15">26</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class OpportunityUpdater_Tests {"><span class="lineCounter-0-0-15">27</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">OpportunityUpdater_Tests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">28</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_update_opportunities_correctly() {"><span class="lineCounter-0-0-15">29</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_update_opportunities_correctly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        //arrange"><span class="lineCounter-0-0-15 prim">30</span>        <span class="token comment">//arrange</span></div><br><div class="line-0-0-16 " data-content="        Opportunity firstOpp = new Opportunity(Id = TestingUtils.generateId(Opportunity.SObjectType));"><span class="lineCounter-0-0-15">31</span>        <span class="token class-name">Opportunity</span> firstOpp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Opportunity</span><span class="token punctuation">(</span><span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Opportunity secondOpp = new Opportunity(Id = TestingUtils.generateId(Opportunity.SObjectType));"><span class="lineCounter-0-0-15">32</span>        <span class="token class-name">Opportunity</span> secondOpp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Opportunity</span><span class="token punctuation">(</span><span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Opportunity</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        List<Opportunity> opps = new List<Opportunity>{ firstOpp, secondOpp };"><span class="lineCounter-0-0-15">33</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span> opps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> firstOpp<span class="token punctuation">,</span> secondOpp <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">34</span></div><br><div class="line-0-0-16 " data-content="        OpportunityLineItem lineItem = new OpportunityLineItem("><span class="lineCounter-0-0-15 prim">35</span>        <span class="token class-name">OpportunityLineItem</span> lineItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpportunityLineItem</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="            OpportunityId = firstOpp.Id,"><span class="lineCounter-0-0-15">36</span>            <span class="token class-name">OpportunityId</span> <span class="token operator">=</span> firstOpp<span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            Description = 'business logic criteria'"><span class="lineCounter-0-0-15">37</span>            <span class="token class-name">Description</span> <span class="token operator">=</span> <span class="token string">'business logic criteria'</span></div><br><div class="line-0-0-16 " data-content="        );"><span class="lineCounter-0-0-15">38</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">39</span></div><br><div class="line-0-0-16 " data-content="        //act"><span class="lineCounter-0-0-15 prim">40</span>        <span class="token comment">//act</span></div><br><div class="line-0-0-16 " data-content="        RepoFactoryMock.QueryResults.addAll(opps);"><span class="lineCounter-0-0-15">41</span>        <span class="token class-name">RepoFactoryMock</span><span class="token punctuation">.</span><span class="token class-name">QueryResults</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>opps<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        RepoFactoryMock.QueryResults.add(lineItem);"><span class="lineCounter-0-0-15">42</span>        <span class="token class-name">RepoFactoryMock</span><span class="token punctuation">.</span><span class="token class-name">QueryResults</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>lineItem<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Factory.getFactory().withMocks.getOpportunityUpdater().updateOppsOnClose(opps);"><span class="lineCounter-0-0-15">43</span>        <span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>withMocks<span class="token punctuation">.</span><span class="token function">getOpportunityUpdater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateOppsOnClose</span><span class="token punctuation">(</span>opps<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">44</span></div><br><div class="line-0-0-16 " data-content="        //assert"><span class="lineCounter-0-0-15 prim">45</span>        <span class="token comment">//assert</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals('Magic Business String', firstOpp.Description);"><span class="lineCounter-0-0-15">46</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'Magic Business String'</span><span class="token punctuation">,</span> firstOpp<span class="token punctuation">.</span><span class="token class-name">Description</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        System.assertNotEquals('Magic Business String', secondOpp.Description);"><span class="lineCounter-0-0-15">47</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertNotEquals</span><span class="token punctuation">(</span><span class="token string">'Magic Business String'</span><span class="token punctuation">,</span> secondOpp<span class="token punctuation">.</span><span class="token class-name">Description</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">48</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">49</span><span class="token punctuation">}</span></div><br></code></pre><p>Furthermore, because our RepoFactoryMock can tell us which queries were performed, we can easily add conditions to our OrderUpdater class and verify in the tests that the query has been updated correctly. Having a strongly typed method for comparing changes to SOQL queries is an extremely powerful tool in your toolbelt. Rather than validating that your query string has been typed correctly in raw SOQL, you can assert for that in your tests.</p><hr><h2 id="wrapping-up" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Wrapping up</h2><p>I've just gone through and outlined the <em>most</em> barebones Repository pattern implementation within Apex. It's easily extensible, and functionality can be increased with minimal method additions in clearly delineated places.</p><p>When I needed to apply a "LIMIT" statement to a query, that functionality was easy to add. When I needed to add sorting, that was achieved through the use of another enum within the Query class and the addition of a method to the <code>Repository.get</code> method. Something that I have often thought of, though I haven't really had the need for it thus far, is re-implementing the common method seen in some mocking libraries that dictates to the mock how many results should be returned per function call. With the above implementation, it ends up being simple to add in an override on the <code>RepoFactoryMock</code> to dictate just how many of the relevant results would be returned.</p><p>The combination of the Repository and Crud classes represents the <strong>entirety</strong> of what's necessary to supercharge your Apex unit tests; providing the benefit of both strongly-typed testing and blazing fast test speed. It should be noted that I actually espouse the use of three different factories --</p><ul><li>a HandlerFactory, which can only be initialized in Triggers, whose sole responsibility is to instantiate Apex Trigger handlers (one per object! Hopefully you all learned the Handler pattern early on)</li><li>the Factory you've seen, which passes instances of itself to all objects getting initialized so that their dependencies can be easily added (and easily swapped, as is the case with the Crud &amp; Repository instances ...)</li><li>the RepositoryFactory, which in my case holds the Crud getter as well as the getting methods for all IRepository instances</li></ul><p>This pattern is the result of many years and many iterations on similar themes across various Salesforce orgs. I haven't seen a verifiably better way that leads to the same decrease in testing time and object complexity, but I'm always looking for new ways to do better. In particular, the lack of generics in Apex makes for some frustrating casting of returned objects. It would be ideal if the below were the method signatures for IRepository:</p><pre class=""><code class="csharp code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public interface IRepository<T> where T : SObject {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">SObject</span></span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="   List<T> get(Query query);"><span class="lineCounter-0-0-15">2</span>   List<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="   List<T> get(List<Query> queries);"><span class="lineCounter-0-0-15">3</span>   List<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token class-name">List<span class="token punctuation">&lt;</span>Query<span class="token punctuation">&gt;</span></span> queries<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">4</span><span class="token punctuation">}</span></div><br></code></pre><p>But hey, that's the world we live in. The day we get lambda functions and generics in Apex will be a very exciting one indeed. I hope you enjoyed this article. I know it's a long one, but I tried to find the right balance between verbosity and justification both in the code examples and prose. You can find full examples at the code over at my <a href="https://github.com/jamessimone/apex-mocks-stress-test/tree/repository">Apex Mocks repo</a>, which I still haven't discussed in detail here but will in a coming post.</p><p>The long and short of it is that the use of the built-in Apex stubbing methods is not as performant as an approach like the one I'm detailing here.</p><p>Till next time!</p><hr><h2 id="postscipt" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Postscipt</h2><p>This entire post was written on two separate plane rides on 9 January 2020 from Boston, Massachusetts to Chicago and then Chicaco to Portland, Oregon. I did not have Wifi; an interesting challenge when trying to write a language that requires an internet connection in order to be compiled. Here are the changes I had to make to get the tests passing and the code to compile:</p><ul><li>The version of the Query class I originally wrote did not call <code>getDescribe().getName()</code> for the passed in SObjectFields, which led to a rather hilarious query exception to be thrown due to the <code>@</code> sign in the SObjectField token</li><li>I couldn't remember if enums could be used in switch statements in Apex. I later updated the <code>getOperator</code> method to correctly reflect this. Switch statements can be very polarizing, as well, in Apex -- they're more verbose than if statements, and the benefits you get with them are probably higher with SObjects; an enum switch statement takes up a lot of room, and only saves you the use of the full enum reference (IE <code>Query.Operator.EQUALS</code> instead of just <code>EQUALS</code> in the switch). Looking at that particular function again, I'd probably favor the if/else syntax to cut down on the lines of code</li><li>There were a few misspellings of the word "Opportunity" -- after seven hours of flying, not that bad though!</li></ul><p>The approach I've written about is a big improvement over the original implementations of these classes that I worked on years ago, and perhaps nothing better exemplifies that than the example test for the <code>OpportunityUpdater</code> passing on the first go. Still, I knew that my examples were lacking several key functionality aspects -- true support for Lists and Sets, in particular, and so the implementation that you'll find on the <a href="https://github.com/jamessimone/apex-mocks-stress-test/tree/repository">Apex Mocks repo</a> is slightly different from the baseline implementation shown here.</p><p>If you made it this far, many thanks for taking the time to read, and I hope you enjoyed this post.</p><div class="contentnav-0-0-7" data-no-search=""><a href="#the-problem-with-soql-usage-in-large-codebases" class="h2" data-content-highlight="the-problem-with-soql-usage-in-large-codebases">The Problem With SOQL Usage In Large Codebases</a><a href="#implementing-the-repository-pattern-in-apex" class="h2" data-content-highlight="implementing-the-repository-pattern-in-apex">Implementing the Repository Pattern in Apex</a><a href="#composing-repository-queries" class="h3" data-content-highlight="composing-repository-queries">Composing repository queries</a><a href="#creating-the-repository" class="h3" data-content-highlight="creating-the-repository">Creating the Repository</a><a href="#wrapping-up" class="h2" data-content-highlight="wrapping-up">Wrapping up</a><a href="#postscipt" class="h2" data-content-highlight="postscipt">Postscipt</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="tujXbNCsiV">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("tujXbNCsiV", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="fhJBDJnINj">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("fhJBDJnINj", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="RjNecshzqb">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("RjNecshzqb", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>