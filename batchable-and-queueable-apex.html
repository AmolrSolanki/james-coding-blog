<!DOCTYPE html><html><head><title>Joys Of Apex | Batchable &amp; Queueable Apex</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons%7CMaterial+Icons+Outlined&amp;display=swap" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Batchable &amp; Queueable Apex"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Batchable &amp; Queueable Apex"><meta name="keywords" content=""><meta property="blog-tags" content=""></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"batchable-and-queueable-apex.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Batchable &amp; Queueable Apex</p></span></h1><script id="fEBUjJmhFH">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("fEBUjJmhFH", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2020-03-27T15:00:00.000Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>Batchable and Queueable Apex are both powerful processing frameworks within Salesforce. Unlock the power of both Batchable and Queueable Apex with the easily extendable <code>DataProcessor</code> pattern, which I'll detail in this post. This has been a <em>long</em> time coming. I've been dreaming of writing this post for years — after getting burned with a few Batch Apex classes.</p><p>Reading the Apex docs concerning Batch Apex, it sounds like a dream come true:</p><blockquote><p>If you use a QueryLocator object, the governor limit for the total number of records retrieved by SOQL queries is bypassed. For example, a batch Apex job for the Account object can return a QueryLocator for all account records (up to 50 million records) in an org.</p></blockquote><p>What the @%^!? <em>50 million records</em> ?? God, we can all go home, the work's pretty much done for us (just kidding, we're all at home anyway). In reality, the use of Batch Apex is frequently a painful experience with:</p><ul><li>slow running batches</li><li>intermittent failures (if one batch fails, the records being updated in it get rolled back ... but that's not true for the records in any of the other batches spawned through the process, good luck trying to diagnose issues in Batchable Apex that's been running with silent failures for a few days ...)</li></ul><p>Being the chief offenders. Let's not even get onto the subject of maintaining the order of batches once they're in the Apex Flex Queue. Have you ever tried to hit a moving target? If you're one of the poor sods who's tried to juggle which Batch Jobs were executing at any given time, yes — yes, you have tried. I've also already spoken about the Batchable boilerplate in the <a href="enum-apex-class-gotchas/">Enum</a> post, so I won't beat on that horse.</p><p>With the introduction of Queueable Apex, it seemed that most people's prayers had been answered; queued jobs ran <em>fast</em>, and it's possible to write recursive Queueable Apex that (when set up correctly) gets around the DML row limit with carefully crafted queries that run in small batches ... essentially, fast Batchable Apex.</p><p>But after a few years of using Queueables instead of Batch Apex, I found myself really pushing the limits (no pun intended) of what was possible in a single transaction with <strong>only</strong> 10,000 rows that could be modified. The truth is, without good sentinel values on the records you're querying (some kind of <code>IsUpdated</code> flag), you can quickly run into trouble with Queueables running forever — head back to the Apex Jobs setup page to try to stop the job before it restarts itself!</p><p>Plus, if you need to modify the sentinel value on 1,000 records, but those records could in turn be responsible for creating more than 9 records each (which is certainly possible with one-to-many relationships), you've just run into the kind of territory I was recently exploring for a client. Query too little, and the jobs will run inefficiently; query too much and you run into a Limit exception. Classic Salesforce.</p><h2 id="introducing-the-dataprocessor" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Introducing the DataProcessor</h2><p>Let's take it back to the end of the <a href="repository-pattern/">Repository</a> post. It's not <em>quite</em> required reading for this post, but I do recommend it. The essentials are the use of the <code>Query</code> and <code>Repository</code> objects to encapsulate SOQL requests, and there'll be a necessary rehash below. That encapsulation is important because passing around Strings is a dangerous game ... and Batchable Apex sadly requires the use of Strings. To begin with, we'll need to revamp the <code>Repository</code> to safely encapsulate the <code>Database.QueryLocator</code> object that Batchables require in their <code>start</code> method. Unfortunately, there's no public constructor for this class, so we won't be able to mock a return value, but that's a story for another day. Here's what I'd like to test first:</p><pre class="with-bar"><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span>classes/Repository_Tests.cls</span></span><div class="line-0-0-18  -codedoc-code-line" data-content="@isTest" id="code1-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="static void it_should_return_count_properly() {" id="code1-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_return_count_properly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    insert new Account(Name = 'Test');" id="code1-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    insert <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'Test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Query nameEqualsTest = new Query(Account.Name, Query.Operator.EQUALS, 'Test');" id="code1-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Query</span> nameEqualsTest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Account<span class="token punctuation">.</span>Name</span><span class="token punctuation">,</span> <span class="token class-name">Query<span class="token punctuation">.</span>Operator</span><span class="token punctuation">.</span>EQUALS<span class="token punctuation">,</span> <span class="token string">'Test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    IRepository repo = new Repository(Account.SObjectType, new List<SObjectField>());" id="code1-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">IRepository</span> repo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span><span class="token class-name">Account<span class="token punctuation">.</span>SObjectType</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code1-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    QueryWrapper wrapper = repo.getWrapper(nameEqualsTest);" id="code1-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">QueryWrapper</span> wrapper <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">getWrapper</span><span class="token punctuation">(</span>nameEqualsTest<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code1-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    System.assertEquals(1, wrapper.ResultSize);" id="code1-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">wrapper<span class="token punctuation">.</span></span>ResultSize</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code1-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>Pretty self-explanatory. The <code>QueryWrapper</code> object will encapsulate not only the <code>Database.QueryLocator</code> — it will also receive an aggregated count for underlying requests. This will allow <code>DataProcessor</code> consumers to judge based on how many results are returned if it will be necessary to batch the request or enqueue it. Salesforce <em>does</em> include the <code>Database.countQuery</code> method in the standard Apex library, but we'll need to tweak how the underlying query string is formed in order to properly conform to the format that <code>countQuery</code> expects. Let's review the implementation:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="//your garden-variety POJO..." id="code2-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//your garden-variety POJO...</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="public class QueryWrapper {" id="code2-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryWrapper</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public QueryWrapper(Database.QueryLocator locator, Integer resultSize) {" id="code2-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token class-name">Database<span class="token punctuation">.</span>QueryLocator</span> locator<span class="token punctuation">,</span> <span class="token class-name">Integer</span> resultSize<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.Locator = locator;" id="code2-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name"><span class="token namespace">this<span class="token punctuation">.</span></span>Locator</span> <span class="token operator">=</span> locator<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.ResultSize = resultSize;" id="code2-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name"><span class="token namespace">this<span class="token punctuation">.</span></span>ResultSize</span> <span class="token operator">=</span> resultSize<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public Database.QueryLocator Locator { get; private set; }" id="code2-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">Database<span class="token punctuation">.</span>QueryLocator</span> <span class="token class-name">Locator</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public Integer ResultSize { get; private set; }" id="code2-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token class-name">ResultSize</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code2-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="//And then the full repository..." id="code2-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//And then the full repository...</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="public class Repository extends Crud implements IRepository {" id="code2-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Repository</span> <span class="token keyword">extends</span> <span class="token class-name">Crud</span> <span class="token keyword">implements</span> <span class="token class-name">IRepository</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private final Schema.SObjectType repoType;" id="code2-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Schema<span class="token punctuation">.</span>SObjectType</span> repoType<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private final List<Schema.SObjectField> queryFields;" id="code2-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Schema<span class="token punctuation">.</span>SObjectField</span><span class="token punctuation">&gt;</span></span> queryFields<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private Boolean shortCircuit = false;" id="code2-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token class-name">Boolean</span> shortCircuit <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public Repository(Schema.SObjectType repoType, List<Schema.SObjectField> queryFields) {" id="code2-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span><span class="token class-name">Schema<span class="token punctuation">.</span>SObjectType</span> repoType<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Schema<span class="token punctuation">.</span>SObjectField</span><span class="token punctuation">&gt;</span></span> queryFields<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.repoType = repoType;" id="code2-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span>repoType <span class="token operator">=</span> repoType<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.queryFields = queryFields;" id="code2-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span>queryFields <span class="token operator">=</span> queryFields<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public QueryWrapper getWrapper(Query query) {" id="code2-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">QueryWrapper</span> <span class="token function">getWrapper</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return this.getWrapper(new List<Query>{ query });" id="code2-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getWrapper</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> query <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public QueryWrapper getWrapper(List<Query> queries) {" id="code2-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">QueryWrapper</span> <span class="token function">getWrapper</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span> queries<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    String queryString = this.getQueryString(queries);" id="code2-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">String</span> queryString <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span>queries<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Integer resultSize = this.getAggregateResultSize(queries);" id="code2-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Integer</span> resultSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAggregateResultSize</span><span class="token punctuation">(</span>queries<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Database.QueryLocator locator = Database.getQueryLocator(queryString);" id="code2-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Database<span class="token punctuation">.</span>QueryLocator</span> locator <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getQueryLocator</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return new QueryWrapper(locator, resultSize);" id="code2-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span>locator<span class="token punctuation">,</span> resultSize<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public List<SObject> get(Query query) {" id="code2-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return this.get(new List<Query>{ query });" id="code2-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> query <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public List<SObject> get(List<Query> queries) {" id="code2-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span> queries<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    String finalQuery = this.getQueryString(queries);" id="code2-l41"><span class="lineCounter-0-0-15 -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">String</span> finalQuery <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span>queries<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    System.debug('Query: \n' + finalQuery);" id="code2-l42"><span class="lineCounter-0-0-15 -codedoc-line-counter">42<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Query: \n'</span> <span class="token operator">+</span> finalQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    List<SObject> results = this.getFromQuery(finalQuery);" id="code2-l43"><span class="lineCounter-0-0-15 -codedoc-line-counter">43<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFromQuery</span><span class="token punctuation">(</span>finalQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    System.debug('Results: \n' + results);" id="code2-l44"><span class="lineCounter-0-0-15 -codedoc-line-counter">44<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Results: \n'</span> <span class="token operator">+</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return results;" id="code2-l45"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">45<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> results<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l46"><span class="lineCounter-0-0-15 -codedoc-line-counter">46<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l47"><span class="lineCounter-0-0-15 -codedoc-line-counter">47<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private String getQueryString(List<Query> queries) {" id="code2-l48"><span class="lineCounter-0-0-15 -codedoc-line-counter">48<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span> queries<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    String selectClause = 'SELECT ' + this.addSelectFields();" id="code2-l49"><span class="lineCounter-0-0-15 -codedoc-line-counter">49<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">String</span> selectClause <span class="token operator">=</span> <span class="token string">'SELECT '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addSelectFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    String fromClause = this.getFrom();" id="code2-l50"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">50<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">String</span> fromClause <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    String whereClause = this.addWheres(queries);" id="code2-l51"><span class="lineCounter-0-0-15 -codedoc-line-counter">51<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">String</span> whereClause <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addWheres</span><span class="token punctuation">(</span>queries<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return selectClause + fromClause + whereClause;" id="code2-l52"><span class="lineCounter-0-0-15 -codedoc-line-counter">52<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> selectClause <span class="token operator">+</span> fromClause <span class="token operator">+</span> whereClause<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l53"><span class="lineCounter-0-0-15 -codedoc-line-counter">53<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l54"><span class="lineCounter-0-0-15 -codedoc-line-counter">54<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private String addSelectFields() {" id="code2-l55"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">55<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">addSelectFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Set<String> fieldStrings = new Set<String>{ 'Id' };" id="code2-l56"><span class="lineCounter-0-0-15 -codedoc-line-counter">56<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fieldStrings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> <span class="token string">'Id'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    for(SObjectField field : this.queryFields) {" id="code2-l57"><span class="lineCounter-0-0-15 -codedoc-line-counter">57<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SObjectField</span> field <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryFields<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        fieldStrings.add(field.getDescribe().getName());" id="code2-l58"><span class="lineCounter-0-0-15 -codedoc-line-counter">58<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        fieldStrings<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code2-l59"><span class="lineCounter-0-0-15 -codedoc-line-counter">59<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return String.join(new List<String>(fieldStrings), ', ');" id="code2-l60"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">60<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>fieldStrings<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l61"><span class="lineCounter-0-0-15 -codedoc-line-counter">61<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l62"><span class="lineCounter-0-0-15 -codedoc-line-counter">62<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private String getFrom() { return '\nFROM ' + this.repoType;  }" id="code2-l63"><span class="lineCounter-0-0-15 -codedoc-line-counter">63<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">'\nFROM '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>repoType<span class="token punctuation">;</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l64"><span class="lineCounter-0-0-15 -codedoc-line-counter">64<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private String addWheres(List<Query> queries) {" id="code2-l65"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">65<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">addWheres</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span> queries<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    List<String> wheres = new List<String>();" id="code2-l66"><span class="lineCounter-0-0-15 -codedoc-line-counter">66<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> wheres <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    for(Query query : queries) {" id="code2-l67"><span class="lineCounter-0-0-15 -codedoc-line-counter">67<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query <span class="token operator">:</span> queries<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        if(query.isEmpty()) { this.shortCircuit = true; }" id="code2-l68"><span class="lineCounter-0-0-15 -codedoc-line-counter">68<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">if</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>shortCircuit <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        wheres.add(query.toString());" id="code2-l69"><span class="lineCounter-0-0-15 -codedoc-line-counter">69<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        wheres<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code2-l70"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">70<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return '\nWHERE ' + String.join(wheres, '\nAND');" id="code2-l71"><span class="lineCounter-0-0-15 -codedoc-line-counter">71<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token string">'\nWHERE '</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>wheres<span class="token punctuation">,</span> <span class="token string">'\nAND'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l72"><span class="lineCounter-0-0-15 -codedoc-line-counter">72<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l73"><span class="lineCounter-0-0-15 -codedoc-line-counter">73<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private List<SObject> getFromQuery(String queryString) {" id="code2-l74"><span class="lineCounter-0-0-15 -codedoc-line-counter">74<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFromQuery</span><span class="token punctuation">(</span><span class="token class-name">String</span> queryString<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return shortCircuit ? new List<SObject>() : Database.query(queryString);" id="code2-l75"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">75<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> shortCircuit <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l76"><span class="lineCounter-0-0-15 -codedoc-line-counter">76<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l77"><span class="lineCounter-0-0-15 -codedoc-line-counter">77<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private Integer getAggregateResultSize(List<Query> queries) {" id="code2-l78"><span class="lineCounter-0-0-15 -codedoc-line-counter">78<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token class-name">Integer</span> <span class="token function">getAggregateResultSize</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Query</span><span class="token punctuation">&gt;</span></span> queries<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    String selectClause = 'SELECT Count()';" id="code2-l79"><span class="lineCounter-0-0-15 -codedoc-line-counter">79<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">String</span> selectClause <span class="token operator">=</span> <span class="token string">'SELECT Count()'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    String fromClause = this.getFrom();" id="code2-l80"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">80<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">String</span> fromClause <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    String whereClause = this.addWheres(queries);" id="code2-l81"><span class="lineCounter-0-0-15 -codedoc-line-counter">81<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">String</span> whereClause <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addWheres</span><span class="token punctuation">(</span>queries<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l82"><span class="lineCounter-0-0-15 -codedoc-line-counter">82<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return Database.countQuery(selectClause + fromClause + whereClause);" id="code2-l83"><span class="lineCounter-0-0-15 -codedoc-line-counter">83<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">countQuery</span><span class="token punctuation">(</span>selectClause <span class="token operator">+</span> fromClause <span class="token operator">+</span> whereClause<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l84"><span class="lineCounter-0-0-15 -codedoc-line-counter">84<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code2-l85"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">85<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>Apologies — I normally paste snippets, but because this work builds on the class that was built in the <a href="/joys-of-apex/repository-pattern">Repository</a> post, it was a little hard to avoid. That's the only rehash necessary, as the rest of the code is all new. The <code>QueryWrapper</code> object ends up with the info it needs, and we only burn one SOQL call in the meantime.</p><p>Initially, I was hoping to do something like the following with the <code>DataProcessor</code>:</p><pre class="with-bar"><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span>classes/DataProcessor.cls</span></span><div class="line-0-0-18  -codedoc-code-line" data-content="public abstract class DataProcessor {" id="code3-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">DataProcessor</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected final Integer resultSize;" id="code3-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> resultSize<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  //if you needed to, you could abort" id="code3-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//if you needed to, you could abort</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  //at any time using the jobId" id="code3-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//at any time using the jobId</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected Id jobId;" id="code3-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> <span class="token class-name">Id</span> jobId<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public DataProcessor(Factory factory) {" id="code3-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">DataProcessor</span><span class="token punctuation">(</span><span class="token class-name">Factory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //implementers will use this constructor" id="code3-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//implementers will use this constructor</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //to install dependencies" id="code3-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//to install dependencies</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="   }" id="code3-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>   <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected DataProcessor(QueryWrapper wrapper) {" id="code3-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> <span class="token class-name">DataProcessor</span><span class="token punctuation">(</span><span class="token class-name">QueryWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.resultSize = wrapper.ResultSize;" id="code3-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span>resultSize <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">wrapper<span class="token punctuation">.</span></span>ResultSize</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code3-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  //these end up being the only four methods" id="code3-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//these end up being the only four methods</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  //you would care about in your implementing classes" id="code3-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//you would care about in your implementing classes</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected virtual QueryWrapper getWrapper() {" id="code3-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> virtual <span class="token class-name">QueryWrapper</span> <span class="token function">getWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    throw new DataProcessorException('Not Implemented');" id="code3-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DataProcessorException</span><span class="token punctuation">(</span><span class="token string">'Not Implemented'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code3-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected virtual void execute(List<SObject> records) { }" id="code3-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> virtual <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected virtual void finish() { }" id="code3-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> virtual <span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected virtual Boolean isBatchable() {" id="code3-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> virtual <span class="token class-name">Boolean</span> <span class="token function">isBatchable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return this.resultSize > Limits.getLimitDmlRows() / 3;" id="code3-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resultSize <span class="token operator">&gt;</span> <span class="token class-name">Limits</span><span class="token punctuation">.</span><span class="token function">getLimitDmlRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code3-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public void process() {" id="code3-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    QueryWrapper wrapper = this.getWrapper();" id="code3-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">QueryWrapper</span> wrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //or some other sentinel value you override" id="code3-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//or some other sentinel value you override</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    if(this.isBatchable()) {" id="code3-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isBatchable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      Database.executeBatch(new DataProcessorBatchable(wrapper));" id="code3-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">executeBatch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DataProcessorBatchable</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    } else {" id="code3-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      System.enqueueJob(new DataProcessorQueueable(wrapper));" id="code3-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">enqueueJob</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DataProcessorQueueable</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code3-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code3-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  //I would never do these linebreaks normally" id="code3-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//I would never do these linebreaks normally</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  //but I know it helps with reading on mobile" id="code3-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//but I know it helps with reading on mobile</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private virtual class DataProcessorBatchable" id="code3-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> virtual <span class="token keyword">class</span> <span class="token class-name">DataProcessorBatchable</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    extends DataProcessor" id="code3-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">extends</span> <span class="token class-name">DataProcessor</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    implements Database.Batchable<SObject>, Database.Stateful {" id="code3-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">implements</span> <span class="token class-name">Database<span class="token punctuation">.</span>Batchable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Database<span class="token punctuation">.</span>Stateful</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    private final String queryLocatorString;" id="code3-l41"><span class="lineCounter-0-0-15 -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> queryLocatorString<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    protected DataProcessorBatchable(QueryWrapper wrapper) {" id="code3-l42"><span class="lineCounter-0-0-15 -codedoc-line-counter">42<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">protected</span> <span class="token class-name">DataProcessorBatchable</span><span class="token punctuation">(</span><span class="token class-name">QueryWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      super(wrapper);" id="code3-l43"><span class="lineCounter-0-0-15 -codedoc-line-counter">43<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">super</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //trying to store Database.QueryLocator in an instance" id="code3-l44"><span class="lineCounter-0-0-15 -codedoc-line-counter">44<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//trying to store Database.QueryLocator in an instance</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //variable leads to the dreaded" id="code3-l45"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">45<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//variable leads to the dreaded</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //System.SerializationException:" id="code3-l46"><span class="lineCounter-0-0-15 -codedoc-line-counter">46<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//System.SerializationException:</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //Not Serializable: Database.QueryLocator error" id="code3-l47"><span class="lineCounter-0-0-15 -codedoc-line-counter">47<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//Not Serializable: Database.QueryLocator error</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //cache the cleaned query string for re-use instead" id="code3-l48"><span class="lineCounter-0-0-15 -codedoc-line-counter">48<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//cache the cleaned query string for re-use instead</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.queryLocatorString = wrapper.Locator.getQuery();" id="code3-l49"><span class="lineCounter-0-0-15 -codedoc-line-counter">49<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span>queryLocatorString <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">wrapper<span class="token punctuation">.</span></span>Locator</span><span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code3-l50"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">50<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l51"><span class="lineCounter-0-0-15 -codedoc-line-counter">51<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    public Database.QueryLocator start(Database.BatchableContext context) {" id="code3-l52"><span class="lineCounter-0-0-15 -codedoc-line-counter">52<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token class-name">Database<span class="token punctuation">.</span>QueryLocator</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">Database<span class="token punctuation">.</span>BatchableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.jobId = context.getJobId();" id="code3-l53"><span class="lineCounter-0-0-15 -codedoc-line-counter">53<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span>jobId <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      return Database.getQueryLocator(queryLocatorString);" id="code3-l54"><span class="lineCounter-0-0-15 -codedoc-line-counter">54<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">return</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getQueryLocator</span><span class="token punctuation">(</span>queryLocatorString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code3-l55"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">55<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    public void execute(Database.BatchableContext context, List<SObject> records) {" id="code3-l56"><span class="lineCounter-0-0-15 -codedoc-line-counter">56<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Database<span class="token punctuation">.</span>BatchableContext</span> context<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //if you were doing something really zany here" id="code3-l57"><span class="lineCounter-0-0-15 -codedoc-line-counter">57<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//if you were doing something really zany here</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //and the jobId had changed, you could re-save it here" id="code3-l58"><span class="lineCounter-0-0-15 -codedoc-line-counter">58<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//and the jobId had changed, you could re-save it here</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.execute(records);" id="code3-l59"><span class="lineCounter-0-0-15 -codedoc-line-counter">59<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code3-l60"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">60<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    public void finish(Database.BatchableContext context) {" id="code3-l61"><span class="lineCounter-0-0-15 -codedoc-line-counter">61<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token class-name">Database<span class="token punctuation">.</span>BatchableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //same" id="code3-l62"><span class="lineCounter-0-0-15 -codedoc-line-counter">62<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//same</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.finish();" id="code3-l63"><span class="lineCounter-0-0-15 -codedoc-line-counter">63<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code3-l64"><span class="lineCounter-0-0-15 -codedoc-line-counter">64<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code3-l65"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">65<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l66"><span class="lineCounter-0-0-15 -codedoc-line-counter">66<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private virtual class DataProcessorQueueable" id="code3-l67"><span class="lineCounter-0-0-15 -codedoc-line-counter">67<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> virtual <span class="token keyword">class</span> <span class="token class-name">DataProcessorQueueable</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    extends DataProcessor" id="code3-l68"><span class="lineCounter-0-0-15 -codedoc-line-counter">68<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">extends</span> <span class="token class-name">DataProcessor</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    implements System.Queueable {" id="code3-l69"><span class="lineCounter-0-0-15 -codedoc-line-counter">69<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">implements</span> <span class="token class-name">System<span class="token punctuation">.</span>Queueable</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    private final String query;" id="code3-l70"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">70<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> query<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l71"><span class="lineCounter-0-0-15 -codedoc-line-counter">71<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    protected DataProcessorQueueable(QueryWrapper wrapper) {" id="code3-l72"><span class="lineCounter-0-0-15 -codedoc-line-counter">72<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">protected</span> <span class="token class-name">DataProcessorQueueable</span><span class="token punctuation">(</span><span class="token class-name">QueryWrapper</span> wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      super(wrapper);" id="code3-l73"><span class="lineCounter-0-0-15 -codedoc-line-counter">73<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">super</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.query = wrapper.Locator.getQuery();" id="code3-l74"><span class="lineCounter-0-0-15 -codedoc-line-counter">74<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span>query <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">wrapper<span class="token punctuation">.</span></span>Locator</span><span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code3-l75"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">75<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l76"><span class="lineCounter-0-0-15 -codedoc-line-counter">76<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    public void execute(QueueableContext context) {" id="code3-l77"><span class="lineCounter-0-0-15 -codedoc-line-counter">77<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">QueueableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.jobId = context.getJobId();" id="code3-l78"><span class="lineCounter-0-0-15 -codedoc-line-counter">78<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span>jobId <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.execute(Database.query(query));" id="code3-l79"><span class="lineCounter-0-0-15 -codedoc-line-counter">79<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.finish();" id="code3-l80"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">80<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code3-l81"><span class="lineCounter-0-0-15 -codedoc-line-counter">81<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code3-l82"><span class="lineCounter-0-0-15 -codedoc-line-counter">82<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l83"><span class="lineCounter-0-0-15 -codedoc-line-counter">83<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private class DataProcessorException extends Exception{}" id="code3-l84"><span class="lineCounter-0-0-15 -codedoc-line-counter">84<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DataProcessorException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code3-l85"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">85<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>Unfortunately, I quickly ran into two errors that prevented the <code>DataProcessor</code> class from encapsulating the inner classes:</p><pre class=""><code class="bash -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="#First I had this problem in saving the above:" id="code4-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="termPrefix-0-0-16 -codedoc-code-term-prefix">$</span><span class="token comment">#First I had this problem in saving the above:</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Error: Only top-level classes can implement Database.Batchable<SObject>" id="code4-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="termPrefix-0-0-16 -codedoc-code-term-prefix">$</span>Error: Only top-level classes can implement Database.Batchable<span class="token operator">&lt;</span>SObject<span class="token operator">&gt;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="#Unlucky. Later, in testing the inner Queueable class:" id="code4-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="termPrefix-0-0-16 -codedoc-code-term-prefix">$</span><span class="token comment">#Unlucky. Later, in testing the inner Queueable class:</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.AsyncException: Queueable cannot be implemented with other system interfaces." id="code4-l4"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="termPrefix-0-0-16 -codedoc-code-term-prefix">$</span>System.AsyncException: Queueable cannot be implemented with other system interfaces.</div><br></code></pre><p>This was a bit of a bummer — I was really hoping to safely encapsulate the all of the processing logic within a single Apex class, hiding the implementation details.</p><p>Regardless, we'll still end up with a simple list of methods to override:</p><ul><li><code>QueryWrapper getWrapper()</code> would have to be re-implemented by any consumer to prevent the exception from being thrown. This is because you need to dictate to the <code>DataProcessor</code> what kind of data you're getting</li><li><code>void execute(List&lt;SObject&gt; records)</code> to define all of the processing details for consumers</li><li>optionally, <code>void finish()</code> and the sentinel <code>Boolean isBatchable()</code> for post-processing and for overriding the default implementation when necessary.</li></ul><p>Since the second error I printed above was found while testing, I'll show the tests first:</p><pre class="with-bar"><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span>classes/DataProcessor_Tests.cls</span></span><div class="line-0-0-18  -codedoc-code-line" data-content="@isTest" id="code5-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private class DataProcessorTests {" id="code5-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DataProcessorTests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @TestSetup" id="code5-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@TestSetup</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  static void setup() {" id="code5-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    insert new Account(Name = ACCOUNT_NAME);" id="code5-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    insert <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Name</span> <span class="token operator">=</span> ACCOUNT_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @isTest" id="code5-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  static void it_should_run_as_queueable_for_small_record_sizes() {" id="code5-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_run_as_queueable_for_small_record_sizes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    runTest();" id="code5-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token function">runTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    System.assertEquals(" id="code5-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      'Completed'," id="code5-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token string">'Completed'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      [SELECT Status FROM AsyncApexJob WHERE JobType = 'Queueable'].Status" id="code5-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">[</span>SELECT <span class="token class-name">Status</span> FROM <span class="token class-name">AsyncApexJob</span> WHERE <span class="token class-name">JobType</span> <span class="token operator">=</span> <span class="token string">'Queueable'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Status</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    );" id="code5-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //ensure batch didn't also run" id="code5-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//ensure batch didn't also run</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    System.assertEquals(" id="code5-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      0," id="code5-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token number">0</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      [SELECT Id FROM AsyncApexJob WHERE JobType = 'BatchApexWorker'].size()" id="code5-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span> FROM <span class="token class-name">AsyncApexJob</span> WHERE <span class="token class-name">JobType</span> <span class="token operator">=</span> <span class="token string">'BatchApexWorker'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    );" id="code5-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @isTest" id="code5-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  static void it_should_run_as_batchable_when_instructed_to() {" id="code5-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_run_as_batchable_when_instructed_to</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    batchable = true;" id="code5-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    batchable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    runTest();" id="code5-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token function">runTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    System.assertEquals(" id="code5-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      'Completed'," id="code5-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token string">'Completed'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      [SELECT Status FROM AsyncApexJob WHERE JobType = 'BatchApexWorker'].Status" id="code5-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">[</span>SELECT <span class="token class-name">Status</span> FROM <span class="token class-name">AsyncApexJob</span> WHERE <span class="token class-name">JobType</span> <span class="token operator">=</span> <span class="token string">'BatchApexWorker'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Status</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    );" id="code5-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //ensure queueable didn't also run" id="code5-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//ensure queueable didn't also run</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    System.assertEquals(" id="code5-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      0," id="code5-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token number">0</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      [SELECT Id FROM AsyncApexJob WHERE JobType = 'Queueable'].size()" id="code5-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span> FROM <span class="token class-name">AsyncApexJob</span> WHERE <span class="token class-name">JobType</span> <span class="token operator">=</span> <span class="token string">'Queueable'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    );" id="code5-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  static void runTest() {" id="code5-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Test.startTest();" id="code5-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">startTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //for actual implementers, you would actually" id="code5-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//for actual implementers, you would actually</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //be calling Factory.getFactory().getTheImplementer.process();" id="code5-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//be calling Factory.getFactory().getTheImplementer.process();</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    new TestAccountProcessor(Factory.getFactory()).process();" id="code5-l41"><span class="lineCounter-0-0-15 -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">new</span> <span class="token class-name">TestAccountProcessor</span><span class="token punctuation">(</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Test.stopTest();" id="code5-l42"><span class="lineCounter-0-0-15 -codedoc-line-counter">42<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">stopTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l43"><span class="lineCounter-0-0-15 -codedoc-line-counter">43<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Account updatedAccount = [SELECT Name FROM Account];" id="code5-l44"><span class="lineCounter-0-0-15 -codedoc-line-counter">44<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Account</span> updatedAccount <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Name</span> FROM <span class="token class-name">Account</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    System.assertEquals(ACCOUNT_NAME + ' TestAccountProcessor', updatedAccount.Name);" id="code5-l45"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">45<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>ACCOUNT_NAME <span class="token operator">+</span> <span class="token string">' TestAccountProcessor'</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">updatedAccount<span class="token punctuation">.</span></span>Name</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    System.assertEquals(true, finished);" id="code5-l46"><span class="lineCounter-0-0-15 -codedoc-line-counter">46<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> finished<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l47"><span class="lineCounter-0-0-15 -codedoc-line-counter">47<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l48"><span class="lineCounter-0-0-15 -codedoc-line-counter">48<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  static Boolean batchable = false;" id="code5-l49"><span class="lineCounter-0-0-15 -codedoc-line-counter">49<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">static</span> <span class="token class-name">Boolean</span> batchable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  static Boolean finished = false;" id="code5-l50"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">50<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">static</span> <span class="token class-name">Boolean</span> finished <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  static String ACCOUNT_NAME = 'Hi';" id="code5-l51"><span class="lineCounter-0-0-15 -codedoc-line-counter">51<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">static</span> <span class="token class-name">String</span> ACCOUNT_NAME <span class="token operator">=</span> <span class="token string">'Hi'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l52"><span class="lineCounter-0-0-15 -codedoc-line-counter">52<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private class TestAccountProcessor extends DataProcessor {" id="code5-l53"><span class="lineCounter-0-0-15 -codedoc-line-counter">53<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">TestAccountProcessor</span> <span class="token keyword">extends</span> <span class="token class-name">DataProcessor</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    private final IRepository accountRepo;" id="code5-l54"><span class="lineCounter-0-0-15 -codedoc-line-counter">54<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">IRepository</span> accountRepo<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    public TestAccountProcessor(Factory factory) {" id="code5-l55"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">55<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token class-name">TestAccountProcessor</span><span class="token punctuation">(</span><span class="token class-name">Factory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      super(factory);" id="code5-l56"><span class="lineCounter-0-0-15 -codedoc-line-counter">56<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">super</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //check out the Factory post if" id="code5-l57"><span class="lineCounter-0-0-15 -codedoc-line-counter">57<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//check out the Factory post if</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //you're scratching your head looking at this!" id="code5-l58"><span class="lineCounter-0-0-15 -codedoc-line-counter">58<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//you're scratching your head looking at this!</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.accountRepo = factory.RepoFactory.getAccountRepo();" id="code5-l59"><span class="lineCounter-0-0-15 -codedoc-line-counter">59<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span>accountRepo <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">factory<span class="token punctuation">.</span></span>RepoFactory</span><span class="token punctuation">.</span><span class="token function">getAccountRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code5-l60"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">60<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l61"><span class="lineCounter-0-0-15 -codedoc-line-counter">61<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //a simple implementation that fetches all accounts" id="code5-l62"><span class="lineCounter-0-0-15 -codedoc-line-counter">62<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//a simple implementation that fetches all accounts</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //with the hard-coded name ... but in reality you could be" id="code5-l63"><span class="lineCounter-0-0-15 -codedoc-line-counter">63<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//with the hard-coded name ... but in reality you could be</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //querying up to 50 million rows!" id="code5-l64"><span class="lineCounter-0-0-15 -codedoc-line-counter">64<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//querying up to 50 million rows!</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    protected override QueryWrapper getWrapper() {" id="code5-l65"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">65<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">protected</span> override <span class="token class-name">QueryWrapper</span> <span class="token function">getWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      return this.accountRepo.getWrapper(" id="code5-l66"><span class="lineCounter-0-0-15 -codedoc-line-counter">66<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accountRepo<span class="token punctuation">.</span><span class="token function">getWrapper</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        new Query(Account.Name, Query.Operator.EQUALS, ACCOUNT_NAME)" id="code5-l67"><span class="lineCounter-0-0-15 -codedoc-line-counter">67<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token class-name">Account<span class="token punctuation">.</span>Name</span><span class="token punctuation">,</span> <span class="token class-name">Query<span class="token punctuation">.</span>Operator</span><span class="token punctuation">.</span>EQUALS<span class="token punctuation">,</span> ACCOUNT_NAME<span class="token punctuation">)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      );" id="code5-l68"><span class="lineCounter-0-0-15 -codedoc-line-counter">68<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code5-l69"><span class="lineCounter-0-0-15 -codedoc-line-counter">69<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l70"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">70<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //a really terrible example implementation" id="code5-l71"><span class="lineCounter-0-0-15 -codedoc-line-counter">71<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//a really terrible example implementation</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //but the sky's the limit, really" id="code5-l72"><span class="lineCounter-0-0-15 -codedoc-line-counter">72<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//but the sky's the limit, really</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //once this thing's kicked off, it can safely run" id="code5-l73"><span class="lineCounter-0-0-15 -codedoc-line-counter">73<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//once this thing's kicked off, it can safely run</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //with however many records were queried for" id="code5-l74"><span class="lineCounter-0-0-15 -codedoc-line-counter">74<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//with however many records were queried for</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    //in your getWrapper method" id="code5-l75"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">75<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//in your getWrapper method</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    protected override void execute(List<SObject> records) {" id="code5-l76"><span class="lineCounter-0-0-15 -codedoc-line-counter">76<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">protected</span> override <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      List<Account> accounts = (List<Account>) records;" id="code5-l77"><span class="lineCounter-0-0-15 -codedoc-line-counter">77<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> records<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      for(Account acc : accounts) {" id="code5-l78"><span class="lineCounter-0-0-15 -codedoc-line-counter">78<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Account</span> acc <span class="token operator">:</span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        acc.Name = acc.Name + ' TestAccountProcessor';" id="code5-l79"><span class="lineCounter-0-0-15 -codedoc-line-counter">79<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name"><span class="token namespace">acc<span class="token punctuation">.</span></span>Name</span> <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">acc<span class="token punctuation">.</span></span>Name</span> <span class="token operator">+</span> <span class="token string">' TestAccountProcessor'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code5-l80"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">80<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.accountRepo.doUpdate(accounts);" id="code5-l81"><span class="lineCounter-0-0-15 -codedoc-line-counter">81<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span>accountRepo<span class="token punctuation">.</span><span class="token function">doUpdate</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code5-l82"><span class="lineCounter-0-0-15 -codedoc-line-counter">82<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l83"><span class="lineCounter-0-0-15 -codedoc-line-counter">83<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    protected override void finish() {" id="code5-l84"><span class="lineCounter-0-0-15 -codedoc-line-counter">84<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">protected</span> override <span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      finished = true;" id="code5-l85"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">85<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      finished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code5-l86"><span class="lineCounter-0-0-15 -codedoc-line-counter">86<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l87"><span class="lineCounter-0-0-15 -codedoc-line-counter">87<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    protected override Boolean isBatchable() {" id="code5-l88"><span class="lineCounter-0-0-15 -codedoc-line-counter">88<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">protected</span> override <span class="token class-name">Boolean</span> <span class="token function">isBatchable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      return !batchable ? super.isBatchable() : batchable;" id="code5-l89"><span class="lineCounter-0-0-15 -codedoc-line-counter">89<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">return</span> <span class="token operator">!</span>batchable <span class="token operator">?</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">isBatchable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> batchable<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code5-l90"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">90<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l91"><span class="lineCounter-0-0-15 -codedoc-line-counter">91<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code5-l92"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">92<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><h2 id="fixing-the-dataprocessor" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Fixing the DataProcessor</h2><p>I had to break the inner classes out into their own classes to get things working properly due to the limitations in inner classes shown above. Here's how things ended up:</p><pre class="with-bar"><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span>classes/DataProcessor.cls</span></span><div class="line-0-0-18  -codedoc-code-line" data-content="public abstract class DataProcessor {" id="code6-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">DataProcessor</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected final Integer resultSize;" id="code6-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> resultSize<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected final DataProcessor processor;" id="code6-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">DataProcessor</span> processor<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected Id jobId;" id="code6-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> <span class="token class-name">Id</span> jobId<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public DataProcessor(Factory factory) { }" id="code6-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">DataProcessor</span><span class="token punctuation">(</span><span class="token class-name">Factory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  //when you see a constructor like this" id="code6-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//when you see a constructor like this</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  //you know you're in for a good time" id="code6-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//you know you're in for a good time</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected DataProcessor(QueryWrapper wrapper, DataProcessor processor) {" id="code6-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> <span class="token class-name">DataProcessor</span><span class="token punctuation">(</span><span class="token class-name">QueryWrapper</span> wrapper<span class="token punctuation">,</span> <span class="token class-name">DataProcessor</span> processor<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.resultSize = wrapper.ResultSize;" id="code6-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span>resultSize <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">wrapper<span class="token punctuation">.</span></span>ResultSize</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.processor = processor;" id="code6-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span>processor <span class="token operator">=</span> processor<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected virtual QueryWrapper getWrapper() {" id="code6-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> virtual <span class="token class-name">QueryWrapper</span> <span class="token function">getWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    throw new DataProcessorException('Not Implemented');" id="code6-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DataProcessorException</span><span class="token punctuation">(</span><span class="token string">'Not Implemented'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected virtual void execute(List<SObject> records) { }" id="code6-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> virtual <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected virtual void finish() { }" id="code6-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> virtual <span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected virtual Boolean isBatchable() {" id="code6-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> virtual <span class="token class-name">Boolean</span> <span class="token function">isBatchable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return this.resultSize > Limits.getLimitDmlRows() / 3;" id="code6-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resultSize <span class="token operator">&gt;</span> <span class="token class-name">Limits</span><span class="token punctuation">.</span><span class="token function">getLimitDmlRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public void process() {" id="code6-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    QueryWrapper wrapper = this.getWrapper();" id="code6-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">QueryWrapper</span> wrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    if(this.isBatchable()) {" id="code6-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isBatchable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //pass the current instance now that dependencies" id="code6-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//pass the current instance now that dependencies</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      //have been setup" id="code6-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">//have been setup</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      Database.executeBatch(new DataProcessorBatchable(wrapper, this));" id="code6-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">executeBatch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DataProcessorBatchable</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    } else {" id="code6-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      System.enqueueJob(new DataProcessorQueueable(wrapper, this));" id="code6-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">enqueueJob</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DataProcessorQueueable</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code6-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private class DataProcessorException extends Exception{}" id="code6-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DataProcessorException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code6-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="public virtual class DataProcessorBatchable" id="code6-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> virtual <span class="token keyword">class</span> <span class="token class-name">DataProcessorBatchable</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  extends DataProcessor" id="code6-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">extends</span> <span class="token class-name">DataProcessor</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  //etc, in either of these" id="code6-l41"><span class="lineCounter-0-0-15 -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//etc, in either of these</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  //you might need Database.Callout as well" id="code6-l42"><span class="lineCounter-0-0-15 -codedoc-line-counter">42<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">//you might need Database.Callout as well</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  implements Database.Batchable<SObject>, Database.Stateful {" id="code6-l43"><span class="lineCounter-0-0-15 -codedoc-line-counter">43<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">implements</span> <span class="token class-name">Database<span class="token punctuation">.</span>Batchable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Database<span class="token punctuation">.</span>Stateful</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private final String queryLocatorString;" id="code6-l44"><span class="lineCounter-0-0-15 -codedoc-line-counter">44<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> queryLocatorString<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public DataProcessorBatchable(QueryWrapper wrapper, DataProcessor processor) {" id="code6-l45"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">45<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">DataProcessorBatchable</span><span class="token punctuation">(</span><span class="token class-name">QueryWrapper</span> wrapper<span class="token punctuation">,</span> <span class="token class-name">DataProcessor</span> processor<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      super(wrapper, processor);" id="code6-l46"><span class="lineCounter-0-0-15 -codedoc-line-counter">46<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">super</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.queryLocatorString = wrapper.Locator.getQuery();" id="code6-l47"><span class="lineCounter-0-0-15 -codedoc-line-counter">47<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span>queryLocatorString <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">wrapper<span class="token punctuation">.</span></span>Locator</span><span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l48"><span class="lineCounter-0-0-15 -codedoc-line-counter">48<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l49"><span class="lineCounter-0-0-15 -codedoc-line-counter">49<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public Database.QueryLocator start(Database.BatchableContext context) {" id="code6-l50"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">50<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">Database<span class="token punctuation">.</span>QueryLocator</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">Database<span class="token punctuation">.</span>BatchableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.jobId = context.getJobId();" id="code6-l51"><span class="lineCounter-0-0-15 -codedoc-line-counter">51<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span>jobId <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return Database.getQueryLocator(queryLocatorString);" id="code6-l52"><span class="lineCounter-0-0-15 -codedoc-line-counter">52<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getQueryLocator</span><span class="token punctuation">(</span>queryLocatorString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l53"><span class="lineCounter-0-0-15 -codedoc-line-counter">53<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public void execute(Database.BatchableContext context, List<SObject> records) {" id="code6-l54"><span class="lineCounter-0-0-15 -codedoc-line-counter">54<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Database<span class="token punctuation">.</span>BatchableContext</span> context<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.processor.execute(records);" id="code6-l55"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">55<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l56"><span class="lineCounter-0-0-15 -codedoc-line-counter">56<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public void finish(Database.BatchableContext context) {" id="code6-l57"><span class="lineCounter-0-0-15 -codedoc-line-counter">57<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token class-name">Database<span class="token punctuation">.</span>BatchableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.processor.finish();" id="code6-l58"><span class="lineCounter-0-0-15 -codedoc-line-counter">58<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l59"><span class="lineCounter-0-0-15 -codedoc-line-counter">59<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code6-l60"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">60<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l61"><span class="lineCounter-0-0-15 -codedoc-line-counter">61<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="public virtual class DataProcessorQueueable" id="code6-l62"><span class="lineCounter-0-0-15 -codedoc-line-counter">62<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> virtual <span class="token keyword">class</span> <span class="token class-name">DataProcessorQueueable</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  extends DataProcessor" id="code6-l63"><span class="lineCounter-0-0-15 -codedoc-line-counter">63<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">extends</span> <span class="token class-name">DataProcessor</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  implements System.Queueable {" id="code6-l64"><span class="lineCounter-0-0-15 -codedoc-line-counter">64<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">implements</span> <span class="token class-name">System<span class="token punctuation">.</span>Queueable</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private final String query;" id="code6-l65"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">65<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> query<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l66"><span class="lineCounter-0-0-15 -codedoc-line-counter">66<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public DataProcessorQueueable(QueryWrapper wrapper, DataProcessor processor) {" id="code6-l67"><span class="lineCounter-0-0-15 -codedoc-line-counter">67<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">DataProcessorQueueable</span><span class="token punctuation">(</span><span class="token class-name">QueryWrapper</span> wrapper<span class="token punctuation">,</span> <span class="token class-name">DataProcessor</span> processor<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      super(wrapper, processor);" id="code6-l68"><span class="lineCounter-0-0-15 -codedoc-line-counter">68<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">super</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.query = wrapper.Locator.getQuery();" id="code6-l69"><span class="lineCounter-0-0-15 -codedoc-line-counter">69<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span>query <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">wrapper<span class="token punctuation">.</span></span>Locator</span><span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l70"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">70<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l71"><span class="lineCounter-0-0-15 -codedoc-line-counter">71<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public void execute(QueueableContext context) {" id="code6-l72"><span class="lineCounter-0-0-15 -codedoc-line-counter">72<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">QueueableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.jobId = context.getJobId();" id="code6-l73"><span class="lineCounter-0-0-15 -codedoc-line-counter">73<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span>jobId <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.processor.execute(Database.query(query));" id="code6-l74"><span class="lineCounter-0-0-15 -codedoc-line-counter">74<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      this.processor.finish();" id="code6-l75"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">75<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">this</span><span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l76"><span class="lineCounter-0-0-15 -codedoc-line-counter">76<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code6-l77"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">77<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><h2 id="batchable--queueable-summary" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Batchable &amp; Queueable Summary</h2><p>And the <code>DataProcessorTests</code> pass (in a third of a second, no less). It's important to note that passing the current processor instance using <code>this</code> in <code>DataProcessor.process</code> is the key to success here. This allows the Queueable / Batchable implementation to <em>only</em> care about fulfilling the Salesforce interface requirements, while delegating the processing methodology to actual consumers. This also allows you to only test the things you need to test; the business logic written into the <code>execute</code> methods.</p><p>Though it requires three classes to properly setup the DataProcessor, I'm pleased with the results of this particular experiment. No more worrying about whether or not your Queueable is going to accidentally end up trying to process too many things. That's a great safety net to have! Plus, if your org rarely ventures into Batchable territory, if batches do end getting enqueued as query results grow in size, they'll have the chance to run at reasonable speeds (it's only when you're already heavily reliant on batches that slowdowns occur).</p><p>Another thing to note — did anybody catch the missed opportunity on Salesforce's side in not having the <code>Context</code> objects inherit in a sane way? It's a shame that there isn't some base class with something like a <code>createdFromId</code> method; I'm fine with there being <code>QueueableContext</code>, and <code>SchedulableContext</code> and <code>BatchableContext</code> interfaces, etc ... but it's not very object-oriented, considering that in the end, regardless of what the context is, you're getting an Id related to the object's initialization.</p><p>So what do you think? Is the <code>DataProcessor</code> pattern something you're interested in implementing in your own org(s)? You can browse the full source code for this example on <a href="https://github.com/jamessimone/apex-mocks-stress-test/tree/data-processor">my Github</a>. I hope that this entry in the <a href="/joys-of-apex/">Joys Of Apex</a> has proven enjoyable; stick around and check out the other posts if you're arriving here for the first time, and thanks for reading!</p><p>The original version of <a href="https://www.jamessimone.net/blog/joys-of-apex/batchable-and-queueable-apex/">Batchable &amp; Queueable Apex can be read on my blog.</a></p><p>As well, I've now made use of this pattern in my <a href="/joys-of-apex/replacing-dlrs-with-custom-rollup">Custom Rollup</a> solution!</p><div class="contentnav-0-0-7" data-no-search=""><a href="#introducing-the-dataprocessor" class="h2" data-content-highlight="introducing-the-dataprocessor">Introducing the DataProcessor</a><a href="#fixing-the-dataprocessor" class="h2" data-content-highlight="fixing-the-dataprocessor">Fixing the DataProcessor</a><a href="#batchable--queueable-summary" class="h2" data-content-highlight="batchable--queueable-summary">Batchable &amp; Queueable Summary</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/formula-date-issues">Formula Date Issues</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/lwc-custom-path">LWC Custom Lead Path</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/refactoring-tips-and-tricks">Refactoring Tips &amp; Tricks</a>
<a href="/joys-of-apex/replacing-dlrs-with-custom-rollup">Replacing DLRS With Custom Rollup</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/set-timeout-and-implementing-delays">setTimeout &amp; Implementing Delays</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/testing-custom-permissions">Testing Custom Permissions</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="bwoUile_SO">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("bwoUile_SO", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="hPCIhnecMd">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("hPCIhnecMd", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="iCIxfsycDO">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("iCIxfsycDO", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>