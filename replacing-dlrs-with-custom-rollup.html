<!DOCTYPE html><html><head><title>Joys Of Apex | Replacing DLRS With Custom Rollup</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons%7CMaterial+Icons+Outlined&amp;display=swap" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Replacing DLRS With Custom Rollup"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Replacing DLRS With Custom Rollup"><meta name="keywords" content=""><meta property="blog-tags" content=""></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"replacing-dlrs-with-custom-rollup.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Replacing DLRS With Custom Rollup</p></span></h1><script id="_FQgkXhWbq">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("_FQgkXhWbq", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2020-12-31T15:00:00.000Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>A few months ago I was tasked with replacing Declarative Lookup Rollup Summaries (DLRS) in an org suffering from frequent deadlocks. Rollup summary fields in Salesforce are plagued by severe limitations -- only being available on master-detail relationships being <a href="#custom-rollup-use-cases">just the start of the list.</a> When faced with implementing custom rollups, most people go with DLRS because it's free. Performance in the org inevitably suffers.</p><p>Read on to learn about how I built <code>Rollup</code>, complete with elastic scaling (go fast when you need to, slow when there are more rollups to process), to assist in orgs looking for DLRS-like flexibility with a much smaller performance overhead.</p><p>Discover how the "Google Analytics" approach to implementing rollups in your Salesforce org gives you the flexibility and power that you need - install with:</p><ul><li><a href="#one-line-of-code"> <em>one line of code</em></a> in any trigger</li><li>no code at all, <a href="#from-flow">using Custom Metadata and an Invocable method</a></li><li>the SOQL query of your choice (pre-tested to ensure it runs) on the schedule of your choosing</li></ul><p><strong>OR</strong> opt-into truly powerful code-based hooks that allow you to perform custom-based filtering using a simple <code>Evaluator</code> interface.</p><p>Keep reading, or <a href="https://github.com/jamessimone/apex-rollup/">check out the repository Readme for more</a>!</p><marker><h2 id="custom-rollup-use-cases">Use Cases For Custom Rollups</h2>

</marker><p>Let's look at some of the problem areas experienced when implementing rollup fields:</p><ul><li>We want to rollup values from one lookup relationship to another related object</li><li>We want to rollup based on criteria on the "parent" record, or perhaps even criteria on another related record</li><li>We want to rollup to different fields based on the filtering criteria we've defined (fields like <code>TotalOfGroupA__c</code> and <code>TotalOfGroupB__c</code>)</li><li>We need to data-fix existing rows to have the correct calculations</li><li>We want to rollup values that are unsupported (Opportunity Close Date can be MIN/MAX'd ... but not Task Activity Date?? Who wrote this manual?!)</li><li>We have fields on a related object that can by synthesized to form a value matching that of another field/fields on another object, and using formula fields to create a "key" field would lead to bad performance</li></ul><p>The list could go on and on. None of these use cases are supported with out-of-the-box Salesforce. You can see in many areas of the platform that providing developers with ways to augment the existing behavior for out-of-the-box features leads to awesome customizations. With rollups, we don't have the ability through the UI to specify something like an overriding Apex class; we have no interface to implement. No -- if we want something better, we have to build it ourselves.</p><h2 id="introducing-rollup" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Introducing Rollup</h2><p>With the stage set and the problem well-defined, let's take a look at the beginnings of the <code>Rollup</code> project by examining how to invoke it from within a Trigger Handler class:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// within the &quot;MyCustomObject__c&quot; trigger handler" id="code1-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// within the "MyCustomObject__c" trigger handler</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code1-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// I'm aware it's not the sexiest interface. Keeping track of which field is which" id="code1-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// I'm aware it's not the sexiest interface. Keeping track of which field is which</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// is now engraved in my head, but I'll annotate for now" id="code1-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// is now engraved in my head, but I'll annotate for now</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// I expect most people will be using CMDT to manage these fields, anyway" id="code1-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// I expect most people will be using CMDT to manage these fields, anyway</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code1-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="RollupCalculator.sumFromTrigger( // the rollup operation" id="code1-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">RollupCalculator</span><span class="token punctuation">.</span><span class="token function">sumFromTrigger</span><span class="token punctuation">(</span> <span class="token comment">// the rollup operation</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  MyCustomObject__c.Amount__c, // the field that will inform the rollup" id="code1-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">MyCustomObject__c<span class="token punctuation">.</span>Amount__c</span><span class="token punctuation">,</span> <span class="token comment">// the field that will inform the rollup</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  MyCustomObject__c.OwnerId, // the field on MyCustomObject related to the next argument, the matching field on the related object" id="code1-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">MyCustomObject__c<span class="token punctuation">.</span>OwnerId</span><span class="token punctuation">,</span> <span class="token comment">// the field on MyCustomObject related to the next argument, the matching field on the related object</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  User.Id, // the matching field on the object where the rollup will be performed" id="code1-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">User<span class="token punctuation">.</span>Id</span><span class="token punctuation">,</span> <span class="token comment">// the matching field on the object where the rollup will be performed</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  User.TotalCustomAmount__c, // the field where the rollup will be written to" id="code1-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">User<span class="token punctuation">.</span>TotalCustomAmount__c</span><span class="token punctuation">,</span> <span class="token comment">// the field where the rollup will be written to</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  new IsFlaggedBySalesUser(), // optional - a way to filter the &quot;newCustomObjects&quot; for ones that match" id="code1-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">new</span> <span class="token class-name">IsFlaggedBySalesUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// optional - a way to filter the "newCustomObjects" for ones that match</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  User.SObjectType // the related object where the rollup will be informed" id="code1-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">User<span class="token punctuation">.</span>SObjectType</span> <span class="token comment">// the related object where the rollup will be informed</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content=");" id="code1-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code1-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private class IsFlaggedBySalesUser implements Rollup.Evaluator {" id="code1-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">IsFlaggedBySalesUser</span> <span class="token keyword">implements</span> <span class="token class-name">Rollup<span class="token punctuation">.</span>Evaluator</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public Boolean matches(Object calcItem) {" id="code1-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Object</span> calcItem<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    MyCustomObject__c customObj = (MyCustomObject__c)calcItem;" id="code1-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">MyCustomObject__c</span> customObj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MyCustomObject__c</span><span class="token punctuation">)</span>calcItem<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return customObj.IsFlaggedBySalesUser__c;" id="code1-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token class-name"><span class="token namespace">customObj<span class="token punctuation">.</span></span>IsFlaggedBySalesUser__c</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code1-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code1-l21"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>In order to create something within Apex that can capture <em>everything</em> necessary for performing rollups in a generic way, many arguments are required. You <em>could</em> get rid of that last argument -- the <code>SObjectType</code> -- but, sadly, there is no method on the existing <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_methods_system_fields_describe.htm#apex_methods_system_fields_describe">DescribeFieldResult class</a> that points to the object it was initialized from.</p><h3 id="getting-the-sobjecttype-from-an-sobjectfield" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Getting The SObjectType From An SObjectField</h3><p>There is a workaround that's been floating around the Salesforce Stack Exchange for several years:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="public static SObjectType getSObjectType(Schema.SObjectField field) {" id="code2-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SObjectType</span> <span class="token function">getSObjectType</span><span class="token punctuation">(</span><span class="token class-name">Schema<span class="token punctuation">.</span>SObjectField</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // This is a solution that was proposed on the Salesforce stack exchange" id="code2-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// This is a solution that was proposed on the Salesforce stack exchange</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // and is the only work-around to a native lookup" id="code2-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// and is the only work-around to a native lookup</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // that I have been able to find." id="code2-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// that I have been able to find.</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Integer fieldHash = ((Object)field).hashCode();" id="code2-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Integer</span> fieldHash <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span>field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // Build a map of hashcodes for each fieldDescribe token" id="code2-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// Build a map of hashcodes for each fieldDescribe token</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Map<String, Schema.SObjectType> globalDescribe = Schema.getGlobalDescribe();" id="code2-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Schema<span class="token punctuation">.</span>SObjectType</span><span class="token punctuation">&gt;</span></span> globalDescribe <span class="token operator">=</span> <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">getGlobalDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Map<Integer,Schema.SObjectType> fieldHashCodeToSObjectTypeMap = new Map<Integer,Schema.SObjectType>();" id="code2-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">Schema<span class="token punctuation">.</span>SObjectType</span><span class="token punctuation">&gt;</span></span> fieldHashCodeToSObjectTypeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">Schema<span class="token punctuation">.</span>SObjectType</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  for (String sobjname: globalDescribe.keySet()) {" id="code2-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> sobjname<span class="token operator">:</span> globalDescribe<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    for (Schema.SObjectField sobjField : globalDescribe.get(sObjName).getDescribe().fields.getMap().values())" id="code2-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Schema<span class="token punctuation">.</span>SObjectField</span> sobjField <span class="token operator">:</span> globalDescribe<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sObjName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fields<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      fieldHashCodeToSObjectTypeMap.put(((Object) sObjField).hashCode(), globalDescribe.get(sobjName));" id="code2-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      fieldHashCodeToSObjectTypeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span> sObjField<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> globalDescribe<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sobjName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code2-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code2-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // hard to believe it, but this actually works! it's a testament to the Describe objects, really:" id="code2-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// hard to believe it, but this actually works! it's a testament to the Describe objects, really:</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // it means that any SObjectField token is a singleton! still, I would NEVER use this in production-level code" id="code2-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// it means that any SObjectField token is a singleton! still, I would NEVER use this in production-level code</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  return fieldHashCodeToSObjectTypeMap.get(fieldHash);" id="code2-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> fieldHashCodeToSObjectTypeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fieldHash<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code2-l18"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>Yikes. While that <em>works</em>, it falls down when you want to further generalize; it only works with strongly-typed <code>SObjectField</code>s; while the use of <code>SObjectField</code> types is a great experience for the developer, they too have shortcomings -- like not supporting parent or child relationships. While it's perfectly valid, using the <code>MyCustomObject__c</code> SObject from above, to reference <code>MyCustomOject__c.Owner.Name</code>, for example, you cannot construct an <code>SObjectField</code> to represent that relationship. Likewise with child relationships. The solution to replace DLRS will need strong ties into an easy-to-use invocable method, and sadly <code>SObjectField</code> is not yet supported as an argument type for Invocable Apex actions.</p><p>Additionally, a note on design -- after even the briefest of forays into the DLRS codebase had me clawing at my eyes, I made the decision to <em>only use one class</em> (and a test class). Isolating the mechanics of the rollups solely within the <code>Rollup</code> class would mean striking a delicate balance between creating a "god class" and adhering to the Single Responsibility Principle.</p><p>Shortcomings aside, the core code in <code>Rollup</code> is worth examining -- let's go deeper.</p><h3 id="implementing-rollups-in-apex" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Implementing Rollups In Apex</h3><p>Without further ado, let's look at some of the key methods in the initial version of <code>Rollup</code>:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// in Rollup" id="code3-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// in Rollup</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// AVG, MAX, MIN, COUNT operations not yet implemented" id="code3-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// AVG, MAX, MIN, COUNT operations not yet implemented</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// because SUM was the only initial ask" id="code3-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// because SUM was the only initial ask</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private enum Op {" id="code3-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">Op</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  SUM," id="code3-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  SUM<span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  UPDATE_SUM," id="code3-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  UPDATE_SUM<span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  DELETE_SUM" id="code3-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  DELETE_SUM</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code3-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// for really powerful up-front filtering of which items" id="code3-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// for really powerful up-front filtering of which items</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// are rolled up, supplying an implementation of the Evaluator" id="code3-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// are rolled up, supplying an implementation of the Evaluator</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// interface does the trick nicely" id="code3-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// interface does the trick nicely</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="public interface Evaluator {" id="code3-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Evaluator</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Boolean matches(Object calcItem);" id="code3-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Object</span> calcItem<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code3-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// refer to the &quot;IsFlaggedBySalesUser&quot; example above" id="code3-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// refer to the "IsFlaggedBySalesUser" example above</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private static List<SObject> filter(List<SObject> calcItems, Evaluator eval) {" id="code3-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> calcItems<span class="token punctuation">,</span> <span class="token class-name">Evaluator</span> eval<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  List<SObject> applicableItems = new List<SObject>();" id="code3-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> applicableItems <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  for(SObject calcItem : calcItems) {" id="code3-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> calcItem <span class="token operator">:</span> calcItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    if(eval != null &amp;&amp; eval.matches(calcItem)) {" id="code3-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">if</span><span class="token punctuation">(</span>eval <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> eval<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>calcItem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      applicableItems.add(calcItem);" id="code3-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      applicableItems<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>calcItem<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code3-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code3-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  return applicableItems;" id="code3-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> applicableItems<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code3-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// key the SObjects passed in to the String value" id="code3-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// key the SObjects passed in to the String value</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// matching the key on the object where the rollup" id="code3-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// matching the key on the object where the rollup</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// will be performed" id="code3-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// will be performed</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private Map<String, List<SObject>> getCalcItemsByLookupField() {" id="code3-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCalcItemsByLookupField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Map<String, List<SObject>> lookupFieldToCalcItems = new Map<String, List<SObject>>();" id="code3-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> lookupFieldToCalcItems <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  for(SObject calcItem : this.calcItems) {" id="code3-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> calcItem <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>calcItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    String key = (String)calcItem.get(this.lookupFieldOnCalcItem);" id="code3-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>calcItem<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lookupFieldOnCalcItem<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    if(lookupFieldToCalcItems.containsKey(key) == false) {" id="code3-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">if</span><span class="token punctuation">(</span>lookupFieldToCalcItems<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      lookupFieldToCalcItems.put(key, new List<SObject>{ calcItem };" id="code3-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      lookupFieldToCalcItems<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> calcItem <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    } else {" id="code3-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      lookupFieldToCalcItems.get(key).add(calcItem);" id="code3-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      lookupFieldToCalcItems<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>calcItem<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code3-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code3-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  return lookupFieldToCalcItems;" id="code3-l41"><span class="lineCounter-0-0-15 -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> lookupFieldToCalcItems<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code3-l42"><span class="lineCounter-0-0-15 -codedoc-line-counter">42<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l43"><span class="lineCounter-0-0-15 -codedoc-line-counter">43<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// your garden-variety dynamic SOQL" id="code3-l44"><span class="lineCounter-0-0-15 -codedoc-line-counter">44<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// your garden-variety dynamic SOQL</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private List<SObject> getLookupItems(Set<String> objIds) {" id="code3-l45"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">45<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLookupItems</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> objIds<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  String queryString =" id="code3-l46"><span class="lineCounter-0-0-15 -codedoc-line-counter">46<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">String</span> queryString <span class="token operator">=</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    'SELECT Id, ' + this.lookupObjOpField.getDescribe().getName() +" id="code3-l47"><span class="lineCounter-0-0-15 -codedoc-line-counter">47<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token string">'SELECT Id, '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lookupObjOpField<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    '\nFROM ' + this.lookupObj.getDescribe().getName() +" id="code3-l48"><span class="lineCounter-0-0-15 -codedoc-line-counter">48<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token string">'\nFROM '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lookupObj<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    '\nWHERE ' + this.lookupField.getDescribe().getName() + ' = :objIds';" id="code3-l49"><span class="lineCounter-0-0-15 -codedoc-line-counter">49<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token string">'\nWHERE '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lookupField<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' = :objIds'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  return Database.query(queryString);" id="code3-l50"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">50<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code3-l51"><span class="lineCounter-0-0-15 -codedoc-line-counter">51<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l52"><span class="lineCounter-0-0-15 -codedoc-line-counter">52<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// the meat of the Rollup" id="code3-l53"><span class="lineCounter-0-0-15 -codedoc-line-counter">53<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// the meat of the Rollup</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private void performRollup(Map<String, List<SObject>> calcItemsByLookupField, List<SObject> lookupItems) {" id="code3-l54"><span class="lineCounter-0-0-15 -codedoc-line-counter">54<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">performRollup</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> calcItemsByLookupField<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> lookupItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  List<SObject> toUpdate = new List<SObject>();" id="code3-l55"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">55<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> toUpdate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  for(SObject lookupRecord : lookupItems) {" id="code3-l56"><span class="lineCounter-0-0-15 -codedoc-line-counter">56<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> lookupRecord <span class="token operator">:</span> lookupItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    String key = (String)lookupRecord.get(this.lookupField);" id="code3-l57"><span class="lineCounter-0-0-15 -codedoc-line-counter">57<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>lookupRecord<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lookupField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    if(calcItemsByLookupField.containsKey(key) == false) {" id="code3-l58"><span class="lineCounter-0-0-15 -codedoc-line-counter">58<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">if</span><span class="token punctuation">(</span>calcItemsByLookupField<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      continue;" id="code3-l59"><span class="lineCounter-0-0-15 -codedoc-line-counter">59<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">continue</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code3-l60"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">60<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l61"><span class="lineCounter-0-0-15 -codedoc-line-counter">61<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    List<SObject> calcItems = calcItemsByLookupField.get(key);" id="code3-l62"><span class="lineCounter-0-0-15 -codedoc-line-counter">62<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> calcItems <span class="token operator">=</span> calcItemsByLookupField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Object priorVal = lookupRecord.get(this.lookupObjOpField);" id="code3-l63"><span class="lineCounter-0-0-15 -codedoc-line-counter">63<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Object</span> priorVal <span class="token operator">=</span> lookupRecord<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lookupObjOpField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Object newVal = this.getRollupVal(calcItems, priorVal);" id="code3-l64"><span class="lineCounter-0-0-15 -codedoc-line-counter">64<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Object</span> newVal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRollupVal</span><span class="token punctuation">(</span>calcItems<span class="token punctuation">,</span> priorVal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    lookupRecord.put(this.lookupObjOpField, newVal);" id="code3-l65"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">65<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    lookupRecord<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lookupObjOpField<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    toUpdate.add(lookupRecord);" id="code3-l66"><span class="lineCounter-0-0-15 -codedoc-line-counter">66<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    toUpdate<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>lookupRecord<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code3-l67"><span class="lineCounter-0-0-15 -codedoc-line-counter">67<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l68"><span class="lineCounter-0-0-15 -codedoc-line-counter">68<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  update toUpdate;" id="code3-l69"><span class="lineCounter-0-0-15 -codedoc-line-counter">69<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  update toUpdate<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code3-l70"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">70<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code3-l71"><span class="lineCounter-0-0-15 -codedoc-line-counter">71<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// right now, this &quot;works&quot; - but we'll need to further generalize" id="code3-l72"><span class="lineCounter-0-0-15 -codedoc-line-counter">72<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// right now, this "works" - but we'll need to further generalize</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// to support other kinds of rollup operations" id="code3-l73"><span class="lineCounter-0-0-15 -codedoc-line-counter">73<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// to support other kinds of rollup operations</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private Object getRollupVal(List<SObject> calcItems, Object priorVal) {" id="code3-l74"><span class="lineCounter-0-0-15 -codedoc-line-counter">74<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">getRollupVal</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> calcItems<span class="token punctuation">,</span> <span class="token class-name">Object</span> priorVal<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Decimal returnVal = priorVal == null ? 0 : (Decimal)priorVal;" id="code3-l75"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">75<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Decimal</span> returnVal <span class="token operator">=</span> priorVal <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span>priorVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  for(SObject calcItem : calcItems) {" id="code3-l76"><span class="lineCounter-0-0-15 -codedoc-line-counter">76<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> calcItem <span class="token operator">:</span> calcItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    switch on this.op {" id="code3-l77"><span class="lineCounter-0-0-15 -codedoc-line-counter">77<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">switch</span> on <span class="token keyword">this</span><span class="token punctuation">.</span>op <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when SUM {" id="code3-l78"><span class="lineCounter-0-0-15 -codedoc-line-counter">78<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when SUM <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        returnVal += (Decimal)calcItem.get(this.opField);" id="code3-l79"><span class="lineCounter-0-0-15 -codedoc-line-counter">79<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        returnVal <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span>calcItem<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code3-l80"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">80<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when DELETE_SUM {" id="code3-l81"><span class="lineCounter-0-0-15 -codedoc-line-counter">81<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when DELETE_SUM <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        returnVal -= (Decimal)calcItem.get(this.opField);" id="code3-l82"><span class="lineCounter-0-0-15 -codedoc-line-counter">82<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        returnVal <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span>calcItem<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code3-l83"><span class="lineCounter-0-0-15 -codedoc-line-counter">83<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when UPDATE_SUM {" id="code3-l84"><span class="lineCounter-0-0-15 -codedoc-line-counter">84<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when UPDATE_SUM <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        Decimal oldVal = (Decimal)this.oldCalcItems.get(calcItem.Id).get(this.opField);" id="code3-l85"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">85<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">Decimal</span> oldVal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>oldCalcItems<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">calcItem<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        Decimal newVal = (Decimal)calcItem.get(this.opField);" id="code3-l86"><span class="lineCounter-0-0-15 -codedoc-line-counter">86<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">Decimal</span> newVal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span>calcItem<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        returnVal += (newVal - oldVal); // could be negative, could be positive" id="code3-l87"><span class="lineCounter-0-0-15 -codedoc-line-counter">87<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        returnVal <span class="token operator">+=</span> <span class="token punctuation">(</span>newVal <span class="token operator">-</span> oldVal<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// could be negative, could be positive</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code3-l88"><span class="lineCounter-0-0-15 -codedoc-line-counter">88<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when else {" id="code3-l89"><span class="lineCounter-0-0-15 -codedoc-line-counter">89<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        throw new IllegalArgumentException('Other rollup op: ' + this.op.name() + ' not yet implemented');" id="code3-l90"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">90<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">'Other rollup op: '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' not yet implemented'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code3-l91"><span class="lineCounter-0-0-15 -codedoc-line-counter">91<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code3-l92"><span class="lineCounter-0-0-15 -codedoc-line-counter">92<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code3-l93"><span class="lineCounter-0-0-15 -codedoc-line-counter">93<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  return returnVal;" id="code3-l94"><span class="lineCounter-0-0-15 -codedoc-line-counter">94<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> returnVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code3-l95"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">95<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>The framework for rolling values up appears fairly quickly; this isn't really even that many lines of code. Indeed, the rest of the <code>Rollup</code> is largely defined by constructors at this point, and static methods exposing the rollup operations.</p><h2 id="reduce-reuse-refactor-rollup-part-two" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Reduce, Reuse, Refactor: Rollup, Part Two</h2><p>First things first -- that <code>getRollupVal</code> method needs to decouple itself from the type of rollup being performed. This is a great use-case for inner classes:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="private Object getRollupVal(RollupCalculator calc, List<SObject> calcItems, Object priorVal) {" id="code4-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">getRollupVal</span><span class="token punctuation">(</span><span class="token class-name">RollupCalculator</span> calc<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> calcItems<span class="token punctuation">,</span> <span class="token class-name">Object</span> priorVal<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Rollup rollup = this.getRollupType(priorVal);" id="code4-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Rollup</span> rollup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRollupType</span><span class="token punctuation">(</span>priorVal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  for (SObject calcItem : calcItems) {" id="code4-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SObject</span> calcItem <span class="token operator">:</span> calcItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    rollup.performRollup(calc.op, priorVal, calcItem, calc.oldCalcItems, calc.opField.getDescribe().getName());" id="code4-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    rollup<span class="token punctuation">.</span><span class="token function">performRollup</span><span class="token punctuation">(</span>calc<span class="token punctuation">.</span>op<span class="token punctuation">,</span> priorVal<span class="token punctuation">,</span> calcItem<span class="token punctuation">,</span> calc<span class="token punctuation">.</span>oldCalcItems<span class="token punctuation">,</span> calc<span class="token punctuation">.</span>opField<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code4-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  return rollup.getReturnValue();" id="code4-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> rollup<span class="token punctuation">.</span><span class="token function">getReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code4-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code4-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private Rollup getRollupType(Object priorVal) {" id="code4-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token class-name">Rollup</span> <span class="token function">getRollupType</span><span class="token punctuation">(</span><span class="token class-name">Object</span> priorVal<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // fun fact - integers, doubles, longs, and decimals" id="code4-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// fun fact - integers, doubles, longs, and decimals</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // will ALL return true here" id="code4-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// will ALL return true here</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  if (priorVal instanceof Decimal) {" id="code4-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>priorVal <span class="token keyword">instanceof</span> <span class="token class-name">Decimal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return new DecimalRollup(priorVal);" id="code4-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DecimalRollup</span><span class="token punctuation">(</span>priorVal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  } else {" id="code4-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    throw new IllegalArgumentException('Rollup operation not defined for: ' + JSON.serialize(priorVal));" id="code4-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">'Rollup operation not defined for: '</span> <span class="token operator">+</span> JSON<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>priorVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code4-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code4-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code4-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private abstract class Rollup {" id="code4-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Rollup</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected Object returnVal;" id="code4-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> <span class="token class-name">Object</span> returnVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public Rollup(Object returnVal) {" id="code4-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">Rollup</span><span class="token punctuation">(</span><span class="token class-name">Object</span> returnVal<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.returnVal = returnVal;" id="code4-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span>returnVal <span class="token operator">=</span> returnVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code4-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public Object getReturnValue() {" id="code4-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return returnVal;" id="code4-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> returnVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code4-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public abstract void performRollup(Op op, Object priorVal, SObject calcItem, Map<Id, SObject> oldCalcItems, String operationField);" id="code4-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">performRollup</span><span class="token punctuation">(</span><span class="token class-name">Op</span> op<span class="token punctuation">,</span> <span class="token class-name">Object</span> priorVal<span class="token punctuation">,</span> <span class="token class-name">SObject</span> calcItem<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldCalcItems<span class="token punctuation">,</span> <span class="token class-name">String</span> operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code4-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code4-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private class DecimalRollup extends Rollup {" id="code4-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DecimalRollup</span> <span class="token keyword">extends</span> <span class="token class-name">Rollup</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public DecimalRollup(Object priorVal) {" id="code4-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">DecimalRollup</span><span class="token punctuation">(</span><span class="token class-name">Object</span> priorVal<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    super(priorVal == null ? 0 : priorVal);" id="code4-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">super</span><span class="token punctuation">(</span>priorVal <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> priorVal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code4-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code4-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public override void performRollup(Op operation, Object priorVal, SObject calcItem, Map<Id, SObject> oldCalcItems, String operationField) {" id="code4-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">performRollup</span><span class="token punctuation">(</span><span class="token class-name">Op</span> operation<span class="token punctuation">,</span> <span class="token class-name">Object</span> priorVal<span class="token punctuation">,</span> <span class="token class-name">SObject</span> calcItem<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldCalcItems<span class="token punctuation">,</span> <span class="token class-name">String</span> operationField<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Decimal returnVal = (Decimal) this.returnVal;" id="code4-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Decimal</span> returnVal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>returnVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    switch on operation {" id="code4-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">switch</span> on operation <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when SUM {" id="code4-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when SUM <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        returnVal += (Decimal) calcItem.get(operationField);" id="code4-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        returnVal <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span> calcItem<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code4-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when DELETE_SUM {" id="code4-l41"><span class="lineCounter-0-0-15 -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when DELETE_SUM <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        returnVal -= (Decimal) calcItem.get(operationField);" id="code4-l42"><span class="lineCounter-0-0-15 -codedoc-line-counter">42<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        returnVal <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span> calcItem<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code4-l43"><span class="lineCounter-0-0-15 -codedoc-line-counter">43<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when UPDATE_SUM {" id="code4-l44"><span class="lineCounter-0-0-15 -codedoc-line-counter">44<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when UPDATE_SUM <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        Decimal oldVal = (Decimal) oldCalcItems.get(calcItem.Id).get(operationField);" id="code4-l45"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">45<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">Decimal</span> oldVal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span> oldCalcItems<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">calcItem<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        Decimal newVal = (Decimal) calcItem.get(operationField);" id="code4-l46"><span class="lineCounter-0-0-15 -codedoc-line-counter">46<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">Decimal</span> newVal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span> calcItem<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        returnVal += (newVal - oldVal); // could be negative, could be positive" id="code4-l47"><span class="lineCounter-0-0-15 -codedoc-line-counter">47<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        returnVal <span class="token operator">+=</span> <span class="token punctuation">(</span>newVal <span class="token operator">-</span> oldVal<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// could be negative, could be positive</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code4-l48"><span class="lineCounter-0-0-15 -codedoc-line-counter">48<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when else {" id="code4-l49"><span class="lineCounter-0-0-15 -codedoc-line-counter">49<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        throw new IllegalArgumentException('Other rollup op: ' + operation.name() + ' not yet implemented');" id="code4-l50"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">50<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">'Other rollup op: '</span> <span class="token operator">+</span> operation<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' not yet implemented'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code4-l51"><span class="lineCounter-0-0-15 -codedoc-line-counter">51<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code4-l52"><span class="lineCounter-0-0-15 -codedoc-line-counter">52<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code4-l53"><span class="lineCounter-0-0-15 -codedoc-line-counter">53<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code4-l54"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">54<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>If you're looking at <code>getRollupType</code> in the above example and thinking that it looks like the <a href="/joys-of-apex/dependency-injection-factory-pattern">Factory pattern</a>, that's a bingo! Now the <em>type</em> of rollup being performed has been decoupled from the logic necessary to perform the actual rollup. That makes it easy to add in:</p><ul><li>new rollup types</li><li>the behavior for rollups based on the <code>Op</code> enum (currently just SUM, but we'll expand on that shortly)</li></ul><p>A potential code smell (perhaps obscured by only having one rollup operation defined) is the <code>switch</code> statement in <code>DecimalRollup</code>. This piece of logic will have to be replicated in each <code>Rollup</code> inner class prior to us being able to proceed. However, with a slight shift in perspective comes an object-oriented opportunity to reduce the boilerplate necessary to introduce new rollup types into the mix:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// in Rollup.cls" id="code5-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// in Rollup.cls</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private enum Op {" id="code5-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">Op</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  SUM," id="code5-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  SUM<span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  UPDATE_SUM," id="code5-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  UPDATE_SUM<span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  DELETE_SUM," id="code5-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  DELETE_SUM<span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  COUNT, // our first new operation!" id="code5-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  COUNT<span class="token punctuation">,</span> <span class="token comment">// our first new operation!</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  UPDATE_COUNT," id="code5-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  UPDATE_COUNT<span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  DELETE_COUNT" id="code5-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  DELETE_COUNT</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code5-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private Rollup getRollupType(Object priorVal, Op operationType) {" id="code5-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token class-name">Rollup</span> <span class="token function">getRollupType</span><span class="token punctuation">(</span><span class="token class-name">Object</span> priorVal<span class="token punctuation">,</span> <span class="token class-name">Op</span> operationType<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // have to use the fully qualified Op name here (including the outer class)" id="code5-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// have to use the fully qualified Op name here (including the outer class)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // since its type is shadowed in this method" id="code5-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// since its type is shadowed in this method</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  if(operationType.name().contains(RollupCalculator.Op.COUNT.name())) {" id="code5-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">if</span><span class="token punctuation">(</span>operationType<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">RollupCalculator<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span>COUNT<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return new CountRollup(priorVal);" id="code5-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CountRollup</span><span class="token punctuation">(</span>priorVal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  } else if (priorVal instanceof Decimal) {" id="code5-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>priorVal <span class="token keyword">instanceof</span> <span class="token class-name">Decimal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return new DecimalRollup(priorVal);" id="code5-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DecimalRollup</span><span class="token punctuation">(</span>priorVal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  } else {" id="code5-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    throw new IllegalArgumentException('Rollup operation not defined for: ' + JSON.serialize(priorVal));" id="code5-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">'Rollup operation not defined for: '</span> <span class="token operator">+</span> JSON<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>priorVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code5-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private abstract class Rollup {" id="code5-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Rollup</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected Object returnVal;" id="code5-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> <span class="token class-name">Object</span> returnVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public Rollup(Object returnVal) {" id="code5-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">Rollup</span><span class="token punctuation">(</span><span class="token class-name">Object</span> returnVal<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.returnVal = returnVal;" id="code5-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span><span class="token punctuation">.</span>returnVal <span class="token operator">=</span> returnVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // we make this virtual to deal with downcasting" id="code5-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// we make this virtual to deal with downcasting</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public virtual Object getReturnValue() {" id="code5-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> virtual <span class="token class-name">Object</span> <span class="token function">getReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return returnVal;" id="code5-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> returnVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public abstract void performRollup(Op op, Object priorVal, SObject calcItem, Map<Id, SObject> oldCalcItems, SObjectField operationField);" id="code5-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">performRollup</span><span class="token punctuation">(</span><span class="token class-name">Op</span> op<span class="token punctuation">,</span> <span class="token class-name">Object</span> priorVal<span class="token punctuation">,</span> <span class="token class-name">SObject</span> calcItem<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldCalcItems<span class="token punctuation">,</span> <span class="token class-name">SObjectField</span> operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code5-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private virtual class DecimalRollup extends Rollup {" id="code5-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> virtual <span class="token keyword">class</span> <span class="token class-name">DecimalRollup</span> <span class="token keyword">extends</span> <span class="token class-name">Rollup</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public DecimalRollup(Object priorVal) {" id="code5-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">DecimalRollup</span><span class="token punctuation">(</span><span class="token class-name">Object</span> priorVal<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    // much as it pains me to duplicate the null check, it must be done;" id="code5-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">// much as it pains me to duplicate the null check, it must be done;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    // we can't reference instance methods till after the super() call" id="code5-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">// we can't reference instance methods till after the super() call</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    super(priorVal == null ? 0 : priorVal);" id="code5-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">super</span><span class="token punctuation">(</span>priorVal <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> priorVal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l41"><span class="lineCounter-0-0-15 -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected Decimal getDecimalOrDefault(Object potentiallyUnitializedDecimal) {" id="code5-l42"><span class="lineCounter-0-0-15 -codedoc-line-counter">42<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> <span class="token class-name">Decimal</span> <span class="token function">getDecimalOrDefault</span><span class="token punctuation">(</span><span class="token class-name">Object</span> potentiallyUnitializedDecimal<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return (Decimal) (potentiallyUnitializedDecimal == null ? 0 : potentiallyUnitializedDecimal);" id="code5-l43"><span class="lineCounter-0-0-15 -codedoc-line-counter">43<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>potentiallyUnitializedDecimal <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> potentiallyUnitializedDecimal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l44"><span class="lineCounter-0-0-15 -codedoc-line-counter">44<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l45"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">45<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected virtual Decimal getNumericValue(SObject calcItem, SObjectField operationField) {" id="code5-l46"><span class="lineCounter-0-0-15 -codedoc-line-counter">46<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> virtual <span class="token class-name">Decimal</span> <span class="token function">getNumericValue</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> calcItem<span class="token punctuation">,</span> <span class="token class-name">SObjectField</span> operationField<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return this.getDecimalOrDefault(calcItem.get(operationField));" id="code5-l47"><span class="lineCounter-0-0-15 -codedoc-line-counter">47<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDecimalOrDefault</span><span class="token punctuation">(</span>calcItem<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>operationField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l48"><span class="lineCounter-0-0-15 -codedoc-line-counter">48<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l49"><span class="lineCounter-0-0-15 -codedoc-line-counter">49<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected virtual Decimal getNumericChangedValue(SObject calcItem, SObjectfield operationField, Map<Id, SObject> oldCalcItems) {" id="code5-l50"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">50<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> virtual <span class="token class-name">Decimal</span> <span class="token function">getNumericChangedValue</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> calcItem<span class="token punctuation">,</span> <span class="token class-name">SObjectfield</span> operationField<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldCalcItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Decimal newVal = this.getNumericValue(calcItem, operationField);" id="code5-l51"><span class="lineCounter-0-0-15 -codedoc-line-counter">51<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Decimal</span> newVal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNumericValue</span><span class="token punctuation">(</span>calcItem<span class="token punctuation">,</span> operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Decimal oldVal = this.getNumericValue(oldCalcItems.get(calcItem.Id), operationField);" id="code5-l52"><span class="lineCounter-0-0-15 -codedoc-line-counter">52<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Decimal</span> oldVal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNumericValue</span><span class="token punctuation">(</span>oldCalcItems<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">calcItem<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">)</span><span class="token punctuation">,</span> operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    // could be negative, could be positive ... could be 0!" id="code5-l53"><span class="lineCounter-0-0-15 -codedoc-line-counter">53<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">// could be negative, could be positive ... could be 0!</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return newVal - oldVal;" id="code5-l54"><span class="lineCounter-0-0-15 -codedoc-line-counter">54<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> newVal <span class="token operator">-</span> oldVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l55"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">55<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l56"><span class="lineCounter-0-0-15 -codedoc-line-counter">56<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public override void performRollup(Op operation, Object priorVal, SObject calcItem, Map<Id, SObject> oldCalcItems, SObjectField operationField) {" id="code5-l57"><span class="lineCounter-0-0-15 -codedoc-line-counter">57<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">performRollup</span><span class="token punctuation">(</span><span class="token class-name">Op</span> operation<span class="token punctuation">,</span> <span class="token class-name">Object</span> priorVal<span class="token punctuation">,</span> <span class="token class-name">SObject</span> calcItem<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldCalcItems<span class="token punctuation">,</span> <span class="token class-name">SObjectField</span> operationField<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Decimal returnVal = (Decimal) this.returnVal;" id="code5-l58"><span class="lineCounter-0-0-15 -codedoc-line-counter">58<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Decimal</span> returnVal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>returnVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    switch on operation {" id="code5-l59"><span class="lineCounter-0-0-15 -codedoc-line-counter">59<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">switch</span> on operation <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when SUM, COUNT {" id="code5-l60"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">60<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when SUM<span class="token punctuation">,</span> COUNT <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        returnVal += this.getNumericValue(calcItem, operationField);" id="code5-l61"><span class="lineCounter-0-0-15 -codedoc-line-counter">61<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        returnVal <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNumericValue</span><span class="token punctuation">(</span>calcItem<span class="token punctuation">,</span> operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code5-l62"><span class="lineCounter-0-0-15 -codedoc-line-counter">62<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when DELETE_SUM, DELETE_COUNT {" id="code5-l63"><span class="lineCounter-0-0-15 -codedoc-line-counter">63<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when DELETE_SUM<span class="token punctuation">,</span> DELETE_COUNT <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        returnVal -= this.getNumericValue(calcItem, operationField);" id="code5-l64"><span class="lineCounter-0-0-15 -codedoc-line-counter">64<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        returnVal <span class="token operator">-=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNumericValue</span><span class="token punctuation">(</span>calcItem<span class="token punctuation">,</span> operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code5-l65"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">65<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when UPDATE_SUM, UPDATE_COUNT {" id="code5-l66"><span class="lineCounter-0-0-15 -codedoc-line-counter">66<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when UPDATE_SUM<span class="token punctuation">,</span> UPDATE_COUNT <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        returnVal += this.getNumericChangedValue(calcItem, operationField, oldCalcItems);" id="code5-l67"><span class="lineCounter-0-0-15 -codedoc-line-counter">67<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        returnVal <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNumericChangedValue</span><span class="token punctuation">(</span>calcItem<span class="token punctuation">,</span> operationField<span class="token punctuation">,</span> oldCalcItems<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code5-l68"><span class="lineCounter-0-0-15 -codedoc-line-counter">68<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when else {" id="code5-l69"><span class="lineCounter-0-0-15 -codedoc-line-counter">69<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        throw new IllegalArgumentException('Other rollup op: ' + operation.name() + ' not yet implemented');" id="code5-l70"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">70<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">'Other rollup op: '</span> <span class="token operator">+</span> operation<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' not yet implemented'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code5-l71"><span class="lineCounter-0-0-15 -codedoc-line-counter">71<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code5-l72"><span class="lineCounter-0-0-15 -codedoc-line-counter">72<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l73"><span class="lineCounter-0-0-15 -codedoc-line-counter">73<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code5-l74"><span class="lineCounter-0-0-15 -codedoc-line-counter">74<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l75"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">75<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private class CountRollup extends DecimalRollup {" id="code5-l76"><span class="lineCounter-0-0-15 -codedoc-line-counter">76<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">CountRollup</span> <span class="token keyword">extends</span> <span class="token class-name">DecimalRollup</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public CountRollup(Object priorVal) {" id="code5-l77"><span class="lineCounter-0-0-15 -codedoc-line-counter">77<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">CountRollup</span><span class="token punctuation">(</span><span class="token class-name">Object</span> priorVal<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    super(priorVal);" id="code5-l78"><span class="lineCounter-0-0-15 -codedoc-line-counter">78<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">super</span><span class="token punctuation">(</span>priorVal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l79"><span class="lineCounter-0-0-15 -codedoc-line-counter">79<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l80"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">80<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public override Object getReturnValue() {" id="code5-l81"><span class="lineCounter-0-0-15 -codedoc-line-counter">81<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> override <span class="token class-name">Object</span> <span class="token function">getReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return (Integer) this.returnVal;" id="code5-l82"><span class="lineCounter-0-0-15 -codedoc-line-counter">82<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>returnVal<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l83"><span class="lineCounter-0-0-15 -codedoc-line-counter">83<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l84"><span class="lineCounter-0-0-15 -codedoc-line-counter">84<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected override Decimal getNumericValue(SObject calcItem, SObjectField operationField) {" id="code5-l85"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">85<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> override <span class="token class-name">Decimal</span> <span class="token function">getNumericValue</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> calcItem<span class="token punctuation">,</span> <span class="token class-name">SObjectField</span> operationField<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Decimal potentialReturnValue = super.getNumericValue(calcItem, operationField);" id="code5-l86"><span class="lineCounter-0-0-15 -codedoc-line-counter">86<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Decimal</span> potentialReturnValue <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getNumericValue</span><span class="token punctuation">(</span>calcItem<span class="token punctuation">,</span> operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return this.getCountValue(potentialReturnValue);" id="code5-l87"><span class="lineCounter-0-0-15 -codedoc-line-counter">87<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCountValue</span><span class="token punctuation">(</span>potentialReturnValue<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l88"><span class="lineCounter-0-0-15 -codedoc-line-counter">88<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l89"><span class="lineCounter-0-0-15 -codedoc-line-counter">89<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  protected override Decimal getNumericChangedValue(SObject calcItem, SObjectField operationField," id="code5-l90"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">90<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">protected</span> override <span class="token class-name">Decimal</span> <span class="token function">getNumericChangedValue</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> calcItem<span class="token punctuation">,</span> <span class="token class-name">SObjectField</span> operationField<span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Map<Id, SObject> oldCalcItems) {" id="code5-l91"><span class="lineCounter-0-0-15 -codedoc-line-counter">91<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldCalcItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Decimal potentialReturnValue = super.getNumericChangedValue(calcItem, operationField, oldCalcItems);" id="code5-l92"><span class="lineCounter-0-0-15 -codedoc-line-counter">92<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Decimal</span> potentialReturnValue <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getNumericChangedValue</span><span class="token punctuation">(</span>calcItem<span class="token punctuation">,</span> operationField<span class="token punctuation">,</span> oldCalcItems<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return this.getCountValue(potentialReturnValue);" id="code5-l93"><span class="lineCounter-0-0-15 -codedoc-line-counter">93<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCountValue</span><span class="token punctuation">(</span>potentialReturnValue<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l94"><span class="lineCounter-0-0-15 -codedoc-line-counter">94<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code5-l95"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">95<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private Decimal getCountValue(Decimal potentialReturnValue) {" id="code5-l96"><span class="lineCounter-0-0-15 -codedoc-line-counter">96<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token class-name">Decimal</span> <span class="token function">getCountValue</span><span class="token punctuation">(</span><span class="token class-name">Decimal</span> potentialReturnValue<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return potentialReturnValue > 0 ? 1 : potentialReturnValue;" id="code5-l97"><span class="lineCounter-0-0-15 -codedoc-line-counter">97<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> potentialReturnValue <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> potentialReturnValue<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code5-l98"><span class="lineCounter-0-0-15 -codedoc-line-counter">98<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code5-l99"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">99<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>Et voila -- in just a few short lines and an additional check in the factory method, we've added a completely different rollup type into the mix. The new <code>CountRollup</code> class has an interesting condition to it (consistent with the rules for how the <code>COUNT</code> function works in SOQL) -- it still requires there to be a non-null value on the field within the calculation item that it's comparing to. It may be the case that people simply want to count all child/related objects and roll up their presence to a parent/related object. I'll be curious to hear from you as to whether or not that functionality is desired, prior to implementing a so-called <code>BlindCount</code> version.</p><p>As I added more functionality, it occurred to me that either by wanting to perform many rollups from within a single trigger, or by having rollup operations involving large amounts of records, it might be possible to creep towards the synchronous DML limit of 10,000 DML rows in a single transaction. Making <code>Rollup</code> perform the bulk of the work async also led to implementing the <a href="/joys-of-apex/batchable-and-queueable-apex">Data Processor</a> pattern -- by burning a few SOQL queries on the synchronous side, <code>Rollup</code> can automatically (or through the use of <code>RollupLimit__mdt</code> custom metadata) scale from running as a Queueable to a Batchable as the size of rollup operations grow. This is the power of elastic scaling!</p><hr><h2 id="rollup---a-note-on-progress" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Rollup - A Note On Progress</h2><marker><div style="display: inline">I wrote the above paragraph on December 21st, and jotted down a note to myself:</div> <div style="background-color: orange; color: white; display: inline;">TODO:</div> max/min ??.
<br>
<br>

</marker><p>Today is December 29th. It's not that I took a break from writing this article; I didn't. What happened? Over the hours (and then days) that followed, I began to add additional operations for <code>Rollup</code>. My assumption -- with the SUM operations for numbers basically "complete" -- surrounding the ease of implementing the rest of the rollup functions slowly began to wither on the vine. I laughed on Christmas <a href="https://github.com/jamessimone/gatsby-remark-footnotes/pull/6">when a stranger submitted a PR on one of my open-source repos</a> -- one thing I was no stranger to was putting in long hours on passion projects, and somebody else was clearly taking advantage of the holidays.</p><p>What began as a casual foray into adding <code>COUNT</code> quickly began to escalate outwards as the code smell that I mentioned earlier -- the <code>switch</code> statement in <code>DecimalRollup</code> became bigger and bigger.</p><blockquote><p>"This isn't really even that many lines of code" - a younger, more naive version of me (earlier in this article), before the <code>switch</code> statement in <code>DecimalRollup</code> ended up as 50% of the size of the entire <code>Rollup</code> class when I started</p></blockquote><p>The addition of an Invocable entry point for Flows and Process Builders contributed to the rising tide of lines of code -- and at the end of that journey, without many of the rollup functions even implemented yet, I realized it was <strong>past time</strong> ... the tests needed to be ported over, and new ones created ASAP to ensure what I had so far was going to work.</p><h3 id="design-decisions-for-testing-the-rollup-framework" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Design Decisions For Testing The Rollup Framework</h3><p>If you've read <a href="/joys-of-apex/">The Joys Of Apex</a> before, you know that keeping your Salesforce tests running quickly is something I'm passionate about. This was doubly important in the current context: the tests I'd originally written were tightly coupled to two things that weren't going to make the cut:</p><ul><li>custom fields on standard SObjects; a no-no for any open source library</li><li>having a trigger handler framework / pre-existing entry point into the code</li></ul><p>One of the reasons that DLRS is so big as a codebase is because it imports a ton of code from FFLib to perform the metadata deployments necessary to create DLRS triggers/rollups as needed. It occurred to me that I was trying to encourage something more along the lines of adding an analytics tag to a website than the sort of service DLRS offerred: I've worked on several analytics implementations, and vetted many vendors. I've never heard of somebody offering a service that <em>didn't</em> require the installation of a JavaScript / backend SDK in order to work (even Cloudflare and other reverse proxy services require up-front configuration). In other words, as I considered how I wanted my tests to work, I had to also solidify the concepts (like <code>Rollup</code> being more akin to installing Google Analytics) necessary for <code>Rollup</code> to be used.</p><p>Since my prior tests were a no-go, I found myself recalling the immortal words of Kent Beck in "Test Driven Development By Example":</p><blockquote><p>You will often be implementing TDD in code that doesn't have adequate tests. When you don't have enough tests, you are bound to come across refactorings that aren't supported by tests ... what do you do? Write the tests you wish you had.</p></blockquote><p>In order to make the tests run fast, I needed to limit the amount of DML performed. Crucial to that effort would be the following class and seam:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// in Rollup.cls" id="code6-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// in Rollup.cls</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="@testVisible" id="code6-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private virtual class DMLHelper {" id="code6-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> virtual <span class="token keyword">class</span> <span class="token class-name">DMLHelper</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public virtual void doUpdate(List<SObject> recordsToUpdate) {" id="code6-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> virtual <span class="token keyword">void</span> <span class="token function">doUpdate</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> recordsToUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    update recordsToUpdate;" id="code6-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    update recordsToUpdate<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code6-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="/**" id="code6-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">/**</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  * receiving an interface/subclass from a property get/set (from the book &quot;The Art Of Unit Testing&quot;) is an old technique;" id="code6-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  * receiving an interface/subclass from a property get/set (from the book "The Art Of Unit Testing") is an old technique;</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  * useful in limited contexts to get around the classic approach to dependency injection" id="code6-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  * useful in limited contexts to get around the classic approach to dependency injection</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  * (such as in this case, when constructor-based DI isn't possible)." id="code6-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  * (such as in this case, when constructor-based DI isn't possible).</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  * It's more palatable in Apex than in many other languages, as a matter of fact -" id="code6-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  * It's more palatable in Apex than in many other languages, as a matter of fact -</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  * this is because the @testVisible annotation enforces for us the override only being possible while testing" id="code6-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  * this is because the @testVisible annotation enforces for us the override only being possible while testing</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  */" id="code6-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  */</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="@testVisible" id="code6-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private static DMLHelper DML {" id="code6-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DMLHelper</span> DML <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  get {" id="code6-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  get <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    if (DML == null) {" id="code6-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DML <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      DML = new DMLHelper();" id="code6-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      DML <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DMLHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code6-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return DML;" id="code6-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> DML<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  set;" id="code6-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  set<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code6-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// and then in the tests:" id="code6-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// and then in the tests:</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code6-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private class DMLMock extends Rollup.DMLHelper {" id="code6-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DMLMock</span> <span class="token keyword">extends</span> <span class="token class-name">Rollup<span class="token punctuation">.</span>DMLHelper</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public List<SObject> Records = new List<SObject>();" id="code6-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Records</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public override void doUpdate(List<SObject> recordsToUpdate) {" id="code6-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">doUpdate</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> recordsToUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    this.Records = recordsToUpdate;" id="code6-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name"><span class="token namespace">this<span class="token punctuation">.</span></span>Records</span> <span class="token operator">=</span> recordsToUpdate<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code6-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code6-l34"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>Wait a minute. <a href="/joys-of-apex/mocking-dml">Doesn't this look familiar</a>? It should. But because I was intent on keeping everything within one class, I couldn't import dependencies -- I either needed to recreate them inside of the <code>Rollup</code> class, or do without them. The <a href="/joys-of-apex/dependency-injection-factory-pattern">Factory pattern for dependency injection</a> <em>and</em> the <a href="/joys-of-apex/repository-pattern">Repository pattern for strongly-typed and easily mocked queries</a> were both discarded as a result. That left me with the DML Mock pattern -- and sure enough, all of the tests are lightning-fast as a result. Here's a simple one:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// in RollupTests.cls" id="code7-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// in RollupTests.cls</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="@isTest" id="code7-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="static void shouldSumFromTriggerAfterInsert() {" id="code7-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shouldSumFromTriggerAfterInsert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  DMLMock mock = getMock(new List<Opportunity>{ new Opportunity(Amount = 25), new Opportunity(Amount = 25) });" id="code7-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">DMLMock</span> mock <span class="token operator">=</span> <span class="token function">getMock</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Opportunity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> <span class="token keyword">new</span> <span class="token class-name">Opportunity</span><span class="token punctuation">(</span><span class="token class-name">Amount</span> <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Opportunity</span><span class="token punctuation">(</span><span class="token class-name">Amount</span> <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Rollup.triggerContext = TriggerOperation.AFTER_INSERT;" id="code7-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Rollup</span><span class="token punctuation">.</span>triggerContext <span class="token operator">=</span> <span class="token class-name">TriggerOperation</span><span class="token punctuation">.</span>AFTER_INSERT<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code7-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Rollup rollup = Rollup.sumFromTrigger(" id="code7-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Rollup</span> rollup <span class="token operator">=</span> <span class="token class-name">Rollup</span><span class="token punctuation">.</span><span class="token function">sumFromTrigger</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Opportunity.Amount," id="code7-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Opportunity<span class="token punctuation">.</span>Amount</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Opportunity.AccountId," id="code7-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Opportunity<span class="token punctuation">.</span>AccountId</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Account.Id," id="code7-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Account<span class="token punctuation">.</span>Id</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Account.AnnualRevenue," id="code7-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Account<span class="token punctuation">.</span>AnnualRevenue</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Account.SObjectType" id="code7-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Account<span class="token punctuation">.</span>SObjectType</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  );" id="code7-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code7-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  System.assertEquals(true, mock.Records.isEmpty());" id="code7-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">mock<span class="token punctuation">.</span></span>Records</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code7-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Test.startTest();" id="code7-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">startTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  rollup.runCalc();" id="code7-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  rollup<span class="token punctuation">.</span><span class="token function">runCalc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Test.stopTest();" id="code7-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">stopTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code7-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  System.assertEquals(1, mock.Records.size(), 'Records should have been populated SUM AFTER_INSERT');" id="code7-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">mock<span class="token punctuation">.</span></span>Records</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Records should have been populated SUM AFTER_INSERT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Account updatedAcc = (Account) mock.Records[0];" id="code7-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Account</span> updatedAcc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token namespace">mock<span class="token punctuation">.</span></span>Records</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  System.assertEquals(50, updatedAcc.AnnualRevenue, 'SUM AFTER_INSERT should add the original opportunity amount');" id="code7-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">updatedAcc<span class="token punctuation">.</span></span>AnnualRevenue</span><span class="token punctuation">,</span> <span class="token string">'SUM AFTER_INSERT should add the original opportunity amount'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code7-l24"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>One hidden side-effect is the tying of the Opportunities to the Account in question - that happens in the <code>getMock</code> method:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// in RollupTests.cls" id="code8-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// in RollupTests.cls</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private static DMLMock getMock(List<SObject> records) {" id="code8-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DMLMock</span> <span class="token function">getMock</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Account acc = [SELECT Id FROM Account];" id="code8-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Account</span> acc <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span> FROM <span class="token class-name">Account</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  for (SObject record : records) {" id="code8-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SObject</span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    record.put('AccountId', acc.Id);" id="code8-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'AccountId'</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">acc<span class="token punctuation">.</span></span>Id</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code8-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code8-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  return loadMock(records);" id="code8-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> <span class="token function">loadMock</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code8-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code8-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// ..." id="code8-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// ...</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code8-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private static DMLMock loadMock(List<SObject> records) {" id="code8-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DMLMock</span> <span class="token function">loadMock</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Rollup.records = records;" id="code8-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Rollup</span><span class="token punctuation">.</span>records <span class="token operator">=</span> records<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Rollup.shouldRun = true;" id="code8-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Rollup</span><span class="token punctuation">.</span>shouldRun <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  DMLMock mock = new DMLMock();" id="code8-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">DMLMock</span> mock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DMLMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Rollup.DML = mock;" id="code8-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Rollup</span><span class="token punctuation">.</span>DML <span class="token operator">=</span> mock<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code8-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  return mock;" id="code8-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> mock<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code8-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>There are, in fact, only three other helper methods (non test methods) in the entire test class. Once I had tests that covered the basics of what I'd written for the <code>SUM</code> and <code>COUNT</code> implementations, it was time to approach this thing TDD-style:</p><ul><li>write a failing test</li><li>write enough production-level code to get the test to pass</li><li>refactor</li></ul><p>This simple rhythm helped me to immediately spot a flaw in the code for the Invocable method as I worked to create tests for this new functionality -- it was being fed into a method that used the current Trigger context (the <code>TriggerOperation</code> enum) to figure out what kind of rollup operation was being performed. That's also where the <code>Rollup.records</code> variable came from in the <code>loadMock</code> code, above; a way to stub in the trigger records without actually having to require a trigger being run.</p><p>When you look at the first ~20 lines of <code>Rollup</code>, you can see the use of these <code>@testVisible</code> private static variables as the "poor man's dependency injection:"</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="  /**" id="code9-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">/**</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="   * Test override / bookkeeping section. Normally I would do this through dependency injection," id="code9-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>   * Test override / bookkeeping section. Normally I would do this through dependency injection,</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="   * but this keeps things much simpler" id="code9-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>   * but this keeps things much simpler</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="   */" id="code9-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>   */</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @testVisible" id="code9-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private static Boolean shouldRun;" id="code9-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Boolean</span> shouldRun<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @testVisible" id="code9-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private static Boolean shouldRunAsBatch = false;" id="code9-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Boolean</span> shouldRunAsBatch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @testVisible" id="code9-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private static TriggerOperation triggerContext = Trigger.operationType;" id="code9-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">TriggerOperation</span> triggerContext <span class="token operator">=</span> <span class="token class-name">Trigger</span><span class="token punctuation">.</span>operationType<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @testVisible" id="code9-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private static Map<Id, SObject> oldRecordsMap;" id="code9-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldRecordsMap<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @testVisible" id="code9-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private static List<Rollup__mdt> rollupMetadata;" id="code9-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rollup__mdt</span><span class="token punctuation">&gt;</span></span> rollupMetadata<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @testVisible" id="code9-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private static List<SObject> queryRecords;" id="code9-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> queryRecords<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @testVisible" id="code9-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private static RollupLimit__mdt defaultRollupLimit;" id="code9-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">RollupLimit__mdt</span> defaultRollupLimit<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  @testVisible" id="code9-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private static RollupLimit__mdt specificRollupLimit;" id="code9-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">RollupLimit__mdt</span> specificRollupLimit<span class="token punctuation">;</span></div><br></code></pre><p>There are some juicy hints, above, of what was ultimately to come.</p><h2 id="adding-custom-metadata-driven-rollups" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Adding Custom Metadata-driven Rollups</h2><p>Adding the CMDT-record driven rollups was simple now that I had a burgeoning test suite and two different possible points of entry (Invocable / Trigger-based) into <code>Rollup</code>. Indeed, because the test suite was expansive and I believe that CMDT rollups form the core of peoples' rollup needs, refactoring the code to support custom metadata as a first-class citizen became (truly) a joy. You can tell that the code is really built around it because there are only 3 lines of code in the public-facing method:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// in Rollup.cls - don't mind that null argument below, it's for the custom Evaluator interface" id="code10-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// in Rollup.cls - don't mind that null argument below, it's for the custom Evaluator interface</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="public static void runFromTrigger() {" id="code10-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runFromTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  SObjectType sObjectType = getTriggerRecords().getSObjectType();" id="code10-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">SObjectType</span> sObjectType <span class="token operator">=</span> <span class="token function">getTriggerRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  List<Rollup__mdt> rollupMetadata = getTriggerRollupMetadata(sObjectType);" id="code10-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rollup__mdt</span><span class="token punctuation">&gt;</span></span> rollupMetadata <span class="token operator">=</span> <span class="token function">getTriggerRollupMetadata</span><span class="token punctuation">(</span>sObjectType<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  runFromTrigger(rollupMetadata, null).runCalc();" id="code10-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token function">runFromTrigger</span><span class="token punctuation">(</span>rollupMetadata<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runCalc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code10-l6"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><marker><br>
<div style="display: inline;" id="one-line-of-code">

</div></marker><marker>

</marker><p>This is the "Google Analytics" approach: in order to use <code>Rollup</code>, all you need to do is add <em>one line of code to your triggers</em>:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="Rollup.runFromTrigger();" id="code11-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Rollup</span><span class="token punctuation">.</span><span class="token function">runFromTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>Unless you need a ton of customization, it's really as simple as that. <strong>Please note</strong>: this <em>requires</em> your trigger to use the following contexts: after insert, after update, and before delete. Without those in place, <code>Rollup</code> will not function as designed for trigger-based rollups!</p><p>The rest of the info -- about which rollups need to be processed for the trigger in question -- can all live in the <code>Rollup__mdt</code> Custom Metadata:</p><ul><li>Label: you can name your metadata records as you please</li><li>Rollup Name: defaults to an underscore version of the Label; again, you can choose this as you will.</li><li>Calc Item: the name of the SObject where the trigger is running. This is an Entity Definition field, so you can only select from available SObjects via a dropdown list.</li><li>Rollup Field On Calc Item: the field you'd like to aggregate. This is a Field Definition field; you can only select from the list of available fields after having made an object-level selection for <code>Calc Item</code></li><li>Lookup Field On Calc Item: the field storing the Id or String referencing a unique value on another object. This is a Field Definition field; you can only select from the list of available fields after having made an object-level selection for <code>Calc Item</code></li><li>Lookup Object: the name of the SObject you'd like to roll the values up to. This is an Entity Definition field, so you can only select from available SObjects via a dropdown list.</li><li>Lookup Field On Lookup Object: the field storing the Id or String referencing the <code>Lookup Field On Calc Item</code> on your lookup object. This is a Field Definition field; you can only select from the list of available fields after having made an object-level selection for <code>Lookup Object</code></li><li>Rollup Field On Lookup Object: the field on the lookup object where the rolled-up values will be stored. This is a Field Definition field; you can only select from the list of available fields after having made an object-level selection for <code>Lookup Object</code></li><li>Rollup Type: SUM / MIN / MAX / AVERAGE / COUNT / COUNT_DISTINCT</li><li>Changed Fields On Calc Item: comma-separated list of field API Names (optional) to filter items from being used in the rollup calculations unless all the stipulated fields have changed</li></ul><p>There are some peculiarities within Apex when working with Entity Definition and Field Definition-based Custom Metadata fields, which I will detail just below in the key takeaways section!</p><h2 id="invoking-rollupcls-from-a-process-builder--flow" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Invoking Rollup.cls From A Process Builder / Flow</h2><marker><div id="from-flow">Invoking the `Rollup` process from a Flow, in particular, is a joy; with a Record Triggered Flow, you can do the up-front processing to take in only the records you need, and then dispatch the rollup operation to the `Rollup` invocable:</div>

</marker><p><img src="./img/joys-of-apex-rollup-flow.png" alt="Example flow" title="Fun and easy rollups from Flows"></p><p>This is also the preferred method for scheduling; while I do expose the option to schedule a rollup from Apex, I find the ease of use in creating Scheduled Flows in conjunction with the deep power of properly configured Invocables to be much more scalable than the "Scheduled Jobs" of old. This also gives you the chance to do some truly crazy rollups -- be it from a Scheduled Flow, an Autolaunched Flow, or a Platform Event-Triggered Flow. As long as you can manipulate data to correspond to the shape of an existing SObject's fields, they don't even have to exist; you could have an Autolaunched flow rolling up records when invoked from a REST API so long as the data you're consuming contains a String/Id matching something on the "parent" rollup object.</p><h2 id="key-takeaways-in-replacing-dlrs" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Key Takeaways In Replacing DLRS</h2><p>There were quite a few learning moments as I worked through rollup edge cases; I've chosen to spend the rest of this article articulating ones that I think might be helpful or interesting to you in your own Salesforce journey:</p><h3 id="entity-definition--field-definition-custom-metadata-relationships-can-be-tricky" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Entity Definition &amp; Field Definition Custom Metadata Relationships Can Be Tricky</h3><p>There's not a whole lot of documentation out there about Entity / Field Definition-basd CMDT. They <em>are</em> as good as they sound -- giving users of your CMDT object-level and field-level safety when letting them select fields, but something interesting that I found while working with Field Definition fields in Apex is that they are stored as "ObjectName.FieldName" in the database. This roughly corresponds to a string-level representation of what an <code>SObjectField</code> type is <em>written</em> as:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// if we query for the Rollup__mdt shown earlier" id="code12-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// if we query for the Rollup__mdt shown earlier</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Rollup__mdt rollupMetadata = [SELECT RollupFieldOnLookupObject__c FROM Rollup__mdt LIMIT 1];" id="code12-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Rollup__mdt</span> rollupMetadata <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">RollupFieldOnLookupObject__c</span> FROM <span class="token class-name">Rollup__mdt</span> LIMIT <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.debug(rollupMetadata.RollupFieldOnLookupObject__c); // outputs &quot;Opportunity.Amount&quot;, for example" id="code12-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">rollupMetadata<span class="token punctuation">.</span></span>RollupFieldOnLookupObject__c</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// outputs "Opportunity.Amount", for example</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="SObjectField opportunityAmount = Opportunity.Amount;" id="code12-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">SObjectField</span> opportunityAmount <span class="token operator">=</span> <span class="token class-name">Opportunity<span class="token punctuation">.</span>Amount</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.debug(opportunityAmount); // ouputs ... &quot;Amount&quot; ... so you know that somebody overrode the &quot;toString()&quot; method for this class!" id="code12-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>opportunityAmount<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ouputs ... "Amount" ... so you know that somebody overrode the "toString()" method for this class!</span></div><br></code></pre><p>When working with dynamic fields in SOQL, developers frequently use the <code>DescribeSObjectResult</code> and <code>DescribeFieldResult</code> classes that give you access to metadata about objects/fields ... but in this case, I found I had to create a helper method specifically for working with the String-based version of the Field Definition values coming in from the <code>Rollup__mdt</code> records:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// takes a string from CMDT like &quot;Opportunity.Amount&quot; and returns just the field name: &quot;Amount&quot;" id="code13-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// takes a string from CMDT like "Opportunity.Amount" and returns just the field name: "Amount"</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// this allows us to match the String-based version of the field with its corresponding SObjectField" id="code13-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// this allows us to match the String-based version of the field with its corresponding SObjectField</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// by calling describeForSObject.fields.getMap().get(theFieldNameReturnedFromgetParedFieldName)" id="code13-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// by calling describeForSObject.fields.getMap().get(theFieldNameReturnedFromgetParedFieldName)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private static String getParedFieldName(String fullFieldName, DescribeSObjectResult describeForSObject) {" id="code13-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getParedFieldName</span><span class="token punctuation">(</span><span class="token class-name">String</span> fullFieldName<span class="token punctuation">,</span> <span class="token class-name">DescribeSObjectResult</span> describeForSObject<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  return String.isBlank(fullFieldName) ? '' : fullFieldName.replace(describeForSObject.getName() + '.', '');" id="code13-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>fullFieldName<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> fullFieldName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>describeForSObject<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code13-l6"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><h3 id="using-enums-is-great-but-instantiating-them-from-strings-isnt-obvious" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Using Enums Is Great, But Instantiating Them From Strings Isn't Obvious</h3><p>You might remember from the <a href="/joys-of-apex/blog/joys-of-apex/">Apex Enum Class Gotchas</a> article that sending the <code>name()</code> value for an enum is the only way to properly deserialize the enum when you're ingesting data either in Apex or in another service. That's all well and good -- but, as it turns out, you can't deserialize directly to the String-based enum:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// in Rollup.cls - making this a public enum doesn't change the result" id="code14-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// in Rollup.cls - making this a public enum doesn't change the result</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private enum Op {" id="code14-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">Op</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  SUM," id="code14-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  SUM<span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  UPDATE_SUM," id="code14-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  UPDATE_SUM<span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  DELETE_SUM" id="code14-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  DELETE_SUM</div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  // etc" id="code14-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token comment">// etc</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code14-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code14-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Rollup__mdt rollupMetadata = methodWhereWeGetTheMetadata();" id="code14-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Rollup__mdt</span> rollupMetadata <span class="token operator">=</span> <span class="token function">methodWhereWeGetTheMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// this is a crazy thing and I wouldn't have wanted to do it anyway, but science ..." id="code14-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// this is a crazy thing and I wouldn't have wanted to do it anyway, but science ...</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// if you ACTUALLY need to do these things from within Apex, I highly recommend the use of the JSONGenerator class" id="code14-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// if you ACTUALLY need to do these things from within Apex, I highly recommend the use of the JSONGenerator class</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="String operationFromMetadata = '{ &quot;op&quot; : &quot;' + rollupMetadata.RollupType__c + '&quot;}';" id="code14-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">String</span> operationFromMetadata <span class="token operator">=</span> <span class="token string">'{ "op" : "'</span> <span class="token operator">+</span> <span class="token class-name"><span class="token namespace">rollupMetadata<span class="token punctuation">.</span></span>RollupType__c</span> <span class="token operator">+</span> <span class="token string">'"}'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Op operation = (Op)JSON.deserialize(operationFromMetadata, Op.class);" id="code14-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Op</span> operation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Op</span><span class="token punctuation">)</span>JSON<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>operationFromMetadata<span class="token punctuation">,</span> <span class="token class-name">Op</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.debug(operation);" id="code14-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// outputs null" id="code14-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// outputs null</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code14-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// you COULD make a wrapper class" id="code14-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// you COULD make a wrapper class</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private class OpWrapper {" id="code14-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">OpWrapper</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public Op op { get; set; }" id="code14-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token class-name">Op</span> op <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code14-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="OpWrapper opWrapper = (OpWrapper)JSON.deserialize(operationFromMetadata, OpWrapper.class);" id="code14-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">OpWrapper</span> opWrapper <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">OpWrapper</span><span class="token punctuation">)</span>JSON<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>operationFromMetadata<span class="token punctuation">,</span> <span class="token class-name">OpWrapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.debug(opWrapper);" id="code14-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>opWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// outputs: &quot;OpWrapper:[Op=SUM]&quot;, for example" id="code14-l23"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// outputs: "OpWrapper:[Op=SUM]", for example</span></div><br></code></pre><p>Keying the string from the CMDT to be valid JSON <em>and</em> creating a wrapper class left me feeling a little ill, so instead I went with a lazily-loaded <code>Map&lt;String, Op&gt;</code> using the included <code>values()</code> method present on all enums:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="private static Map<String, Op> opNameToOp {" id="code15-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Op</span><span class="token punctuation">&gt;</span></span> opNameToOp <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  get {" id="code15-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  get <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    if (opNameToOp == null) {" id="code15-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>opNameToOp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      opNameToOp = new Map<String, Op>();" id="code15-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      opNameToOp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Op</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      for (Op operation : Op.values()) {" id="code15-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Op</span> operation <span class="token operator">:</span> <span class="token class-name">Op</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        opNameToOp.put(operation.name(), operation);" id="code15-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        opNameToOp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>operation<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> operation<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code15-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code15-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return opNameToOp;" id="code15-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> opNameToOp<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code15-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  set;" id="code15-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  set<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code15-l12"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>It's not perfect, but it's better than crafting JSON to get around not being able to cast from a String to an enum, and not being able to reference the enum by its <code>name()</code> in any other way.</p><h3 id="not-all-fields-of-the-same-type-in-salesforce-support-min-or-max-operations" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Not all fields of the same type in Salesforce support MIN or MAX operations</h3><p>This is probably true of other field types (honestly, at this point, nothing would really surprise me), but it came up frequently for me while testing with <code>Date</code> / <code>Datetime</code> fields, as well as multi-select picklists (the Devil's picklists, some would say).</p><p>It <em>did</em> come as a real surprise to me as I was writing tests; I had used only the Account and Opportunity objects so far in my tests, in an effort to keep them as generic as possible. I wanted to write a test using a <code>Date</code> field that <em>wasn't</em> required on insert to test my <code>DefaultFieldInitializer</code> (more on that in a second). While you can <code>MIN</code> or <code>MAX</code> the Opportunity's <code>CloseDate</code> field, the "parent" object I had been using as the target of my rollups, Account, didn't have a <code>Date</code> field on it. In retrospect, I could have used the Contract object (and later I would), but I'm glad I didn't, as I might not have encountered this charming error message otherwise: <code>System.QueryException: There's a problem with your query: field ActivityDate does not support aggregate operator MAX</code>. Uhhh, OK. Thanks for that, Salesforce.</p><p>Wherever possible, I've tried to make the code resilient to the idiosyncracies of the platform; for operations like this, if that means doing the damn <code>MIN</code> / <code>MAX</code> myself, so be it:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// MIN/MAX is allowed, but not for all fields, and not consistently. Go figure!" id="code16-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// MIN/MAX is allowed, but not for all fields, and not consistently. Go figure!</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="protected virtual override Object calculateNewAggregateValue(Set<Id> excludedItems, Op operation, SObjectField operationField, SObjectType sObjectType) {" id="code16-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">protected</span> virtual override <span class="token class-name">Object</span> <span class="token function">calculateNewAggregateValue</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span> excludedItems<span class="token punctuation">,</span> <span class="token class-name">Op</span> operation<span class="token punctuation">,</span> <span class="token class-name">SObjectField</span> operationField<span class="token punctuation">,</span> <span class="token class-name">SObjectType</span> sObjectType<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Object aggregate;" id="code16-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Object</span> aggregate<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  try {" id="code16-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">try</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    aggregate = super.calculateNewAggregateValue(excludedItems, operation, operationField, sObjectType);" id="code16-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    aggregate <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">calculateNewAggregateValue</span><span class="token punctuation">(</span>excludedItems<span class="token punctuation">,</span> operation<span class="token punctuation">,</span> operationField<span class="token punctuation">,</span> sObjectType<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  } catch (Exception ex) {" id="code16-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    // technically a System.QueryException, but I figure we might as well catch em all and try like hell to aggregate anyway" id="code16-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">// technically a System.QueryException, but I figure we might as well catch em all and try like hell to aggregate anyway</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Decimal minOrMax;" id="code16-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Decimal</span> minOrMax<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    List<SObject> allOtherItems = Database.query('SELECT ' + operationField + ' FROM ' + sObjectType + ' WHERE Id != :excludedItems');" id="code16-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> allOtherItems <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT '</span> <span class="token operator">+</span> operationField <span class="token operator">+</span> <span class="token string">' FROM '</span> <span class="token operator">+</span> sObjectType <span class="token operator">+</span> <span class="token string">' WHERE Id != :excludedItems'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    for (SObject otherItem : allOtherItems) {" id="code16-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SObject</span> otherItem <span class="token operator">:</span> allOtherItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      Decimal otherItemDate = this.getDecimalOrDefault(otherItem.get(operationField));" id="code16-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">Decimal</span> otherItemDate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDecimalOrDefault</span><span class="token punctuation">(</span>otherItem<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>operationField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      if (otherItemDate != null &amp;&amp; operation.name().contains(Op.MAX.name()) &amp;&amp; (minOrMax == null || otherItemDate > minOrMax)) {" id="code16-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>otherItemDate <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> operation<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">Op</span><span class="token punctuation">.</span>MAX<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>minOrMax <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> otherItemDate <span class="token operator">&gt;</span> minOrMax<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        minOrMax = otherItemDate;" id="code16-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        minOrMax <span class="token operator">=</span> otherItemDate<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      } else if (otherItemDate != null &amp;&amp; operation.name().contains(Op.MIN.name()) &amp;&amp; (minOrMax == null || otherItemDate < minOrMax)) {" id="code16-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>otherItemDate <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> operation<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">Op</span><span class="token punctuation">.</span>MIN<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>minOrMax <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> otherItemDate <span class="token operator">&lt;</span> minOrMax<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        minOrMax = otherItemDate;" id="code16-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        minOrMax <span class="token operator">=</span> otherItemDate<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code16-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code16-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    if (minOrMax == null) {" id="code16-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>minOrMax <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      aggregate = operation.name().contains(Op.MIN.name()) ? FieldInitializer.maximumLongValue : FieldInitializer.minimumLongValue;" id="code16-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      aggregate <span class="token operator">=</span> operation<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">Op</span><span class="token punctuation">.</span>MIN<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">FieldInitializer</span><span class="token punctuation">.</span>maximumLongValue <span class="token operator">:</span> <span class="token class-name">FieldInitializer</span><span class="token punctuation">.</span>minimumLongValue<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    } else {" id="code16-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      aggregate = minOrMax;" id="code16-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      aggregate <span class="token operator">=</span> minOrMax<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code16-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code16-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code16-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  return aggregate;" id="code16-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> aggregate<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code16-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// not pictured - the &quot;hot as hell&quot; section where min/max gets tabulated for multi-select picklists. Yowza! Feel the burn!" id="code16-l27"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// not pictured - the "hot as hell" section where min/max gets tabulated for multi-select picklists. Yowza! Feel the burn!</span></div><br></code></pre><h3 id="null-as-a-value-doesnt-retain-its-type-information" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Null as a value doesn't retain its type information</h3><p>I thought I'd be able to simply query a given field on the rollup object in question, test for its type using <code>instanceof</code>, and then move on to rolling up. Unfortunately, that approach failed on my very first test where the rollup object didn't have the rollup field initialized. I needed to find something -- <em>anything</em> -- that would give me a clue about what the type was for a given field at runtime, and found it in the <code>DisplayType</code> enum. Indeed, I found out after creating the default value initializer that this was the same method employed by a number of dynamic Apex test libraries:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// in Rollup.cls" id="code17-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// in Rollup.cls</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private virtual class DefaultSObjectFieldInitializer {" id="code17-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> virtual <span class="token keyword">class</span> <span class="token class-name">DefaultSObjectFieldInitializer</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public final Datetime defaultDateTime = Datetime.newInstanceGmt(1970, 1, 1);" id="code17-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Datetime</span> defaultDateTime <span class="token operator">=</span> <span class="token class-name">Datetime</span><span class="token punctuation">.</span><span class="token function">newInstanceGmt</span><span class="token punctuation">(</span><span class="token number">1970</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public final Long maximumLongValue = (Math.pow(2, 63) - 1).longValue();" id="code17-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> maximumLongValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public final Long minimumLongValue = this.maximumLongValue * -1;" id="code17-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> minimumLongValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maximumLongValue <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code17-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  public virtual Object getDefaultValue(SObjectField field) {" id="code17-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">public</span> virtual <span class="token class-name">Object</span> <span class="token function">getDefaultValue</span><span class="token punctuation">(</span><span class="token class-name">SObjectField</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      DescribeFieldResult fieldDescribe = field.getDescribe();" id="code17-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">DescribeFieldResult</span> fieldDescribe <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      if (fieldDescribe.isDefaultedOnCreate()) {" id="code17-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldDescribe<span class="token punctuation">.</span><span class="token function">isDefaultedOnCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        return fieldDescribe.getDefaultValue();" id="code17-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">return</span> fieldDescribe<span class="token punctuation">.</span><span class="token function">getDefaultValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code17-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      // not surprisingly, &quot;getDefaultValue&quot; on the DescribeFieldResult returns null for fields without default values" id="code17-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">// not surprisingly, "getDefaultValue" on the DescribeFieldResult returns null for fields without default values</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      // this is a shame - all types *should* have default values. Instead, we have the privilege of getting to initialize them" id="code17-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token comment">// this is a shame - all types *should* have default values. Instead, we have the privilege of getting to initialize them</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      Object initializedDefault;" id="code17-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">Object</span> initializedDefault<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      switch on fieldDescribe.getType() {" id="code17-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">switch</span> on fieldDescribe<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when CURRENCY, DOUBLE, INTEGER, LONG, PERCENT {" id="code17-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when CURRENCY<span class="token punctuation">,</span> DOUBLE<span class="token punctuation">,</span> INTEGER<span class="token punctuation">,</span> LONG<span class="token punctuation">,</span> PERCENT <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        initializedDefault = 0;" id="code17-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        initializedDefault <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code17-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when DATETIME {" id="code17-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when DATETIME <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        initializedDefault = this.defaultDateTime;" id="code17-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        initializedDefault <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultDateTime<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code17-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when DATE {" id="code17-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when DATE <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        initializedDefault = this.defaultDateTime.dateGmt();" id="code17-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        initializedDefault <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultDateTime<span class="token punctuation">.</span><span class="token function">dateGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code17-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when TIME {" id="code17-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when TIME <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        initializedDefault = this.defaultDateTime.timeGmt();" id="code17-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        initializedDefault <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultDateTime<span class="token punctuation">.</span><span class="token function">timeGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code17-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when STRING, ID, TEXTAREA, URL, PHONE, EMAIL{" id="code17-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when STRING<span class="token punctuation">,</span> ID<span class="token punctuation">,</span> TEXTAREA<span class="token punctuation">,</span> URL<span class="token punctuation">,</span> PHONE<span class="token punctuation">,</span> EMAIL<span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        initializedDefault = '';" id="code17-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        initializedDefault <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code17-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when PICKLIST, MULTIPICKLIST {" id="code17-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when PICKLIST<span class="token punctuation">,</span> MULTIPICKLIST <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        // more on this part in a second" id="code17-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token comment">// more on this part in a second</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        initializedDefault = new PicklistController(field.getDescibe()).getDefaultValue(field);" id="code17-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        initializedDefault <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PicklistController</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getDescibe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultValue</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code17-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      when else {" id="code17-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      when <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        throw new IllegalArgumentException('Field: ' + field + ' of type: ' + fieldType.name() + ' specified invalid for rollup operation');" id="code17-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">'Field: '</span> <span class="token operator">+</span> field <span class="token operator">+</span> <span class="token string">' of type: '</span> <span class="token operator">+</span> fieldType<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' specified invalid for rollup operation'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code17-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code17-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return initializedDefault;" id="code17-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> initializedDefault<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code17-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code17-l41"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><h3 id="finding-default-sobject-fields-for-different-displaytypes-is-fun" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Finding default SObject fields for different DisplayTypes is fun</h3><p>In the end, this Anonymous Apex script proved invaluable for hunting down standardly available fields of special types like <code>TIME</code>:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="public static void printDisplayTypeInfo(DisplayType desiredType) {" id="code18-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printDisplayTypeInfo</span><span class="token punctuation">(</span><span class="token class-name">DisplayType</span> desiredType<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  Map<String, SObjectType> namesToTypes = Schema.getGlobalDescribe();" id="code18-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SObjectType</span><span class="token punctuation">&gt;</span></span> namesToTypes <span class="token operator">=</span> <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">getGlobalDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  for(SObjectType sType : namesToTypes.values()) {" id="code18-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SObjectType</span> sType <span class="token operator">:</span> namesToTypes<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    Map<String, SObjectField> fields = sType.getDescribe().fields.getMap();" id="code18-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span> fields <span class="token operator">=</span> sType<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fields<span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    for(String fieldName : fields.keyset()){" id="code18-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> fieldName <span class="token operator">:</span> fields<span class="token punctuation">.</span><span class="token function">keyset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      SObjectField field = fields.get(fieldName);" id="code18-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">SObjectField</span> field <span class="token operator">=</span> fields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      DescribeFieldResult describeResult = field.getDescribe();" id="code18-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">DescribeFieldResult</span> describeResult <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      if(describeResult.getType() == desiredType &amp;&amp; describeResult.isUpdateable()) {" id="code18-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">if</span><span class="token punctuation">(</span>describeResult<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> desiredType <span class="token operator">&amp;&amp;</span> describeResult<span class="token punctuation">.</span><span class="token function">isUpdateable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="          System.debug('SObjectType: ' + sType);" id="code18-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>          <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'SObjectType: '</span> <span class="token operator">+</span> sType<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="          System.debug(describeResult.getName());" id="code18-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>          <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>describeResult<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="          // you could put a return statement here to only print the first result found" id="code18-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>          <span class="token comment">// you could put a return statement here to only print the first result found</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code18-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code18-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code18-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code18-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>I had never worked with the ContactPointAddress or ContactPointEmail objects before; they're relatively new additions to the system, and it was fun to learn a bit more about them while using them to wire up different zany relationships.</p><h3 id="object-oriented-programming-is-extremely-powerful-all-dates-are-numbers" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Object-Oriented Programming Is Extremely Powerful (All Dates Are Numbers)</h3><p>I've talked quite a bit about the infamous <code>switch</code> statement now in the <code>DecimalRollupCalculator</code>. After implementing all of the rollup operations for numbers, I teetered at the precipice -- how to take the logic in <code>DecimalRollupCalculator</code> and generalize it so that other subclasses could make use of it. As I considered the horrors of a <code>switch</code> statement that needed to differentiate not only between different rollup operations, but also their <em>context</em> (was it an insert? an update? a delete??), my stomach began to twist. I had just written my first failing test for implementing MAX for Datetimes. Would my response <em>really</em> be to copy pasta?</p><p>Then it hit me. Datetimes are all stored uniformly within Salesforce in UTC time. UTC can be represented by numbers. <code>Dates</code> are just <code>Datetime</code>s with a zero'd out <code>Time</code> section. The game was on. In the end, this section <em>truly</em> took very little additional code to get right:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// omitting the Datetime parent class, which itself descends from DecimalRollupCalculator" id="code19-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// omitting the Datetime parent class, which itself descends from DecimalRollupCalculator</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// the reason should be clear if you take a peek at the source code. While it's simple, an" id="code19-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// the reason should be clear if you take a peek at the source code. While it's simple, an</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// excerpt from DatetimeRollupCalculator is shown below in the &quot;SOQL Drops Milliseconds From Datetimes ...&quot; section" id="code19-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// excerpt from DatetimeRollupCalculator is shown below in the "SOQL Drops Milliseconds From Datetimes ..." section</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="private class DateRollupCalculator extends DatetimeRollupCalculator {" id="code19-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DateRollupCalculator</span> <span class="token keyword">extends</span> <span class="token class-name">DatetimeRollupCalculator</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    // for Date, it's not necessary to override the &quot;getDecimalOrDefault&quot; method in DatetimeRollupCalculator" id="code19-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">// for Date, it's not necessary to override the "getDecimalOrDefault" method in DatetimeRollupCalculator</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    // because the conversion only happens in &quot;getReturnValue&quot;" id="code19-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">// because the conversion only happens in "getReturnValue"</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    public DateRollupCalculator(Object priorVal, SObjectField operationField) {" id="code19-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token class-name">DateRollupCalculator</span><span class="token punctuation">(</span><span class="token class-name">Object</span> priorVal<span class="token punctuation">,</span> <span class="token class-name">SObjectField</span> operationField<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      super(Datetime.newInstanceGmt((Date) priorVal, Time.newInstance(0, 0, 0, 0)), operationField);" id="code19-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Datetime</span><span class="token punctuation">.</span><span class="token function">newInstanceGmt</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Date</span><span class="token punctuation">)</span> priorVal<span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code19-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code19-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    public override Object getReturnValue() {" id="code19-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> override <span class="token class-name">Object</span> <span class="token function">getReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      return ((Datetime) super.getReturnValue()).dateGmt();" id="code19-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Datetime</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dateGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code19-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code19-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code19-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private class TimeRollupCalculator extends DatetimeRollupCalculator {" id="code19-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">TimeRollupCalculator</span> <span class="token keyword">extends</span> <span class="token class-name">DatetimeRollupCalculator</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    public TimeRollupCalculator(Object priorVal, SObjectField operationField) {" id="code19-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token class-name">TimeRollupCalculator</span><span class="token punctuation">(</span><span class="token class-name">Object</span> priorVal<span class="token punctuation">,</span> <span class="token class-name">SObjectField</span> operationField<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      super(Datetime.newInstanceGmt(FieldInitializer.defaultDateTime.dateGmt(), (Time) priorVal), operationField);" id="code19-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Datetime</span><span class="token punctuation">.</span><span class="token function">newInstanceGmt</span><span class="token punctuation">(</span><span class="token class-name">FieldInitializer</span><span class="token punctuation">.</span>defaultDateTime<span class="token punctuation">.</span><span class="token function">dateGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">)</span> priorVal<span class="token punctuation">)</span><span class="token punctuation">,</span> operationField<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code19-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code19-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    public override Object getReturnValue() {" id="code19-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> override <span class="token class-name">Object</span> <span class="token function">getReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      return ((Datetime) super.getReturnValue()).timeGmt();" id="code19-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Datetime</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code19-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code19-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    protected override Decimal getDecimalOrDefault(Object potentiallyUnitializedDecimal) {" id="code19-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">protected</span> override <span class="token class-name">Decimal</span> <span class="token function">getDecimalOrDefault</span><span class="token punctuation">(</span><span class="token class-name">Object</span> potentiallyUnitializedDecimal<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      Datetime defaultDatetime;" id="code19-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token class-name">Datetime</span> defaultDatetime<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      if (potentiallyUnitializedDecimal instanceof Time) {" id="code19-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>potentiallyUnitializedDecimal <span class="token keyword">instanceof</span> <span class="token class-name">Time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        defaultDatetime = Datetime.newInstanceGmt(FieldInitializer.defaultDateTime.dateGmt(), (Time) potentiallyUnitializedDecimal);" id="code19-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        defaultDatetime <span class="token operator">=</span> <span class="token class-name">Datetime</span><span class="token punctuation">.</span><span class="token function">newInstanceGmt</span><span class="token punctuation">(</span><span class="token class-name">FieldInitializer</span><span class="token punctuation">.</span>defaultDateTime<span class="token punctuation">.</span><span class="token function">dateGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">)</span> potentiallyUnitializedDecimal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      } else if (potentiallyUnitializedDecimal instanceof Decimal) {" id="code19-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>potentiallyUnitializedDecimal <span class="token keyword">instanceof</span> <span class="token class-name">Decimal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        defaultDatetime = Datetime.newInstance(((Decimal) potentiallyUnitializedDecimal).longValue());" id="code19-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        defaultDatetime <span class="token operator">=</span> <span class="token class-name">Datetime</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span> potentiallyUnitializedDecimal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      } else {" id="code19-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="        defaultDatetime = FieldInitializer.defaultDateTime;" id="code19-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        defaultDatetime <span class="token operator">=</span> <span class="token class-name">FieldInitializer</span><span class="token punctuation">.</span>defaultDateTime<span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      }" id="code19-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="      return defaultDatetime.getTime();" id="code19-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">return</span> defaultDatetime<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    }" id="code19-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code19-l36"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br></code></pre><p>That commit -- and the powerful realization that I'd been able to add a possible <em>sixty-three</em> different permutations for rollup operations in what amounted to a mere ~32 lines of code ... that's the power of Object-Oriented Programming!</p><p><strong>Edit</strong> -- what I failed to mention, upon originally publishing this article, was that there <em>was</em> a duplicated switch statement (for String-based rollups); a detail that had bothered me in the days leading up to release, but which I didn't have the time (or energy, after several marathon days spent "finishing" <code>Rollup</code>) to address prior to launching. Several days after releasing, I went back and made use of the <a href="https://en.wikipedia.org/wiki/Chain-of-responsibility_pattern">Chain Of Responsibility</a> to break up this duplication. As is common when virtual methods are added at the parent level, this actually ended up <em>increasing</em> the lines of code in the final <code>Rollup</code> file. At the same time, indentation (one of the great sins present in the use of switch statements) was much reduced. What was left? <a href="https://github.com/jamessimone/apex-rollup/blob/v1.0.2/rollup/main/default/classes/Rollup.cls#L1407">One switch statement to rule them all, with virtual methods to bind them</a>. While lines of code can be a metric for complexity, it also often ends up being deceptive -- the code reads more like a story, now, where rollup operations are explicitly opted into, instead of having to scan through a switch statement to determine which operation leads to which result.</p><h3 id="intvalue-on-a-long-can-be-a-wild-ride" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>intValue() on a Long can be a wild ride</h3><p>While working on MAX/MIN based code, I realized quickly that there were only two reliable sentinel values when it came to numbers -- the maximum possible number that would fit into a 64-bit number (a <code>Long</code>), and the minimum possible number. What bit me <em>really, really</em> hard while working on implementing min/max for picklists? To anwer that, first an aside -- min/maxing on a picklist is supposed to return the deepest possible entry in the picklist (for MAX), or the closest to the top of the picklist (for MIN). Picklists have many ... interesting ... subleties in Salesforce, and the implicit concept of "rank" (just look at the Path components for Lead Status or Opportunity Stage Name) is just one of their many quirks.</p><p>If a value doesn't exist on the lookup object, that value should always lose; on a MIN it should be greater than the "rank" of any other field (so that any comparison to it leads to a truthy "less than" evaluation); on a MAX it should be less than the rank of any other field (likewise; it should lead to a truthy "greater than" evaluation). Making an object to perform these evaluations for picklists was a great exercise in Object Oriented Programming -- frequently throughout this project, that proved to be the case. Making the <code>PicklistController</code> inner class descend from the <code>DefaultFieldInitializer</code> made sense in the context of the object hierarchy. Though the <code>PicklistController</code> had many more responsibilities, it could also handle setting the default value for a picklist with ease.</p><p>Where things finally took a turn for the worse was when my first picklist test for ensuring MIN/MAX was working correctly failed. The logic looked perfect -- what could be the issue? It took me a painful 30 minutes to <em>see</em> the issue, so deeply ingrained were my assumptions about the way that <code>Long</code> values would translate to <code>Integers</code>. Only at the last second did I truly comprehend that I had betrayed myself:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="private class PicklistController extends DefaultSObjectFieldInitializer {" id="code20-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">PicklistController</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultSObjectFieldInitializer</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// etc ..." id="code20-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// etc ...</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code20-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  private Integer getSentinelValue(Boolean isMin) {" id="code20-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">private</span> <span class="token class-name">Integer</span> <span class="token function">getSentinelValue</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> isMin<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    return (isMin ? this.maximumLongValue : this.minimumLongValue).intValue();" id="code20-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>isMin <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maximumLongValue <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minimumLongValue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  }" id="code20-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="}" id="code20-l7"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>Passing <code>Boolean</code> values as method arguments is always to be strongly discouraged, but this method call was already on the tail end of a ternary and I felt, when creating it, that I had no other option. I will say, though, that I once had a coworker who was deeply passionate about using nested ternaries. I lost track of him over the years, but ... perhaps the issue would have been clearer to me if the culprit had been in a truly doubled ternary; after all, who in their right minds could avoid investigating such a travesty?</p><p>In any case. Do you know what the integer values are for the minimum and maximum <code>Long</code> values (-2^63 and 2^63, respectively)?</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="Long maximumLongValue = (Math.pow(2, 63) - 1).longValue();" id="code21-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Long</span> maximumLongValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Long minimumLongValue = maximumLongValue * -1;" id="code21-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Long</span> minimumLongValue <span class="token operator">=</span> maximumLongValue <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code21-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.debug(maximumLongValue); // prints: 9223372036854775807" id="code21-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>maximumLongValue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints: 9223372036854775807</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.debug(minimumLongValue); // prints: -9223372036854775807" id="code21-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>minimumLongValue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints: -9223372036854775807</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="" id="code21-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// Now as ints!" id="code21-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// Now as ints!</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.debug(maximumLongValue.intValue()); // prints -1" id="code21-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>maximumLongValue<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints -1</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="System.debug(minimumLongValue.intValue()); // prints 1" id="code21-l9"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>minimumLongValue<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 1</span></div><br></code></pre><p>Ouch. Well, that explained my failing test! My understanding (after a brief foray into the details) is that casting to <code>Integer</code> or calling <code>intValue()</code> is safe within the bounds of the 32-bit allowed integer sizes, but after that all bets are off. Creating the min/max integer bounds did the trick wonderfully. Running into edge cases like this can hurt, but it also expands the mind -- you only get bit by something like this once before knowing to look out for it next time around. Plus, I ended up being able to get rid of the <code>Boolean</code> passing altogether -- two birds with one stone!</p><h3 id="soql-drops-the-milliseconds-from-datetime-fields-when-they-are-retrieved-from-the-database" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>SOQL drops the milliseconds from Datetime fields when they are retrieved from the database</h3><p>This was a fun one -- and one that I was already aware of from lurking on the <a href="https://join.sfxd.org/">SFXD Discord</a>. This is a real pain -- especially in testing --, but in the end the following bit did the trick nicely:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-19"><span></span><span></span><span></span><span></span></span><div class="line-0-0-18  -codedoc-code-line" data-content="// one of the worst things about SOQL is that Datetimes retrieved have the millisecond values truncated" id="code22-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// one of the worst things about SOQL is that Datetimes retrieved have the millisecond values truncated</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="Datetime datetimeWithMs = potentiallyUnitializedDecimal instanceof Decimal" id="code22-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">Datetime</span> datetimeWithMs <span class="token operator">=</span> potentiallyUnitializedDecimal <span class="token keyword">instanceof</span> <span class="token class-name">Decimal</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  ? Datetime.newInstance(((Decimal) potentiallyUnitializedDecimal).longValue())" id="code22-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token operator">?</span> <span class="token class-name">Datetime</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span> potentiallyUnitializedDecimal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  : ((Datetime) potentiallyUnitializedDecimal);" id="code22-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Datetime</span><span class="token punctuation">)</span> potentiallyUnitializedDecimal<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// reading through the source code provides a more cogent rationale" id="code22-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// reading through the source code provides a more cogent rationale</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="// for the above eyesore over anything I can muster here." id="code22-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">// for the above eyesore over anything I can muster here.</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="return Datetime.newInstanceGmt(" id="code22-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">return</span> <span class="token class-name">Datetime</span><span class="token punctuation">.</span><span class="token function">newInstanceGmt</span><span class="token punctuation">(</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    datetimeWithMs.yearGmt()," id="code22-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    datetimeWithMs<span class="token punctuation">.</span><span class="token function">yearGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    datetimeWithMs.monthGmt()," id="code22-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    datetimeWithMs<span class="token punctuation">.</span><span class="token function">monthGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    datetimeWithMs.dayGmt()," id="code22-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    datetimeWithMs<span class="token punctuation">.</span><span class="token function">dayGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    datetimeWithMs.hourGmt()," id="code22-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    datetimeWithMs<span class="token punctuation">.</span><span class="token function">hourGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    datetimeWithMs.minuteGmt()," id="code22-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    datetimeWithMs<span class="token punctuation">.</span><span class="token function">minuteGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="    datetimeWithMs.secondGmt()" id="code22-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    datetimeWithMs<span class="token punctuation">.</span><span class="token function">secondGmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-18  -codedoc-code-line" data-content="  )" id="code22-l14"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">)</span></div><br></code></pre><hr><h2 id="custom-rollup-wrap-up" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Custom Rollup Wrap-up</h2><p>Well, it's out there now. This article -- and the corresponding code -- has consumed an enormous quantity of time since work began on it in earnest in early December. I would highly recommend developers check out <a href="https://github.com/jamessimone/apex-rollup/">the source code</a> (and the travelogue style <a href="https://github.com/jamessimone/apex-mocks-stress-test/commits/rollup">commit history</a>). Over the coming months I plan to add more functionality to <code>Rollup</code> -- for now, I'm hopeful that you'll consider trying it out. It's efficient, scales elastically, allows for rollups on fields (like <code>Task.ActivityDate</code>) that don't always allow for rollups in SOQL, and is well-tested.</p><p>I'm aware that <code>Rollup</code> doesn't hit 100% feature-parity versus DLRS ... and though I have plans to meet that challenge, as well, I believe that we're well past the fabled "80% of the functionality" stage. If your org (like many out there) is struggling under the weight of DLRS' auto-spawned triggers, I'm confident that <code>Rollup</code> will be a valuable tool for both the declaratively-minded as well as the developers out there.</p><hr><h2 id="postscript" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Postscript</h2><p>My original intent was to finish this article by December 27th, the one year anniversary of the <a href="/joys-of-apex/">Joys Of Apex</a>. Despite some insanely long days spent writing, that didn't quite happen. Despite that, I just wanted to say that the readers of this series have helped ease the burden in a year that was extremely challenging for many people. Stuck inside for large portions of time, I took to writing -- and it shows. More than ten of the articles I wrote over the last year came out during the first 2 months of the pandemic -- some only days apart from one another. I do not advertise, and have not attempted to monetise in any way the incredible surge of traffic my personal website has experienced as a result. My intent is to provide readers with free content and materials to refer back to. Indeed, the only work I've done on the site over the past year was immediately preceeding this article, as I spruced up the Joys Of Apex blog page to better show off the posts.</p><p>All of that is to say -- thank you for an incredible year. Here's to hoping that 2021 will prove a better year for the world, and for you.</p><p>The original version of <a href="https://www.jamessimone.net/blog/joys-of-apex/replacing-dlrs-with-custom-rollup/">Replacing DLRS With Custom Rollup can be read on my blog.</a></p><div class="contentnav-0-0-7" data-no-search=""><a href="#custom-rollup-use-cases" class="h2" data-content-highlight="custom-rollup-use-cases">Use Cases For Custom Rollups</a><a href="#introducing-rollup" class="h2" data-content-highlight="introducing-rollup">Introducing Rollup</a><a href="#getting-the-sobjecttype-from-an-sobjectfield" class="h3" data-content-highlight="getting-the-sobjecttype-from-an-sobjectfield">Getting The SObjectType From An SObjectField</a><a href="#implementing-rollups-in-apex" class="h3" data-content-highlight="implementing-rollups-in-apex">Implementing Rollups In Apex</a><a href="#reduce-reuse-refactor-rollup-part-two" class="h2" data-content-highlight="reduce-reuse-refactor-rollup-part-two">Reduce, Reuse, Refactor: Rollup, Part Two</a><a href="#rollup---a-note-on-progress" class="h2" data-content-highlight="rollup---a-note-on-progress">Rollup - A Note On Progress</a><a href="#design-decisions-for-testing-the-rollup-framework" class="h3" data-content-highlight="design-decisions-for-testing-the-rollup-framework">Design Decisions For Testing The Rollup Framework</a><a href="#adding-custom-metadata-driven-rollups" class="h2" data-content-highlight="adding-custom-metadata-driven-rollups">Adding Custom Metadata-driven Rollups</a><a href="#invoking-rollupcls-from-a-process-builder--flow" class="h2" data-content-highlight="invoking-rollupcls-from-a-process-builder--flow">Invoking Rollup.cls From A Process Builder / Flow</a><a href="#key-takeaways-in-replacing-dlrs" class="h2" data-content-highlight="key-takeaways-in-replacing-dlrs">Key Takeaways In Replacing DLRS</a><a href="#entity-definition--field-definition-custom-metadata-relationships-can-be-tricky" class="h3" data-content-highlight="entity-definition--field-definition-custom-metadata-relationships-can-be-tricky">Entity Definition &amp; Field Definition Custom Metadata Relationships Can Be Tricky</a><a href="#using-enums-is-great-but-instantiating-them-from-strings-isnt-obvious" class="h3" data-content-highlight="using-enums-is-great-but-instantiating-them-from-strings-isnt-obvious">Using Enums Is Great, But Instantiating Them From Strings Isn't Obvious</a><a href="#not-all-fields-of-the-same-type-in-salesforce-support-min-or-max-operations" class="h3" data-content-highlight="not-all-fields-of-the-same-type-in-salesforce-support-min-or-max-operations">Not all fields of the same type in Salesforce support MIN or MAX operations</a><a href="#null-as-a-value-doesnt-retain-its-type-information" class="h3" data-content-highlight="null-as-a-value-doesnt-retain-its-type-information">Null as a value doesn't retain its type information</a><a href="#finding-default-sobject-fields-for-different-displaytypes-is-fun" class="h3" data-content-highlight="finding-default-sobject-fields-for-different-displaytypes-is-fun">Finding default SObject fields for different DisplayTypes is fun</a><a href="#object-oriented-programming-is-extremely-powerful-all-dates-are-numbers" class="h3" data-content-highlight="object-oriented-programming-is-extremely-powerful-all-dates-are-numbers">Object-Oriented Programming Is Extremely Powerful (All Dates Are Numbers)</a><a href="#intvalue-on-a-long-can-be-a-wild-ride" class="h3" data-content-highlight="intvalue-on-a-long-can-be-a-wild-ride">intValue() on a Long can be a wild ride</a><a href="#soql-drops-the-milliseconds-from-datetime-fields-when-they-are-retrieved-from-the-database" class="h3" data-content-highlight="soql-drops-the-milliseconds-from-datetime-fields-when-they-are-retrieved-from-the-database">SOQL drops the milliseconds from Datetime fields when they are retrieved from the database</a><a href="#custom-rollup-wrap-up" class="h2" data-content-highlight="custom-rollup-wrap-up">Custom Rollup Wrap-up</a><a href="#postscript" class="h2" data-content-highlight="postscript">Postscript</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/advanced-logging-using-nebula-logger">Advanced Logging Using Nebula Logger</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/formula-date-issues">Formula Date Issues</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/lwc-custom-path">LWC Custom Lead Path</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/refactoring-tips-and-tricks">Refactoring Tips &amp; Tricks</a>
<a href="/joys-of-apex/replacing-dlrs-with-custom-rollup">Replacing DLRS With Custom Rollup</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/set-timeout-and-implementing-delays">setTimeout &amp; Implementing Delays</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/testing-custom-permissions">Testing Custom Permissions</a>
<a href="/joys-of-apex/the-tao-of-apex">The Tao Of Apex</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="XDTmwSYGOM">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("XDTmwSYGOM", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="EBLqlwznAG">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("EBLqlwznAG", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="oTHuynLHWI">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("oTHuynLHWI", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>