<!DOCTYPE html><html><head><title>Joys Of Apex | Refactoring Tips &amp; Tricks</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Refactoring Tips &amp; Tricks"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Refactoring Tips &amp; Tricks"><meta name="keywords" content=""><meta property="blog-tags" content=""></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"refactoring-tips-and-tricks.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Refactoring Tips &amp; Tricks</p></span></h1><script id="TcRsEzcQFx">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("TcRsEzcQFx", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2020-07-30T15:12:03.284Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>Identifying areas for potential code reuse is not always obvious. People learn and remember things in different ways; on a large team, and in a large project, keeping the entirety of a code base in your head is frequently an improbable proposition. Some manage. Some find themselves rewriting functions monotonously, either on a tight sprint deadline or simply because it’s easier to <em>copy paste</em> than it is to generalize. Refactoring is, ultimately, a luxury — but one that is worthwhile to invest your time in, as you will reap the dividends of refactoring efforts the longer your code is in use.</p><p>I’d like to walk you through some of my favorite refactoring tools — both mental and tangible assets that may help you to identify repetitive code that it is safe to abstract upon or consolidate.</p><h2 id="collection-utilities" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Collection Utilities</h2><p>I have frequently touched upon the necessity of Apex <code>List</code> (and other iterable classes) helpers. In another programming language, you frequently have the option to extend the base library classes in order to add functionality as you see fit — since we don’t have that luxury in Apex, it instead makes sense to cover useful <code>List</code> extension methods, which can reside in a helper class. Once more, we’re left without the tools we might otherwise be armed by: since you can’t create static classes in Apex, I typically like to label my Utils classes as abstract. This prevents them from being erroneously instantiated at runtime.</p><p>The "two" biggest helper functions you will 100% find use for in your journey through Apex? Methods for creating Maps from Lists or Sets. I say "two" in quotes because you will also benefit from overloading these methods to give you greater flexibility (although you only need to adopt the methods you intend to use). Before showing them off, let's look at a little code that you might find familiar:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="//a processing method in one of your classes" id="code1-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//a processing method in one of your classes</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="private Map<Id, List<SObject>> getTasksKeyedToAccounts(List<Account> accounts) {" id="code1-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTasksKeyedToAccounts</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    //you might prefer a lower allocation cost" id="code1-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//you might prefer a lower allocation cost</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    //method to get the Ids for each account." id="code1-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//method to get the Ids for each account.</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    //that's legit! I also typically keep this" id="code1-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//that's legit! I also typically keep this</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    //method in the same utils class I'll be showing" id="code1-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//method in the same utils class I'll be showing</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    Set<Id> accountIds = new Map<Id, Account>(accounts).keySet();" id="code1-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span> accountIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    List<Task> tasks = [" id="code1-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> <span class="token punctuation">[</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        SELECT Id, WhatId, etc ..." id="code1-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        SELECT <span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">WhatId</span><span class="token punctuation">,</span> etc <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        FROM Task" id="code1-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        FROM <span class="token class-name">Task</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        WHERE WhatId =: accountIds" id="code1-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        WHERE <span class="token class-name">WhatId</span> <span class="token operator">=</span><span class="token operator">:</span> accountIds</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    ];" id="code1-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code1-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    Map<Id, List<SObject>> accountIdToTasks = new Map<Id, List<SObject>>();" id="code1-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> accountIdToTasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    for(Task t : tasks) {" id="code1-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Task</span> t <span class="token operator">:</span> tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        if(accountIdToTasks.containsKey(t.WhatId)) {" id="code1-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">if</span><span class="token punctuation">(</span>accountIdToTasks<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token class-name">WhatId</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            accountIdToTasks.get(t.WhatId).add(t);" id="code1-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            accountIdToTasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token class-name">WhatId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        } else {" id="code1-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            accountIdToTasks.put(t.WhatId, new List<SObject> { t });" id="code1-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            accountIdToTasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token class-name">WhatId</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        }" id="code1-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code1-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code1-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    //do further processing higher in the call stack" id="code1-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//do further processing higher in the call stack</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    return accountIdToTasks;" id="code1-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> accountIdToTasks<span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code1-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>That's your garden-variety one-to-many example of code that is practically begging to be refactored. There is also the (much simpler) one-to-one example: the cases where you need to return a <code>Map&lt;Id, SObject&gt;</code>. In both instances, it's entirely possible that you will occasionally also have some additional filtering criteria when building your Map — it may be the case that at times you need to filter some of your SObjects out based on domain-specific business rules. Taking the previously shown example a bit further (and for more notes on making constants for your picklists, check out <a href="/joys-of-apex/picklist-validation">my post on Picklist Validation</a>):</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="//back in getTasksKeyedToAccounts" id="code2-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//back in getTasksKeyedToAccounts</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//normally I would use previously constructed constants" id="code2-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//normally I would use previously constructed constants</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//if these values, like the below, were coming from a picklist" id="code2-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//if these values, like the below, were coming from a picklist</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="List<String> matchingTaskTypes = new List<String>{ 'Chat', 'Inbound' };" id="code2-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> matchingTaskTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> <span class="token string">'Chat'</span><span class="token punctuation">,</span> <span class="token string">'Inbound'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="for(Task t : tasks) {" id="code2-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Task</span> t <span class="token operator">:</span> tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    //if the task's type doesn't match some pre-approved list" id="code2-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//if the task's type doesn't match some pre-approved list</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    //don't add it" id="code2-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">//don't add it</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    if(matchingTaskTypes.contains(t.Type)) {" id="code2-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">if</span><span class="token punctuation">(</span>matchingTaskTypes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token class-name">Type</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        continue;" id="code2-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">continue</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code2-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    else if(accountIdToTasks.containsKey(t.WhatId)) {" id="code2-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>accountIdToTasks<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token class-name">WhatId</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        accountIdToTasks.get(t.WhatId).add(t);" id="code2-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        accountIdToTasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token class-name">WhatId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    } else {" id="code2-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        accountIdToTasks.put(t.WhatId, new List<SObject>{ t });" id="code2-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        accountIdToTasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token class-name">WhatId</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> t <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code2-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code2-l16"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>So ... let's review our use-cases:</p><ul><li>building <code>Map&lt;Id, SObject&gt;</code> with and without filtering</li><li>building <code>Map&lt;Id, List&lt;SObject&gt;&gt;</code> with and without filtering</li></ul><p>Let's take a look at the tests, first:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="@isTest" id="code3-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="private class CollectionUtilsTests {" id="code3-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">CollectionUtilsTests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    @isTest" id="code3-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    static void it_should_create_one_to_one_map_from_key() {" id="code3-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_create_one_to_one_map_from_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//this is an extremely dumbed down example" id="code3-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//this is an extremely dumbed down example</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//you could accomplish the same thing with" id="code3-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//you could accomplish the same thing with</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//the standard Map constructor, but this method" id="code3-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//the standard Map constructor, but this method</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//serves to show that an Id and a String can be used" id="code3-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//serves to show that an Id and a String can be used</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//interchangeably in this context, and that the SObjectField" id="code3-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//interchangeably in this context, and that the SObjectField</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//token can be used to create the Map keys" id="code3-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//token can be used to create the Map keys</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        List<Account> accounts = new List<Account>{" id="code3-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//I've shown the TestingUtils method enough times that I think" id="code3-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//I've shown the TestingUtils method enough times that I think</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//we can skip the documentation on it. Google it or check" id="code3-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//we can skip the documentation on it. Google it or check</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//my repo for the source code" id="code3-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//my repo for the source code</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            new Account(Id = TestingUtils.generateId(Account.SObjectType))" id="code3-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        };" id="code3-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code3-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        Map<String, SObject> expected = new Map<String, SObject> {" id="code3-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> expected <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            accounts[0].Id => accounts[0]" id="code3-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            accounts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token class-name">Id</span> <span class="token operator">=</span><span class="token operator">&gt;</span> accounts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        };" id="code3-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code3-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        System.assertEquals(expected, CollectionUtils.convertToMap(accounts, Account.Id));" id="code3-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">convertToMap</span><span class="token punctuation">(</span>accounts<span class="token punctuation">,</span> <span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code3-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code3-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    @isTest" id="code3-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    static void it_should_create_one_to_many_map_from_key() {" id="code3-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_create_one_to_many_map_from_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        Id accountId = TestingUtils.generateId(Account.SObjectType);" id="code3-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">Id</span> accountId <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code3-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        List<Task> expected = new List<Task>{" id="code3-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> expected <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            new Task(WhatId = accountId, Id = TestingUtils.generateId(Task.SObjectType))," id="code3-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token class-name">WhatId</span> <span class="token operator">=</span> accountId<span class="token punctuation">,</span> <span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            new Task(WhatId = accountId, Id = TestingUtils.generateId(Task.SObjectType))" id="code3-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token class-name">WhatId</span> <span class="token operator">=</span> accountId<span class="token punctuation">,</span> <span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        };" id="code3-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code3-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        Map<String, List<SObject>> actual = CollectionUtils.convertToListMap(expected, Task.WhatId);" id="code3-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> actual <span class="token operator">=</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">convertToListMap</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> <span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token class-name">WhatId</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        System.assertEquals(expected, actual.values()[0]);" id="code3-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> actual<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//yes, you can compare Ids and Strings directly without a cast" id="code3-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//yes, you can compare Ids and Strings directly without a cast</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        System.assertEquals(true, actual.containsKey(accountId));" id="code3-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> actual<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>accountId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//here you need a cast of some sort since next() returns Object" id="code3-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//here you need a cast of some sort since next() returns Object</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//clearly (String) would also suffice" id="code3-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//clearly (String) would also suffice</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        System.assertEquals(accountId, (Id)actual.keySet().iterator().next());" id="code3-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Id</span><span class="token punctuation">)</span>actual<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code3-l41"><span class="lineCounter-0-0-15 -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code3-l42"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">42<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>This is the basic setup, using static <code>convertToMap</code> and <code>convertToListMap</code> methods, which I will show in a moment. Some things to note:</p><ul><li>Ids can function as Strings. This is not a well-documented SFDC feature, but it's something that allows you incredible flexibility when constructing genericized Maps of SObjects</li><li>even if you could have returned a strongly typed SObject (a Task or Account in these examples), you <em>will</em> now have to cast when dealing with your SObjects on the calling side. I consider this a small price to pay for not having to write out those iterations every time I need to key something by an Id/String.</li><li>this structure could be further generalized (instead of locking the inner Map's type down to just <code>SObject</code>s); the paradigm functions well with the base <code>Object</code> as well, which allows you to use these functions anywhere within the system instead of just on Salesforce objects.</li></ul><p>The more complex setup for each method that allows you to perform filtering operations (tests first!):</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="//in CollectionUtilsTests" id="code4-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//in CollectionUtilsTests</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="public class TestCollectionEvaluator extends CollectionUtils.CollectionEvaluator {" id="code4-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestCollectionEvaluator</span> <span class="token keyword">extends</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token class-name">CollectionEvaluator</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    private final List<String> taskTypes;" id="code4-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> taskTypes<span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code4-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public TestCollectionEvaluator() {" id="code4-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token class-name">TestCollectionEvaluator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        super();" id="code4-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        this.taskTypes = new List<String> {" id="code4-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">this</span><span class="token punctuation">.</span>taskTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            'Chat'," id="code4-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token string">'Chat'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            'Inbound Call'" id="code4-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token string">'Inbound Call'</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        };" id="code4-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code4-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code4-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public override Boolean matchesCriteria(SObject obj) {" id="code4-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> override <span class="token class-name">Boolean</span> <span class="token function">matchesCriteria</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//or you could do a &quot;get&quot; here" id="code4-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//or you could do a "get" here</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        return this.taskTypes.contains(((Task)obj).Type);" id="code4-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taskTypes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token class-name">Type</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code4-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code4-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code4-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="@isTest" id="code4-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="static void it_should_create_one_to_many_map_with_filter() {" id="code4-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_create_one_to_many_map_with_filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    Id accountId = TestingUtils.generateId(Account.SObjectType);" id="code4-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Id</span> accountId <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code4-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    List<Task> tasks = new List<Task>{" id="code4-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        new Task(WhatId = accountId, Id = TestingUtils.generateId(Task.SObjectType))," id="code4-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token class-name">WhatId</span> <span class="token operator">=</span> accountId<span class="token punctuation">,</span> <span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        new Task(WhatId = accountId, Id = TestingUtils.generateId(Task.SObjectType))," id="code4-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token class-name">WhatId</span> <span class="token operator">=</span> accountId<span class="token punctuation">,</span> <span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        new Task(" id="code4-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            WhatId = accountId," id="code4-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token class-name">WhatId</span> <span class="token operator">=</span> accountId<span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            Id = TestingUtils.generateId(Task.SObjectType)," id="code4-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token class-name">Id</span> <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            Type = 'Chat' //again this would normally be a const" id="code4-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token class-name">Type</span> <span class="token operator">=</span> <span class="token string">'Chat'</span> <span class="token comment">//again this would normally be a const</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        )" id="code4-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">)</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    };" id="code4-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code4-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    Map<String, List<SObject>> actual = CollectionUtils.convertToListMap(" id="code4-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> actual <span class="token operator">=</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">convertToListMap</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        tasks," id="code4-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        tasks<span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        Task.WhatId," id="code4-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token class-name">WhatId</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        new TestCollectionEvaluator()" id="code4-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">new</span> <span class="token class-name">TestCollectionEvaluator</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    );" id="code4-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code4-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    System.assertEquals(tasks[2], actual.values()[0][0]);" id="code4-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>tasks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> actual<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code4-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code4-l41"><span class="lineCounter-0-0-15 -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="//etc, you get it - the next test is the one-to-one with filter" id="code4-l42"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">42<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//etc, you get it - the next test is the one-to-one with filter</span></div><br></code></pre><p>Now we've taken the original functionality and generalized it, adding an abstract class that only needs its children to implement a <code>matchesCriteria</code> boolean method to perform complex filtering. Let's take a look at the source code:</p><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="//since it can't be static" id="code5-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">//since it can't be static</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="public abstract class CollectionUtils {" id="code5-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CollectionUtils</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public static Map<String, SObject> convertToMap(List<SObject> sObjectList, String field) {" id="code5-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">convertToMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> sObjectList<span class="token punctuation">,</span> <span class="token class-name">String</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        return converttoMap(sobjectList, field, null);" id="code5-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">return</span> <span class="token function">converttoMap</span><span class="token punctuation">(</span>sobjectList<span class="token punctuation">,</span> field<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code5-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public static Map<String, SObject> convertToMap(List<SObject> sObjectList, SObjectField field) {" id="code5-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">convertToMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> sObjectList<span class="token punctuation">,</span> <span class="token class-name">SObjectField</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        return convertToMap(sObjectList, field.getDescribe().getName(), null);" id="code5-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">return</span> <span class="token function">convertToMap</span><span class="token punctuation">(</span>sObjectList<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code5-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public static Map<String, SObject> convertToMap(List<SObject> sobjectList," id="code5-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">convertToMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> sobjectList<span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        SObjectField field, CollectionEvaluator eval) {" id="code5-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">SObjectField</span> field<span class="token punctuation">,</span> <span class="token class-name">CollectionEvaluator</span> eval<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        return convertToMap(sobjectList, field.getDescribe().getName(), eval);" id="code5-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">return</span> <span class="token function">convertToMap</span><span class="token punctuation">(</span>sobjectList<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> eval<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code5-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public static Map<String, SObject> convertToMap(List<SObject> sObjectList," id="code5-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">convertToMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> sObjectList<span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        String fieldName, CollectionEvaluator eval) {" id="code5-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">String</span> fieldName<span class="token punctuation">,</span> <span class="token class-name">CollectionEvaluator</span> eval<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        Map<String, SObject> mapping = new Map<String, SObject>();" id="code5-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> mapping <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        for(SObject sObj : sObjectList) {" id="code5-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> sObj <span class="token operator">:</span> sObjectList<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            String key = (String)sObj.get(fieldName);" id="code5-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>sObj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            if(String.isBlank(key) ||" id="code5-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="                eval != null &amp;&amp; eval.matchesCriteria(sObj) == false) {" id="code5-l22"><span class="lineCounter-0-0-15 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                eval <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> eval<span class="token punctuation">.</span><span class="token function">matchesCriteria</span><span class="token punctuation">(</span>sObj<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="                continue;" id="code5-l23"><span class="lineCounter-0-0-15 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token keyword">continue</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            }" id="code5-l24"><span class="lineCounter-0-0-15 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            mapping.put(key, sObj);" id="code5-l25"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            mapping<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> sObj<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        }" id="code5-l26"><span class="lineCounter-0-0-15 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        return mapping;" id="code5-l27"><span class="lineCounter-0-0-15 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">return</span> mapping<span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code5-l28"><span class="lineCounter-0-0-15 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l29"><span class="lineCounter-0-0-15 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public static Map<String, List<SObject>> convertToListMap(List<SObject> sObjectList, SObjectField idKey) {" id="code5-l30"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">convertToListMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> sObjectList<span class="token punctuation">,</span> <span class="token class-name">SObjectField</span> idKey<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        return convertToListMap(sObjectList, idKey.getDescribe().getName(), null);" id="code5-l31"><span class="lineCounter-0-0-15 -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">return</span> <span class="token function">convertToListMap</span><span class="token punctuation">(</span>sObjectList<span class="token punctuation">,</span> idKey<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code5-l32"><span class="lineCounter-0-0-15 -codedoc-line-counter">32<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l33"><span class="lineCounter-0-0-15 -codedoc-line-counter">33<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public static Map<String, List<SObject>> convertToListMap(List<SObject> sObjectList, String idKey) {" id="code5-l34"><span class="lineCounter-0-0-15 -codedoc-line-counter">34<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">convertToListMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> sObjectList<span class="token punctuation">,</span> <span class="token class-name">String</span> idKey<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        return convertToListMap(sObjectList, idKey, null);" id="code5-l35"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">35<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">return</span> <span class="token function">convertToListMap</span><span class="token punctuation">(</span>sObjectList<span class="token punctuation">,</span> idKey<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code5-l36"><span class="lineCounter-0-0-15 -codedoc-line-counter">36<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l37"><span class="lineCounter-0-0-15 -codedoc-line-counter">37<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public static Map<String, List<SObject>> convertToListMap(List<SObject> sObjectList, SObjectField idKey," id="code5-l38"><span class="lineCounter-0-0-15 -codedoc-line-counter">38<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">convertToListMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> sObjectList<span class="token punctuation">,</span> <span class="token class-name">SObjectField</span> idKey<span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        CollectionEvaluator eval) {" id="code5-l39"><span class="lineCounter-0-0-15 -codedoc-line-counter">39<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">CollectionEvaluator</span> eval<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        return convertToListMap(sObjectList, idKey.getDescribe().getName(), eval);" id="code5-l40"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">40<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">return</span> <span class="token function">convertToListMap</span><span class="token punctuation">(</span>sObjectList<span class="token punctuation">,</span> idKey<span class="token punctuation">.</span><span class="token function">getDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> eval<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code5-l41"><span class="lineCounter-0-0-15 -codedoc-line-counter">41<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l42"><span class="lineCounter-0-0-15 -codedoc-line-counter">42<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public static Map<String, List<SObject>> convertToListMap(List<SObject> sObjectList, String idKey," id="code5-l43"><span class="lineCounter-0-0-15 -codedoc-line-counter">43<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">convertToListMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> sObjectList<span class="token punctuation">,</span> <span class="token class-name">String</span> idKey<span class="token punctuation">,</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        CollectionEvaluator eval) {" id="code5-l44"><span class="lineCounter-0-0-15 -codedoc-line-counter">44<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">CollectionEvaluator</span> eval<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        Map<String, List<SObject>> keyToListValues = new Map<String, List<SObject>>();" id="code5-l45"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">45<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> keyToListValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        for(SObject sObj : sObjectList) {" id="code5-l46"><span class="lineCounter-0-0-15 -codedoc-line-counter">46<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> sObj <span class="token operator">:</span> sObjectList<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            String key = (String)sObj.get(idKey);" id="code5-l47"><span class="lineCounter-0-0-15 -codedoc-line-counter">47<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>sObj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idKey<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            if(String.isBlank(key) ||" id="code5-l48"><span class="lineCounter-0-0-15 -codedoc-line-counter">48<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="                eval != null &amp;&amp; eval.matchesCriteria(sObj) == false) {" id="code5-l49"><span class="lineCounter-0-0-15 -codedoc-line-counter">49<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                eval <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> eval<span class="token punctuation">.</span><span class="token function">matchesCriteria</span><span class="token punctuation">(</span>sObj<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="                    continue;" id="code5-l50"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">50<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            }" id="code5-l51"><span class="lineCounter-0-0-15 -codedoc-line-counter">51<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            else if(keyToListValues.containsKey(key)) {" id="code5-l52"><span class="lineCounter-0-0-15 -codedoc-line-counter">52<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>keyToListValues<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="                keyToListValues.get(key).add(sObj);" id="code5-l53"><span class="lineCounter-0-0-15 -codedoc-line-counter">53<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                keyToListValues<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sObj<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            } else {" id="code5-l54"><span class="lineCounter-0-0-15 -codedoc-line-counter">54<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="                keyToListValues.put(key, new List<SObject>{ sObj });" id="code5-l55"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">55<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                keyToListValues<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> sObj <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            }" id="code5-l56"><span class="lineCounter-0-0-15 -codedoc-line-counter">56<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        }" id="code5-l57"><span class="lineCounter-0-0-15 -codedoc-line-counter">57<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        return keyToListValues;" id="code5-l58"><span class="lineCounter-0-0-15 -codedoc-line-counter">58<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">return</span> keyToListValues<span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code5-l59"><span class="lineCounter-0-0-15 -codedoc-line-counter">59<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l60"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">60<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    public abstract class CollectionEvaluator {" id="code5-l61"><span class="lineCounter-0-0-15 -codedoc-line-counter">61<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CollectionEvaluator</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        public abstract Boolean matchesCriteria(SObject obj);" id="code5-l62"><span class="lineCounter-0-0-15 -codedoc-line-counter">62<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Boolean</span> <span class="token function">matchesCriteria</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    }" id="code5-l63"><span class="lineCounter-0-0-15 -codedoc-line-counter">63<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code5-l64"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">64<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>That may look like a lot of boilerplate, but these methods are insanely useful. I count 10+ examples of the <code>convertToListMap</code> method being called in a random org, and 20+ calls to <code>convertToMap</code>. The base methods are 11 and 13 lines long, respectively; the full palette of them amounts to 56 lines of code. If you make use of these methods more than 5 times in your entire codebase, they're worth implementing, and your savings compounds as you make more and more use of them. In the org I just quoted, that's a savings of ~300 lines of code! Plus you can cut down lines if you intend to only use these with <code>SObjects</code> without complex fields; in that case, you only need the method definitions with the <code>SObjectField</code> tokens.</p><p>Measuring the performance of dev teams is more an art than a science, and developers have long pushed back on being measured by lines of code produced; in general, whenever LOC is the actual metric by which people are measured, copying and pasting is the preferred past-time. If the metric were which developers were <em>removing</em> the most code, things would be a lot more interesting: I'm not making the case that you should be using this as a performance metric, but removing code through generalizing key usage patterns saves you time and energy in the long run.</p><p>Since working with collections is such a frequent paradigm within Apex, think hard and observe often when interacting with and writing new code related to lists/sets/maps. Refactoring to an invocation you can consume in more places may take you a little bit up front, but will save you more and more as time goes on. I'm not trying to touch on an exhaustive list of <code>CollectionUtils</code> methods; rather, my point in this post (and in posts like <a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a> is that because we work with collections so frequently, they are a ripe area of the codebase to achieve easy refactoring wins).</p><h2 id="identifying-other-areas-for-code-reuse" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Identifying Other Areas For Code Reuse</h2><p>What are some other big areas where you can find refactoring potential in your Salesforce org? I've spoken about centralizing your SOQL methodology in the <a href="/joys-of-apex/repository-pattern">Repository Pattern</a>; this doesn't just give you type-safety for all your Apex queries, it also allows you to test against your SOQL where clauses (in and of itself a good thing).</p><p>Code that focuses on callouts is also a good place to revisit. It can be verbose to always be instantiating <code>HttpRequestMessage</code> objects — there's an opportunity to consolidate things accordingly.</p><p>Those examples are the most generalized, but in each individual org there also exists different paradigms, complexities, and conformity to standards (both those that are widely available and self-imposed ones). With such creativity abounding, how can we best analyze our code in a time-efficient manner in order to identify low-hanging fruit?</p><h3 id="cleaning-up-aura-components" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Cleaning Up Aura Components</h3><p>One person I'd like to give a shoutout to is <a href="https://github.com/jlyon87">Justin Lyon</a>, who is constantly active and helpful on the SFXD discord — on the subject of Aura components, he was the first I've seen to suggest generalizing your Aura actions to avoid a ton of the <code>setCallback/getCallback</code> boilerplate that comes with Apex/LDS interactions in Aura. <a href="https://github.com/jlyon87/lightning-kit/blob/master/js/promisify.js">He uses a static resource</a> to ensure <code>promisify</code> can be imported via <code>ltng-require</code> tag (a problem obviated in LWC by the ability to create actual utils; for more info see the Readme in the linked Github for Justin's project):</p><pre class=""><code class="javascript -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="window.kit = (function Promisify(kit) {" id="code6-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>window<span class="token punctuation">.</span>kit <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">Promisify</span><span class="token punctuation">(</span><span class="token parameter">kit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  var promisify = function (auraAction) {" id="code6-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">var</span> <span class="token function-variable function">promisify</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">auraAction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    return new Promise(" id="code6-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      $A.getCallback(function (resolve, reject) {" id="code6-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      $<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">getCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        auraAction.setCallback(this, function (res) {" id="code6-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        auraAction<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="          var state = res.getState();" id="code6-l6"><span class="lineCounter-0-0-15 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>          <span class="token keyword">var</span> state <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="          if (state === &quot;SUCCESS&quot;) {" id="code6-l7"><span class="lineCounter-0-0-15 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            resolve(res);" id="code6-l8"><span class="lineCounter-0-0-15 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="          } else {" id="code6-l9"><span class="lineCounter-0-0-15 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="            reject(res);" id="code6-l10"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token function">reject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="          }" id="code6-l11"><span class="lineCounter-0-0-15 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>          <span class="token punctuation">}</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        });" id="code6-l12"><span class="lineCounter-0-0-15 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code6-l13"><span class="lineCounter-0-0-15 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="        $A.enqueueAction(auraAction);" id="code6-l14"><span class="lineCounter-0-0-15 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        $<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">enqueueAction</span><span class="token punctuation">(</span>auraAction<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="      })" id="code6-l15"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    );" id="code6-l16"><span class="lineCounter-0-0-15 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  };" id="code6-l17"><span class="lineCounter-0-0-15 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code6-l18"><span class="lineCounter-0-0-15 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  kit.promisify = promisify;" id="code6-l19"><span class="lineCounter-0-0-15 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  kit<span class="token punctuation">.</span>promisify <span class="token operator">=</span> promisify<span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code6-l20"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  return kit;" id="code6-l21"><span class="lineCounter-0-0-15 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token keyword">return</span> kit<span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="})(window.kit || {});" id="code6-l22"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>kit <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>Justin has a bunch of other utils that can get added to the global <code>kit</code> object, and they're all worth browsing through! He also had some helpful things to say on the potential downsides to using <code>ltng-require</code>, since scripts loaded via that means don't execute if the Aura component in question isn't rendered — <a href="https://developer.salesforce.com/docs/component-library/bundle/lightning:backgroundUtilityItem/documentation">Salesforce's <code>backgroundUtilityItem</code> component</a> can be used as a cleaner means of accomplishing adding helper functions to Aura, and Justin <a href="https://github.com/jlyon87/aura-toaster">has an example repo for that as well</a>.</p><hr><p>Me not having thought about the Aura action boilerplate just goes to show that switching context can sometimes lead to wearing the wrong hat; when I first started writing Aura components, (as I've talked about previously in <a href="/joys-of-apex/lwc-custom-path">my post on building a custom Lead Path LWC</a>), I barely knew the difference between Aura and JavaScript — and by the time I did, the glaring code duplications in each of my components wasn't something I'd thought about. Think about the different contexts you switch into when writing code — is there an area for improvement beyond Apex?</p><h3 id="enter-sloppy" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Enter Sloppy</h3><p>The (most excellently) named <a href="http://strlen.com/sloppy/">Sloppy</a> is <em>by far</em> my favorite static code analysis tool — and because it's language agnostic, this means that you can use it to scan your entire codebase by filetype.</p><p>Sloppy works by tokenizing your code by block and analyzing tokens that are similar. This allows it to detect matching lines and lines that nearly match across files, and "rank" that code in terms of Sloppiness (where a higher score means more duplication) across your entire codebase. It's an extremely powerful tool — let's see it in action. (<strong>Note</strong>: sloppy only takes a few seconds to run, but if you want instant feedback on what's happening, I recommend running it on powershell if you're developing on Windows. In bash the output doesn't stream till the operation completes):</p><pre class=""><code class="powershell -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="# in the directory you've downloaded sloppy to" id="code7-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment"># in the directory you've downloaded sloppy to</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="./sloppy -ccls -o50 the/directory/your/code/resides" id="code7-l2"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">.</span><span class="token operator">/</span>sloppy <span class="token operator">-</span>ccls <span class="token operator">-</span>o50 the<span class="token operator">/</span>directory<span class="token operator">/</span>your<span class="token operator">/</span>code<span class="token operator">/</span>resides</div><br></code></pre><p>So let's see what's going on here — sloppy takes a few command line arguments to make your life easier. It automatically scans for a ton of commonly used file extensions by default:</p><ul><li>JavaScript</li><li>C/C++/C#</li><li>Java</li><li>PHP</li><li>Python</li><li>etc ...</li></ul><p>The first argument, <code>-ccls</code> adds <code>.cls</code> to the list of file endings. The second arg, <code>-o50</code> expands the printed list of most sloppy tokens to 50. You can tailor the number of results to suit your fancy; it defaults to 10. A <em>third</em> argument you might consider using would be <code>-eTest</code> (sloppy is case-sensitive with args); you may find that a lot of your duplication comes from test files, and might be OK with omitting that from the results to focus on the <em>real</em> issues. In tests, there is also something to be said for the occasional duplication, if it makes an individual unit test easier to read.</p><p>Many of the results are keyed to the specific business and are, ultimately, not interesting; I've run sloppy on this particular codebase many times, and I've winnowed down the particularly glaring repetitions already. An example of sloppy's output that <em>is</em> interesting would be the below snippet:</p><pre class=""><code class="powershell -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="34 tokens &amp; 3 skips (743 sloppiness, 0.32% of total) starting at:" id="code8-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>34 tokens &amp; 3 skips <span class="token punctuation">(</span>743 sloppiness<span class="token punctuation">,</span> 0<span class="token punctuation">.</span>32<span class="token operator">%</span> of total<span class="token punctuation">)</span> starting at:</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="=> C:\Users\myName\Documents\Code\someOrg\src\classes\Class1.cls:145" id="code8-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>=&gt; C:\Users\myName\Documents\Code\someOrg\src\classes\Class1<span class="token punctuation">.</span>cls:145</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="=> C:\Users\myName\Documents\Code\someOrg\src\classes\Class2.cls:100" id="code8-l3"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>=&gt; C:\Users\myName\Documents\Code\someOrg\src\classes\Class2<span class="token punctuation">.</span>cls:100</div><br></code></pre><pre class=""><code class="java -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="if (accountIdToContact.containsKey(acc.Id)) {" id="code9-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">if</span> <span class="token punctuation">(</span>accountIdToContact<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>acc<span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    Contact con = accountIdToContact.get(acc.Id);" id="code9-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token class-name">Contact</span> con <span class="token operator">=</span> accountIdToContact<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>acc<span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    con.OwnerId = acc.OwnerId;" id="code9-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    con<span class="token punctuation">.</span><span class="token class-name">OwnerId</span> <span class="token operator">=</span> acc<span class="token punctuation">.</span><span class="token class-name">OwnerId</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="    this .... //end token" id="code9-l4"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">this</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//end token</span></div><br></code></pre><p>Pretty benign repetition, but if there were many classes using that same owner assignment paradigm (and sloppy will print out <em>all</em> classes where the duplication occurs), I would definitely consider consolidating that logic. Interestingly, the biggest offender in this codebase is actually the Aura components with their repetitive action handling! Fool me once ...</p><p>Sloppy also outputs some cool stats regarding the overall "sloppiness" of your project in terms of duplication:</p><pre class=""><code class="powershell -codedoc-code-snippet code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="summary:" id="code10-l1"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>summary:</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code10-l2"><span class="lineCounter-0-0-15 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="total tokens: 96206" id="code10-l3"><span class="lineCounter-0-0-15 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>total tokens: 96206</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="total sloppiness: 234333" id="code10-l4"><span class="lineCounter-0-0-15 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>total sloppiness: 234333</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="sloppiness / token ratio: 2.44" id="code10-l5"><span class="lineCounter-0-0-15 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>sloppiness <span class="token operator">/</span> token ratio: 2<span class="token punctuation">.</span>44</div><br></code></pre><p>That last part — the "sloppiness / token ratio" means you should be looking for a lower score. The first time I ran sloppy on this codebase, the score was hovering around 12, if I recall correctly. I definitely put a lot of time into lowering that ratio!</p><h2 id="closing-thoughts-on-refactoring" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Closing Thoughts On Refactoring</h2><p>In the end, how you choose to refactor is your own perogative. That being said, I hope that for dealing with collections in Apex, as well as identifying other key repetitive areas in your codebase, this post will prove of service. At the very least, thinking about how your code may be bloated is always helpful in refining your craft.</p><p>As well, there are many static code analysis programs available. I happen to like sloppy because it's small, fast as hell, and it can be run on many different codebases. The gamified output also provides satisfying feedback as you refactor the code it identifies as being duplicated. Of course, I'll be curious to hear about the different tools other people use (I know some people swear by Apex PMD, but the analysis that Apex PMD provides is more in the sense of guidelines: don't perform SOQL in loops; don't create deeply nested <code>if</code> statements, etc ...) — share the knowledge 😀. Till next time!</p><hr><p><strong>Edit</strong> — <a href="https://www.reddit.com/user/kgeee34/">kgeee34</a> wrote in to talk about <a href="https://gitlab.com/StevenWCox/sfapexdoc/-/wikis/home">ApexDoc</a>; I've linked the version of the project that is being actively maintained, as the SFDC repo has been abandoned. It generates Markdown pages that self-document your Apex code — perfect for being hosted on a developer wiki site or even within your repo itself.</p><p>The original version of <a href="https://www.jamessimone.net/blog/joys-of-apex/refactoring-tips-and-tricks/">Refactoring Trips &amp; Tricks can be read on my blog.</a></p><hr><p><strong>Postscript</strong></p><p>For those following along, you'll note that for the first time in a while, there was a considerable delay in article publication times. Those delays may continue. My fiance and I adopted a puppy ... suffice it to say, my writing time is at an all-time low. On the other hand, we have an adorable little hound named Buckwheat romping around, and having him has been a blast so far:</p><p><img src="/joys-of-apex/img/young-buckwheat.jpg" alt="The young Buck"></p><div class="contentnav-0-0-7" data-no-search=""><a href="#collection-utilities" class="h2" data-content-highlight="collection-utilities">Collection Utilities</a><a href="#identifying-other-areas-for-code-reuse" class="h2" data-content-highlight="identifying-other-areas-for-code-reuse">Identifying Other Areas For Code Reuse</a><a href="#cleaning-up-aura-components" class="h3" data-content-highlight="cleaning-up-aura-components">Cleaning Up Aura Components</a><a href="#enter-sloppy" class="h3" data-content-highlight="enter-sloppy">Enter Sloppy</a><a href="#closing-thoughts-on-refactoring" class="h2" data-content-highlight="closing-thoughts-on-refactoring">Closing Thoughts On Refactoring</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/lwc-custom-path">LWC Custom Lead Path</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/refactoring-tips-and-tricks">Refactoring Tips &amp; Tricks</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/set-timeout-and-implementing-delays">setTimeout &amp; Implementing Delays</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/testing-custom-permissions">Testing Custom Permissions</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="itRzbLFVOE">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("itRzbLFVOE", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="uNKXmHowBz">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("uNKXmHowBz", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="yqkZongiXB">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("yqkZongiXB", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>