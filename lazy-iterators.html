<!DOCTYPE html><html><head><title>Joys Of Apex | Lazy Iterators</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Lazy Iterators"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Lazy Iterators"></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"lazy-iterators.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Lazy Iterators</p></span></h1><script id="zJFrkLpGSC">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("zJFrkLpGSC", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2020-05-20T15:00:00.000Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>Welcome back to the <a href="/joys-of-apex/">Joys Of Apex</a>! You may remember from the <a href="/joys-of-apex/sorting-and-performance-in-apex#fn-1">footnotes of Sorting &amp; Performance In Apex</a> that I mentioned <a href="https://nebulaconsulting.co.uk/insights/list-processing-in-apex/">an article on iterators</a>, which I first read in February while browsing the Salesforce subreddit. One thing that I dwelt on for some time after reading the article was how my clients might be able to use the power of lazy iteration - which differs from the eager iteration performed by the traditional "for" loops we use quite often in SFDC Apex development - to speed up trigger handlers. Were there performance gains to be had by delaying the evaluation of records in a Trigger context? I would also highly recommend the YouTube video that is posted in the article: this talk on <a href="https://www.youtube.com/watch?v=bSbCJUSaSkY">lazy evaluations from GOTO 2018</a> is fantastic</p><p>I was impressed at the time with the object-oriented approach that Aidan Harding and the folks over at Nebula Consulting had undertaken when implementing the Lazy Iterator framework. The idea for this article has been brewing since then. Their <code>LazyIterator</code> object uses the Decorator pattern to add functionality to the underlying iterators found on all Salesforce <code>List</code> objects -- reading through their codebase got me re-excited about working with collections in Apex. You may recall from the <a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a> post that using iterators to page through collections is much faster than any of the "for" loop implementations!</p><p>I'd also like to thank Aidan for generously proof-reading the beta version of this, which led to a couple of great edits. This article is assuredly better for his input.</p><h2 id="a-short-history-of-lazy-evaluation" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>A Short History Of Lazy Evaluation</h2><blockquote><p>All problems in computer science can be solved using one more level of indirection. -- David Wheeler</p></blockquote><p>So-called "Lazy" evaluated functions have their actual execution delayed until a "terminator" function is called. It's common for lazy functions to be chained together using fluent interfaces, culminating with actions being performed when the terminator function is called. What can Salesforce developers writing Apex code stand to gain by learning more about lazy functions?</p><p>Fluent interfaces -- or objects that return themselves during function calls -- also tend to satisfy one of the prerequisites for Object-Oriented Programming; namely, encapsulation. While fluency as a property of functions/objects has become associated more with functional programming than with OOP, many developers are being unwittingly exposed to pseudo-fluent interfaces (and, as a result, functional paradigms) through the JavaScript collection API; it's not uncommon to see various <code>filter</code>, <code>map</code>, and <code>reduce</code> calls being chained together when iterating through lists in JavaScript. It's also not uncommon for people to underestimate the performance implications that come with using these functions -- in JavaScript's vanilla functions' case, our code's readability increases at the cost of performance:</p><h2 id="eager-evaluation-in-javascript--apex" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Eager Evaluation in JavaScript &amp; Apex</h2><pre class=""><code class="javascript code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="const list = [1, 2, 3, 4, 5, 6, 7];"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="const doubleOfEvens = list.filter((x) => x % 2 === 0).map((num) => num * 2);"><span class="lineCounter-0-0-15">2</span><span class="token keyword">const</span> doubleOfEvens <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> num <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="console.log(doubleOfEvens);"><span class="lineCounter-0-0-15">4</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doubleOfEvens<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="//output: [ 4, 8, 12 ]"><span class="lineCounter-0-0-15 prim">5</span><span class="token comment">//output: [ 4, 8, 12 ]</span></div><br></code></pre><p>Well-named (and encapsulated) functions are appreciated by developers because they are easy to understand. Even if you don't know JavaScript, you can look at the above code snippet and divine its meaning: <em>given a starting list of numbers, take the ones that don't have a remainder when divided by two, and multiply those values <strong>by</strong> two</em>. However, when you look at what that code is effectively doing, you might begin to feel differently about it:</p><pre class=""><code class="javascript code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="var list = [1, 2, 3, 4, 5, 6, 7];"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="var evens = [];"><span class="lineCounter-0-0-15">2</span><span class="token keyword">var</span> evens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="for (var i = 0; i < list.length; i++) {"><span class="lineCounter-0-0-15">3</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  var num = list[i];"><span class="lineCounter-0-0-15">4</span>  <span class="token keyword">var</span> num <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  if (num % 2 === 0) {"><span class="lineCounter-0-0-15 prim">5</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    evens.push(num);"><span class="lineCounter-0-0-15">6</span>    evens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">7</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">8</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">9</span></div><br><div class="line-0-0-16 " data-content="var doubleOfEvens = [];"><span class="lineCounter-0-0-15 prim">10</span><span class="token keyword">var</span> doubleOfEvens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="for (var index = 0; index < evens.length; index++) {"><span class="lineCounter-0-0-15">11</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> evens<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  var even = evens[index];"><span class="lineCounter-0-0-15">12</span>  <span class="token keyword">var</span> even <span class="token operator">=</span> evens<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  doubleOfEvens.push(even * 2);"><span class="lineCounter-0-0-15">13</span>  doubleOfEvens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>even <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">14</span><span class="token punctuation">}</span></div><br></code></pre><p>Yikes. Turning back to Apex, you might immediately see the parallels between this example and how a typical Apex trigger handler is set up:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/AccountHandler.cls</span></span><div class="line-0-0-16 " data-content="public class AccountHandler extends TriggerHandler {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountHandler</span> <span class="token keyword">extends</span> <span class="token class-name">TriggerHandler</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">2</span></div><br><div class="line-0-0-16 " data-content="  public override void beforeInsert(List<SObject> newRecords) {"><span class="lineCounter-0-0-15">3</span>  <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">beforeInsert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> newRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    List<Account> accounts = (List<Account>)newRecords;"><span class="lineCounter-0-0-15">4</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>newRecords<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">5</span></div><br><div class="line-0-0-16 " data-content="    this.trimAccountName(accounts);"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">trimAccountName</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.formatAccountPhone(accounts);"><span class="lineCounter-0-0-15">7</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatAccountPhone</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    //etc ..."><span class="lineCounter-0-0-15">8</span>    <span class="token comment">//etc ...</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">9</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="  private void trimAccountName(List<Account> accounts) {"><span class="lineCounter-0-0-15">11</span>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">trimAccountName</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    for(Account acc : accounts) {"><span class="lineCounter-0-0-15">12</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Account</span> acc <span class="token operator">:</span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      acc.Name = acc.Name.normalizeSpace();"><span class="lineCounter-0-0-15">13</span>      acc<span class="token punctuation">.</span><span class="token class-name">Name</span> <span class="token operator">=</span> acc<span class="token punctuation">.</span><span class="token class-name">Name</span><span class="token punctuation">.</span><span class="token function">normalizeSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">14</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15 prim">15</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">16</span></div><br><div class="line-0-0-16 " data-content="  private void formatAccountPhone(List<Account> accounts) {"><span class="lineCounter-0-0-15">17</span>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">formatAccountPhone</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    for(Account acc : accounts) {"><span class="lineCounter-0-0-15">18</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Account</span> acc <span class="token operator">:</span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      // do stuff with the phone"><span class="lineCounter-0-0-15">19</span>      <span class="token comment">// do stuff with the phone</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">20</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">21</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">22</span><span class="token punctuation">}</span></div><br></code></pre><p>This pattern is pretty typical. It's not uncommon in larger organizations for the big objects -- Leads and Opportunities in particular -- to have dozens (if not hundreds) of trigger handler methods, each of which likely involves sifting through the entirety of the old/new records prior to performing business logic. As trigger handlers grow in size, related functionality is frequently broken out into other classes; this tends to obscure just how much processing is occurring as a handler churns through records.</p><p>Once records are being updated, many developers have utility methods designed to compare the old and new objects handed to SFDC developers in the form of <code>Trigger.old</code> and <code>Trigger.new</code> lists, but even these utility methods frequently take the form of iterating over the entirety of the old and new records to isolate matches. (This becomes a problem when you need to isolate many different groups of changed records to do further processing; e.g. Accounts that need their Opportunities updated, Accounts that need their Contacts updated, if a particular Opportunity Line Item is added, go back to the Account, etc ...) So what can we do? <em>Should</em> we do something to address this "problem" -- or is it really not a problem at all, but one of the results of a growing system? As usual, to answer that question, we're going to have to write some tests.</p><h2 id="measuring-sobject-trigger-performance" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Measuring SObject Trigger Performance</h2><p>These particular tests will make use of Queueable Apex. <em>Why</em> use Queueables over our typical Apex tests? There's an argument to be made (by some) that the overhead introduced by the test classes themselves actually obscure the production-level performance results. I haven't found that to be the case, but with long-running operations, it's possible for running tests to time out, so we'll be avoiding that issue altogether. In order to avoid hitting any kind of <em>Anonymous Apex</em> timeouts, we'll choose the easiest of the async Apex implementations to rig up a timer:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/QueueableTimer.cls</span></span><div class="line-0-0-16 " data-content="public class QueueableTimer implements System.Queueable {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueueableTimer</span> <span class="token keyword">implements</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">Queueable</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  private Datetime lastTime;"><span class="lineCounter-0-0-15">2</span>  <span class="token keyword">private</span> <span class="token class-name">Datetime</span> lastTime<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="  public QueueableTimer() {"><span class="lineCounter-0-0-15">4</span>  <span class="token keyword">public</span> <span class="token class-name">QueueableTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.lastTime = System.now();"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>lastTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">6</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="  public void execute(QueueableContext context) {"><span class="lineCounter-0-0-15">8</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">QueueableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    Savepoint sp = Database.setSavepoint();"><span class="lineCounter-0-0-15">9</span>    <span class="token class-name">Savepoint</span> sp <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">setSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    List<Account> accounts = this.getExampleAccountsToInsert();"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getExampleAccountsToInsert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.log('Starting execute after gathering sample records');"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Starting execute after gathering sample records'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">12</span></div><br><div class="line-0-0-16 " data-content="    insert accounts;"><span class="lineCounter-0-0-15">13</span>    insert accounts<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">14</span></div><br><div class="line-0-0-16 " data-content="    this.log('Ending');"><span class="lineCounter-0-0-15 prim">15</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Ending'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    Database.rollback(sp);"><span class="lineCounter-0-0-15">16</span>    <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">17</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">18</span></div><br><div class="line-0-0-16 " data-content="  private List<Account> getExampleAccountsToInsert() {"><span class="lineCounter-0-0-15">19</span>  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> <span class="token function">getExampleAccountsToInsert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    List<Account> accounts = new List<Account>();"><span class="lineCounter-0-0-15 prim">20</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    //savepoint usage consumes a DML row ..."><span class="lineCounter-0-0-15">21</span>    <span class="token comment">//savepoint usage consumes a DML row ...</span></div><br><div class="line-0-0-16 " data-content="    for(Integer index = 0; index < 9998; index++) {"><span class="lineCounter-0-0-15">22</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> <span class="token number">9998</span><span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      accounts.add("><span class="lineCounter-0-0-15">23</span>      accounts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        new Account("><span class="lineCounter-0-0-15">24</span>        <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="          Name = ' Testing' + index.format() + ' ',"><span class="lineCounter-0-0-15 prim">25</span>          <span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">' Testing'</span> <span class="token operator">+</span> index<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="          Phone = '8438816989'"><span class="lineCounter-0-0-15">26</span>          <span class="token class-name">Phone</span> <span class="token operator">=</span> <span class="token string">'8438816989'</span></div><br><div class="line-0-0-16 " data-content="        )"><span class="lineCounter-0-0-15">27</span>        <span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="      );"><span class="lineCounter-0-0-15">28</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">29</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    return accounts;"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token keyword">return</span> accounts<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">31</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">32</span></div><br><div class="line-0-0-16 " data-content="  private void log(String startingString) {"><span class="lineCounter-0-0-15">33</span>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">String</span> startingString<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    System.debug("><span class="lineCounter-0-0-15">34</span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="      startingString + ', time passed: '"><span class="lineCounter-0-0-15 prim">35</span>      startingString <span class="token operator">+</span> <span class="token string">', time passed: '</span></div><br><div class="line-0-0-16 " data-content="      + this.getSecondsPassed().format()"><span class="lineCounter-0-0-15">36</span>      <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSecondsPassed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="      + ' seconds'"><span class="lineCounter-0-0-15">37</span>      <span class="token operator">+</span> <span class="token string">' seconds'</span></div><br><div class="line-0-0-16 " data-content="    );"><span class="lineCounter-0-0-15">38</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.lastTime = System.now();"><span class="lineCounter-0-0-15">39</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>lastTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15 prim">40</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">41</span></div><br><div class="line-0-0-16 " data-content="  private Decimal getSecondsPassed() {"><span class="lineCounter-0-0-15">42</span>  <span class="token keyword">private</span> <span class="token class-name">Decimal</span> <span class="token function">getSecondsPassed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    return ((Decimal)(System.now().getTime()"><span class="lineCounter-0-0-15">43</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Decimal</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="      - this.lastTime.getTime()))"><span class="lineCounter-0-0-15">44</span>      <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastTime<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="      .divide(1000, 4);"><span class="lineCounter-0-0-15 prim">45</span>      <span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">46</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">47</span><span class="token punctuation">}</span></div><br></code></pre><p>This code is going to interact with our extremely plain <code>AccountHandler</code> object, called by the trigger on Accounts:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public class AccountHandler extends TriggerHandler {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountHandler</span> <span class="token keyword">extends</span> <span class="token class-name">TriggerHandler</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  public override void beforeInsert(List<SObject> insertedRecords) {"><span class="lineCounter-0-0-15">2</span>  <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">beforeInsert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> insertedRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    //no methods for now"><span class="lineCounter-0-0-15">3</span>    <span class="token comment">//no methods for now</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">4</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">5</span><span class="token punctuation">}</span></div><br></code></pre><p>Right now, with the <code>beforeInsert</code> method empty, kicking off the <code>QueueableTimer</code> prints the following:</p><pre class=""><code class="bash code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="Starting execute after gathering sample records, time passed: 0.788 seconds"><span class="lineCounter-0-0-15 prim">1</span>Starting execute after gathering sample records, <span class="token function">time</span> passed: <span class="token number">0.788</span> seconds</div><br><div class="line-0-0-16 " data-content="Ending, time passed: 32.035 seconds"><span class="lineCounter-0-0-15 prim">2</span>Ending, <span class="token function">time</span> passed: <span class="token number">32.035</span> seconds</div><br></code></pre><p>It's important to note that the baseline is being measured <em>prior</em> to the <code>Savepoint</code> being rolled back. Something that should be immediately obvious in looking at these results? It's not the setting up of the savepoint or the Account list that is leading to any kind of slowdown; this is just how long it takes for Salesforce triggers to process large record sets in 200 increment batches. I tested various other org structures, including those with Duplicate Rules enabled, workflows, validation rules, etc ... while those definitely slow down the resulting insert (Standard duplicate rules for Accounts added nearly 7 seconds to the processing time), the vast majority of the time was simply in creating that many objects. This should give you a good idea, per 10k records, how long it takes at baseline to process records: .0032 seconds per Account. Not too shabby.</p><h2 id="measuring-eagerly-evaluated-methods" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Measuring Eagerly-Evaluated Methods</h2><p>We'll just update the <code>AccountHandler</code> object so that the <code>beforeInsert</code> method contains some vanilla processing methods as I had shown earlier:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/AccountHandler.cls</span></span><div class="line-0-0-16 " data-content="public override void beforeInsert(List<SObject> newRecords) {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">beforeInsert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> newRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  List<Account> accounts = (List<Account>)newRecords;"><span class="lineCounter-0-0-15">2</span>  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>newRecords<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="  this.trimAccountName(accounts);"><span class="lineCounter-0-0-15">4</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">trimAccountName</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  this.formatAccountPhone(accounts);"><span class="lineCounter-0-0-15 prim">5</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatAccountPhone</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">6</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="private void trimAccountName(List<Account> accounts) {"><span class="lineCounter-0-0-15">8</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">trimAccountName</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  for(Account acc : accounts) {"><span class="lineCounter-0-0-15">9</span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Account</span> acc <span class="token operator">:</span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    acc.Name = acc.Name.normalizeSpace();"><span class="lineCounter-0-0-15 prim">10</span>    acc<span class="token punctuation">.</span><span class="token class-name">Name</span> <span class="token operator">=</span> acc<span class="token punctuation">.</span><span class="token class-name">Name</span><span class="token punctuation">.</span><span class="token function">normalizeSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">11</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">12</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">13</span></div><br><div class="line-0-0-16 " data-content="private void formatAccountPhone(List<Account> accounts) {"><span class="lineCounter-0-0-15">14</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">formatAccountPhone</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  for(Account acc : accounts) {"><span class="lineCounter-0-0-15 prim">15</span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Account</span> acc <span class="token operator">:</span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.formatPhone(acc.Phone);"><span class="lineCounter-0-0-15">16</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatPhone</span><span class="token punctuation">(</span>acc<span class="token punctuation">.</span><span class="token class-name">Phone</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">17</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">18</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">19</span></div><br><div class="line-0-0-16 " data-content="private String formatPhoneNumber(String phone) {"><span class="lineCounter-0-0-15 prim">20</span><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">formatPhoneNumber</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  if(phone.length() == 10) {"><span class="lineCounter-0-0-15">21</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>phone<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    return '(' + phone.substring(0, 3) + ') '"><span class="lineCounter-0-0-15">22</span>    <span class="token keyword">return</span> <span class="token string">'('</span> <span class="token operator">+</span> phone<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">') '</span></div><br><div class="line-0-0-16 " data-content="        + phone.substring(3, 6) + '-'"><span class="lineCounter-0-0-15">23</span>        <span class="token operator">+</span> phone<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-'</span></div><br><div class="line-0-0-16 " data-content="        + phone.substring(6);"><span class="lineCounter-0-0-15">24</span>        <span class="token operator">+</span> phone<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  } else if (phone.length() == 11 &amp;&amp; phone.substring(0) == '1') {"><span class="lineCounter-0-0-15 prim">25</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>phone<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">11</span> <span class="token operator">&amp;&amp;</span> phone<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      return this.formatPhoneNumber("><span class="lineCounter-0-0-15">26</span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatPhoneNumber</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        phone.substring("><span class="lineCounter-0-0-15">27</span>        phone<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="          1,"><span class="lineCounter-0-0-15">28</span>          <span class="token number">1</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="          phone.length() - 1)"><span class="lineCounter-0-0-15">29</span>          phone<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="      );"><span class="lineCounter-0-0-15 prim">30</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">31</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">32</span></div><br><div class="line-0-0-16 " data-content="  return phone;"><span class="lineCounter-0-0-15">33</span>  <span class="token keyword">return</span> phone<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">34</span><span class="token punctuation">}</span></div><br></code></pre><p>Two simple methods -- let's see how much processing time that consumes:</p><pre class=""><code class="bash code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="Starting execute after gathering sample records, time passed: 0.403 seconds"><span class="lineCounter-0-0-15 prim">1</span>Starting execute after gathering sample records, <span class="token function">time</span> passed: <span class="token number">0.403</span> seconds</div><br><div class="line-0-0-16 " data-content="Ending, time passed: 33.469 seconds"><span class="lineCounter-0-0-15 prim">2</span>Ending, <span class="token function">time</span> passed: <span class="token number">33.469</span> seconds</div><br></code></pre><p>That's a 4.47% increase in processing time. With smaller number of records, of course, such increases are hardly noticeable -- until they are. I think anybody who's converted a lead at the start of a greenfield project versus several years into the implementation can attest to the fact (which I have cited previously in the <a href="react-versus-lightning-web/components/">React.js versus Lightning Web Components post</a>) that delays as small as 50ms can both be detected and negatively impact the end user experience.</p><h2 id="diving-into-lazy-evaluation" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Diving Into Lazy Evaluation</h2><p>Somebody recently asked a question regarding the performance and organization of Apex triggers as they grow, and possible design patterns for cleaning up complicated handlers. Since it's something I've spent quite a bit of time thinking about as I pondered the <code>LazyIterator</code> framework, I directed them to read the <a href="https://nebulaconsulting.co.uk/insights/list-processing-in-apex/">Nebula Consulting post on Lazy Iterators</a>. Their response?</p><blockquote><p>That seems hard for the next guy to learn, to be honest</p></blockquote><p>They're not wrong. Looking at the <a href="https://bitbucket.org/nebulaconsulting/nebula-core/src/master/">Nebula Bitbucket</a> shows that a lot has changed since the article was written last year; many updates to the framework, and a lot of potential. But, like FFLib, the issues with larger frameworks lie in stimulating adoption. How can you get new users to grok the intent of your code, particularly with very abstract examples? Documentation helps, but it's not perfect, and as soon as you have documentation, you're in an arms-race with yourself to keep it up-to-date. Typically, frameworks achieve widespread adoption by providing some combination of three things:</p><ul><li>ease of learning</li><li>enhancements on basic functionality</li><li>performance improvements</li></ul><p>These tenets hold true for domains outside of programming, of course, but across the tech stack it's easy to see different permutations of this concept:</p><ul><li>logging frameworks get adopted because, despite typically carrying a learning curve, they help to raise the visibility of errors</li><li>immutability frameworks get adopted because they help to prevent hard-to-trace pointer bugs</li><li>fluent frameworks get adopted because they make the code easier to read</li></ul><p>In many ways, I'm the ideal consumer of the <code>LazyIterator</code> framework -- I'm a consulting company looking to bring performance improvements to my clients, many of whom already deal with routine system slowdown due to growth. How can I wrap the functionality presented by the <code>LazyIterator</code> concept into something that's easier for others (including myself) to use and understand? The examples that follow are heavily-influenced by Aidan Harding's work. I re-implemented everything from scratch -- not something that I think is necessary the vast majority of the time, but somethign that I think indeed helps when looking to further your understanding of new concepts.</p><h3 id="re-implementing-a-lazy-iterator" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Re-implementing A Lazy Iterator</h3><p>This is a stirling use-case for inner classes. Much like how people got really excited when <a href="https://developer.mozilla.org/en-US/docs/Glossary/IIFE">IIFE's</a> became a big part of JavaScript development, inner classes allow you to hide the scary parts of your code from other consumers. And, much like IIFE's, they can abused/over-used. They're not always the answer! Another alternative, which is frequently talked about in the book Clean Code, is the Adapter pattern, where you isolate the code foreign to your codebase through the use of interfaces and boundary objects.</p><p>Since we're talking about trigger handler frameworks, I am going to tailor the code that follows towards exploring how to achieve lazy iteration in a trigger handler's context. It should be noted that the <code>LazyIterator</code> framework covers an enormous swath of material and use-cases; keeping it simple here will help to keep the overall size of what you're reading down to a manageable level.</p><p>I'll start "simple", with a wrapped iterator capable of detecting when SObjectFields have changed:</p><h3 id="implementing-a-lazy-filter-function" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Implementing A Lazy Filter Function</h3><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/ObjectChangeProcessor.cls</span></span><div class="line-0-0-16 " data-content="//separate file for the interface"><span class="lineCounter-0-0-15 prim">1</span><span class="token comment">//separate file for the interface</span></div><br><div class="line-0-0-16 " data-content="//because outside callers can"><span class="lineCounter-0-0-15">2</span><span class="token comment">//because outside callers can</span></div><br><div class="line-0-0-16 " data-content="//(and need to) implement"><span class="lineCounter-0-0-15">3</span><span class="token comment">//(and need to) implement</span></div><br><div class="line-0-0-16 " data-content="public interface BooleanFunction {"><span class="lineCounter-0-0-15">4</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BooleanFunction</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  Boolean isTrueFor(Object o);"><span class="lineCounter-0-0-15 prim">5</span>  <span class="token class-name">Boolean</span> <span class="token function">isTrueFor</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">6</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="public class ObjectChangeProcessor {"><span class="lineCounter-0-0-15">8</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectChangeProcessor</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  private LazyIterator iterator;"><span class="lineCounter-0-0-15">9</span>  <span class="token keyword">private</span> <span class="token class-name">LazyIterator</span> iterator<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="//assumes objects are in the same order"><span class="lineCounter-0-0-15">11</span><span class="token comment">//assumes objects are in the same order</span></div><br><div class="line-0-0-16 " data-content="//as in Trigger.oldRecord, Trigger.new"><span class="lineCounter-0-0-15">12</span><span class="token comment">//as in Trigger.oldRecord, Trigger.new</span></div><br><div class="line-0-0-16 " data-content="  public ObjectChangeProcessor(List<SObject> oldObjects, List<SObject> newObjects) {"><span class="lineCounter-0-0-15">13</span>  <span class="token keyword">public</span> <span class="token class-name">ObjectChangeProcessor</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldObjects<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> newObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.iterator = new LazySObjectPairIterator(oldObjects, newObjects);"><span class="lineCounter-0-0-15">14</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>iterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySObjectPairIterator</span><span class="token punctuation">(</span>oldObjects<span class="token punctuation">,</span> newObjects<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15 prim">15</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">16</span></div><br><div class="line-0-0-16 " data-content="  public ObjectChangeProcessor filterByChangeInField(SObjectField field) {"><span class="lineCounter-0-0-15">17</span>  <span class="token keyword">public</span> <span class="token class-name">ObjectChangeProcessor</span> <span class="token function">filterByChangeInField</span><span class="token punctuation">(</span><span class="token class-name">SObjectField</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    return this.filterByChangeInFields(new List<SObjectField>{ field });"><span class="lineCounter-0-0-15">18</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filterByChangeInFields</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> field <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">19</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">20</span></div><br><div class="line-0-0-16 " data-content="  public ObjectChangeProcessor filterByChangeInFields(List<SObjectField> fields) {"><span class="lineCounter-0-0-15">21</span>  <span class="token keyword">public</span> <span class="token class-name">ObjectChangeProcessor</span> <span class="token function">filterByChangeInFields</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span> fields<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.iterator = new LazyFilterIterator(this.iterator, new FieldChangedFilterProcessor(fields));"><span class="lineCounter-0-0-15">22</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>iterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyFilterIterator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>iterator<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">FieldChangedFilterProcessor</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    return this;"><span class="lineCounter-0-0-15">23</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">24</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">25</span></div><br><div class="line-0-0-16 " data-content="  public ObjectChangeProcessor filter(BooleanFunction function) {"><span class="lineCounter-0-0-15">26</span>  <span class="token keyword">public</span> <span class="token class-name">ObjectChangeProcessor</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">BooleanFunction</span> function<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.iterator = new LazyFilterIterator(this.iterator, function);"><span class="lineCounter-0-0-15">27</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>iterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyFilterIterator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>iterator<span class="token punctuation">,</span> function<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    return this;"><span class="lineCounter-0-0-15">28</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">29</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">30</span></div><br><div class="line-0-0-16 " data-content="  public List<Object> toList(List<Object> toList) {"><span class="lineCounter-0-0-15">31</span>  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">toList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> toList<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    return this.iterator.toList(toList);"><span class="lineCounter-0-0-15">32</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iterator<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span>toList<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">33</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">34</span></div><br><div class="line-0-0-16 " data-content="//BASE LAZY ITERATOR"><span class="lineCounter-0-0-15 prim">35</span><span class="token comment">//BASE LAZY ITERATOR</span></div><br><div class="line-0-0-16 " data-content="  virtual class LazyIterator implements Iterator<Object> {"><span class="lineCounter-0-0-15">36</span>  virtual <span class="token keyword">class</span> <span class="token class-name">LazyIterator</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final Iterator<Object> iterator;"><span class="lineCounter-0-0-15">37</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> iterator<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">38</span></div><br><div class="line-0-0-16 " data-content="    public LazyIterator(Iterator<Object> iterator) {"><span class="lineCounter-0-0-15">39</span>    <span class="token keyword">public</span> <span class="token class-name">LazyIterator</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> iterator<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      this.iterator = iterator;"><span class="lineCounter-0-0-15 prim">40</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>iterator <span class="token operator">=</span> iterator<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">41</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">42</span></div><br><div class="line-0-0-16 " data-content="    protected LazyIterator() {"><span class="lineCounter-0-0-15">43</span>    <span class="token keyword">protected</span> <span class="token class-name">LazyIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="//one of the more fun statements"><span class="lineCounter-0-0-15">44</span><span class="token comment">//one of the more fun statements</span></div><br><div class="line-0-0-16 " data-content="//made possible by self-implementation ..."><span class="lineCounter-0-0-15 prim">45</span><span class="token comment">//made possible by self-implementation ...</span></div><br><div class="line-0-0-16 " data-content="      this.iterator = this;"><span class="lineCounter-0-0-15">46</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>iterator <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">47</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">48</span></div><br><div class="line-0-0-16 " data-content="    public virtual Boolean hasNext() {"><span class="lineCounter-0-0-15">49</span>    <span class="token keyword">public</span> virtual <span class="token class-name">Boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      return this.iterator.hasNext();"><span class="lineCounter-0-0-15 prim">50</span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">51</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">52</span></div><br><div class="line-0-0-16 " data-content="    public virtual Object next() {"><span class="lineCounter-0-0-15">53</span>    <span class="token keyword">public</span> virtual <span class="token class-name">Object</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      return this.iterator.next();"><span class="lineCounter-0-0-15">54</span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">55</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">56</span></div><br><div class="line-0-0-16 " data-content="    public List<Object> toList(List<Object> toList) {"><span class="lineCounter-0-0-15">57</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">toList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> toList<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      while(this.hasNext()) {"><span class="lineCounter-0-0-15">58</span>      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        toList.add(this.next());"><span class="lineCounter-0-0-15">59</span>        toList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      }"><span class="lineCounter-0-0-15 prim">60</span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="      return toList;"><span class="lineCounter-0-0-15">61</span>      <span class="token keyword">return</span> toList<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">62</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">63</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">64</span></div><br><div class="line-0-0-16 " data-content="//Wrapped SObject Pair Iterator"><span class="lineCounter-0-0-15 prim">65</span><span class="token comment">//Wrapped SObject Pair Iterator</span></div><br><div class="line-0-0-16 " data-content="  virtual class LazySObjectPairIterator extends LazyIterator {"><span class="lineCounter-0-0-15">66</span>  virtual <span class="token keyword">class</span> <span class="token class-name">LazySObjectPairIterator</span> <span class="token keyword">extends</span> <span class="token class-name">LazyIterator</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final Iterator<SObject> oldIterator;"><span class="lineCounter-0-0-15">67</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldIterator<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private final Iterator<SObject> newIterator;"><span class="lineCounter-0-0-15">68</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> newIterator<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">69</span></div><br><div class="line-0-0-16 " data-content="    public LazySObjectPairIterator(List<SObject> oldObjects, List<SObject> newObjects) {"><span class="lineCounter-0-0-15 prim">70</span>    <span class="token keyword">public</span> <span class="token class-name">LazySObjectPairIterator</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldObjects<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> newObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      super();"><span class="lineCounter-0-0-15">71</span>      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      this.newIterator = newObjects.iterator();"><span class="lineCounter-0-0-15">72</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>newIterator <span class="token operator">=</span> newObjects<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      this.oldIterator = oldObjects.iterator();"><span class="lineCounter-0-0-15">73</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>oldIterator <span class="token operator">=</span> oldObjects<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">74</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">75</span></div><br><div class="line-0-0-16 " data-content="//wrapper POJO"><span class="lineCounter-0-0-15">76</span><span class="token comment">//wrapper POJO</span></div><br><div class="line-0-0-16 " data-content="  private class SObjectWrapper {"><span class="lineCounter-0-0-15">77</span>  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SObjectWrapper</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public final SObject oldRecord, newRecord;"><span class="lineCounter-0-0-15">78</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">SObject</span> oldRecord<span class="token punctuation">,</span> newRecord<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    public SObjectWrapper(SObject oldRecord, SObject newRecord) {"><span class="lineCounter-0-0-15">79</span>    <span class="token keyword">public</span> <span class="token class-name">SObjectWrapper</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> oldRecord<span class="token punctuation">,</span> <span class="token class-name">SObject</span> newRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      this.oldRecord = oldRecord;"><span class="lineCounter-0-0-15 prim">80</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>oldRecord <span class="token operator">=</span> oldRecord<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      this.newRecord = newRecord;"><span class="lineCounter-0-0-15">81</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>newRecord <span class="token operator">=</span> newRecord<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">82</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">83</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">84</span></div><br><div class="line-0-0-16 " data-content="//realistically, you could just do one of"><span class="lineCounter-0-0-15 prim">85</span><span class="token comment">//realistically, you could just do one of</span></div><br><div class="line-0-0-16 " data-content="//these, since it's required that"><span class="lineCounter-0-0-15">86</span><span class="token comment">//these, since it's required that</span></div><br><div class="line-0-0-16 " data-content="//both lists have the same # of elements"><span class="lineCounter-0-0-15">87</span><span class="token comment">//both lists have the same # of elements</span></div><br><div class="line-0-0-16 " data-content="    public override Boolean hasNext() {"><span class="lineCounter-0-0-15">88</span>    <span class="token keyword">public</span> override <span class="token class-name">Boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      return this.oldIterator.hasNext() &amp;&amp;"><span class="lineCounter-0-0-15">89</span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>oldIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></div><br><div class="line-0-0-16 " data-content="        this.newIterator.hasNext();"><span class="lineCounter-0-0-15 prim">90</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>newIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">91</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">92</span></div><br><div class="line-0-0-16 " data-content="    public override Object next() {"><span class="lineCounter-0-0-15">93</span>    <span class="token keyword">public</span> override <span class="token class-name">Object</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      return new SObjectWrapper("><span class="lineCounter-0-0-15">94</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SObjectWrapper</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        this.oldIterator.next(),"><span class="lineCounter-0-0-15 prim">95</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>oldIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        this.newIterator.next()"><span class="lineCounter-0-0-15">96</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>newIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="      );"><span class="lineCounter-0-0-15">97</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">98</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">99</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">100</span></div><br><div class="line-0-0-16 " data-content="//Iterator that allows for filtering ..."><span class="lineCounter-0-0-15">101</span><span class="token comment">//Iterator that allows for filtering ...</span></div><br><div class="line-0-0-16 " data-content="  virtual class LazyFilterIterator extends LazyIterator {"><span class="lineCounter-0-0-15">102</span>  virtual <span class="token keyword">class</span> <span class="token class-name">LazyFilterIterator</span> <span class="token keyword">extends</span> <span class="token class-name">LazyIterator</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private Object next;"><span class="lineCounter-0-0-15">103</span>    <span class="token keyword">private</span> <span class="token class-name">Object</span> next<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private final BooleanFunction filter;"><span class="lineCounter-0-0-15">104</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BooleanFunction</span> filter<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    public LazyFilterIterator(LazyIterator iterator, BooleanFunction filter) {"><span class="lineCounter-0-0-15 prim">105</span>    <span class="token keyword">public</span> <span class="token class-name">LazyFilterIterator</span><span class="token punctuation">(</span><span class="token class-name">LazyIterator</span> iterator<span class="token punctuation">,</span> <span class="token class-name">BooleanFunction</span> filter<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      super(iterator);"><span class="lineCounter-0-0-15">106</span>      <span class="token keyword">super</span><span class="token punctuation">(</span>iterator<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      this.filter = filter;"><span class="lineCounter-0-0-15">107</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>filter <span class="token operator">=</span> filter<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">108</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">109</span></div><br><div class="line-0-0-16 " data-content="/* NB: the Nebula version uses"><span class="lineCounter-0-0-15 prim">110</span><span class="token comment">/* NB: the Nebula version uses</span></div><br><div class="line-0-0-16 " data-content="another method, &quot;peek()&quot;, but for both"><span class="lineCounter-0-0-15">111</span>another method, "peek()", but for both</div><br><div class="line-0-0-16 " data-content="terseness and expressiveness, I find this"><span class="lineCounter-0-0-15">112</span>terseness and expressiveness, I find this</div><br><div class="line-0-0-16 " data-content="recursive method more descriptive: hasNext()"><span class="lineCounter-0-0-15">113</span>recursive method more descriptive: hasNext()</div><br><div class="line-0-0-16 " data-content="peeks values ahead of the current object"><span class="lineCounter-0-0-15">114</span>peeks values ahead of the current object</div><br><div class="line-0-0-16 " data-content="in the list for matches, advancing the"><span class="lineCounter-0-0-15 prim">115</span>in the list for matches, advancing the</div><br><div class="line-0-0-16 " data-content="internal iterator's place till it"><span class="lineCounter-0-0-15">116</span>internal iterator's place till it</div><br><div class="line-0-0-16 " data-content="finds the next match or reaches the end."><span class="lineCounter-0-0-15">117</span>finds the next match or reaches the end.</div><br><div class="line-0-0-16 " data-content="This is tail-recursive and, as such,"><span class="lineCounter-0-0-15">118</span>This is tail-recursive and, as such,</div><br><div class="line-0-0-16 " data-content="stack safe */"><span class="lineCounter-0-0-15">119</span>stack safe */</div><br><div class="line-0-0-16 " data-content="    public override Boolean hasNext() {"><span class="lineCounter-0-0-15 prim">120</span>    <span class="token keyword">public</span> override <span class="token class-name">Boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      if(super.hasNext()) {"><span class="lineCounter-0-0-15">121</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.next = super.next();"><span class="lineCounter-0-0-15">122</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return this.filter.isTrueFor(this.next) ? true : this.hasNext();"><span class="lineCounter-0-0-15">123</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filter<span class="token punctuation">.</span><span class="token function">isTrueFor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      }"><span class="lineCounter-0-0-15">124</span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">125</span></div><br><div class="line-0-0-16 " data-content="      return false;"><span class="lineCounter-0-0-15">126</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">127</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">128</span></div><br><div class="line-0-0-16 " data-content="    public override Object next() {"><span class="lineCounter-0-0-15">129</span>    <span class="token keyword">public</span> override <span class="token class-name">Object</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      if(this.next != null &amp;&amp; this.next instanceof SObjectWrapper) {"><span class="lineCounter-0-0-15 prim">130</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token keyword">instanceof</span> <span class="token class-name">SObjectWrapper</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return ((SObjectWrapper)this.next).newRecord;"><span class="lineCounter-0-0-15">131</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SObjectWrapper</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">.</span>newRecord<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      }"><span class="lineCounter-0-0-15">132</span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="      return this.next;"><span class="lineCounter-0-0-15">133</span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>next<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">134</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15 prim">135</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">136</span></div><br><div class="line-0-0-16 " data-content="  class FieldChangedFilterProcessor implements BooleanFunction {"><span class="lineCounter-0-0-15">137</span>  <span class="token keyword">class</span> <span class="token class-name">FieldChangedFilterProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BooleanFunction</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final List<SObjectField> fields;"><span class="lineCounter-0-0-15">138</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span> fields<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    public FieldChangedFilterProcessor(SObjectField field) {"><span class="lineCounter-0-0-15">139</span>    <span class="token keyword">public</span> <span class="token class-name">FieldChangedFilterProcessor</span><span class="token punctuation">(</span><span class="token class-name">SObjectField</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      this(new List<SObjectField>{ field });"><span class="lineCounter-0-0-15 prim">140</span>      <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> field <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">141</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public FieldChangedFilterProcessor(List<SObjectField> fields) {"><span class="lineCounter-0-0-15">142</span>    <span class="token keyword">public</span> <span class="token class-name">FieldChangedFilterProcessor</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObjectField</span><span class="token punctuation">&gt;</span></span> fields<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      this.fields = fields;"><span class="lineCounter-0-0-15">143</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>fields <span class="token operator">=</span> fields<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">144</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">145</span></div><br><div class="line-0-0-16 " data-content="    public Boolean isTrueFor(Object obj) {"><span class="lineCounter-0-0-15">146</span>    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">isTrueFor</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      SObjectWrapper wrapper = (SObjectWrapper)obj;"><span class="lineCounter-0-0-15">147</span>      <span class="token class-name">SObjectWrapper</span> wrapper <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SObjectWrapper</span><span class="token punctuation">)</span>obj<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      Boolean hasMatch = false;"><span class="lineCounter-0-0-15">148</span>      <span class="token class-name">Boolean</span> hasMatch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      Integer counter = 0;"><span class="lineCounter-0-0-15">149</span>      <span class="token class-name">Integer</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="//since the matching variable is also"><span class="lineCounter-0-0-15 prim">150</span><span class="token comment">//since the matching variable is also</span></div><br><div class="line-0-0-16 " data-content="//what's being returned, I prefer this format"><span class="lineCounter-0-0-15">151</span><span class="token comment">//what's being returned, I prefer this format</span></div><br><div class="line-0-0-16 " data-content="//to the usage of a &quot;break&quot; statement"><span class="lineCounter-0-0-15">152</span><span class="token comment">//to the usage of a "break" statement</span></div><br><div class="line-0-0-16 " data-content="      while(counter < this.fields.size() &amp;&amp; !hasMatch) {"><span class="lineCounter-0-0-15">153</span>      <span class="token keyword">while</span><span class="token punctuation">(</span>counter <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fields<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        hasMatch = wrapper.oldRecord == null ||"><span class="lineCounter-0-0-15">154</span>        hasMatch <span class="token operator">=</span> wrapper<span class="token punctuation">.</span>oldRecord <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span></div><br><div class="line-0-0-16 " data-content="          wrapper.oldRecord.get(this.fields[counter]) !="><span class="lineCounter-0-0-15 prim">155</span>          wrapper<span class="token punctuation">.</span>oldRecord<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fields<span class="token punctuation">[</span>counter<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span></div><br><div class="line-0-0-16 " data-content="          wrapper.newRecord.get(this.fields[counter]);"><span class="lineCounter-0-0-15">156</span>          wrapper<span class="token punctuation">.</span>newRecord<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fields<span class="token punctuation">[</span>counter<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        counter++;"><span class="lineCounter-0-0-15">157</span>        counter<span class="token operator">++</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      }"><span class="lineCounter-0-0-15">158</span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="      return hasMatch;"><span class="lineCounter-0-0-15">159</span>      <span class="token keyword">return</span> hasMatch<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">160</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">161</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">162</span><span class="token punctuation">}</span></div><br></code></pre><p>As always, usage of the Decorator pattern means you're looking at a lot more code. However, I've minimized the usage of standalone custom classes in this version, using the <code>ObjectChangeProcessor</code> to wrap everything up with a bow. For more generic usages, you probably <em>wouldn't</em> wrap the <code>LazyIterator</code> itself. What does all of this code get us? Easy and lazily-implemented detection of records in a trigger that have changed based on field conditions:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/ObjectChangeProcessorTests.cls</span></span><div class="line-0-0-16 " data-content="private class ObjectChangeProcessorTests {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ObjectChangeProcessorTests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  @isTest"><span class="lineCounter-0-0-15">2</span>  <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="  static void it_should_correctly_filter_records() {"><span class="lineCounter-0-0-15">3</span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_correctly_filter_records</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    Account acc = new Account("><span class="lineCounter-0-0-15">4</span>    <span class="token class-name">Account</span> acc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="      Name = 'Test Account',"><span class="lineCounter-0-0-15 prim">5</span>      <span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'Test Account'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="      NumberOfEmployees = 5"><span class="lineCounter-0-0-15">6</span>      <span class="token class-name">NumberOfEmployees</span> <span class="token operator">=</span> <span class="token number">5</span></div><br><div class="line-0-0-16 " data-content="    );"><span class="lineCounter-0-0-15">7</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">8</span></div><br><div class="line-0-0-16 " data-content="    Account newAcc = new Account("><span class="lineCounter-0-0-15">9</span>    <span class="token class-name">Account</span> newAcc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="      Name = acc.Name,"><span class="lineCounter-0-0-15 prim">10</span>      <span class="token class-name">Name</span> <span class="token operator">=</span> acc<span class="token punctuation">.</span><span class="token class-name">Name</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="      NumberOfEmployees = acc.NumberOfEmployees + 2"><span class="lineCounter-0-0-15">11</span>      <span class="token class-name">NumberOfEmployees</span> <span class="token operator">=</span> acc<span class="token punctuation">.</span><span class="token class-name">NumberOfEmployees</span> <span class="token operator">+</span> <span class="token number">2</span></div><br><div class="line-0-0-16 " data-content="    );"><span class="lineCounter-0-0-15">12</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">13</span></div><br><div class="line-0-0-16 " data-content="    Account accTwo = new Account("><span class="lineCounter-0-0-15">14</span>    <span class="token class-name">Account</span> accTwo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="      Name = 'Test Two',"><span class="lineCounter-0-0-15 prim">15</span>      <span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'Test Two'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="      NumberOfEmployees = 5"><span class="lineCounter-0-0-15">16</span>      <span class="token class-name">NumberOfEmployees</span> <span class="token operator">=</span> <span class="token number">5</span></div><br><div class="line-0-0-16 " data-content="    );"><span class="lineCounter-0-0-15">17</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">18</span></div><br><div class="line-0-0-16 " data-content="    Account accThree = new Account("><span class="lineCounter-0-0-15">19</span>    <span class="token class-name">Account</span> accThree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="      Name = 'Test Three',"><span class="lineCounter-0-0-15 prim">20</span>      <span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'Test Three'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="      NumberOfEmployees = 6"><span class="lineCounter-0-0-15">21</span>      <span class="token class-name">NumberOfEmployees</span> <span class="token operator">=</span> <span class="token number">6</span></div><br><div class="line-0-0-16 " data-content="    );"><span class="lineCounter-0-0-15">22</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">23</span></div><br><div class="line-0-0-16 " data-content="    Account accThreeNew = new Account("><span class="lineCounter-0-0-15">24</span>    <span class="token class-name">Account</span> accThreeNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="      Name = accThree.Name,"><span class="lineCounter-0-0-15 prim">25</span>      <span class="token class-name">Name</span> <span class="token operator">=</span> accThree<span class="token punctuation">.</span><span class="token class-name">Name</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="      NumberOfEmployees = accThree.NumberOfEmployees + 1"><span class="lineCounter-0-0-15">26</span>      <span class="token class-name">NumberOfEmployees</span> <span class="token operator">=</span> accThree<span class="token punctuation">.</span><span class="token class-name">NumberOfEmployees</span> <span class="token operator">+</span> <span class="token number">1</span></div><br><div class="line-0-0-16 " data-content="    );"><span class="lineCounter-0-0-15">27</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">28</span></div><br><div class="line-0-0-16 " data-content="    List<SObject> oldObjects = new List<SObject>{ acc, accTwo, accThree } ;"><span class="lineCounter-0-0-15">29</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> acc<span class="token punctuation">,</span> accTwo<span class="token punctuation">,</span> accThree <span class="token punctuation">}</span> <span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    List<SObject> newObjects = new List<SObject>{ newAcc, accTwo, accThreeNew };"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> newObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> newAcc<span class="token punctuation">,</span> accTwo<span class="token punctuation">,</span> accThreeNew <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">31</span></div><br><div class="line-0-0-16 " data-content="    ObjectChangeProcessor processor = new ObjectChangeProcessor(oldObjects, newObjects);"><span class="lineCounter-0-0-15">32</span>    <span class="token class-name">ObjectChangeProcessor</span> processor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectChangeProcessor</span><span class="token punctuation">(</span>oldObjects<span class="token punctuation">,</span> newObjects<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">33</span></div><br><div class="line-0-0-16 " data-content="    List<Account> accounts = (List<Account>)"><span class="lineCounter-0-0-15">34</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="      processor"><span class="lineCounter-0-0-15 prim">35</span>      processor</div><br><div class="line-0-0-16 " data-content="        .filterByChangeInField(Account.NumberOfEmployees)"><span class="lineCounter-0-0-15">36</span>        <span class="token punctuation">.</span><span class="token function">filterByChangeInField</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">NumberOfEmployees</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="        .toList(new List<Account>());"><span class="lineCounter-0-0-15">37</span>        <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">38</span></div><br><div class="line-0-0-16 " data-content="    System.assertEquals(2, accounts.size());"><span class="lineCounter-0-0-15">39</span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> accounts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    System.assertEquals(7, accounts[0].NumberOfEmployees);"><span class="lineCounter-0-0-15 prim">40</span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> accounts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token class-name">NumberOfEmployees</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    System.assertEquals(7, accounts[1].NumberOfEmployees);"><span class="lineCounter-0-0-15">41</span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> accounts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token class-name">NumberOfEmployees</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">42</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">43</span><span class="token punctuation">}</span></div><br></code></pre><p>Writing a test like this -- documentation, in and of itself -- is my preferred method for investigating a foreign object's API. Does it perform like I expect it to? Does it require complicated arguments to setup and maintain? The further you deviate from the SFDC included library for Apex, the harder it is going to be for somebody else to use.</p><hr><p>When examining the original version of <code>LazyFilterIterator</code>'s "hasNext" implementation, Aidan suggested that it might not be stack-safe. Apex allows for a maximum stack depth of 1000 units, and running up against that boundary condition wouldn't be covered by the upcoming <code>QueueableTimer</code> tests that you'll see below; because Apex Triggers artificially chunk operations into 200 record increments, it might lead to a false sense of confidence in the code's ability to process large amounts of objects. After tweaking the existing recursive function, I wrote the following test:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/ObjectChangeProcessorTests.cls</span></span><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="static void it_should_not_blow_the_stack_while_filtering() {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_not_blow_the_stack_while_filtering</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  //that oughtta' do it!"><span class="lineCounter-0-0-15">3</span>  <span class="token comment">//that oughtta' do it!</span></div><br><div class="line-0-0-16 " data-content="  Integer sentinelValue = 10^7;"><span class="lineCounter-0-0-15">4</span>  <span class="token class-name">Integer</span> sentinelValue <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">^</span><span class="token number">7</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  List<Account> accounts = new List<Account>();"><span class="lineCounter-0-0-15 prim">5</span>  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  for(Integer index = 0; index < sentinelValue; index++) {"><span class="lineCounter-0-0-15">6</span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> sentinelValue<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    accounts.add(new Account(Name = 'Test ' + index));"><span class="lineCounter-0-0-15">7</span>    accounts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'Test '</span> <span class="token operator">+</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">8</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">9</span></div><br><div class="line-0-0-16 " data-content="  ObjectChangeProcessor processor = new ObjectChangeProcessor(accounts);"><span class="lineCounter-0-0-15 prim">10</span>  <span class="token class-name">ObjectChangeProcessor</span> processor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectChangeProcessor</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  List<Object> sameAccounts = processor"><span class="lineCounter-0-0-15">11</span>  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> sameAccounts <span class="token operator">=</span> processor</div><br><div class="line-0-0-16 " data-content="    .filter(new AlwaysTrue())"><span class="lineCounter-0-0-15">12</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AlwaysTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    .toList(new List<Account>());"><span class="lineCounter-0-0-15">13</span>    <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">14</span></div><br><div class="line-0-0-16 " data-content="  System.assertEquals(sentinelValue, sameAccounts.size());"><span class="lineCounter-0-0-15 prim">15</span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>sentinelValue<span class="token punctuation">,</span> sameAccounts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  System.assert(true, 'Should make it here');"><span class="lineCounter-0-0-15">16</span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'Should make it here'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">17</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">18</span></div><br><div class="line-0-0-16 " data-content="class AlwaysTrue implements BooleanFunction {"><span class="lineCounter-0-0-15">19</span><span class="token keyword">class</span> <span class="token class-name">AlwaysTrue</span> <span class="token keyword">implements</span> <span class="token class-name">BooleanFunction</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  public Boolean isTrueFor(Object o) { return true; }"><span class="lineCounter-0-0-15 prim">20</span>  <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">isTrueFor</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">21</span><span class="token punctuation">}</span></div><br></code></pre><p>And the test passed. Joy. As an aside, I typically don't advocate for testing implementation details (the iterator should work the same regardless of the number of records!); that said, on SFDC, it's always advisable to have bulkified tests to verify that you don't exceed your SOQL/SOSL/DML allowances, and assuring that your custom iterator isn't going to blow up on a large data-set certainly falls into this bulkified testing mandate.</p><h3 id="implementing-a-lazy-processor-function" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Implementing A Lazy Processor Function</h3><p>Now I want to move on towards achieving feature parity through the <code>LazyIterator</code> with the code shown earlier for the <code>AccountHandler</code> object; namely, how can I load the iterator with functions that can act upon the SObjects passed into the trigger. This involves a sad case of boilerplate due to not being able to cast on a <code>Iterator&lt;SObject&gt;</code> to <code>Iterator&lt;Object&gt;</code>. Let's go back to the <code>ObjectChangeProcessor</code>:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/Function.cls</span></span><div class="line-0-0-16 " data-content="public interface Function {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Function</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  void call(Object o);"><span class="lineCounter-0-0-15">2</span>  <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">3</span><span class="token punctuation">}</span></div><br></code></pre><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/ObjectChangeProcessor.cls</span></span><div class="line-0-0-16 " data-content="public class ObjectChangeProcessor {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectChangeProcessor</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  private LazyIterator iterator;"><span class="lineCounter-0-0-15">2</span>  <span class="token keyword">private</span> <span class="token class-name">LazyIterator</span> iterator<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  private List<Function> functions;"><span class="lineCounter-0-0-15">3</span>  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Function</span><span class="token punctuation">&gt;</span></span> functions<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">4</span></div><br><div class="line-0-0-16 " data-content="  public ObjectChangeProcessor(List<SObject> oldObjects, List<SObject> newObjects) {"><span class="lineCounter-0-0-15 prim">5</span>  <span class="token keyword">public</span> <span class="token class-name">ObjectChangeProcessor</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> oldObjects<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> newObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this(new LazySObjectPairIterator(oldObjects, newObjects));"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LazySObjectPairIterator</span><span class="token punctuation">(</span>oldObjects<span class="token punctuation">,</span> newObjects<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">7</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">8</span></div><br><div class="line-0-0-16 " data-content="/*alas, this constructor leads to the dreaded"><span class="lineCounter-0-0-15">9</span><span class="token comment">/*alas, this constructor leads to the dreaded</span></div><br><div class="line-0-0-16 " data-content="&quot;Operation cast is not allowed on type: System.ListIterator<SObject>&quot; error"><span class="lineCounter-0-0-15 prim">10</span>"Operation cast is not allowed on type: System.ListIterator&lt;SObject&gt;" error</div><br><div class="line-0-0-16 " data-content="public ObjectChangeProcessor(List<SObject> records) {"><span class="lineCounter-0-0-15">11</span>public ObjectChangeProcessor(List&lt;SObject&gt; records) {</div><br><div class="line-0-0-16 " data-content="  this((Iterator<Object>)records.iterator());"><span class="lineCounter-0-0-15">12</span>  this((Iterator&lt;Object&gt;)records.iterator());</div><br><div class="line-0-0-16 " data-content="}*/"><span class="lineCounter-0-0-15">13</span>}*/</div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">14</span></div><br><div class="line-0-0-16 " data-content="  public ObjectChangeProcessor(List<SObject> records) {"><span class="lineCounter-0-0-15 prim">15</span>  <span class="token keyword">public</span> <span class="token class-name">ObjectChangeProcessor</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    //so we have to do this instead :-\"><span class="lineCounter-0-0-15">16</span>    <span class="token comment">//so we have to do this instead :-\</span></div><br><div class="line-0-0-16 " data-content="    this(new LazySObjectIterator(records.iterator()));"><span class="lineCounter-0-0-15">17</span>    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LazySObjectIterator</span><span class="token punctuation">(</span>records<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">18</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">19</span></div><br><div class="line-0-0-16 " data-content="  private ObjectChangeProcessor(LazyIterator iterator) {"><span class="lineCounter-0-0-15 prim">20</span>  <span class="token keyword">private</span> <span class="token class-name">ObjectChangeProcessor</span><span class="token punctuation">(</span><span class="token class-name">LazyIterator</span> iterator<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.iterator = iterator;"><span class="lineCounter-0-0-15">21</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>iterator <span class="token operator">=</span> iterator<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.functions = new List<Function>();"><span class="lineCounter-0-0-15">22</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>functions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Function</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">23</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">24</span></div><br><div class="line-0-0-16 " data-content="  public ObjectChangeProcessor addFunction(Function func) {"><span class="lineCounter-0-0-15 prim">25</span>  <span class="token keyword">public</span> <span class="token class-name">ObjectChangeProcessor</span> <span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token class-name">Function</span> func<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.functions.add(func);"><span class="lineCounter-0-0-15">26</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>functions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    return this;"><span class="lineCounter-0-0-15">27</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">28</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">29</span></div><br><div class="line-0-0-16 " data-content="  public void process() {"><span class="lineCounter-0-0-15 prim">30</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.iterator.forEach(this.functions);"><span class="lineCounter-0-0-15">31</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>iterator<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>functions<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">32</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">33</span><span class="token punctuation">}</span></div><br></code></pre><p>And in the iterator inner class:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public LazyIterator forEach(Function func) {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token class-name">LazyIterator</span> <span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">Function</span> func<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  return this.forEach(new List<Function>{ func });"><span class="lineCounter-0-0-15">2</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Function</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> func <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">3</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="public LazyIterator forEach(List<Function> funcs) {"><span class="lineCounter-0-0-15">4</span><span class="token keyword">public</span> <span class="token class-name">LazyIterator</span> <span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Function</span><span class="token punctuation">&gt;</span></span> funcs<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  while(this.hasNext()) {"><span class="lineCounter-0-0-15 prim">5</span>  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="//it's iterators all the way down!"><span class="lineCounter-0-0-15">6</span><span class="token comment">//it's iterators all the way down!</span></div><br><div class="line-0-0-16 " data-content="    Iterator<Function> funcIterator = funcs.iterator();"><span class="lineCounter-0-0-15">7</span>    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Function</span><span class="token punctuation">&gt;</span></span> funcIterator <span class="token operator">=</span> funcs<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    Object nextObject = this.next();"><span class="lineCounter-0-0-15">8</span>    <span class="token class-name">Object</span> nextObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    while(funcIterator.hasNext()) {"><span class="lineCounter-0-0-15">9</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>funcIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      Function func = funcIterator.next();"><span class="lineCounter-0-0-15 prim">10</span>      <span class="token class-name">Function</span> func <span class="token operator">=</span> funcIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      func.call(nextObject);"><span class="lineCounter-0-0-15">11</span>      func<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>nextObject<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">12</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">13</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  return this;"><span class="lineCounter-0-0-15">14</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">15</span><span class="token punctuation">}</span></div><br></code></pre><p>Plus we need to add the <code>LazySObjectIterator</code> inner class since casting on the <code>Iterator</code> object is not allowed:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="virtual class LazySObjectIterator extends LazyIterator {"><span class="lineCounter-0-0-15 prim">1</span>virtual <span class="token keyword">class</span> <span class="token class-name">LazySObjectIterator</span> <span class="token keyword">extends</span> <span class="token class-name">LazyIterator</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  private final Iterator<SObject> iterator;"><span class="lineCounter-0-0-15">2</span>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> iterator<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  public LazySObjectIterator(Iterator<SObject> iterator) {"><span class="lineCounter-0-0-15">3</span>  <span class="token keyword">public</span> <span class="token class-name">LazySObjectIterator</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> iterator<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    super();"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.iterator = iterator;"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>iterator <span class="token operator">=</span> iterator<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">6</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="  public override Boolean hasNext() {"><span class="lineCounter-0-0-15">8</span>  <span class="token keyword">public</span> override <span class="token class-name">Boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    return this.iterator.hasNext();"><span class="lineCounter-0-0-15">9</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15 prim">10</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">11</span></div><br><div class="line-0-0-16 " data-content="  public override Object next() {"><span class="lineCounter-0-0-15">12</span>  <span class="token keyword">public</span> override <span class="token class-name">Object</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    return this.iterator.next();"><span class="lineCounter-0-0-15">13</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">14</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">15</span><span class="token punctuation">}</span></div><br></code></pre><p>Going back to our <code>AccountHandler</code> example, it's time to encapsulate the phone/name update methods within classes:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/AccountHandler.cls</span></span><div class="line-0-0-16 " data-content="public class AccountHandler extends TriggerHandler {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountHandler</span> <span class="token keyword">extends</span> <span class="token class-name">TriggerHandler</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">2</span></div><br><div class="line-0-0-16 " data-content="  public override void beforeInsert(List<SObject> insertedRecords) {"><span class="lineCounter-0-0-15">3</span>  <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">beforeInsert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> insertedRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    new ObjectChangeProcessor(insertedRecords)"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">new</span> <span class="token class-name">ObjectChangeProcessor</span><span class="token punctuation">(</span>insertedRecords<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="      .addFunction(new NameNormalizer())"><span class="lineCounter-0-0-15 prim">5</span>      <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NameNormalizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="      .addFunction(new PhoneNormalizer())"><span class="lineCounter-0-0-15">6</span>      <span class="token punctuation">.</span><span class="token function">addFunction</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PhoneNormalizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="      .process();"><span class="lineCounter-0-0-15">7</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">8</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">9</span></div><br><div class="line-0-0-16 " data-content="  class NameNormalizer implements Function {"><span class="lineCounter-0-0-15 prim">10</span>  <span class="token keyword">class</span> <span class="token class-name">NameNormalizer</span> <span class="token keyword">implements</span> <span class="token class-name">Function</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public void call(Object o) {"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      Account acc = (Account)o;"><span class="lineCounter-0-0-15">12</span>      <span class="token class-name">Account</span> acc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">)</span>o<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      acc.Name = acc.Name.normalizeSpace();"><span class="lineCounter-0-0-15">13</span>      acc<span class="token punctuation">.</span><span class="token class-name">Name</span> <span class="token operator">=</span> acc<span class="token punctuation">.</span><span class="token class-name">Name</span><span class="token punctuation">.</span><span class="token function">normalizeSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">14</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15 prim">15</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">16</span></div><br><div class="line-0-0-16 " data-content="  class PhoneNormalizer implements Function {"><span class="lineCounter-0-0-15">17</span>  <span class="token keyword">class</span> <span class="token class-name">PhoneNormalizer</span> <span class="token keyword">implements</span> <span class="token class-name">Function</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public void call(Object o) {"><span class="lineCounter-0-0-15">18</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      Account acc = (Account)o;"><span class="lineCounter-0-0-15">19</span>      <span class="token class-name">Account</span> acc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">)</span>o<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      acc.Phone = this.formatPhoneNumber("><span class="lineCounter-0-0-15 prim">20</span>      acc<span class="token punctuation">.</span><span class="token class-name">Phone</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatPhoneNumber</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        //strip non-digits"><span class="lineCounter-0-0-15">21</span>        <span class="token comment">//strip non-digits</span></div><br><div class="line-0-0-16 " data-content="        acc.Phone.replaceAll("><span class="lineCounter-0-0-15">22</span>        acc<span class="token punctuation">.</span><span class="token class-name">Phone</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="          '[^0-9]',"><span class="lineCounter-0-0-15">23</span>          <span class="token string">'[^0-9]'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="          ''"><span class="lineCounter-0-0-15">24</span>          <span class="token string">''</span></div><br><div class="line-0-0-16 " data-content="        )"><span class="lineCounter-0-0-15 prim">25</span>        <span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="      );"><span class="lineCounter-0-0-15">26</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">27</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">28</span></div><br><div class="line-0-0-16 " data-content="  private String formatPhoneNumber(String phone) {"><span class="lineCounter-0-0-15">29</span>  <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">formatPhoneNumber</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    if(phone.length() == 10) {"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>phone<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="          return '(' + phone.substring(0, 3) + ') '"><span class="lineCounter-0-0-15">31</span>          <span class="token keyword">return</span> <span class="token string">'('</span> <span class="token operator">+</span> phone<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">') '</span></div><br><div class="line-0-0-16 " data-content="              + phone.substring(3, 6) + '-'"><span class="lineCounter-0-0-15">32</span>              <span class="token operator">+</span> phone<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-'</span></div><br><div class="line-0-0-16 " data-content="              + phone.substring(6);"><span class="lineCounter-0-0-15">33</span>              <span class="token operator">+</span> phone<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      } else if (phone.length() == 11"><span class="lineCounter-0-0-15">34</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>phone<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">11</span></div><br><div class="line-0-0-16 " data-content="        &amp;&amp; phone.substring(0) == '1') {"><span class="lineCounter-0-0-15 prim">35</span>        <span class="token operator">&amp;&amp;</span> phone<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="          return this.formatPhoneNumber("><span class="lineCounter-0-0-15">36</span>          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatPhoneNumber</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="            phone.substring("><span class="lineCounter-0-0-15">37</span>            phone<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="              1, phone.length() - 1)"><span class="lineCounter-0-0-15">38</span>              <span class="token number">1</span><span class="token punctuation">,</span> phone<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="          );"><span class="lineCounter-0-0-15">39</span>          <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      }"><span class="lineCounter-0-0-15 prim">40</span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="      return phone;"><span class="lineCounter-0-0-15">41</span>      <span class="token keyword">return</span> phone<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">42</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="  }"><span class="lineCounter-0-0-15">43</span>  <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">44</span><span class="token punctuation">}</span></div><br></code></pre><p>Note that testing the <code>NameNormalizer</code> and <code>PhoneNormalizer</code> inner classes is easily achievable, and they can also be broken out of the Handler into individual/wrapped classes as their responsibilities increase.</p><h2 id="measuring-lazy-evaluation" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Measuring Lazy Evaluation</h2><p>Now that the <code>AccountHandler</code> code has been updated, it's finally time to re-run the <code>QueueableTimer</code> object to see how lazy iteration stands up, performance-wise. Note, again, that I take the average of many runs when reporting out on performance. In other news, "finally time" turned out to be ~4 hours of writing between the "QueueableTimer" runs -- whoah!</p><pre class=""><code class="bash code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="Starting execute after gathering sample records, time passed: 0.363 seconds"><span class="lineCounter-0-0-15 prim">1</span>Starting execute after gathering sample records, <span class="token function">time</span> passed: <span class="token number">0.363</span> seconds</div><br><div class="line-0-0-16 " data-content="Ending, time passed: 32.416 seconds"><span class="lineCounter-0-0-15 prim">2</span>Ending, <span class="token function">time</span> passed: <span class="token number">32.416</span> seconds</div><br></code></pre><table><thead><th>Handler Method</th><th>Time</th><th>% Diff</th><th>Comments</th></thead><tbody><tr><td>Empty</td><td>32.035s</td><td>0.00%</td><td>Without any logic at all</td></tr><tr><td>Standard for loops</td><td>33.469s</td><td>4.47%</td><td>Two calls to "for" loop iteration methods</td></tr><tr><td>LazyIterator</td><td>32.416s</td><td>1.19%</td><td>Two "function" classes added to iterator</td></tr></tbody></table><p>Plus, the results of the tests in <code>ObjectChangeProcessorTests</code>:</p><table><thead><th>TEST NAME</th><th>OUTCOME</th><th>RUNTIME (MS)</th></thead><tbody><tr><td>it-should-call-functions-added-to-processor</td><td>Pass</td><td>16</td></tr><tr><td>it-should-correctly-filter-records</td><td>Pass</td><td>8</td></tr><tr><td>it-should-not-blow-the-stack-while-filtering</td><td>Pass</td><td>5</td></tr></tbody></table><p>I'll take 5ms to iterate 10 million rows, yes please.</p><p>In general, I would hasten to say two things regarding the performance of the <code>LazyIterator</code> -- both the vanilla <code>for</code> loop and Lazy Iterator approach were tested dozens of times and an average of their results were taken. That said, the standard deviation for both approaches is large enough that I would caution taking the results <em>too</em> seriously. While I don't find it hard to believe that relying heavily on the native iterators outperforms the additional cost of initializing objects, neither do I find the performance gain in real terms to be the deciding factor in adopting this framework.</p><hr><h2 id="wrapping-up" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Wrapping Up</h2><p>Reverse-engineering (an admittedly <em>extremely small portion of</em>) the <code>LazyIterator</code> proved to be good, clean fun. Like all good exercises, it left me with plenty of inspiration for how to apply the code to my own use-cases. While I had a few nits with the overall level of verbosity, in general I would say that the framework code is both well-annotated with Javadoc descriptions and remarkably expressive at a very high-level of abstraction -- no easy feat. I left impressed, which is my highest praise.</p><p>I will definitely be making use of some of the code here and from the Nebula Consulting repo. I like the fluent nature of working with the wrapped iterator; I can also see, with some work, how I would expand upon the structure orchestrated here to accommodate my two other most frequent use-cases:</p><ul><li>iterating through a list with a <code>Map&lt;Id, Object&gt;</code> or <code>Map&lt;String, Object&gt;</code> that matches a value in that list, and performing processing</li><li>iterating through a list with a <code>Map&lt;Id, List&lt;Object&gt;&gt;</code> or <code>Map&lt;String, List&lt;Object&gt;&gt;</code> that matches a value in that list, and performing processing</li></ul><p>Additionally, there are some fun considerations for the <code>LazyIterator</code> -- some of which are handled within the existing Nebula Consulting <code>LazyIterator</code> framework, some of which would be excellent additions:</p><ul><li>Allowing you to filter for multiple discrete (not necessarily mutually exclusive, but independent) criteria in a single iteration. This would really help with performing additional processing on subsets of data depending on different field changes / entry conditions <em>without</em> unnecessary iteration. You could definitely finangle this into an existing <code>Function</code> definition, but really you would be looking for a combination of the existing <code>Function</code> and <code>BooleanFunction</code> implementations, where all matches were tested for and, conditionally, processing was done if the result matched. Of course, depending on your business logic, there definitely exists the potential for independent updates to depend on one another in some happy temporal soup. Traditionally, showing that the order of functions being called matters makes use of explicit passing of variables to the further-down-the-line functions to make the coupling explicit. With a fluent iterator, another approach would be necessary; in looking again at the Nebula Repo, their <code>ForkIterator</code> <em>does</em> handle the first use-case (independent filtering), but massaging the API to better broadcast dependent forking is only a dream at the moment</li><li>proper support for empty iterators (clasically, the use of a singleton "null" instance is used; a singleton because you only ever need one instance of it) -- I've been promised a framework-wide approach using their <code>EmptyIterator</code> object is forthcoming!</li><li>first class support for Maps, as discussed above. Ideally the <code>LazyIterator</code> would be able to both build a one-to-one (<code>Map&lt;Id, Object&gt;</code> or <code>Map&lt;String, Object&gt;</code>) or one-to-many (<code>Map&lt;Id, List&lt;Object&gt;&gt;</code> or <code>Map&lt;String, List&lt;Object&gt;&gt;</code>) collection as part of a <code>Function</code> <em>and</em> pass the results to future <code>Function</code>s for usage. Unfortunately, while casting is a "pain" with Lists, it's not even allowed with Maps in Apex, which would probably necessitate painful (and limiting) serialization/deserialization techniques (which has actual performance implications, as well)</li></ul><p>As always, I hope that this post proved illuminating -- if not on the seemingly endless iteration topic, then at least in having walked this road with me for some time. It's always appreciated.</p><p>Till next time!</p><div class="contentnav-0-0-7" data-no-search=""><a href="#a-short-history-of-lazy-evaluation" class="h2" data-content-highlight="a-short-history-of-lazy-evaluation">A Short History Of Lazy Evaluation</a><a href="#eager-evaluation-in-javascript--apex" class="h2" data-content-highlight="eager-evaluation-in-javascript--apex">Eager Evaluation in JavaScript &amp; Apex</a><a href="#measuring-sobject-trigger-performance" class="h2" data-content-highlight="measuring-sobject-trigger-performance">Measuring SObject Trigger Performance</a><a href="#measuring-eagerly-evaluated-methods" class="h2" data-content-highlight="measuring-eagerly-evaluated-methods">Measuring Eagerly-Evaluated Methods</a><a href="#diving-into-lazy-evaluation" class="h2" data-content-highlight="diving-into-lazy-evaluation">Diving Into Lazy Evaluation</a><a href="#re-implementing-a-lazy-iterator" class="h3" data-content-highlight="re-implementing-a-lazy-iterator">Re-implementing A Lazy Iterator</a><a href="#implementing-a-lazy-filter-function" class="h3" data-content-highlight="implementing-a-lazy-filter-function">Implementing A Lazy Filter Function</a><a href="#implementing-a-lazy-processor-function" class="h3" data-content-highlight="implementing-a-lazy-processor-function">Implementing A Lazy Processor Function</a><a href="#measuring-lazy-evaluation" class="h2" data-content-highlight="measuring-lazy-evaluation">Measuring Lazy Evaluation</a><a href="#wrapping-up" class="h2" data-content-highlight="wrapping-up">Wrapping Up</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="CGRXrJuOXt">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("CGRXrJuOXt", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="IrSntyTQaQ">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("IrSntyTQaQ", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="ac_VmKrOgp">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ac_VmKrOgp", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>