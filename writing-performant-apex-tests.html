<!DOCTYPE html><html><head><title>Joys Of Apex | Writing Performant Apex Tests</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Writing Performant Apex Tests"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Writing Performant Apex Tests"></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"writing-performant-apex-tests.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Writing Performant Apex Tests</p></span></h1><script id="azQBedlHay">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("azQBedlHay", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2020-03-02T15:12:03.284Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>Let's go back to basics when talking about designing and working in Apex codebases. There are a few design patterns that help to make your unit tests fast and performant -- which in turn speeds up your development time. As well, being able to run your whole test suite in a matter of minutes (max) becomes crucially important as your (or your client's) system grows organically over time. Refactoring code is a lot like weeding in a garden: you might see some beautiful things without it, but you'll never consistently be able to work in an Apex codebase without identifying patterns, abstracting them, and re-writing code to make use of the new abstractions.</p><p>There <em>is</em> a time when it's too early to refactor -- while writing the code the first time. Indeed, the TDD mentality is often repurposed to promote something an old colleague of mine fondly refers to as "prefactoring" -- refactoring your code too early. The "red, green, refactor" mantra is encouraged instead of trying to achieve the perfect system upfront; code is inherently complicated, the business needs transform over time, and while humans are exceptional at pattern recognition when it's staring them in the face, we fare poorly as a species in attempting to forecast patterns. If you wouldn't do it with the stock market, in other words, you probably shouldn't be doing it with the code you're writing.</p><p>So what are the most important Apex patterns to follow? I would hazard to guess that the two most important patterns that should be followed in <strong>all</strong> Apex codebases are:</p><ul><li>the TriggerHandler pattern. This has been covered in great depth across a number of prominent SFDC bloggers over the years; a quick Google search for "apex trigger handler pattern" surfaces an enormous quantity of results. I just wrote a <a href="/joys-of-apex/lightweight-trigger-handler">lightweight TriggerHandler implementation</a> so that if this is somehow the first time you're hearing about this pattern, you have a reference point</li><li>Bulkification -- Salesforce coined the term "bulkify," advising developers to always consider the consequences of multiple SObjects being updated at a time. Given that users typically want bulk update capabilities on their List Views (to say nothing of what might happen from somebody kicking off a Flow ...), writing code that doesn't exceed your <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_gov_limits.htm">Apex governor limits</a> is of <em>crucial</em> importance. Probably the most common thing that you see in this vein is the age-old adage about not performing SOQL queries in loops</li></ul><p>So what follows, logically, when considering architecture on the SFDC platform in light of these two patterns? In a way, though Salesforce has now released the Platform Event and EventBus architecture, you can also think of your triggers as event observers. Most code is designed to do one of two things:</p><ul><li>respond to changes</li><li>look for changes, then respond (Scheduled Apex, in other words)</li></ul><h2 id="test-fast-test-often" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Test Fast, Test Often</h2><p>What other patterns may be of use to the aspiring developer / systems architect? One of the reasons that <a href="/joys-of-apex/mocking-dml">I advise the use of a DML-mocking architecture</a> is because of how expensive it is, in regards to time, to insert/update records in your unit tests. In a large org with hundreds/thousands of tests, it's not uncommon for test runs to take upwards of an hour (indeed, in some codebases, people might be <em>dreaming</em> about the tests taking only an hour to run).</p><p>If you're in the middle of refactoring, minimizing the amount of time your tests take to run is the single best way to improve your development time. If you have to wait hours prior to validating a code change (or, even worse, a deploy fails and you have other features needing to be deployed at the same time ...), your ability to quicly respond to change has been completely hamstrung. It's also not necessary to do a total codebase overhaul when implementing changes like a DML-wrapper; start in an isolated area, show to your team/client's that development time speeds up when test coverage and speed lends itself to developer confidence, and make incremental changes to support an overall reduction in test time.</p><p>This leads me into coverage of the existing industry standard for mocking libraries, <a href="https://github.com/apex-enterprise-patterns/fflib-apex-mocks">FFLib's Apex Mocks</a>. It conforms to the Mockito dependency injection standard for mocking, and allows you to inject stubs into your Apex unit tests -- purportedly increasing their speed by replacing complicated database calls and large insert/update operations with mocks of your choice.</p><p>But how performant is the existing Apex Mocks library, when compared to the <code>Crud</code> class that I introduced in the aforementioned <a href="/joys-of-apex/mocking-dml">Mocking DML</a> post, and made similarly accessible in your tests through the use of the <a href="/joys-of-apex/dependency-injection-factory-pattern">Factory Dependency Injection</a> pattern? This originally came up as a pretty bold challenge by a user on reddit who seemed to suggest that there was no space in the Salesforce ecosystem for another dependency injection framework; I thought it best to test that assertion, and the results can also be found covered in great detail on my <a href="https://github.com/jamessimone/apex-mocks-stress-test">Apex Mocks</a> repo's master branch.</p><p>The simplest possible method for stress-testing the two systems is to fake the insertion of a large amount of data. I originally wanted to iterate over a million rows to simulate what it would be like if you wanted to emulate potentially real-world conditions while working with Batch Apex or your org frequently responds to bulk interactions from external APIs:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/ApexMocksTests.cls</span></span><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class ApexMocksTests {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ApexMocksTests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private static Integer LARGE_NUMBER = 1000000;"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> LARGE_NUMBER <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">4</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void fflib_should_mock_dml_statements_update() {"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fflib_should_mock_dml_statements_update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        // Given"><span class="lineCounter-0-0-15">7</span>        <span class="token comment">// Given</span></div><br><div class="line-0-0-16 " data-content="        fflib_ApexMocks mocks = new fflib_ApexMocks();"><span class="lineCounter-0-0-15">8</span>        fflib_ApexMocks mocks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">fflib_ApexMocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        ICrud mockCrud = (ICrud)mocks.mock(Crud.class);"><span class="lineCounter-0-0-15">9</span>        <span class="token class-name">ICrud</span> mockCrud <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ICrud</span><span class="token punctuation">)</span>mocks<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">Crud</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Account fakeAccount = new Account();"><span class="lineCounter-0-0-15 prim">10</span>        <span class="token class-name">Account</span> fakeAccount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">11</span></div><br><div class="line-0-0-16 " data-content="        // When"><span class="lineCounter-0-0-15">12</span>        <span class="token comment">// When</span></div><br><div class="line-0-0-16 " data-content="        for(Integer i = 0; i < LARGE_NUMBER; i++) {"><span class="lineCounter-0-0-15">13</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> LARGE_NUMBER<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            mockCrud.doUpdate(fakeAccount);"><span class="lineCounter-0-0-15">14</span>            mockCrud<span class="token punctuation">.</span><span class="token function">doUpdate</span><span class="token punctuation">(</span>fakeAccount<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15 prim">15</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">16</span></div><br><div class="line-0-0-16 " data-content="        // Then"><span class="lineCounter-0-0-15">17</span>        <span class="token comment">// Then</span></div><br><div class="line-0-0-16 " data-content="        mocks.verify(mockCrud, LARGE_NUMBER);"><span class="lineCounter-0-0-15">18</span>        mocks<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>mockCrud<span class="token punctuation">,</span> LARGE_NUMBER<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">19</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">20</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">21</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void crudmock_should_mock_dml_statements_update() {"><span class="lineCounter-0-0-15">22</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">crudmock_should_mock_dml_statements_update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        //Given"><span class="lineCounter-0-0-15">23</span>        <span class="token comment">//Given</span></div><br><div class="line-0-0-16 " data-content="        ICrud mockCrud = CrudMock.getMock();"><span class="lineCounter-0-0-15">24</span>        <span class="token class-name">ICrud</span> mockCrud <span class="token operator">=</span> <span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token function">getMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Account fakeAccount = new Account();"><span class="lineCounter-0-0-15 prim">25</span>        <span class="token class-name">Account</span> fakeAccount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">26</span></div><br><div class="line-0-0-16 " data-content="        //When"><span class="lineCounter-0-0-15">27</span>        <span class="token comment">//When</span></div><br><div class="line-0-0-16 " data-content="        for(Integer i = 0; i < LARGE_NUMBER; i++) {"><span class="lineCounter-0-0-15">28</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> LARGE_NUMBER<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            mockCrud.doUpdate(fakeAccount);"><span class="lineCounter-0-0-15">29</span>            mockCrud<span class="token punctuation">.</span><span class="token function">doUpdate</span><span class="token punctuation">(</span>fakeAccount<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15 prim">30</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">31</span></div><br><div class="line-0-0-16 " data-content="        //Then"><span class="lineCounter-0-0-15">32</span>        <span class="token comment">//Then</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(LARGE_NUMBER, CrudMock.Updated.size());"><span class="lineCounter-0-0-15">33</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>LARGE_NUMBER<span class="token punctuation">,</span> <span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token class-name">Updated</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">34</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">35</span><span class="token punctuation">}</span></div><br></code></pre><p>That led to some pretty unfortunate results in the console.</p><p>Using diff notation to indicate test passes / failures:</p><pre class=""><code class="diff code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="$ yarn test ApexMocksTests*"><span class="lineCounter-0-0-15 prim">1</span>$ yarn test ApexMocksTests*</div><br><div class="line-0-0-16 " data-content="$ dmc test ApexMocksTests*"><span class="lineCounter-0-0-15">2</span>$ dmc test ApexMocksTests*</div><br><div class="line-0-0-16 " data-content="[dmc] using org: apex-mocks (default)"><span class="lineCounter-0-0-15">3</span>[dmc] using org: apex-mocks (default)</div><br><div class="line-0-0-16 " data-content="[dmc] * src/classes/ApexMocksTests.cls"><span class="lineCounter-0-0-15">4</span>[dmc] * src/classes/ApexMocksTests.cls</div><br><div class="line-0-0-16 " data-content="[dmc] ===> ApexMocksTests test results <==="><span class="lineCounter-0-0-15 prim">5</span>[dmc] ===&gt; ApexMocksTests test results &lt;===</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] ApexMocksTests: crudmock_should_mock_dml_statements_update, time: 4.635s"><span class="lineCounter-0-0-15">6</span><span class="token inserted-sign inserted">+[dmc] [pass] ApexMocksTests: crudmock_should_mock_dml_statements_update, time: 4.635s</span></div><br><div class="line-0-0-16 " data-content="-[err] [fail] ApexMocksTests: fflib_should_mock_dml_statements_update =>"><span class="lineCounter-0-0-15">7</span><span class="token deleted-sign deleted">-[err] [fail] ApexMocksTests: fflib_should_mock_dml_statements_update =&gt;</span></div><br><div class="line-0-0-16 " data-content="-System.LimitException: Apex CPU time limit exceeded =>"><span class="lineCounter-0-0-15">8</span>-System.LimitException: Apex CPU time limit exceeded =&gt;</div><br><div class="line-0-0-16 " data-content="-Class.fflib_MethodCountRecorder.recordMethod: line 57, column 1"><span class="lineCounter-0-0-15">9</span>-Class.fflib_MethodCountRecorder.recordMethod: line 57, column 1</div><br><div class="line-0-0-16 " data-content="-Class.fflib_ApexMocks.recordMethod: line 170, column 1"><span class="lineCounter-0-0-15 prim">10</span>-Class.fflib_ApexMocks.recordMethod: line 170, column 1</div><br><div class="line-0-0-16 " data-content="-Class.fflib_ApexMocks.mockNonVoidMethod: line 280, column 1"><span class="lineCounter-0-0-15">11</span>-Class.fflib_ApexMocks.mockNonVoidMethod: line 280, column 1</div><br><div class="line-0-0-16 " data-content="-Class.fflib_ApexMocks.handleMethodCall: line 83, column 1"><span class="lineCounter-0-0-15">12</span>-Class.fflib_ApexMocks.handleMethodCall: line 83, column 1</div><br><div class="line-0-0-16 " data-content="-Class.Crud__sfdc_ApexStub.doUpdate: line 103, column 1"><span class="lineCounter-0-0-15">13</span>-Class.Crud__sfdc_ApexStub.doUpdate: line 103, column 1</div><br><div class="line-0-0-16 " data-content="-Class.ApexMocksTests.fflib_should_mock_dml_statements_update:"><span class="lineCounter-0-0-15">14</span>-Class.ApexMocksTests.fflib_should_mock_dml_statements_update:</div><br><div class="line-0-0-16 " data-content="-line 14, column 1, time: 16.06s"><span class="lineCounter-0-0-15 prim">15</span>-line 14, column 1, time: 16.06s</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Number of tests run: 2 <==="><span class="lineCounter-0-0-15">16</span>[dmc] ===&gt; Number of tests run: 2 &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Total test time: 20.69500s <==="><span class="lineCounter-0-0-15">17</span>[dmc] ===&gt; Total test time: 20.69500s &lt;===</div><br><div class="line-0-0-16 " data-content="[err] Failed -> 1 test failures"><span class="lineCounter-0-0-15">18</span>[err] Failed -&gt; 1 test failures</div><br><div class="line-0-0-16 " data-content="[dmc] [NOT OK]"><span class="lineCounter-0-0-15">19</span>[dmc] [NOT OK]</div><br><div class="line-0-0-16 " data-content="error Command failed with exit code 1."><span class="lineCounter-0-0-15 prim">20</span>error Command failed with exit code 1.</div><br></code></pre><p>Unlucky. The FFLib library can't handle iterating over a million rows (it also can't handle 100,000) - let's try 10,000 instead:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/ApexMocksTests.cls</span></span><div class="line-0-0-16 " data-content="private static Integer LARGE_NUMBER = 10000;"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> LARGE_NUMBER <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span></div><br></code></pre><p>And the results:</p><pre class=""><code class="diff code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="$ yarn test ApexMocksTests*"><span class="lineCounter-0-0-15 prim">1</span>$ yarn test ApexMocksTests*</div><br><div class="line-0-0-16 " data-content="yarn run v1.22.0"><span class="lineCounter-0-0-15">2</span>yarn run v1.22.0</div><br><div class="line-0-0-16 " data-content="$ dmc test ApexMocksTests*"><span class="lineCounter-0-0-15">3</span>$ dmc test ApexMocksTests*</div><br><div class="line-0-0-16 " data-content="[dmc] using org: apex-mocks (default)"><span class="lineCounter-0-0-15">4</span>[dmc] using org: apex-mocks (default)</div><br><div class="line-0-0-16 " data-content="[dmc] * src/classes/ApexMocksTests.cls"><span class="lineCounter-0-0-15 prim">5</span>[dmc] * src/classes/ApexMocksTests.cls</div><br><div class="line-0-0-16 " data-content="[dmc] ===> ApexMocksTests test results <==="><span class="lineCounter-0-0-15">6</span>[dmc] ===&gt; ApexMocksTests test results &lt;===</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] ApexMocksTests: crudmock_should_mock_dml_statements_update, time: 0.591s"><span class="lineCounter-0-0-15">7</span><span class="token inserted-sign inserted">+[dmc] [pass] ApexMocksTests: crudmock_should_mock_dml_statements_update, time: 0.591s</span></div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] ApexMocksTests: fflib_should_mock_dml_statements_update, time: 11.145s"><span class="lineCounter-0-0-15">8</span>+[dmc] [pass] ApexMocksTests: fflib_should_mock_dml_statements_update, time: 11.145s</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Number of tests run: 2 <==="><span class="lineCounter-0-0-15">9</span>[dmc] ===&gt; Number of tests run: 2 &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Total test time: 11.73600s <==="><span class="lineCounter-0-0-15 prim">10</span>[dmc] ===&gt; Total test time: 11.73600s &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] [OK]"><span class="lineCounter-0-0-15 prim">11</span>[dmc] [OK]</div><br></code></pre><p>Dan Appleman talked several years ago at Dreamforce about the need for "burn-in" when testing: that test results can vary run-over-run, and that some optimization seemingly takes place within Apex as tests are run frequently. On the <a href="https://github.com/jamessimone/apex-mocks-stress-test">Apex Mocks</a> repo, you can see the result of FFLib's library versus my own over no fewer than 10 different test runs, but the moral of the story is that these results didn't occur randomly, or vary wildly run over run. Time after time, the use of a simple DML wrapper proved to be ridiculously more performant than the existing FFLib mocking implementation. If you're working for an enterprise organization with hundreds or thousands of tests, the time-savings potential alone in using the Crud/CrudMock wrappers is something that should be making your ears perk up.</p><p>What other Apex paradigms can look to validate through the use of tests?</p><h2 id="looping-in-apex" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Looping in Apex</h2><div class="tabs-0-0-18"><script id="qhlWsyDPFv">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("qhlWsyDPFv", "T764P9zpaV5eSCd1H0okyw==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="tab first selected" data-tab-title="Iterating In Apex"><p>Let's talk about loops. You might be thinking to yourself right now ... <em>really, loops? Like, a for loop?? Why do we need to talk about that?!</em> There's a <em>lot</em> of potential in performance optimization when it comes to iterating through large lists of records -- particularly if this is an area you've never thought about optimizing, previously. Specifically, how you iterate through loops matters. If you're talking about business-critical functionality, the first thing you can optimize is the number of loops you execute.</p></div><div class="tab" data-tab-title="Iteration Footnote"><p>This is not an Apex-specific optimization; a friend of mine and I were shocked, several years ago, when implementing analytics with <a href="https://www.mixpanel.com/">Mixpanel</a> - their HTTP API for tracking events <a href="https://developer.mixpanel.com/docs/http#section-batch-requests">accepts a maximum of 50 events at a time</a>. Our first stab at splitting lists of events made heavy use of .Net's LINQ syntax -- a pleasant experience for any developer, particularly with a fluent interface that lets you chain together commands to quickly cobble together two different lists of event records. However, due to the number of times our lists were being iterated through with LINQ, our program's thread time was quite high ... and, as anybody familiar with cloud computing can relate to, time == $$. Ditching LINQ and using one iteration method to split up our lists ended up shaving enough time off of our process time to fit within the cheapest pricing level our cloud provider offered.</p></div></div><p>After that, though, there's a few different ways to iterate:</p><ul><li>the <strong>absolute</strong> classic WHILE loop. Your mom &amp; dad wrote WHILE loops, and there's still nothing wrong with them today!</li><li>the <strong>boring</strong> for loop with built in index: <code>for(Integer index = 0; index &lt; SOME_NUMBER; index ++)</code></li><li>the syntax sugar version of the for loop: <code>for(SObject record : records)</code></li><li>the <strong>dark horse</strong>, the one that has so much potential but also comes built in ... the ITERATOR instance</li></ul><p>Let's write some tests:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/LoopTests.cls</span></span><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class LoopTests {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">LoopTests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="    //I only added the baseline test after first running the initial"><span class="lineCounter-0-0-15">4</span>    <span class="token comment">//I only added the baseline test after first running the initial</span></div><br><div class="line-0-0-16 " data-content="    //tests a number of times. You'll see when it starts to be measured"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token comment">//tests a number of times. You'll see when it starts to be measured</span></div><br><div class="line-0-0-16 " data-content="    //in my output. Apologies for the oversight!"><span class="lineCounter-0-0-15">6</span>    <span class="token comment">//in my output. Apologies for the oversight!</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">7</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_establish_baseline_using_while_loop() {"><span class="lineCounter-0-0-15">8</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_establish_baseline_using_while_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> accountsToInsert = fillAccountList();"><span class="lineCounter-0-0-15">9</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token function">fillAccountList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">11</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">12</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_test_fake_while_loop_insert() {"><span class="lineCounter-0-0-15">13</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_test_fake_while_loop_insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> accountsToInsert = fillAccountList();"><span class="lineCounter-0-0-15">14</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token function">fillAccountList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">15</span></div><br><div class="line-0-0-16 " data-content="        CrudMock.getMock().doInsert(accountsToInsert);"><span class="lineCounter-0-0-15">16</span>        <span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token function">getMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doInsert</span><span class="token punctuation">(</span>accountsToInsert<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">17</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(LARGE_NUMBER, CrudMock.Inserted.size());"><span class="lineCounter-0-0-15">18</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>LARGE_NUMBER<span class="token punctuation">,</span> <span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token class-name">Inserted</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">19</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">20</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">21</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_test_fake_basic_for_loop_insert() {"><span class="lineCounter-0-0-15">22</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_test_fake_basic_for_loop_insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> accountsToInsert = new List<SObject>();"><span class="lineCounter-0-0-15">23</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        for(Integer index = 0; index < LARGE_NUMBER; index++) {"><span class="lineCounter-0-0-15">24</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> LARGE_NUMBER<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            Account acc = new Account(Name = 'Test' + index);"><span class="lineCounter-0-0-15 prim">25</span>            <span class="token class-name">Account</span> acc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'Test'</span> <span class="token operator">+</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            accountsToInsert.add(acc);"><span class="lineCounter-0-0-15">26</span>            accountsToInsert<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">27</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">28</span></div><br><div class="line-0-0-16 " data-content="        CrudMock.getMock().doInsert(accountsToInsert);"><span class="lineCounter-0-0-15">29</span>        <span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token function">getMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doInsert</span><span class="token punctuation">(</span>accountsToInsert<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">30</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(LARGE_NUMBER, CrudMock.Inserted.size());"><span class="lineCounter-0-0-15">31</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>LARGE_NUMBER<span class="token punctuation">,</span> <span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token class-name">Inserted</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">32</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">33</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">34</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_test_fake_syntax_sugar_for_loop_insert() {"><span class="lineCounter-0-0-15 prim">35</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_test_fake_syntax_sugar_for_loop_insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> accountsToInsert = fillAccountList();"><span class="lineCounter-0-0-15">36</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token function">fillAccountList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">37</span></div><br><div class="line-0-0-16 " data-content="        for(SObject record : accountsToInsert) {"><span class="lineCounter-0-0-15">38</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> <span class="token keyword">record</span> <span class="token operator">:</span> accountsToInsert<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            setNameToRandomValue(record);"><span class="lineCounter-0-0-15">39</span>            <span class="token function">setNameToRandomValue</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15 prim">40</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">41</span></div><br><div class="line-0-0-16 " data-content="        CrudMock.getMock().doInsert(accountsToInsert);"><span class="lineCounter-0-0-15">42</span>        <span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token function">getMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doInsert</span><span class="token punctuation">(</span>accountsToInsert<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">43</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(LARGE_NUMBER, CrudMock.Inserted.size());"><span class="lineCounter-0-0-15">44</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>LARGE_NUMBER<span class="token punctuation">,</span> <span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token class-name">Inserted</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">45</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">46</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">47</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_test_iterator_while_loop_insert() {"><span class="lineCounter-0-0-15">48</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_test_iterator_while_loop_insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> accountsToInsert = fillAccountList();"><span class="lineCounter-0-0-15">49</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token function">fillAccountList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">50</span></div><br><div class="line-0-0-16 " data-content="        //you can only use iterators in while loops"><span class="lineCounter-0-0-15">51</span>        <span class="token comment">//you can only use iterators in while loops</span></div><br><div class="line-0-0-16 " data-content="        while(accountsToInsert.iterator().hasNext()) {"><span class="lineCounter-0-0-15">52</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>accountsToInsert<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            setNameToRandomValue(accountsToInsert.iterator().next());"><span class="lineCounter-0-0-15">53</span>            <span class="token function">setNameToRandomValue</span><span class="token punctuation">(</span>accountsToInsert<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">54</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">55</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">56</span></div><br><div class="line-0-0-16 " data-content="    private static Integer LARGE_NUMBER = 100000;"><span class="lineCounter-0-0-15">57</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> LARGE_NUMBER <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private static List<SObject> fillAccountList() {"><span class="lineCounter-0-0-15">58</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">fillAccountList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Integer counter = 0;"><span class="lineCounter-0-0-15">59</span>        <span class="token class-name">Integer</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> accountsToInsert = new List<SObject>();"><span class="lineCounter-0-0-15 prim">60</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        while(counter < LARGE_NUMBER) {"><span class="lineCounter-0-0-15">61</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>counter <span class="token operator">&lt;</span> LARGE_NUMBER<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            Account acc = new Account(Name = 'Test' + counter);"><span class="lineCounter-0-0-15">62</span>            <span class="token class-name">Account</span> acc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'Test'</span> <span class="token operator">+</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            accountsToInsert.add(acc);"><span class="lineCounter-0-0-15">63</span>            accountsToInsert<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            counter++;"><span class="lineCounter-0-0-15">64</span>            counter<span class="token operator">++</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15 prim">65</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        return accountsToInsert;"><span class="lineCounter-0-0-15">66</span>        <span class="token keyword">return</span> accountsToInsert<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">67</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">68</span></div><br><div class="line-0-0-16 " data-content="    private static void setNameToRandomValue(SObject record) {"><span class="lineCounter-0-0-15">69</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setNameToRandomValue</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> <span class="token keyword">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        record.put('Name', 'Something ' + Math.random().format());"><span class="lineCounter-0-0-15 prim">70</span>        <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'Name'</span><span class="token punctuation">,</span> <span class="token string">'Something '</span> <span class="token operator">+</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">71</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">72</span><span class="token punctuation">}</span></div><br></code></pre><p>To be clear, because some of the test methods make use of the <code>fillAccountList</code> function and THEN do additional work, I was hoping to establish a baseline for how long that particular iteration took in order to understand how the other methods that required a filled list in order to do their own thing were affected. My first attempt with <code>LARGE_NUMBER</code> set to 1 million didn't go so hot:</p><pre class=""><code class="diff code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="$ yarn test LoopTest*"><span class="lineCounter-0-0-15 prim">1</span>$ yarn test LoopTest*</div><br><div class="line-0-0-16 " data-content="yarn run v1.22.0"><span class="lineCounter-0-0-15">2</span>yarn run v1.22.0</div><br><div class="line-0-0-16 " data-content="$ dmc test LoopTest*"><span class="lineCounter-0-0-15">3</span>$ dmc test LoopTest*</div><br><div class="line-0-0-16 " data-content="[dmc] using org: apex-mocks (default)"><span class="lineCounter-0-0-15">4</span>[dmc] using org: apex-mocks (default)</div><br><div class="line-0-0-16 " data-content="[dmc] * src/classes/LoopTests.cls"><span class="lineCounter-0-0-15 prim">5</span>[dmc] * src/classes/LoopTests.cls</div><br><div class="line-0-0-16 " data-content="[dmc] ===> LoopTests test results <==="><span class="lineCounter-0-0-15">6</span>[dmc] ===&gt; LoopTests test results &lt;===</div><br><div class="line-0-0-16 " data-content="-[err] [fail] LoopTests: it_should_test_fake_basic_for_loop_insert =>"><span class="lineCounter-0-0-15">7</span><span class="token deleted-sign deleted">-[err] [fail] LoopTests: it_should_test_fake_basic_for_loop_insert =&gt;</span></div><br><div class="line-0-0-16 " data-content="- System.LimitException: Apex CPU time limit exceeded =>"><span class="lineCounter-0-0-15">8</span>- System.LimitException: Apex CPU time limit exceeded =&gt;</div><br><div class="line-0-0-16 " data-content="- Class.LoopTests.it_should_test_fake_basic_for_loop_insert: line 18, column 1, time: 16.05s"><span class="lineCounter-0-0-15">9</span>- Class.LoopTests.it_should_test_fake_basic_for_loop_insert: line 18, column 1, time: 16.05s</div><br><div class="line-0-0-16 " data-content="-[err] [fail] LoopTests: it_should_test_fake_syntax_sugar_for_loop_insert =>"><span class="lineCounter-0-0-15 prim">10</span>-[err] [fail] LoopTests: it_should_test_fake_syntax_sugar_for_loop_insert =&gt;</div><br><div class="line-0-0-16 " data-content="-System.LimitException: Apex CPU time limit exceeded =>"><span class="lineCounter-0-0-15">11</span>-System.LimitException: Apex CPU time limit exceeded =&gt;</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.fillAccountList: line 54, column 1"><span class="lineCounter-0-0-15">12</span>-Class.LoopTests.fillAccountList: line 54, column 1</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.it_should_test_fake_syntax_sugar_for_loop_insert: line 28, column 1, time: 15.732s"><span class="lineCounter-0-0-15">13</span>-Class.LoopTests.it_should_test_fake_syntax_sugar_for_loop_insert: line 28, column 1, time: 15.732s</div><br><div class="line-0-0-16 " data-content="-[err] [fail] LoopTests: it_should_test_fake_while_loop_insert =>"><span class="lineCounter-0-0-15">14</span>-[err] [fail] LoopTests: it_should_test_fake_while_loop_insert =&gt;</div><br><div class="line-0-0-16 " data-content="-System.LimitException: Apex CPU time limit exceeded =>"><span class="lineCounter-0-0-15 prim">15</span>-System.LimitException: Apex CPU time limit exceeded =&gt;</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.fillAccountList: line 52, column 1"><span class="lineCounter-0-0-15">16</span>-Class.LoopTests.fillAccountList: line 52, column 1</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.it_should_test_fake_while_loop_insert: line 6, column 1, time: 16.082s"><span class="lineCounter-0-0-15">17</span>-Class.LoopTests.it_should_test_fake_while_loop_insert: line 6, column 1, time: 16.082s</div><br><div class="line-0-0-16 " data-content="-[err] [fail] LoopTests: it_should_test_iterator_for_loop_insert =>"><span class="lineCounter-0-0-15">18</span>-[err] [fail] LoopTests: it_should_test_iterator_for_loop_insert =&gt;</div><br><div class="line-0-0-16 " data-content="-System.LimitException: Apex CPU time limit exceeded =>"><span class="lineCounter-0-0-15">19</span>-System.LimitException: Apex CPU time limit exceeded =&gt;</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.fillAccountList: line 53, column 1"><span class="lineCounter-0-0-15 prim">20</span>-Class.LoopTests.fillAccountList: line 53, column 1</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.it_should_test_iterator_for_loop_insert: line 41, column 1, time: 15.924s"><span class="lineCounter-0-0-15">21</span>-Class.LoopTests.it_should_test_iterator_for_loop_insert: line 41, column 1, time: 15.924s</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Number of tests run: 4 <==="><span class="lineCounter-0-0-15">22</span>[dmc] ===&gt; Number of tests run: 4 &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Total test time: 63.78800s <==="><span class="lineCounter-0-0-15">23</span>[dmc] ===&gt; Total test time: 63.78800s &lt;===</div><br><div class="line-0-0-16 " data-content="[err] Failed -> 4 test failures"><span class="lineCounter-0-0-15">24</span>[err] Failed -&gt; 4 test failures</div><br><div class="line-0-0-16 " data-content="[dmc] [NOT OK]"><span class="lineCounter-0-0-15 prim">25</span>[dmc] [NOT OK]</div><br></code></pre><p>Hmm OK. Large number was a little too ... large. Let's try with 100k instead.</p><pre class=""><code class="diff code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="$ yarn test LoopTest*"><span class="lineCounter-0-0-15 prim">1</span>$ yarn test LoopTest*</div><br><div class="line-0-0-16 " data-content="yarn run v1.22.0"><span class="lineCounter-0-0-15">2</span>yarn run v1.22.0</div><br><div class="line-0-0-16 " data-content="$ dmc test LoopTest*"><span class="lineCounter-0-0-15">3</span>$ dmc test LoopTest*</div><br><div class="line-0-0-16 " data-content="[dmc] using org: apex-mocks (default)"><span class="lineCounter-0-0-15">4</span>[dmc] using org: apex-mocks (default)</div><br><div class="line-0-0-16 " data-content="[dmc] * src/classes/LoopTests.cls"><span class="lineCounter-0-0-15 prim">5</span>[dmc] * src/classes/LoopTests.cls</div><br><div class="line-0-0-16 " data-content="[dmc] ===> LoopTests test results <==="><span class="lineCounter-0-0-15">6</span>[dmc] ===&gt; LoopTests test results &lt;===</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_basic_for_loop_insert, time: 16.105s"><span class="lineCounter-0-0-15">7</span><span class="token inserted-sign inserted">+[dmc] [pass] LoopTests: it_should_test_fake_basic_for_loop_insert, time: 16.105s</span></div><br><div class="line-0-0-16 " data-content="-[err] [fail] LoopTests: it_should_test_fake_syntax_sugar_for_loop_insert"><span class="lineCounter-0-0-15">8</span><span class="token deleted-sign deleted">-[err] [fail] LoopTests: it_should_test_fake_syntax_sugar_for_loop_insert</span></div><br><div class="line-0-0-16 " data-content="-=> System.LimitException: Apex CPU time limit exceeded =>"><span class="lineCounter-0-0-15">9</span>-=&gt; System.LimitException: Apex CPU time limit exceeded =&gt;</div><br><div class="line-0-0-16 " data-content="-Class.TestingUtils.generateIds: line 17, column 1"><span class="lineCounter-0-0-15 prim">10</span>-Class.TestingUtils.generateIds: line 17, column 1</div><br><div class="line-0-0-16 " data-content="-Class.CrudMock.doInsert: line 21, column 1"><span class="lineCounter-0-0-15">11</span>-Class.CrudMock.doInsert: line 21, column 1</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.it_should_test_fake_syntax_sugar_for_loop_insert: line 34, column 1, time: 15.869s"><span class="lineCounter-0-0-15">12</span>-Class.LoopTests.it_should_test_fake_syntax_sugar_for_loop_insert: line 34, column 1, time: 15.869s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_while_loop_insert, time: 13.554s"><span class="lineCounter-0-0-15">13</span><span class="token inserted-sign inserted">+[dmc] [pass] LoopTests: it_should_test_fake_while_loop_insert, time: 13.554s</span></div><br><div class="line-0-0-16 " data-content="-[err] [fail] LoopTests: it_should_test_iterator_for_loop_insert =>"><span class="lineCounter-0-0-15">14</span><span class="token deleted-sign deleted">-[err] [fail] LoopTests: it_should_test_iterator_for_loop_insert =&gt;</span></div><br><div class="line-0-0-16 " data-content="-System.LimitException: Apex CPU time limit exceeded =>"><span class="lineCounter-0-0-15 prim">15</span>-System.LimitException: Apex CPU time limit exceeded =&gt;</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.setNameToRandomValue: line 61, column 1"><span class="lineCounter-0-0-15">16</span>-Class.LoopTests.setNameToRandomValue: line 61, column 1</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.it_should_test_iterator_for_loop_insert: line 44, column 1, time: 15.323s"><span class="lineCounter-0-0-15">17</span>-Class.LoopTests.it_should_test_iterator_for_loop_insert: line 44, column 1, time: 15.323s</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Number of tests run: 4 <==="><span class="lineCounter-0-0-15">18</span>[dmc] ===&gt; Number of tests run: 4 &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Total test time: 60.85100s <==="><span class="lineCounter-0-0-15">19</span>[dmc] ===&gt; Total test time: 60.85100s &lt;===</div><br><div class="line-0-0-16 " data-content="[err] Failed -> 2 test failures"><span class="lineCounter-0-0-15 prim">20</span>[err] Failed -&gt; 2 test failures</div><br><div class="line-0-0-16 " data-content="[dmc] [NOT OK]"><span class="lineCounter-0-0-15 prim">21</span>[dmc] [NOT OK]</div><br></code></pre><p>OK so we're getting somewhere. As expected, the while loop and vanilla for loop outperform their fancier counterparts. It's a little bit disappointing that the syntax sugar for loop and the iterator don't compile down to the same instructions, but let's change LARGE_NUMBER to 10k and get a look at the results (you'll notice this is also where I added in the baseline for the first time ...):</p><pre class=""><code class="diff code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="$ yarn test LoopTests*"><span class="lineCounter-0-0-15 prim">1</span>$ yarn test LoopTests*</div><br><div class="line-0-0-16 " data-content="yarn run v1.22.0"><span class="lineCounter-0-0-15">2</span>yarn run v1.22.0</div><br><div class="line-0-0-16 " data-content="$ dmc test LoopTests*"><span class="lineCounter-0-0-15">3</span>$ dmc test LoopTests*</div><br><div class="line-0-0-16 " data-content="[dmc] using org: apex-mocks (default)"><span class="lineCounter-0-0-15">4</span>[dmc] using org: apex-mocks (default)</div><br><div class="line-0-0-16 " data-content="[dmc] * src/classes/LoopTests.cls"><span class="lineCounter-0-0-15 prim">5</span>[dmc] * src/classes/LoopTests.cls</div><br><div class="line-0-0-16 " data-content="[dmc] ===> LoopTests test results <==="><span class="lineCounter-0-0-15">6</span>[dmc] ===&gt; LoopTests test results &lt;===</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_establish_baseline_using_while_loop, time: 0.304s"><span class="lineCounter-0-0-15">7</span><span class="token inserted-sign inserted">+[dmc] [pass] LoopTests: it_should_establish_baseline_using_while_loop, time: 0.304s</span></div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_basic_for_loop_insert, time: 1.366s"><span class="lineCounter-0-0-15">8</span>+[dmc] [pass] LoopTests: it_should_test_fake_basic_for_loop_insert, time: 1.366s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_syntax_sugar_for_loop_insert, time: 2.354s"><span class="lineCounter-0-0-15">9</span>+[dmc] [pass] LoopTests: it_should_test_fake_syntax_sugar_for_loop_insert, time: 2.354s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_while_loop_insert, time: 1.592s"><span class="lineCounter-0-0-15 prim">10</span>+[dmc] [pass] LoopTests: it_should_test_fake_while_loop_insert, time: 1.592s</div><br><div class="line-0-0-16 " data-content="-[err] [fail] LoopTests: it_should_test_iterator_for_loop_insert =>"><span class="lineCounter-0-0-15">11</span><span class="token deleted-sign deleted">-[err] [fail] LoopTests: it_should_test_iterator_for_loop_insert =&gt;</span></div><br><div class="line-0-0-16 " data-content="-System.LimitException: Apex CPU time limit exceeded =>"><span class="lineCounter-0-0-15">12</span>-System.LimitException: Apex CPU time limit exceeded =&gt;</div><br><div class="line-0-0-16 " data-content="-Class.-LoopTests.setNameToRandomValue: line 66, column 1"><span class="lineCounter-0-0-15">13</span>-Class.-LoopTests.setNameToRandomValue: line 66, column 1</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.it_should_test_iterator_for_loop_insert: line 49, column 1, time: 16.473s"><span class="lineCounter-0-0-15">14</span>-Class.LoopTests.it_should_test_iterator_for_loop_insert: line 49, column 1, time: 16.473s</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Number of tests run: 5 <==="><span class="lineCounter-0-0-15 prim">15</span>[dmc] ===&gt; Number of tests run: 5 &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Total test time: 22.08900s <==="><span class="lineCounter-0-0-15">16</span>[dmc] ===&gt; Total test time: 22.08900s &lt;===</div><br><div class="line-0-0-16 " data-content="[err] Failed -> 1 test failures"><span class="lineCounter-0-0-15">17</span>[err] Failed -&gt; 1 test failures</div><br><div class="line-0-0-16 " data-content="[dmc] [NOT OK]"><span class="lineCounter-0-0-15 prim">18</span>[dmc] [NOT OK]</div><br></code></pre><p>Overall, this is some highly fascinating stuff. You can see that apples-to-apples, the basic while loop completely dominates, operating more than a second faster than the baseline for loop. As expected, the syntax sugar for loop lags a little bit behind. The real surprise, for me, though, was how terrible the performance of the built in List iterator is. Supposing that it is implemented behind the scenes as a simple while loop -- certainly, that's the implementation that I would expect in this case -- it seems downright bizarre for it to perform so poorly. I should also note that I run the tests several times before reporting the results, to ensure that any variations shake themselves out during burn-in.</p><p>I do believe there is a case to be made for custom iterators (and, since writing this article, I've also published an article examining the usage of custom iterators to power <a href="/joys-of-apex/lazy-iterators">Lazy Evaluated Loops</a> ... so let's test that vanilla implementation I was just discussing:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/ListIterator.cls</span></span><div class="line-0-0-16 " data-content="public class ListIterator implements System.Iterator<SObject> {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ListIterator</span> <span class="token keyword">implements</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final List<SObject> records;"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private Integer index;"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> index<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">4</span></div><br><div class="line-0-0-16 " data-content="    public ListIterator(List<SObject> records) {"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token keyword">public</span> <span class="token class-name">ListIterator</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.records = records;"><span class="lineCounter-0-0-15">6</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>records <span class="token operator">=</span> records<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.index = 0;"><span class="lineCounter-0-0-15">7</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">8</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">9</span></div><br><div class="line-0-0-16 " data-content="    public boolean hasNext() {"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return this.index < this.records.size() - 1;"><span class="lineCounter-0-0-15">11</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>records<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">12</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">13</span></div><br><div class="line-0-0-16 " data-content="    public SObject next() {"><span class="lineCounter-0-0-15">14</span>    <span class="token keyword">public</span> <span class="token class-name">SObject</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        if(index == records.size() -1) {"><span class="lineCounter-0-0-15 prim">15</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">==</span> records<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            return null;"><span class="lineCounter-0-0-15">16</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">17</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        index++;"><span class="lineCounter-0-0-15">18</span>        index<span class="token operator">++</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return records[index];"><span class="lineCounter-0-0-15">19</span>        <span class="token keyword">return</span> records<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">20</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">21</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">22</span></div><br><div class="line-0-0-16 " data-content="//in LoopTests.cls"><span class="lineCounter-0-0-15">23</span><span class="token comment">//in LoopTests.cls</span></div><br><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15">24</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="static void it_should_test_custom_iterator_while_loop() {"><span class="lineCounter-0-0-15 prim">25</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_test_custom_iterator_while_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    List<SObject> accountsToInsert = fillAccountList();"><span class="lineCounter-0-0-15">26</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token function">fillAccountList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    Iterator<SObject> listIterator = new ListIterator(accountsToInsert);"><span class="lineCounter-0-0-15">27</span>    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> listIterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListIterator</span><span class="token punctuation">(</span>accountsToInsert<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">28</span></div><br><div class="line-0-0-16 " data-content="    while(listIterator.hasNext()) {"><span class="lineCounter-0-0-15">29</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>listIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        setNameToRandomValue(listIterator.next());"><span class="lineCounter-0-0-15 prim">30</span>        <span class="token function">setNameToRandomValue</span><span class="token punctuation">(</span>listIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">31</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">32</span><span class="token punctuation">}</span></div><br></code></pre><p>And the results (let me just take a deep breath and let out the frustration following the use of the "Iterator" syntax. It's like Salesforce <em>wants</em> to throw it back in our faces by saying: "look! Generics! Just not for you!!"):</p><pre class=""><code class="diff code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="$ yarn test LoopTests*"><span class="lineCounter-0-0-15 prim">1</span>$ yarn test LoopTests*</div><br><div class="line-0-0-16 " data-content="yarn run v1.22.0"><span class="lineCounter-0-0-15">2</span>yarn run v1.22.0</div><br><div class="line-0-0-16 " data-content="$ dmc test LoopTests*"><span class="lineCounter-0-0-15">3</span>$ dmc test LoopTests*</div><br><div class="line-0-0-16 " data-content="[dmc] using org: apex-mocks (default)"><span class="lineCounter-0-0-15">4</span>[dmc] using org: apex-mocks (default)</div><br><div class="line-0-0-16 " data-content="[dmc] * src/classes/LoopTests.cls"><span class="lineCounter-0-0-15 prim">5</span>[dmc] * src/classes/LoopTests.cls</div><br><div class="line-0-0-16 " data-content="[dmc] ===> LoopTests test results <==="><span class="lineCounter-0-0-15">6</span>[dmc] ===&gt; LoopTests test results &lt;===</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_establish_baseline_using_while_loop, time: 0.391s"><span class="lineCounter-0-0-15">7</span><span class="token inserted-sign inserted">+[dmc] [pass] LoopTests: it_should_establish_baseline_using_while_loop, time: 0.391s</span></div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_custom_iterator_while_loop, time: 1.32s"><span class="lineCounter-0-0-15">8</span>+[dmc] [pass] LoopTests: it_should_test_custom_iterator_while_loop, time: 1.32s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_basic_for_loop_insert, time: 2.189s"><span class="lineCounter-0-0-15">9</span>+[dmc] [pass] LoopTests: it_should_test_fake_basic_for_loop_insert, time: 2.189s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_syntax_sugar_for_loop_insert, time: 2.404s"><span class="lineCounter-0-0-15 prim">10</span>+[dmc] [pass] LoopTests: it_should_test_fake_syntax_sugar_for_loop_insert, time: 2.404s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_while_loop_insert, time: 1.65s"><span class="lineCounter-0-0-15">11</span>+[dmc] [pass] LoopTests: it_should_test_fake_while_loop_insert, time: 1.65s</div><br><div class="line-0-0-16 " data-content="-[err] [fail] LoopTests: it_should_test_iterator_while_loop_insert =>"><span class="lineCounter-0-0-15">12</span><span class="token deleted-sign deleted">-[err] [fail] LoopTests: it_should_test_iterator_while_loop_insert =&gt;</span></div><br><div class="line-0-0-16 " data-content="-System.LimitException: Apex CPU time limit exceeded =>"><span class="lineCounter-0-0-15">13</span>-System.LimitException: Apex CPU time limit exceeded =&gt;</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.setNameToRandomValue: line 76, column 1"><span class="lineCounter-0-0-15">14</span>-Class.LoopTests.setNameToRandomValue: line 76, column 1</div><br><div class="line-0-0-16 " data-content="-Class.LoopTests.it_should_test_iterator_while_loop_insert: line 49, column 1, time: 16.205s"><span class="lineCounter-0-0-15 prim">15</span>-Class.LoopTests.it_should_test_iterator_while_loop_insert: line 49, column 1, time: 16.205s</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Number of tests run: 6 <==="><span class="lineCounter-0-0-15">16</span>[dmc] ===&gt; Number of tests run: 6 &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Total test time: 24.15900s <==="><span class="lineCounter-0-0-15">17</span>[dmc] ===&gt; Total test time: 24.15900s &lt;===</div><br><div class="line-0-0-16 " data-content="[err] Failed -> 1 test failures"><span class="lineCounter-0-0-15">18</span>[err] Failed -&gt; 1 test failures</div><br><div class="line-0-0-16 " data-content="[dmc] [NOT OK]"><span class="lineCounter-0-0-15 prim">19</span>[dmc] [NOT OK]</div><br></code></pre><p>That's much more in line with what I would expect. Which leads me to suspect that caching the iterator will help the basic implementation as well:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/LoopTests.cls</span></span><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="static void it_should_test_iterator_while_loop_insert() {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_test_iterator_while_loop_insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    List<SObject> accountsToInsert = fillAccountList();"><span class="lineCounter-0-0-15">3</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token function">fillAccountList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    Iterator<SObject> accountIterator = accountsToInsert.iterator();"><span class="lineCounter-0-0-15">4</span>    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountIterator <span class="token operator">=</span> accountsToInsert<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">5</span></div><br><div class="line-0-0-16 " data-content="    while(accountIterator.hasNext()) {"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>accountIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        setNameToRandomValue(accountIterator.next());"><span class="lineCounter-0-0-15">7</span>        <span class="token function">setNameToRandomValue</span><span class="token punctuation">(</span>accountIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">8</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">9</span><span class="token punctuation">}</span></div><br></code></pre><pre class=""><code class="diff code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="$ yarn test LoopTests*"><span class="lineCounter-0-0-15 prim">1</span>$ yarn test LoopTests*</div><br><div class="line-0-0-16 " data-content="yarn run v1.22.0"><span class="lineCounter-0-0-15">2</span>yarn run v1.22.0</div><br><div class="line-0-0-16 " data-content="$ dmc test LoopTests*"><span class="lineCounter-0-0-15">3</span>$ dmc test LoopTests*</div><br><div class="line-0-0-16 " data-content="[dmc] using org: apex-mocks (default)"><span class="lineCounter-0-0-15">4</span>[dmc] using org: apex-mocks (default)</div><br><div class="line-0-0-16 " data-content="[dmc] * src/classes/LoopTests.cls"><span class="lineCounter-0-0-15 prim">5</span>[dmc] * src/classes/LoopTests.cls</div><br><div class="line-0-0-16 " data-content="[dmc] ===> LoopTests test results <==="><span class="lineCounter-0-0-15">6</span>[dmc] ===&gt; LoopTests test results &lt;===</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_establish_baseline_using_while_loop, time: 0.388s"><span class="lineCounter-0-0-15">7</span><span class="token inserted-sign inserted">+[dmc] [pass] LoopTests: it_should_establish_baseline_using_while_loop, time: 0.388s</span></div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_custom_iterator_while_loop, time: 1.303s"><span class="lineCounter-0-0-15">8</span>+[dmc] [pass] LoopTests: it_should_test_custom_iterator_while_loop, time: 1.303s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_basic_for_loop_insert, time: 1.773s"><span class="lineCounter-0-0-15">9</span>+[dmc] [pass] LoopTests: it_should_test_fake_basic_for_loop_insert, time: 1.773s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_syntax_sugar_for_loop_insert, time: 2.404s"><span class="lineCounter-0-0-15 prim">10</span>+[dmc] [pass] LoopTests: it_should_test_fake_syntax_sugar_for_loop_insert, time: 2.404s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_while_loop_insert, time: 1.633s"><span class="lineCounter-0-0-15">11</span>+[dmc] [pass] LoopTests: it_should_test_fake_while_loop_insert, time: 1.633s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_iterator_while_loop_insert, time: 0.791s"><span class="lineCounter-0-0-15">12</span>+[dmc] [pass] LoopTests: it_should_test_iterator_while_loop_insert, time: 0.791s</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Number of tests run: 6 <==="><span class="lineCounter-0-0-15">13</span>[dmc] ===&gt; Number of tests run: 6 &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Total test time: 8.29200s <==="><span class="lineCounter-0-0-15">14</span>[dmc] ===&gt; Total test time: 8.29200s &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] [OK]"><span class="lineCounter-0-0-15 prim">15</span>[dmc] [OK]</div><br></code></pre><p>Mystery solved! Considering that iterators are just decorating the basic while loop, it makes sense that they would closely follow it in terms of performance.</p><p>For mission-critical code that demands low latency, you should definitely consider using a while loop, or at the very least the built in iterator on the Salesforce List class.</p><h2 id="exceptions-in-apex" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Exceptions in Apex</h2><p>Let's talk about exceptions. When it comes to performance, building exceptions is an allegedly costly operation. Maybe this is coming as news to you (again, I would recommend a simple google search "java cost of throwing exceptions), but it kind of makes sense, thinking about all the extra stuff that needs to happen when an exception is thrown:</p><ul><li>first the nearest catch block has to be found</li><li>if there's a catch block, the exception has to be tested against the catch block's constructor</li><li>if the test passes, the exception is initialized and the catch block is entered</li><li>if the test fails, the next catch block is searched for and the process is repeated</li><li>unless there isn't another catch block, at which point the code terminates due to the uncaught exception</li><li>PS, now you have to pay the time cost for the database rollback to occur. I hope the exception wasn't thrown 5 triggers deep!</li></ul><p>Of course, particularly for dealing with HTTP related code, there's the temptation to write something clean ... something beautiful:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/HttpService.cls</span></span><div class="line-0-0-16 " data-content="@RestResource(urlMapping='/api/*')"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@RestResource</span><span class="token punctuation">(</span>urlMapping<span class="token operator">=</span><span class="token string">'/api/*'</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="global class HttpService {"><span class="lineCounter-0-0-15">2</span>global <span class="token keyword">class</span> <span class="token class-name">HttpService</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    global class SalesforceResponse {"><span class="lineCounter-0-0-15">3</span>    global <span class="token keyword">class</span> <span class="token class-name">SalesforceResponse</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        global SalesforceResponse() {"><span class="lineCounter-0-0-15">4</span>        global <span class="token class-name">SalesforceResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            this.Success = true;"><span class="lineCounter-0-0-15 prim">5</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Success</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            this.IdsUpdated = new List<Id>();"><span class="lineCounter-0-0-15">6</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">IdsUpdated</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">7</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">8</span></div><br><div class="line-0-0-16 " data-content="        public Boolean Success { get; set; }"><span class="lineCounter-0-0-15">9</span>        <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token class-name">Success</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        public List<Id> IdsUpdated { get; set;}"><span class="lineCounter-0-0-15 prim">10</span>        <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">IdsUpdated</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">11</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">12</span></div><br><div class="line-0-0-16 " data-content="    global class SalesforceRequest {"><span class="lineCounter-0-0-15">13</span>    global <span class="token keyword">class</span> <span class="token class-name">SalesforceRequest</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<Id> IdsToDoThingsWith { get; set; }"><span class="lineCounter-0-0-15">14</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Id</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">IdsToDoThingsWith</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">15</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">16</span></div><br><div class="line-0-0-16 " data-content="    @HttpPost"><span class="lineCounter-0-0-15">17</span>    <span class="token annotation punctuation">@HttpPost</span></div><br><div class="line-0-0-16 " data-content="    global static SalesforceResponse post(SalesforceRequest req) {"><span class="lineCounter-0-0-15">18</span>    global <span class="token keyword">static</span> <span class="token class-name">SalesforceResponse</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token class-name">SalesforceRequest</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        SalesforceResponse res = new SalesforceResponse();"><span class="lineCounter-0-0-15">19</span>        <span class="token class-name">SalesforceResponse</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SalesforceResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        try {"><span class="lineCounter-0-0-15 prim">20</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            //do something that will potentially fail here"><span class="lineCounter-0-0-15">21</span>            <span class="token comment">//do something that will potentially fail here</span></div><br><div class="line-0-0-16 " data-content="            //with the Ids passed in"><span class="lineCounter-0-0-15">22</span>            <span class="token operator">/</span><span class="token operator">/</span><span class="token keyword">with</span> the <span class="token class-name">Ids</span> passed in</div><br><div class="line-0-0-16 " data-content="            if(someConditional != true) {"><span class="lineCounter-0-0-15">23</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>someConditional <span class="token operator">!=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                throw new CalloutException('Meaningful fail message!');"><span class="lineCounter-0-0-15">24</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CalloutException</span><span class="token punctuation">(</span><span class="token string">'Meaningful fail message!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15 prim">25</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        } catch(Exception ex) {"><span class="lineCounter-0-0-15">26</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            res.Success = false;"><span class="lineCounter-0-0-15">27</span>            res<span class="token punctuation">.</span><span class="token class-name">Success</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">28</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        return res;"><span class="lineCounter-0-0-15">29</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">31</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">32</span><span class="token punctuation">}</span></div><br></code></pre><p>Mmm. So clean. Single-return methods are so tasty. But are we leading ourselves astray with this pattern? Will it cost us valuable seconds to collect that Exception if our large data operation fails? As you know, there's only one way to find out ...</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="@isTest | classes/ExceptTesting.cls"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@isTest</span> <span class="token operator">|</span> classes<span class="token operator">/</span><span class="token class-name">ExceptTesting</span><span class="token punctuation">.</span>cls</div><br><div class="line-0-0-16 " data-content="private class ExceptTesting {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ExceptTesting</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    //salesforce has bizarre rules in place about"><span class="lineCounter-0-0-15">3</span>    <span class="token comment">//salesforce has bizarre rules in place about</span></div><br><div class="line-0-0-16 " data-content="    //naming classes with the word Exception in them"><span class="lineCounter-0-0-15">4</span>    <span class="token comment">//naming classes with the word Exception in them</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_provide_baseline_testing_time() {}"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_provide_baseline_testing_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">8</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_throw_exception() {"><span class="lineCounter-0-0-15">9</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_throw_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        throw new TestException();"><span class="lineCounter-0-0-15 prim">10</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TestException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">11</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">12</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">13</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_catch_thrown_exception() {"><span class="lineCounter-0-0-15">14</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_catch_thrown_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Exception ex;"><span class="lineCounter-0-0-15 prim">15</span>        <span class="token class-name">Exception</span> ex<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">16</span></div><br><div class="line-0-0-16 " data-content="        try {"><span class="lineCounter-0-0-15">17</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            throw new TestException('Some message here');"><span class="lineCounter-0-0-15">18</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TestException</span><span class="token punctuation">(</span><span class="token string">'Some message here'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        } catch(Exception exc) {"><span class="lineCounter-0-0-15">19</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exc<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            ex = exc;"><span class="lineCounter-0-0-15 prim">20</span>            ex <span class="token operator">=</span> exc<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">21</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">22</span></div><br><div class="line-0-0-16 " data-content="        System.assertNotEquals(null, ex);"><span class="lineCounter-0-0-15">23</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertNotEquals</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">24</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">25</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">26</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_build_big_nested_stacktrace() {"><span class="lineCounter-0-0-15">27</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_build_big_nested_stacktrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        String exceptionMessage = 'hi'.repeat(100000);"><span class="lineCounter-0-0-15">28</span>        <span class="token class-name">String</span> exceptionMessage <span class="token operator">=</span> <span class="token string">'hi'</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Exception caughtEx;"><span class="lineCounter-0-0-15">29</span>        <span class="token class-name">Exception</span> caughtEx<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        try {"><span class="lineCounter-0-0-15 prim">30</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            try {"><span class="lineCounter-0-0-15">31</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                throw new TestException('First exception');"><span class="lineCounter-0-0-15">32</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TestException</span><span class="token punctuation">(</span><span class="token string">'First exception'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            } catch(Exception ex) {"><span class="lineCounter-0-0-15">33</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                throw new TestException(ex.getMessage() + '\n' + exceptionMessage);"><span class="lineCounter-0-0-15">34</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TestException</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> exceptionMessage<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15 prim">35</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        } catch(Exception ex) {"><span class="lineCounter-0-0-15">36</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            caughtEx = ex;"><span class="lineCounter-0-0-15">37</span>            caughtEx <span class="token operator">=</span> ex<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">38</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">39</span></div><br><div class="line-0-0-16 " data-content="        System.assertNotEquals(null, caughtEx);"><span class="lineCounter-0-0-15 prim">40</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertNotEquals</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> caughtEx<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">41</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">42</span></div><br><div class="line-0-0-16 " data-content="    private class TestException extends Exception {}"><span class="lineCounter-0-0-15">43</span>    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">TestException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">44</span><span class="token punctuation">}</span></div><br></code></pre><p>For one thing, I was interested in seeing if the uncaught exception would be faster in running than the caught one; for another, I wanted to see just how big a difference would be generated between the baseline for simply starting and running a test (which consistently hovers around 5-hundredths of a second):</p><pre class=""><code class="diff code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="$ yarn test ExceptTesting*"><span class="lineCounter-0-0-15 prim">1</span>$ yarn test ExceptTesting*</div><br><div class="line-0-0-16 " data-content="yarn run v1.22.0"><span class="lineCounter-0-0-15">2</span>yarn run v1.22.0</div><br><div class="line-0-0-16 " data-content="$ dmc test ExceptTesting*"><span class="lineCounter-0-0-15">3</span>$ dmc test ExceptTesting*</div><br><div class="line-0-0-16 " data-content="[dmc] using org: apex-mocks (default)"><span class="lineCounter-0-0-15">4</span>[dmc] using org: apex-mocks (default)</div><br><div class="line-0-0-16 " data-content="[dmc] * src/classes/ExceptTesting.cls"><span class="lineCounter-0-0-15 prim">5</span>[dmc] * src/classes/ExceptTesting.cls</div><br><div class="line-0-0-16 " data-content="[dmc] ===> ExceptTesting test results <==="><span class="lineCounter-0-0-15">6</span>[dmc] ===&gt; ExceptTesting test results &lt;===</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] ExceptTesting: it_should_build_big_nested_stacktrace, time: 0.031s"><span class="lineCounter-0-0-15">7</span><span class="token inserted-sign inserted">+[dmc] [pass] ExceptTesting: it_should_build_big_nested_stacktrace, time: 0.031s</span></div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] ExceptTesting: it_should_catch_thrown_exception, time: 0.005s"><span class="lineCounter-0-0-15">8</span>+[dmc] [pass] ExceptTesting: it_should_catch_thrown_exception, time: 0.005s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] ExceptTesting: it_should_provide_baseline_testing_time, time: 0.006s"><span class="lineCounter-0-0-15">9</span>+[dmc] [pass] ExceptTesting: it_should_provide_baseline_testing_time, time: 0.006s</div><br><div class="line-0-0-16 " data-content="-[err] [fail] ExceptTesting: it_should_throw_exception =>"><span class="lineCounter-0-0-15 prim">10</span><span class="token deleted-sign deleted">-[err] [fail] ExceptTesting: it_should_throw_exception =&gt;</span></div><br><div class="line-0-0-16 " data-content="-ExceptTesting.TestException: Script-thrown exception =>"><span class="lineCounter-0-0-15">11</span>-ExceptTesting.TestException: Script-thrown exception =&gt;</div><br><div class="line-0-0-16 " data-content="-Class.ExceptTesting.it_should_throw_exception: line 10, column 1, time: 0.005s"><span class="lineCounter-0-0-15">12</span>-Class.ExceptTesting.it_should_throw_exception: line 10, column 1, time: 0.005s</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Number of tests run: 4 <==="><span class="lineCounter-0-0-15">13</span>[dmc] ===&gt; Number of tests run: 4 &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Total test time: 0.04700s <==="><span class="lineCounter-0-0-15">14</span>[dmc] ===&gt; Total test time: 0.04700s &lt;===</div><br><div class="line-0-0-16 " data-content="[err] Failed -> 1 test failures"><span class="lineCounter-0-0-15 prim">15</span>[err] Failed -&gt; 1 test failures</div><br><div class="line-0-0-16 " data-content="[dmc] [NOT OK]"><span class="lineCounter-0-0-15 prim">16</span>[dmc] [NOT OK]</div><br></code></pre><p>Admittedly, perhaps my methodology is simply busted, but even though the "cost" of building an extremely convoluted exception out of several other exceptions is 6 times slower than simply not catching, the <em>real</em> cost of building safe structures and code paths in your application may win out. It all depends on how much latency matters to you. In FinTech, hundredths of a second matter; they're the difference between making money and losing it.</p><p>Being aware of the potential time tax you might be paying due to your application's code helps you avoid paying the tax when performance matters.</p><h2 id="back-to-refactoring" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Back To Refactoring</h2><p>Let's go back to our original mocking DML example:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/LoopTests.cls</span></span><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class LoopTests {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">LoopTests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">3</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_establish_baseline_using_while_loop() {"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_establish_baseline_using_while_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> accountsToInsert = fillAccountList();"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token function">fillAccountList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">6</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">8</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_test_fake_while_loop_insert() {"><span class="lineCounter-0-0-15">9</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_test_fake_while_loop_insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> accountsToInsert = fillAccountList();"><span class="lineCounter-0-0-15 prim">10</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token function">fillAccountList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">11</span></div><br><div class="line-0-0-16 " data-content="        CrudMock.getMock().doInsert(accountsToInsert);"><span class="lineCounter-0-0-15">12</span>        <span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token function">getMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doInsert</span><span class="token punctuation">(</span>accountsToInsert<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">13</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(LARGE_NUMBER, CrudMock.Inserted.size());"><span class="lineCounter-0-0-15">14</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>LARGE_NUMBER<span class="token punctuation">,</span> <span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token class-name">Inserted</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">15</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">16</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">17</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_test_actual_while_loop_insert() {"><span class="lineCounter-0-0-15">18</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_test_actual_while_loop_insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> accountsToInsert = fillAccountList();"><span class="lineCounter-0-0-15">19</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token function">fillAccountList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">20</span></div><br><div class="line-0-0-16 " data-content="        //I would typically use the singleton Crud.doInsert method here"><span class="lineCounter-0-0-15">21</span>        <span class="token comment">//I would typically use the singleton Crud.doInsert method here</span></div><br><div class="line-0-0-16 " data-content="        //but ultimately they're the same operation"><span class="lineCounter-0-0-15">22</span>        <span class="token comment">//but ultimately they're the same operation</span></div><br><div class="line-0-0-16 " data-content="        insert accountsToInsert;"><span class="lineCounter-0-0-15">23</span>        insert accountsToInsert<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">24</span></div><br><div class="line-0-0-16 " data-content="        List<Account> insertedAccs = [SELECT Id FROM Account];"><span class="lineCounter-0-0-15 prim">25</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> insertedAccs <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span> FROM <span class="token class-name">Account</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(LARGE_NUMBER, insertedAccs.size());"><span class="lineCounter-0-0-15">26</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>LARGE_NUMBER<span class="token punctuation">,</span> insertedAccs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">27</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">28</span></div><br><div class="line-0-0-16 " data-content="    private static Integer LARGE_NUMBER = 10000;"><span class="lineCounter-0-0-15">29</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> LARGE_NUMBER <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private static List<SObject> fillAccountList() {"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">fillAccountList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Integer counter = 0;"><span class="lineCounter-0-0-15">31</span>        <span class="token class-name">Integer</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        List<SObject> accountsToInsert = new List<SObject>();"><span class="lineCounter-0-0-15">32</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span> accountsToInsert <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        while(counter < LARGE_NUMBER) {"><span class="lineCounter-0-0-15">33</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>counter <span class="token operator">&lt;</span> LARGE_NUMBER<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            Account acc = new Account(Name = 'Test' + counter);"><span class="lineCounter-0-0-15">34</span>            <span class="token class-name">Account</span> acc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Name</span> <span class="token operator">=</span> <span class="token string">'Test'</span> <span class="token operator">+</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            accountsToInsert.add(acc);"><span class="lineCounter-0-0-15 prim">35</span>            accountsToInsert<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            counter++;"><span class="lineCounter-0-0-15">36</span>            counter<span class="token operator">++</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">37</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        return accountsToInsert;"><span class="lineCounter-0-0-15">38</span>        <span class="token keyword">return</span> accountsToInsert<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">39</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">40</span></div><br><div class="line-0-0-16 " data-content="    private static void setNameToRandomValue(SObject record) {"><span class="lineCounter-0-0-15">41</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setNameToRandomValue</span><span class="token punctuation">(</span><span class="token class-name">SObject</span> <span class="token keyword">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        record.put('Name', 'Something ' + Math.random().format());"><span class="lineCounter-0-0-15">42</span>        <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'Name'</span><span class="token punctuation">,</span> <span class="token string">'Something '</span> <span class="token operator">+</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">43</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">44</span><span class="token punctuation">}</span></div><br></code></pre><p>With large number set to 10,000, let's see what happens when comparing the actual cost of inserting records compared to faking their insert through the CrudMock:</p><pre class=""><code class="diff code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="$ yarn test LoopTests*"><span class="lineCounter-0-0-15 prim">1</span>$ yarn test LoopTests*</div><br><div class="line-0-0-16 " data-content="yarn run v1.22.0"><span class="lineCounter-0-0-15">2</span>yarn run v1.22.0</div><br><div class="line-0-0-16 " data-content="$ dmc test LoopTests*"><span class="lineCounter-0-0-15">3</span>$ dmc test LoopTests*</div><br><div class="line-0-0-16 " data-content="[dmc] using org: apex-mocks (default)"><span class="lineCounter-0-0-15">4</span>[dmc] using org: apex-mocks (default)</div><br><div class="line-0-0-16 " data-content="[dmc] * src/classes/LoopTests.cls"><span class="lineCounter-0-0-15 prim">5</span>[dmc] * src/classes/LoopTests.cls</div><br><div class="line-0-0-16 " data-content="[dmc] ===> LoopTests test results <==="><span class="lineCounter-0-0-15">6</span>[dmc] ===&gt; LoopTests test results &lt;===</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_establish_baseline_using_while_loop, time: 0.4s"><span class="lineCounter-0-0-15">7</span><span class="token inserted-sign inserted">+[dmc] [pass] LoopTests: it_should_establish_baseline_using_while_loop, time: 0.4s</span></div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_actual_while_loop_insert, time: 54.043s"><span class="lineCounter-0-0-15">8</span>+[dmc] [pass] LoopTests: it_should_test_actual_while_loop_insert, time: 54.043s</div><br><div class="line-0-0-16 " data-content="+[dmc] [pass] LoopTests: it_should_test_fake_while_loop_insert, time: 1.541s"><span class="lineCounter-0-0-15">9</span>+[dmc] [pass] LoopTests: it_should_test_fake_while_loop_insert, time: 1.541s</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Number of tests run: 3 <==="><span class="lineCounter-0-0-15 prim">10</span>[dmc] ===&gt; Number of tests run: 3 &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] ===> Total test time: 55.98400s <==="><span class="lineCounter-0-0-15">11</span>[dmc] ===&gt; Total test time: 55.98400s &lt;===</div><br><div class="line-0-0-16 " data-content="[dmc] [OK]"><span class="lineCounter-0-0-15 prim">12</span>[dmc] [OK]</div><br></code></pre><p>............ welp. OK then. As you can see, there's a considerable amount of variation in what Salesforce allows when it comes to testing time. I ran this (and the other tests in LoopTests) several times to validate these results. Performing actual DML is absurdly expensive in terms of time.</p><p>What are some other operations that can lead to testing slowdown?</p><ul><li>Going from Contracts into new Opportunities with CPQ</li><li>converting Leads</li><li>merging of any kind (Lead to Lead, Lead to Contact/Account -- which is actually conversion, Contact to Contact, Account to Account)</li><li>calculating rollup fields on Master-Detail records (this one is also extremely prone to the dreaded <code>unable to lock row</code> error in tests, unless you are very careful to use randomized names between records)</li><li>upserting on external Ids (upserting in general, since it falls into the realm of DML)</li></ul><p>In <a href="https://smile.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882/">Clean Code</a>, there's an excellent chapter on boundaries in code; how to recognize them, how to plan around them. Knowing that these are the weak spots when it comes to writing performant code (not only in your unit tests, but in your application code) can help you to identify the spots that are the most important to isolate in your code.</p><p>As an example, if you have tests for performing merges, you might consider mocking your merging code in places where merging is a side-effect of the code you have under test. Likewise, you should definitely try to minimize where leads are being converted in your test code.</p><p>These tips should be part of your everyday testing toolbelt -- and should occupy the same space in your mind as the sacred rules like:</p><ul><li>always use randomized values when setting unique fields on test objects so that your tests can run safely in parallel</li><li>always use @testSetup methods when you need to insert objects that will be required by more than one of your test methods</li></ul><h2 id="conclusion" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Conclusion</h2><p>It's my hope that this article helps you to think about the importance of your own time, and the time of your team, when it comes to writing tests. One of the reasons that I'm a firm proponent of TDD (and paired programming!) is that it allows you (and your team, if you have one) to observe the positive effects of a test-first mentality: when you can run your tests often, and they run quickly, you feel empowered to move quickly in your codebase(s). You also get to see patterns develop organically over time; instead of trying to force yourself to be the perfect architect at all times, you can get straight into the weeds prior to taking out your refactoring tools.</p><p>This last point is particularly prescient for the perfectionists. I've seen many talented developers waylay themselves, lost in thought over the perfect class setup and the DRY-est methods. Simply getting down to business gets your creative juices flowing, allows you to recognize patterns as they occur, and clean the code up as you go. Over time, of course, you build the muscle-memory necessary to identify paradigms before code is written; once you've built one publicly facing API, for example, you know what goes into scaffolding the structure and can remember the gotchas when it comes time to build the next one.</p><p>If you're looking to dig into the code a little bit more than what was exhibited here, I would encourage you to check out the <a href="https://github.com/jamessimone/apex-mocks-stress-test/tree/performant-tests">performant-tests branch on my Apex Mocks repo</a>. Thanks for taking this testing ride with me -- till next time!</p><div class="contentnav-0-0-7" data-no-search=""><a href="#test-fast-test-often" class="h2" data-content-highlight="test-fast-test-often">Test Fast, Test Often</a><a href="#looping-in-apex" class="h2" data-content-highlight="looping-in-apex">Looping in Apex</a><a href="#exceptions-in-apex" class="h2" data-content-highlight="exceptions-in-apex">Exceptions in Apex</a><a href="#back-to-refactoring" class="h2" data-content-highlight="back-to-refactoring">Back To Refactoring</a><a href="#conclusion" class="h2" data-content-highlight="conclusion">Conclusion</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="SjLFycrDWc">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("SjLFycrDWc", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="hPnrwrzmuv">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("hPnrwrzmuv", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="RCdEFGITrl">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("RCdEFGITrl", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>