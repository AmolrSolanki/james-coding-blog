<!DOCTYPE html><html><head><title>Joys Of Apex | Dependency Injection &amp; The Factory Pattern</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Dependency Injection &amp; The Factory Pattern"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Dependency Injection &amp; The Factory Pattern"></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"dependency-injection-factory-pattern.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Dependency Injection &amp; The Factory Pattern</p></span></h1><script id="IBXYrvmTwv">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("IBXYrvmTwv", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><p>Welcome back to another episode in the continuing Joys Of Apex discussion. In my last post, I covered how to wrap your SFDC DML operations using <a href="/joys-of-apex/mocking-dml">Crud / CrudMock</a>. As we head into the New Year, let's talk about Dependency Injection (DI) - popularly used to simplify object creation, allow for polymorphic construction of objects, and easily stub out object dependencies while writing tests.</p><h3 id="intro-to-dependency-injection-in-apex" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Intro to Dependency Injection in Apex</h3><p>But let's take it slow. What does Dependency Injection look like? Let's take some simple Apex examples:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public class AccountWrapper {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountWrapper</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final Account account;"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Account</span> account<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="    public AccountWrapper() {"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">public</span> <span class="token class-name">AccountWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.account = [SELECT Id FROM Account LIMIT 1];"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>account <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span> FROM <span class="token class-name">Account</span> LIMIT <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">6</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">7</span><span class="token punctuation">}</span></div><br></code></pre><p>This is literally the simplest wrapper object possible. But if you ever want to change the reference to the <code>Account</code> being stored in the constructor, or mock it for testing the <code>AccountWrapper</code>'s functionality, you're going to need to go with another approach -- injecting the <code>Account</code> SObject via the constructor:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public class AccountWrapper {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountWrapper</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final Account account;"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Account</span> account<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="    public AccountWrapper(Account account) {"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">public</span> <span class="token class-name">AccountWrapper</span><span class="token punctuation">(</span><span class="token class-name">Account</span> account<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="       this.account = account;"><span class="lineCounter-0-0-15 prim">5</span>       <span class="token keyword">this</span><span class="token punctuation">.</span>account <span class="token operator">=</span> account<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">6</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">7</span><span class="token punctuation">}</span></div><br></code></pre><p>Now, it becomes the object responsible for initializing the <code>AccountWrapper</code> to pass in the correct Account reference; this also means that you can easily create a dummy account for your tests when you don't require a specific account to test your wrapper's functionality.</p><h3 id="the-problems-with-dependency-injection" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>The Problems with Dependency Injection</h3><p>Dependency injection thus becomes your one-stop shop, especially when making sensible unit tests, for passing in only the objects your class needs in order to test what you're testing. Dependencies that aren't used on the code path you're testing can be omitted, or mocked through a shared interface or extended mock object. But it wouldn't be Apex without a few roadblocks thrown your way care of Salesforce -- because Apex is compiled by pushing your local classes up to the cloud, you can run into issues where refactoring your existing objects can be made difficult when changing the signature of an object's constructor. Anybody who's ever waded through the dreaded <em>Dependent Class Is Out Of Alignment</em> error when deploying your Apex classes knows that if your objects are all being constructed via the <code>new</code> keyword in many different places, correctly refactoring your existing initialization statements to properly match your constructor signature can be ... difficult, or at the very least, time-consuming. Time is precious.</p><p>But how can we fix this problem? If we need to dynamically inject classes with other classes at runtime yet still have the flexibility to swap out those dependencies when testing, is there any way to do so?</p><p><strong>Important preamble</strong> -- I have found great success in using the method I am about to describe. If it doesn't float your Object-Oriented Boat, please accept my apologies.</p><h3 id="using-the-factory-pattern-in-apex" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Using the Factory Pattern In Apex</h3><p>The <a href="https://en.wikipedia.org/wiki/Factory_method_pattern">Factory Pattern</a> offers a centralized place where your objects are constructed. Typically, the Factory ends up looking something like this:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public abstract class Factory {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Factory</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public static AccountWrapper getAccountWrapper() {"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AccountWrapper</span> <span class="token function">getAccountWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return new AccountWrapper("><span class="lineCounter-0-0-15">3</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AccountWrapper</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="            //ruh roh, we still have this hard-coded dependency somewhere"><span class="lineCounter-0-0-15">4</span>            <span class="token comment">//ruh roh, we still have this hard-coded dependency somewhere</span></div><br><div class="line-0-0-16 " data-content="            //more on that later"><span class="lineCounter-0-0-15 prim">5</span>            <span class="token comment">//more on that later</span></div><br><div class="line-0-0-16 " data-content="            [SELECT Id FROM Account LIMIT 1]"><span class="lineCounter-0-0-15">6</span>            <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span> FROM <span class="token class-name">Account</span> LIMIT <span class="token number">1</span><span class="token punctuation">]</span></div><br><div class="line-0-0-16 " data-content="        );"><span class="lineCounter-0-0-15">7</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">8</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">9</span><span class="token punctuation">}</span></div><br></code></pre><p>And whenever you need to initialize the <code>AccountWrapper</code>:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="//some code, somewhere, that needs the wrapper"><span class="lineCounter-0-0-15 prim">1</span><span class="token comment">//some code, somewhere, that needs the wrapper</span></div><br><div class="line-0-0-16 " data-content="AccountWrapper wrapper = Factory.getAccountWrapper();"><span class="lineCounter-0-0-15 prim">2</span><span class="token class-name">AccountWrapper</span> wrapper <span class="token operator">=</span> <span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">getAccountWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>What are the benefits of this approach? Well, now our "client" code (so-called because it is the consumer of initialized <code>AccountWrappers</code>) doesn't need to know how the object is constructed; it's agnostic of the wrapper's dependencies, which can change without having to refactor all of the places using the object. But things still aren't ideal. Initializing the objects within the Factory has brought about the centralization of how your objects are being constructed ... but the Factory itself now runs the risk of becoming extremely bloated. We'd like for the Factory to be responsible for object initialization without having to know exactly what each object needs. That way, it expands in size only so much as you need to create objects, instead of exponentially as your object's dependencies change and increase. Luckily ... there's a way.</p><h3 id="the-factory-pattern--constructor-injection" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>The Factory Pattern &amp; Constructor Injection</h3><p>Let's take our Factory example in Apex and improve it, slightly:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public virtual class Factory {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> virtual <span class="token keyword">class</span> <span class="token class-name">Factory</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public virtual Account getAccount() {"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">public</span> virtual <span class="token class-name">Account</span> <span class="token function">getAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return [SELECT Id FROM Account LIMIT 1];"><span class="lineCounter-0-0-15">3</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span>SELECT <span class="token class-name">Id</span> FROM <span class="token class-name">Account</span> LIMIT <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">4</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">5</span></div><br><div class="line-0-0-16 " data-content="    public virtual AccountWrapper getAccountWrapper() {"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">public</span> virtual <span class="token class-name">AccountWrapper</span> <span class="token function">getAccountWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return new AccountWrapper(this);"><span class="lineCounter-0-0-15">7</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AccountWrapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">8</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">9</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="public class AccountWrapper {"><span class="lineCounter-0-0-15">11</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountWrapper</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final Account account;"><span class="lineCounter-0-0-15">12</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Account</span> account<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">13</span></div><br><div class="line-0-0-16 " data-content="    public AccountWrapper(Factory factory) {"><span class="lineCounter-0-0-15">14</span>    <span class="token keyword">public</span> <span class="token class-name">AccountWrapper</span><span class="token punctuation">(</span><span class="token class-name">Factory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.account = factory.getAccount();"><span class="lineCounter-0-0-15 prim">15</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>account <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">16</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">17</span><span class="token punctuation">}</span></div><br></code></pre><p>Wowza. The Factory stays slim, expanding only as you add new objects to your codebase; the responsibility for construction still lies with the object, and it always has access to the dependencies it needs! That's pretty cool. You can also stub out the <code>getAccount</code> method, should you need to fake your account dependency in tests. Even nicer, if the <code>getAccount</code> method is one used frequently in tests, you can also centralize your overrides in a shared test file.</p><p>But let's bring it back to our <a href="/joys-of-apex/mocking-dml">Crud example</a>:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public virtual class Factory {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> virtual <span class="token keyword">class</span> <span class="token class-name">Factory</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public ICrud Crud { get; private set; }"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">public</span> <span class="token class-name">ICrud</span> <span class="token class-name">Crud</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="    private static Factory factory;"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Factory</span> factory<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">5</span></div><br><div class="line-0-0-16 " data-content="    @testVisible"><span class="lineCounter-0-0-15">6</span>    <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-16 " data-content="    protected Factory() {"><span class="lineCounter-0-0-15">7</span>    <span class="token keyword">protected</span> <span class="token class-name">Factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.Crud = new Crud();"><span class="lineCounter-0-0-15">8</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Crud</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Crud</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">9</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="    public static Factory getFactory() {"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Factory</span> <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        //production code can only initialize the factory through this method"><span class="lineCounter-0-0-15">12</span>        <span class="token comment">//production code can only initialize the factory through this method</span></div><br><div class="line-0-0-16 " data-content="        if(factory == null) {"><span class="lineCounter-0-0-15">13</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            factory = new Factory();"><span class="lineCounter-0-0-15">14</span>            factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15 prim">15</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">16</span></div><br><div class="line-0-0-16 " data-content="        return factory;"><span class="lineCounter-0-0-15">17</span>        <span class="token keyword">return</span> factory<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">18</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">19</span></div><br><div class="line-0-0-16 " data-content="    public static BusinessLogicThing getBusinessLogicThing() {"><span class="lineCounter-0-0-15 prim">20</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BusinessLogicThing</span> <span class="token function">getBusinessLogicThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return new BusinessLogicThing(this);"><span class="lineCounter-0-0-15">21</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BusinessLogicThing</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">22</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">23</span></div><br><div class="line-0-0-16 " data-content="    @testVisible"><span class="lineCounter-0-0-15">24</span>    <span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-16 " data-content="    private Factory withMocks {"><span class="lineCounter-0-0-15 prim">25</span>    <span class="token keyword">private</span> <span class="token class-name">Factory</span> withMocks <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        get {"><span class="lineCounter-0-0-15">26</span>        get <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            this.Crud = new CrudMock();"><span class="lineCounter-0-0-15">27</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Crud</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CrudMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            return this;"><span class="lineCounter-0-0-15">28</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">29</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">31</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">32</span></div><br><div class="line-0-0-16 " data-content="//your production code"><span class="lineCounter-0-0-15">33</span><span class="token comment">//your production code</span></div><br><div class="line-0-0-16 " data-content="public class BusinessLogicThing {"><span class="lineCounter-0-0-15">34</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BusinessLogicThing</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final ICrud crud;"><span class="lineCounter-0-0-15 prim">35</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ICrud</span> crud<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">36</span></div><br><div class="line-0-0-16 " data-content="    public BusinessLogicThing(Factory factory) {"><span class="lineCounter-0-0-15">37</span>    <span class="token keyword">public</span> <span class="token class-name">BusinessLogicThing</span><span class="token punctuation">(</span><span class="token class-name">Factory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.crud = factory.Crud;"><span class="lineCounter-0-0-15">38</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>crud <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token class-name">Crud</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">39</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">40</span></div><br><div class="line-0-0-16 " data-content="    public void handleBusinessLogic(List<Account> accountsNeedingBusinessLogicDone) {"><span class="lineCounter-0-0-15">41</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleBusinessLogic</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accountsNeedingBusinessLogicDone<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.updateAccountValues(accountsNeedingBusinessLogicDone);"><span class="lineCounter-0-0-15">42</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateAccountValues</span><span class="token punctuation">(</span>accountsNeedingBusinessLogicDone<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.crud.doUpdate(accountsNeedingBusinessLogicDone);"><span class="lineCounter-0-0-15">43</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>crud<span class="token punctuation">.</span><span class="token function">doUpdate</span><span class="token punctuation">(</span>accountsNeedingBusinessLogicDone<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">44</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">45</span></div><br><div class="line-0-0-16 " data-content="    private void updateAccountValues(List<Account> accounts) {"><span class="lineCounter-0-0-15">46</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateAccountValues</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        for(Account acc : accounts) {"><span class="lineCounter-0-0-15">47</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Account</span> acc <span class="token operator">:</span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            //do business stuff here"><span class="lineCounter-0-0-15">48</span>            <span class="token comment">//do business stuff here</span></div><br><div class="line-0-0-16 " data-content="            //for now let's set some silly value"><span class="lineCounter-0-0-15">49</span>            <span class="token comment">//for now let's set some silly value</span></div><br><div class="line-0-0-16 " data-content="            acc.Name = acc.Name + ' New';"><span class="lineCounter-0-0-15 prim">50</span>            acc<span class="token punctuation">.</span><span class="token class-name">Name</span> <span class="token operator">=</span> acc<span class="token punctuation">.</span><span class="token class-name">Name</span> <span class="token operator">+</span> <span class="token string">' New'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">51</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">52</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">53</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">54</span></div><br><div class="line-0-0-16 " data-content="//your test code"><span class="lineCounter-0-0-15 prim">55</span><span class="token comment">//your test code</span></div><br><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15">56</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class BusinessLogicThing_Tests {"><span class="lineCounter-0-0-15">57</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">BusinessLogicThing_Tests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">58</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void It_Should_Update_Accounts_Correctly() {"><span class="lineCounter-0-0-15">59</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">It_Should_Update_Accounts_Correctly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        //Given"><span class="lineCounter-0-0-15 prim">60</span>        <span class="token comment">//Given</span></div><br><div class="line-0-0-16 " data-content="        String testString = 'Test';"><span class="lineCounter-0-0-15">61</span>        <span class="token class-name">String</span> testString <span class="token operator">=</span> <span class="token string">'Test'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Account fakeAccount = new Account(Name = testString);"><span class="lineCounter-0-0-15">62</span>        <span class="token class-name">Account</span> fakeAccount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Name</span> <span class="token operator">=</span> testString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">63</span></div><br><div class="line-0-0-16 " data-content="        //When"><span class="lineCounter-0-0-15">64</span>        <span class="token comment">//When</span></div><br><div class="line-0-0-16 " data-content="        BusinessLogicThing bizLogic = Factory.getFactory().withMocks.getBusinessLogicThing();"><span class="lineCounter-0-0-15 prim">65</span>        <span class="token class-name">BusinessLogicThing</span> bizLogic <span class="token operator">=</span> <span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>withMocks<span class="token punctuation">.</span><span class="token function">getBusinessLogicThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        bizLogic.handleBusinessLogic(new List<Account>{ fakeAccount });"><span class="lineCounter-0-0-15">66</span>        bizLogic<span class="token punctuation">.</span><span class="token function">handleBusinessLogic</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> fakeAccount <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">67</span></div><br><div class="line-0-0-16 " data-content="        //Then"><span class="lineCounter-0-0-15">68</span>        <span class="token comment">//Then</span></div><br><div class="line-0-0-16 " data-content="        Account updatedAccount = (Account) CrudMock.Updated.Accounts.singleOrDefault;"><span class="lineCounter-0-0-15">69</span>        <span class="token class-name">Account</span> updatedAccount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">)</span> <span class="token class-name">CrudMock</span><span class="token punctuation">.</span><span class="token class-name">Updated</span><span class="token punctuation">.</span><span class="token class-name">Accounts</span><span class="token punctuation">.</span>singleOrDefault<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(testString + ' New', updatedAccount.Name);"><span class="lineCounter-0-0-15 prim">70</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>testString <span class="token operator">+</span> <span class="token string">' New'</span><span class="token punctuation">,</span> updatedAccount<span class="token punctuation">.</span><span class="token class-name">Name</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">71</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">72</span><span class="token punctuation">}</span></div><br></code></pre><h3 id="summing-up-dependency-injection--the-factory-pattern-in-apex" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Summing up Dependency Injection &amp; The Factory Pattern In Apex</h3><p>So what happened here? The Factory in Apex got initialized with the production level Crud wrapper - and in the production level code, we know that the Crud's <code>doUpdate</code> method is going to correctly update Accounts run through the BusinessLogicThing. But in the <em>tests</em>, we can completely avoid having to hit the database and the subsequent requerying to verify that the Account Names have been updated accordingly. We can simply go to our mock and verify that:</p><ul><li>the Account has been put into the correct list</li><li>there's only one of them (the <code>singleOrDefault</code> method will throw an exception if, as a result of the called code, more than one record exists in the list)</li><li>the Name property has been updated, as we expect</li></ul><p>That's the power of the Factory Pattern when used with Dependency Injection. Typically, test slowness is the result of the Salesforce database being hit. So far in the Joy Of Apex, we've covered one possible approach to hitting the database -- through DML operations like record creation, upserting, updating, deleting, or undeleting.</p><p>There is <em>another</em> side to test slowness, though -- accessing the database through querying. In an upcoming episode in this ongoing series, I'll cover how you can use the <strong>Repository Pattern</strong> similarly to our Crud implementation to hot-swap out querying the database while in tests. And once we've covered the Repository ... that's it. There have been some voicing the opinion that this code is a lot of boilerplate; on the contrary, I find that organizations making use of these files typically save on lines of code, test complexity, and developer overhead. That last point is particularly important, and I'd like to give a short explanation:</p><p>Without the use of fancy tooling (and I am aware that there are some tools out there to do this, but so far the Salesforce sponsored tooling for VSCode is still kind of disappointing for non-DX orgs), onboarding new developers or consultants to an existing Salesforce.com project often involves hours and hours of head's-down code-digging, particularly to understand how objects are constructed. In an ideal world, where we would have access to niceties like Visual Studio's running count of how many times and where objects are being used, this would be less of an issue; but, considering that most developers are either clinging close to MavensMate/Sublime or VSCode and some combination of VSCode plugins, giving developers a one-stop-shop for where objects are initialized helps to familiarize them with the codebase and object interplay much faster.</p><p>Here's to hoping you enjoyed this episode of The Joys Of Apex. More to come in 2020 -- for now, wishing you all a Happy New Year!</p><p>PS -- I did some stress testing on the use of the CrudMock / Crud class I am recommending versus the FFLib Apex Mocks library which was developed by Andrew Fawcett, who worked on FinancialForce prior to working for Salesforce. FinancialForce's approach closely aligns with that of Mockito, one of the pre-eminent Java mocking solutions, and as such is widely accepted in the industry as the de-facto way to approach mocking within Apex. I will also be covering this in a future post, but for now if you are curious, <a href="https://github.com/jamessimone/apex-mocks-stress-test">check out the project on my Github</a> for a sneak peek of the relative performance merits for each library. Cheers!</p><div class="contentnav-0-0-7" data-no-search=""><a href="#intro-to-dependency-injection-in-apex" class="h3" data-content-highlight="intro-to-dependency-injection-in-apex">Intro to Dependency Injection in Apex</a><a href="#the-problems-with-dependency-injection" class="h3" data-content-highlight="the-problems-with-dependency-injection">The Problems with Dependency Injection</a><a href="#using-the-factory-pattern-in-apex" class="h3" data-content-highlight="using-the-factory-pattern-in-apex">Using the Factory Pattern In Apex</a><a href="#the-factory-pattern--constructor-injection" class="h3" data-content-highlight="the-factory-pattern--constructor-injection">The Factory Pattern &amp; Constructor Injection</a><a href="#summing-up-dependency-injection--the-factory-pattern-in-apex" class="h3" data-content-highlight="summing-up-dependency-injection--the-factory-pattern-in-apex">Summing up Dependency Injection &amp; The Factory Pattern In Apex</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/writing-performance-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="EcQzhynKHA">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("EcQzhynKHA", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="lJQpalUzGE">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("lJQpalUzGE", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="ISZIdchGug">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ISZIdchGug", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>