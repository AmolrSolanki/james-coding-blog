<!DOCTYPE html><html><head><title>Joys Of Apex | Continuous Integration With SFDX</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Continuous Integration With SFDX"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Continuous Integration With SFDX"></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"continuous-integration-with-sfdx.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Continuous Integration With SFDX</p></span></h1><script id="yNhWKOoULq">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("yNhWKOoULq", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2020-04-29T15:12:03.284Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>Updating your build pipeline to use SFDX is something that is coming up with greater and greater frequency. Many companies are still using the old metadata format for Salesforce, and perhaps the full advantage of scratch orgs and the new metadata format is still a hard sell. It's understandable. Using ANT, jsforce, or any of a dozen other legacy options for performing production deploys makes people uncomfortable; also understandable. One has only to glance at the NPM warnings when installing jsforce, for example, to have second thoughts about that particular approach. Yet for a while, wrappers around the Salesforce metadata and tooling APIs were in vogue specifically because they abstracted away the unpleasantness of working with these APIs (well, the relative unpleasantness -- one has only to examine the Marketing Cloud APIs to gain a fuller appreciation for the word <em>unpleasant</em>).</p><p>I thought I'd do a little write-up about my experience porting an older project over to the use of SFDX while still getting two big advantages:</p><ul><li>deletion of Apex classes when the current git repository's Apex Classes no longer include references to Apex Classes within the targeted Salesforce org</li><li>continuous integration. I want deploys to occur when merges are accomplished on specific feature branches/the master branch. Obviously everybody's build pipeline differs, and you may have many different pre-prod environments; hopefully whatever CI system you're using supports setting up pipelines for git branches specific to that environment</li></ul><h2 id="automating-apex-class-deletion" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Automating Apex Class Deletion</h2><p>Some time ago, my mentor and I wrote an npm package, <a href="https://github.com/bruce-lindsay/apex-class-cleanup#readme">apex-class-cleanup</a> which made use of jsforce to dynamically configure the <code>destructiveChangesPre.xml</code> file that Salesforce requires be included with a metadata deployment in order to delete Apex classes prior to the tests being run -- crucial for avoiding conflicts. At the time, we used Handlebars to template out this XML file ... but it's a pretty simple file, and now with SFDX we have the use of the <code>sfdx force:mdapi:listmetadata</code> command, which removes the jsforce requirement entirely. Let's see if we can get rid of that Handlebars dependency as well ...</p><p>When you run <code>sfdx force:mdapi:listmetadata</code>, you also have the option of specifying a destination file for the output, as well as the format of the output. Using <code>sfdx force:mdapi:listmetadata --json -m ApexClass -f ./existingApexClasses.json</code>, we can grab just the Apex classes in our Salesforce org and write them to the current directory in an <code>existingApexClasses</code> json file. We don't want this file to be tracked in source control -- it should be added to our <code>.gitignore</code> file. Personally, I'd also like to clean up the file post-deployment so it doesn't stick around in my working directory, or that of my build runner.</p><p>So ... we need to get the existing Apex classes, and after the deploy has finished, perform some cleanup. This is a perfect use case for the built in <code>pre/post</code> commands baked into NPM scripts; by naming a script task <code>deploy</code>, we can then require that something run before it by naming the task to run before it <code>predeploy</code> and require that a task run after the <code>deploy</code> task has finished by naming a task <code>postdeploy</code>.</p><p>Our <code>package.json</code> file ends up looking like:</p><pre class=""><code class="json code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="&quot;predeploy&quot;: &quot;sfdx force:mdapi:listmetadata --json -m ApexClass -f ./existingApexClasses.json&quot;,"><span class="lineCounter-0-0-15 prim">1</span><span class="token property">"predeploy"</span><span class="token operator">:</span> <span class="token string">"sfdx force:mdapi:listmetadata --json -m ApexClass -f ./existingApexClasses.json"</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="//the -w flag is minutes for the SFDX runner to wait for your deployment. You want this value to be higher"><span class="lineCounter-0-0-15">2</span><span class="token comment">//the -w flag is minutes for the SFDX runner to wait for your deployment. You want this value to be higher</span></div><br><div class="line-0-0-16 " data-content="//than any possible increment your deploy could take ..."><span class="lineCounter-0-0-15">3</span><span class="token comment">//than any possible increment your deploy could take ...</span></div><br><div class="line-0-0-16 " data-content="//the -d flag is wherever your unconverted source directory is."><span class="lineCounter-0-0-15">4</span><span class="token comment">//the -d flag is wherever your unconverted source directory is.</span></div><br><div class="line-0-0-16 " data-content="//traditionally this was &quot;src&quot;, but your mileage may vary"><span class="lineCounter-0-0-15 prim">5</span><span class="token comment">//traditionally this was </span><span class="token string">"src"</span><span class="token punctuation">,</span> but your mileage may vary</div><br><div class="line-0-0-16 " data-content="&quot;deploy&quot;: &quot;node ./createDestructiveChanges.js &amp;&amp; sfdx force:mdapi:deploy -d \&quot;src\&quot; -w 10&quot;,"><span class="lineCounter-0-0-15">6</span><span class="token property">"deploy"</span><span class="token operator">:</span> <span class="token string">"node ./createDestructiveChanges.js &amp;&amp; sfdx force:mdapi:deploy -d \"src\" -w 10"</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="&quot;postdeploy&quot;: &quot;node ./cleanup.js&quot;"><span class="lineCounter-0-0-15 prim">7</span><span class="token property">"postdeploy"</span><span class="token operator">:</span> <span class="token string">"node ./cleanup.js"</span></div><br></code></pre><p>So what do those <code>createDestructiveChanges</code> and <code>cleanup</code> files look like?</p><p>Let's look at how to create the XML file first:</p><pre class="with-bar"><code class="javascript code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>./createDestructiveChanges.js</span></span><div class="line-0-0-16 " data-content="const existingClasses = require(&quot;./existingApexClasses.json&quot;);"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">const</span> existingClasses <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./existingApexClasses.json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="const fs = require(&quot;fs&quot;);"><span class="lineCounter-0-0-15">2</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="const options = {"><span class="lineCounter-0-0-15">4</span><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  //you could also use dotenv or something similar"><span class="lineCounter-0-0-15 prim">5</span>  <span class="token comment">//you could also use dotenv or something similar</span></div><br><div class="line-0-0-16 " data-content="  //to inject these two values by process.env values"><span class="lineCounter-0-0-15">6</span>  <span class="token comment">//to inject these two values by process.env values</span></div><br><div class="line-0-0-16 " data-content="  apiVersion: &quot;48.0&quot;,"><span class="lineCounter-0-0-15">7</span>  apiVersion<span class="token operator">:</span> <span class="token string">"48.0"</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="  classesFolder: &quot;./src/classes/&quot;,"><span class="lineCounter-0-0-15">8</span>  classesFolder<span class="token operator">:</span> <span class="token string">"./src/classes/"</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="};"><span class="lineCounter-0-0-15">9</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="const serverFileStats = existingClasses.map("><span class="lineCounter-0-0-15">11</span><span class="token keyword">const</span> serverFileStats <span class="token operator">=</span> existingClasses<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="  (existingClass) =>"><span class="lineCounter-0-0-15">12</span>  <span class="token punctuation">(</span><span class="token parameter">existingClass</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></div><br><div class="line-0-0-16 " data-content="    new Promise((resolve) => {"><span class="lineCounter-0-0-15">13</span>    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      if ("><span class="lineCounter-0-0-15">14</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        existingClass.namespacePrefix &amp;&amp;"><span class="lineCounter-0-0-15 prim">15</span>        existingClass<span class="token punctuation">.</span>namespacePrefix <span class="token operator">&amp;&amp;</span></div><br><div class="line-0-0-16 " data-content="        existingClass.namespacePrefix !== &quot;&quot;"><span class="lineCounter-0-0-15">16</span>        existingClass<span class="token punctuation">.</span>namespacePrefix <span class="token operator">!==</span> <span class="token string">""</span></div><br><div class="line-0-0-16 " data-content="      ) {"><span class="lineCounter-0-0-15">17</span>      <span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return resolve({ stat: true, existingClass });"><span class="lineCounter-0-0-15">18</span>        <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stat<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> existingClass <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      }"><span class="lineCounter-0-0-15">19</span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="      return fs.stat("><span class="lineCounter-0-0-15 prim">20</span>      <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        options.classesFolder + existingClass.fullName + &quot;.cls&quot;,"><span class="lineCounter-0-0-15">21</span>        options<span class="token punctuation">.</span>classesFolder <span class="token operator">+</span> existingClass<span class="token punctuation">.</span>fullName <span class="token operator">+</span> <span class="token string">".cls"</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        (err, stats) => {"><span class="lineCounter-0-0-15">22</span>        <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="          if (err) {"><span class="lineCounter-0-0-15">23</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            return resolve({ stat: false, existingClass });"><span class="lineCounter-0-0-15">24</span>            <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stat<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> existingClass <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="          }"><span class="lineCounter-0-0-15 prim">25</span>          <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="          return resolve({ stat: stats, existingClass });"><span class="lineCounter-0-0-15">26</span>          <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stat<span class="token operator">:</span> stats<span class="token punctuation">,</span> existingClass <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">27</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="      );"><span class="lineCounter-0-0-15">28</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    })"><span class="lineCounter-0-0-15">29</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content=");"><span class="lineCounter-0-0-15 prim">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">31</span></div><br><div class="line-0-0-16 " data-content="const missingClassesPromise = () =>"><span class="lineCounter-0-0-15">32</span><span class="token keyword">const</span> <span class="token function-variable function">missingClassesPromise</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></div><br><div class="line-0-0-16 " data-content="  Promise.all(serverFileStats)"><span class="lineCounter-0-0-15">33</span>  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>serverFileStats<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    .then((statAndElements) =>"><span class="lineCounter-0-0-15">34</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">statAndElements</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></div><br><div class="line-0-0-16 " data-content="      statAndElements.filter((el) => !el.stat).map((el) => el.el)"><span class="lineCounter-0-0-15 prim">35</span>      statAndElements<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>stat<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> el<span class="token punctuation">.</span>el<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    )"><span class="lineCounter-0-0-15">36</span>    <span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    .then((extraClasses) => {"><span class="lineCounter-0-0-15">37</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">extraClasses</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="      if (extraClasses.length === 0) {"><span class="lineCounter-0-0-15">38</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>extraClasses<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        console.log(&quot;No extra classes found.&quot;);"><span class="lineCounter-0-0-15">39</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"No extra classes found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="      }"><span class="lineCounter-0-0-15 prim">40</span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="      return { extraClasses };"><span class="lineCounter-0-0-15">41</span>      <span class="token keyword">return</span> <span class="token punctuation">{</span> extraClasses <span class="token punctuation">}</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    });"><span class="lineCounter-0-0-15">42</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">43</span></div><br><div class="line-0-0-16 " data-content="missingClassesPromise().then(({ extraClasses }) => {"><span class="lineCounter-0-0-15">44</span><span class="token function">missingClassesPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> extraClasses <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  //I'm not saying this is the best thing in the world."><span class="lineCounter-0-0-15 prim">45</span>  <span class="token comment">//I'm not saying this is the best thing in the world.</span></div><br><div class="line-0-0-16 " data-content="  //It's not. But the format of the XML file hasn't changed"><span class="lineCounter-0-0-15">46</span>  <span class="token comment">//It's not. But the format of the XML file hasn't changed</span></div><br><div class="line-0-0-16 " data-content="  //And it's pretty simple to construct."><span class="lineCounter-0-0-15">47</span>  <span class="token comment">//And it's pretty simple to construct.</span></div><br><div class="line-0-0-16 " data-content="  const header = '<?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?>';"><span class="lineCounter-0-0-15">48</span>  <span class="token keyword">const</span> header <span class="token operator">=</span> <span class="token string">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  const packageStart ="><span class="lineCounter-0-0-15">49</span>  <span class="token keyword">const</span> packageStart <span class="token operator">=</span></div><br><div class="line-0-0-16 " data-content="    '<Package xmlns=&quot;http://soap.sforce.com/2006/04/metadata&quot;>';"><span class="lineCounter-0-0-15 prim">50</span>    <span class="token string">'&lt;Package xmlns="http://soap.sforce.com/2006/04/metadata"&gt;'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  const typesStart = &quot;<types>&quot;;"><span class="lineCounter-0-0-15">51</span>  <span class="token keyword">const</span> typesStart <span class="token operator">=</span> <span class="token string">"&lt;types&gt;"</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  const name = &quot;<name>ApexClass</name>&quot;;"><span class="lineCounter-0-0-15">52</span>  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">"&lt;name&gt;ApexClass&lt;/name&gt;"</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  const classes = extraClasses.map("><span class="lineCounter-0-0-15">53</span>  <span class="token keyword">const</span> classes <span class="token operator">=</span> extraClasses<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="    (extraClass) => `<members>${extraClass.fullName}</members>`"><span class="lineCounter-0-0-15">54</span>    <span class="token punctuation">(</span><span class="token parameter">extraClass</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;members&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extraClass<span class="token punctuation">.</span>fullName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/members&gt;</span><span class="token template-punctuation string">`</span></span></div><br><div class="line-0-0-16 " data-content="  );"><span class="lineCounter-0-0-15 prim">55</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  const typesEnd = &quot;</types>&quot;;"><span class="lineCounter-0-0-15">56</span>  <span class="token keyword">const</span> typesEnd <span class="token operator">=</span> <span class="token string">"&lt;/types&gt;"</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  const version = `<version>${options.apiVersion}</version>`;"><span class="lineCounter-0-0-15">57</span>  <span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;version&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>apiVersion<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/version&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  const packageEnd = &quot;</Package>&quot;;"><span class="lineCounter-0-0-15">58</span>  <span class="token keyword">const</span> packageEnd <span class="token operator">=</span> <span class="token string">"&lt;/Package&gt;"</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  const xmlPieces = ["><span class="lineCounter-0-0-15">59</span>  <span class="token keyword">const</span> xmlPieces <span class="token operator">=</span> <span class="token punctuation">[</span></div><br><div class="line-0-0-16 " data-content="    header,"><span class="lineCounter-0-0-15 prim">60</span>    header<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    packageStart,"><span class="lineCounter-0-0-15">61</span>    packageStart<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    typesStart,"><span class="lineCounter-0-0-15">62</span>    typesStart<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    name,"><span class="lineCounter-0-0-15">63</span>    name<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    classes,"><span class="lineCounter-0-0-15">64</span>    classes<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    typesEnd,"><span class="lineCounter-0-0-15 prim">65</span>    typesEnd<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    version,"><span class="lineCounter-0-0-15">66</span>    version<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    packageEnd,"><span class="lineCounter-0-0-15">67</span>    packageEnd<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="  ];"><span class="lineCounter-0-0-15">68</span>  <span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">69</span></div><br><div class="line-0-0-16 " data-content="  const xmlContent = xmlPieces.join(&quot;\n&quot;);"><span class="lineCounter-0-0-15 prim">70</span>  <span class="token keyword">const</span> xmlContent <span class="token operator">=</span> xmlPieces<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="  return fs.writeFileSync(&quot;src/destructiveChangesPre.xml&quot;, xmlContent);"><span class="lineCounter-0-0-15">71</span>  <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">"src/destructiveChangesPre.xml"</span><span class="token punctuation">,</span> xmlContent<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="});"><span class="lineCounter-0-0-15 prim">72</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><div class="tabs-0-0-18"><script id="ePtYhPbbys">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ePtYhPbbys", "T764P9zpaV5eSCd1H0okyw==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div class="tab first selected" data-tab-title="Create Destructive Changes Notes"><p>So -- <code>createDestructiveChanges</code> relies on the output from our <code>predeploy</code> step, and then compares the existing classes in our current git branch to the ones that were returned from our Salesforce org. For the ones that don't match, they're added to the <code>destructiveChangesPre.xml</code> file that Salesforce requires. The one annoyance here is that <code>sfdx force:mdapi:listmetadata</code> doesn't currently support an argument for getting only metadata from a specific namespace, so if you have installed packages on your org, they need to get filtered out first (which happens in the <code>serverFileStats</code> function, above). Also please note the important caveat that, again, this sort of thing is only going to work with the old org metadata structure</p></div><div class="tab" data-tab-title="Footnote"><p>One of the big advantages in moving to packaging through SFDX is that this class cleanup happens out of the box when upgrading packages.</p></div></div><p>The cleanup file doesn't have to be anything complicated:</p><pre class="with-bar"><code class="javascript code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>./cleanup.js</span></span><div class="line-0-0-16 " data-content="const fs = require(&quot;fs&quot;);"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">2</span></div><br><div class="line-0-0-16 " data-content="try {"><span class="lineCounter-0-0-15">3</span><span class="token keyword">try</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  fs.unlinkSync(&quot;./src/destructiveChangesPre.xml&quot;);"><span class="lineCounter-0-0-15">4</span>  fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span><span class="token string">"./src/destructiveChangesPre.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="} catch {}"><span class="lineCounter-0-0-15 prim">5</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">6</span></div><br><div class="line-0-0-16 " data-content="try {"><span class="lineCounter-0-0-15">7</span><span class="token keyword">try</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="  fs.unlinkSync(&quot;./existingApexClasses.json&quot;);"><span class="lineCounter-0-0-15">8</span>  fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span><span class="token string">"./existingApexClasses.json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="} catch {}"><span class="lineCounter-0-0-15 prim">9</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></div><br></code></pre><p>You could do the same in Bash/Powershell, as you please. It doesn't really matter. I have no preference between using node, <code>rm -rf</code>, or <code>Remove-Item</code>. Whatever floats your boat. The node implementation is shown primarily because we're talking about deploying through the use of a <code>package.json</code> file. The underlying steps to achieve this functionality remain the same, regardless of which shell / language you're using in your builds.</p><h2 id="continuous-integration-with-sfdx" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Continuous Integration With SFDX</h2><p>So ... locally, we have SFDX authorized to the Salesforce orgs of our choice ... but in order to securely allow for continuous integration, it's of absolutely crucial importance that we not expose our Salesforce login information except at the exact moment in our builds where we need to authorize SFDX.</p><p>In Node, at the moment, there's the popular <code>sfdx-cli</code> wrapper to allow for the use of SFDX commands through NPM. You have two essential choices when setting up CI with SFDX:</p><ul><li>if you (and your organization) have a pre-existing "secrets" management solution, be it Docker Secrets, Vault, CyberArk, AWS Secrets, etc ... you may feel comfortable embedding your SFDX Auth URL (retrieved through the <code>sfdx force:org:display --verbose</code>) into your existing secrets manager as is. As long as you have a way of exposing this value within your build runner's environment variables, you can then write a simple script to move this secret to a file (which is required by SFDX in order for it to be read):</li></ul><pre class="with-bar"><code class="javascript code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>./writeSalesforceAuth.js</span></span><div class="line-0-0-16 " data-content="const fs = require(&quot;fs&quot;);"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">2</span></div><br><div class="line-0-0-16 " data-content="fs.writeFileSync(&quot;salesforce-auth&quot;, process.env.AUTH_TOKEN);"><span class="lineCounter-0-0-15 prim">3</span>fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">"salesforce-auth"</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">AUTH_TOKEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br></code></pre><p>Or ...</p><pre class=""><code class="bash code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="echo $AUTH_TOKEN > ./salesforce-auth"><span class="lineCounter-0-0-15 prim">1</span><span class="token builtin class-name">echo</span> <span class="token variable">$AUTH_TOKEN</span> <span class="token operator">&gt;</span> ./salesforce-auth</div><br></code></pre><p>Or even perhaps:</p><pre class=""><code class="powershell code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="$env:AUTH_TOKEN > salesforce-auth"><span class="lineCounter-0-0-15 prim">1</span><span class="token variable">$env</span>:AUTH_TOKEN &gt; salesforce<span class="token operator">-</span>auth</div><br></code></pre><p>Again, whatever makes you happy. Just remember to clean up that file at the end of your build! Our full build pipeline for production deploys thus becomes:</p><ol><li>Auth our build runner by calling <code>sfdx force:auth:sfdxurl:store -f ./salesforce-auth -d"</code> as part of your deploy script</li><li>Continue on with the deploy as shown in the <code>package.json</code> example from above</li><li>Automate the cleanup of build artifacts with any kind of sensitive/transitive information</li></ol><p><strong>OR:</strong></p><ul><li>if you either don't use a pre-existing secrets management solution or you have some other blocker, you can follow the steps outlined <a href="https://salesforce.vidyard.com/watch/H3GHcWvD91oxcKeDtFksuN">in a few other places</a> to securely encrypt the value of your SFDX Auth URL for usage in your CI pipeline.</li></ul><p>Essentially, this involves the use of a secret key known only to you/your team that functions as the SSL cipher for your SFDX Auth Url, which is then decrypted during your build.</p><p>YMMV, as they say. I personally find it likely that if a person with ill intent had taken the time to infiltrate your build system, they almost certainly also have access to wherever your remote repository is hosted; it doesn't really matter if you are using a secret key that is then going to decrypt a file you have committed to your repository with the encrypted contents of your SFDX Auth Token ... they can just extract that information in one additional step.</p><p>You can certainly make the argument that if wherever the environment variables are securely stored to begin with gets hacked, and they <em>only</em> get the cipher key, security still has the chance through password resets and cipher recreation to protect your secrets. Again, it's a "once again removed" situation where I feel that one thing follows the other, and you're better off revoking your existing authorized user in that case.</p><h2 id="wrapping-up" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Wrapping Up</h2><p>Getting continuous integration up and running for Salesforce is important, regardless of whether you've fully converted over to using the new metadata format or not. Hopefully we can all agree on that. For me, the icing on the cake is not having to manually delete classes when in the midst of big refactors. Whether you're using BitBucket, Gitlab, or Github, there are many options for setting up continuous integration; there are also plenty of existing integrations (CircleCI, CumulusCI , Jenkins, etc ...) that either have Salesforce / SFDX support, or outright specialize in setting up build pipelines for you.</p><p>Maybe you're curious as to what some of those underpinnings may look like when using Github Actions, Gitlab Pipelines, etc ... if so, hopefully this post proved illuminating and helpful to you. Either way, thanks for sticking with me through this journey -- not exactly our typical <a href="/joys-of-apex/">Joys Of Apex</a> subject material, but an important tooling step and something that I thought worth mentioning. Till next time!</p><div class="contentnav-0-0-7" data-no-search=""><a href="#automating-apex-class-deletion" class="h2" data-content-highlight="automating-apex-class-deletion">Automating Apex Class Deletion</a><a href="#continuous-integration-with-sfdx" class="h2" data-content-highlight="continuous-integration-with-sfdx">Continuous Integration With SFDX</a><a href="#wrapping-up" class="h2" data-content-highlight="wrapping-up">Wrapping Up</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="oxdaVSJBhW">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("oxdaVSJBhW", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="AtFXswjWVC">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("AtFXswjWVC", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="rszNHpJYJe">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("rszNHpJYJe", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>