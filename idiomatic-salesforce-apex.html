<!DOCTYPE html><html><head><title>Joys Of Apex | Idiomatic Salesforce Apex</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Idiomatic Salesforce Apex"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Idiomatic Salesforce Apex"></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"idiomatic-salesforce-apex.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Idiomatic Salesforce Apex</p></span></h1><script id="rohypPpFTa">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("rohypPpFTa", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2020-02-10T15:12:03.284Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>We often hear the word "idiomatic" applied to programming languages to express the language-specific way of accomplishing routinely encountered problems. In this post, we dive into how to write idiomatic Salesforce Apex to make the most of each line of code as I refactoring some existing vendor code into an easier to understand format.</p><h2 id="the-problem" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>The Problem</h2><p>Following up on the <a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a> post, I was looking to push exceptions generated in Apex to <a href="https://rollbar.com/error-tracking/apex/">Rollbar</a>. Organizations, if they're using plenty of services beyond Salesforce, will undoubtedly be using a centralized logging solution. I've seen many <a href="https://www.elastic.co/what-is/elk-stack">ELK-stack</a> approaches out there, but Rollbar (and competitors like Sumo Logic) is commonly seen on the web development side as an easy vendor to opt into, without having to worry about hosting or dashboard building. Once a company's using a vendor for one side of their logging approach, you can best believe that getting any other service's exceptions into said solution is going to be desirable -- centralize where you view exceptions being generated, and you increase the visibility of all code-related issues.</p><p>At the time, I naively assumed that because Rollbar had an Apex installed package, my conscience could rest easy going with the provided solution. I was wrong. Upon installing the Rollbar package into a sandbox, I realized quickly that there were going to be a few issues (I want to use this as an opportunity to say that I love Rollbar. I think they're a great company that provides a great service. I use their code as an opportunity to make a point in this post; I'm not trying to trash it):</p><ul><li>no installation customization. I wasn't looking for an Email Service to be installed, just a way to post the logs I'd already gathered to Rollbar</li><li>no Namespace / AppExchange certification. This means that their code is competing with all other custom code for the same Salesforce limits and computational time. Ouch.</li><li>no async log processing. Want to post something to Rollbar after performing DML? You're gonna need your own solution for that.</li></ul><p>That being said ... no need to reinvent the wheel, I thought. You can't see namespaced code in your org unless it's a global class (and even then you can't see the full object) ... but that wasn't the case for this code, so I dove right in.</p><p>I had already seen via the documentation on Rollbar's <a href="https://docs.rollbar.com/docs/salesforce-apex">Apex documentation page</a> that they were employing the Singleton pattern for accessing the logger, so that was the first thing I chose to look at:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/Rollbar.cls</span></span><div class="line-0-0-16 " data-content="public with sharing class Rollbar {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">with</span> sharing <span class="token keyword">class</span> <span class="token class-name">Rollbar</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">2</span></div><br><div class="line-0-0-16 " data-content="    public static Rollbar instance() {"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Rollbar</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        if (Rollbar.instance == null) {"><span class="lineCounter-0-0-15">4</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Rollbar</span><span class="token punctuation">.</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            Rollbar.instance = new Rollbar();"><span class="lineCounter-0-0-15 prim">5</span>            <span class="token class-name">Rollbar</span><span class="token punctuation">.</span>instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rollbar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">6</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="        return Rollbar.instance;"><span class="lineCounter-0-0-15">8</span>        <span class="token keyword">return</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span>instance<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">9</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="    public static Rollbar init()"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Rollbar</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    {"><span class="lineCounter-0-0-15">12</span>    <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return Rollbar.init("><span class="lineCounter-0-0-15">13</span>        <span class="token keyword">return</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="            RollbarSettings__c.getInstance().AccessToken__c,"><span class="lineCounter-0-0-15">14</span>            <span class="token class-name">RollbarSettings__c</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token class-name">AccessToken__c</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            UserInfo.getOrganizationName()"><span class="lineCounter-0-0-15 prim">15</span>            <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">getOrganizationName</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="        );"><span class="lineCounter-0-0-15">16</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">17</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">18</span></div><br><div class="line-0-0-16 " data-content="    public static Rollbar init(String accessToken, String environment) {"><span class="lineCounter-0-0-15">19</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Rollbar</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">String</span> accessToken<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return Rollbar.init(new Config(accessToken, environment));"><span class="lineCounter-0-0-15 prim">20</span>        <span class="token keyword">return</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span> environment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">21</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">22</span></div><br><div class="line-0-0-16 " data-content="    public static Rollbar init(Config config) {"><span class="lineCounter-0-0-15">23</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Rollbar</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Config</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Rollbar instance = instance();"><span class="lineCounter-0-0-15">24</span>        <span class="token class-name">Rollbar</span> instance <span class="token operator">=</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        instance.config = config;"><span class="lineCounter-0-0-15 prim">25</span>        instance<span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        instance.notifier = new Notifier(instance.config);"><span class="lineCounter-0-0-15">26</span>        instance<span class="token punctuation">.</span>notifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notifier</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        instance.initialized = true;"><span class="lineCounter-0-0-15">27</span>        instance<span class="token punctuation">.</span>initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return instance;"><span class="lineCounter-0-0-15">28</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">29</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">30</span></div><br><div class="line-0-0-16 " data-content="    public static HttpResponse log(String level, String message) {"><span class="lineCounter-0-0-15">31</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResponse</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">String</span> level<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Rollbar instance = initializedInstance();"><span class="lineCounter-0-0-15">32</span>        <span class="token class-name">Rollbar</span> instance <span class="token operator">=</span> <span class="token function">initializedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return instance.notifier.log(level, message);"><span class="lineCounter-0-0-15">33</span>        <span class="token keyword">return</span> instance<span class="token punctuation">.</span>notifier<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">34</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">35</span></div><br><div class="line-0-0-16 " data-content="    public static HttpResponse log(Exception exc) {"><span class="lineCounter-0-0-15">36</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResponse</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exc<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Rollbar instance = initializedInstance();"><span class="lineCounter-0-0-15">37</span>        <span class="token class-name">Rollbar</span> instance <span class="token operator">=</span> <span class="token function">initializedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return instance.notifier.log(exc);"><span class="lineCounter-0-0-15">38</span>        <span class="token keyword">return</span> instance<span class="token punctuation">.</span>notifier<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>exc<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">39</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">40</span></div><br><div class="line-0-0-16 " data-content="    public static HttpResponse log(Exception exc, Map<String, Object> custom) {"><span class="lineCounter-0-0-15">41</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResponse</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exc<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> custom<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Rollbar instance = initializedInstance();"><span class="lineCounter-0-0-15">42</span>        <span class="token class-name">Rollbar</span> instance <span class="token operator">=</span> <span class="token function">initializedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return instance.notifier.log(exc, custom);"><span class="lineCounter-0-0-15">43</span>        <span class="token keyword">return</span> instance<span class="token punctuation">.</span>notifier<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>exc<span class="token punctuation">,</span> custom<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">44</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">45</span></div><br><div class="line-0-0-16 " data-content="    public static HttpResponse log(ExceptionData exData) {"><span class="lineCounter-0-0-15">46</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResponse</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">ExceptionData</span> exData<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Rollbar instance = initializedInstance();"><span class="lineCounter-0-0-15">47</span>        <span class="token class-name">Rollbar</span> instance <span class="token operator">=</span> <span class="token function">initializedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return instance.notifier.log(exData);"><span class="lineCounter-0-0-15">48</span>        <span class="token keyword">return</span> instance<span class="token punctuation">.</span>notifier<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>exData<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">49</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">50</span></div><br><div class="line-0-0-16 " data-content="    private static Rollbar initializedInstance()"><span class="lineCounter-0-0-15">51</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Rollbar</span> <span class="token function">initializedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    {"><span class="lineCounter-0-0-15">52</span>    <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Rollbar instance = Rollbar.instance();"><span class="lineCounter-0-0-15">53</span>        <span class="token class-name">Rollbar</span> instance <span class="token operator">=</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        if (!instance.initialized) {"><span class="lineCounter-0-0-15">54</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span>initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            Rollbar.init();"><span class="lineCounter-0-0-15 prim">55</span>            <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">56</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">57</span></div><br><div class="line-0-0-16 " data-content="        return instance;"><span class="lineCounter-0-0-15">58</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">59</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">60</span></div><br><div class="line-0-0-16 " data-content="    private Rollbar() {"><span class="lineCounter-0-0-15">61</span>    <span class="token keyword">private</span> <span class="token class-name">Rollbar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">62</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">63</span></div><br><div class="line-0-0-16 " data-content="    private static Rollbar instance = null;"><span class="lineCounter-0-0-15">64</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Rollbar</span> instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private Config config = null;"><span class="lineCounter-0-0-15 prim">65</span>    <span class="token keyword">private</span> <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private Notifier notifier = null;"><span class="lineCounter-0-0-15">66</span>    <span class="token keyword">private</span> <span class="token class-name">Notifier</span> notifier <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private Boolean initialized = false;"><span class="lineCounter-0-0-15">67</span>    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> initialized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">68</span><span class="token punctuation">}</span></div><br></code></pre><h2 id="refactoring-into-idiomatic-apex" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Refactoring Into Idiomatic Apex</h2><p>Let's just leave aside all those public init methods and hone in here ...</p><p>So we've got ~ 70 lines of code mostly dealing with the problem of initializing a singleton instance / logging with strings that are actually constants.</p><ul><li>Idiomatic Apex allows us to initialize properties using a peculiar method that removes the need for backing members in the class</li><li>If we can't have a proper namespace, we might as well standardize all of these file names to start with Rollbar so we know that when we see something called a Config, it's a Rollbar config; when we see something called a Notifier, we know it's a Rollbar notifier</li><li>Let's cut out those string constants in favor of an enum</li><li>The Rollbar singleton is taking in an API token from a Custom Setting, and the Salesforce Org name, but we don't even need that info here - we need it in the JSON object that's receivable by Rollbar</li></ul><p>First let's review the idomatic way to initialize Singletons in Apex (if you're interested in more information on the singleton shown below, please read <a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a> to learn more!):</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/SingletonExample.cls</span></span><div class="line-0-0-16 " data-content="public class MyClass {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private MyClass() {"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">private</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        //prevent public initialization"><span class="lineCounter-0-0-15">3</span>        <span class="token comment">//prevent public initialization</span></div><br><div class="line-0-0-16 " data-content="        //you can still use dependency injection within your constructor though"><span class="lineCounter-0-0-15">4</span>        <span class="token comment">//you can still use dependency injection within your constructor though</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">6</span></div><br><div class="line-0-0-16 " data-content="    //Singleton method"><span class="lineCounter-0-0-15">7</span>    <span class="token comment">//Singleton method</span></div><br><div class="line-0-0-16 " data-content="    private static final MyClass Instance = new MyClass();"><span class="lineCounter-0-0-15">8</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MyClass</span> <span class="token class-name">Instance</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">9</span></div><br><div class="line-0-0-16 " data-content="    //expose public static methods for using MyClass"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token comment">//expose public static methods for using MyClass</span></div><br><div class="line-0-0-16 " data-content="    public static void sayHi() {"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Instance.say('hi');"><span class="lineCounter-0-0-15">12</span>        <span class="token class-name">Instance</span><span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">'hi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">13</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">14</span></div><br><div class="line-0-0-16 " data-content="    private void say(String sayString) {"><span class="lineCounter-0-0-15 prim">15</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token class-name">String</span> sayString<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        System.debug(sayString);"><span class="lineCounter-0-0-15">16</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>sayString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">17</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">18</span><span class="token punctuation">}</span></div><br></code></pre><p>With that in mind, let's streamline this implementation:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/Rollbar.cls</span></span><div class="line-0-0-16 " data-content="private final Http http;"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Http</span> http<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="private final RollbarDataBuilder dataBuilder;"><span class="lineCounter-0-0-15">2</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RollbarDataBuilder</span> dataBuilder<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="private static final String API_URI = 'https://api.rollbar.com/api/1/item/';"><span class="lineCounter-0-0-15">4</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> API_URI <span class="token operator">=</span> <span class="token string">'https://api.rollbar.com/api/1/item/'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">5</span></div><br><div class="line-0-0-16 " data-content="public enum Level { Critical, Debug, Error, Info, Warning }"><span class="lineCounter-0-0-15">6</span><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Level</span> <span class="token punctuation">{</span> <span class="token class-name">Critical</span><span class="token punctuation">,</span> <span class="token class-name">Debug</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">Info</span><span class="token punctuation">,</span> <span class="token class-name">Warning</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">7</span></div><br><div class="line-0-0-16 " data-content="private Rollbar() {"><span class="lineCounter-0-0-15">8</span><span class="token keyword">private</span> <span class="token class-name">Rollbar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.dataBuilder = new RollbarDataBuilder();"><span class="lineCounter-0-0-15">9</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dataBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RollbarDataBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.http = new Http();"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Http</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">11</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">12</span></div><br><div class="line-0-0-16 " data-content="public static final Rollbar Instance = new Rollbar();"><span class="lineCounter-0-0-15">13</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Rollbar</span> <span class="token class-name">Instance</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rollbar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">14</span></div><br><div class="line-0-0-16 " data-content="public static HttpResponse log(Level level, String message) {"><span class="lineCounter-0-0-15 prim">15</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResponse</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Level</span> level<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    Message payload = Instance.dataBuilder.build(level, message);"><span class="lineCounter-0-0-15">16</span>    <span class="token class-name">Message</span> payload <span class="token operator">=</span> <span class="token class-name">Instance</span><span class="token punctuation">.</span>dataBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    return send(payload);"><span class="lineCounter-0-0-15">17</span>    <span class="token keyword">return</span> <span class="token function">send</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">18</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">19</span></div><br><div class="line-0-0-16 " data-content="public static HttpResponse log(Exception ex) {"><span class="lineCounter-0-0-15 prim">20</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResponse</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    Message payload = Instance.dataBuilder.build(ex);"><span class="lineCounter-0-0-15">21</span>    <span class="token class-name">Message</span> payload <span class="token operator">=</span> <span class="token class-name">Instance</span><span class="token punctuation">.</span>dataBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    return send(payload);"><span class="lineCounter-0-0-15">22</span>    <span class="token keyword">return</span> <span class="token function">send</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">23</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">24</span></div><br><div class="line-0-0-16 " data-content="private static HttpResponse send(Message payload) {"><span class="lineCounter-0-0-15 prim">25</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">HttpResponse</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Message</span> payload<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    HttpRequest request = new HttpRequest();"><span class="lineCounter-0-0-15">26</span>    <span class="token class-name">HttpRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    request.setEndpoint(API_URI);"><span class="lineCounter-0-0-15">27</span>    request<span class="token punctuation">.</span><span class="token function">setEndpoint</span><span class="token punctuation">(</span>API_URI<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    request.setMethod(RestMethod.POST.name());"><span class="lineCounter-0-0-15">28</span>    request<span class="token punctuation">.</span><span class="token function">setMethod</span><span class="token punctuation">(</span><span class="token class-name">RestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    //Rollbar only wants non-null properties sent over"><span class="lineCounter-0-0-15">29</span>    <span class="token comment">//Rollbar only wants non-null properties sent over</span></div><br><div class="line-0-0-16 " data-content="    //The second argument suppresses null values"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token comment">//The second argument suppresses null values</span></div><br><div class="line-0-0-16 " data-content="    request.setBody(Json.serialize(payload, true));"><span class="lineCounter-0-0-15">31</span>    request<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token class-name">Json</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">32</span></div><br><div class="line-0-0-16 " data-content="    HttpResponse res = Instance.http.send(request);"><span class="lineCounter-0-0-15">33</span>    <span class="token class-name">HttpResponse</span> res <span class="token operator">=</span> <span class="token class-name">Instance</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    if(res.getStatusCode() != 200) {"><span class="lineCounter-0-0-15">34</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        throw new CalloutException("><span class="lineCounter-0-0-15 prim">35</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CalloutException</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="            'Rollbar callout failed with response: ' + res.getBody()"><span class="lineCounter-0-0-15">36</span>            <span class="token string">'Rollbar callout failed with response: '</span> <span class="token operator">+</span> res<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="        );"><span class="lineCounter-0-0-15">37</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">38</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    return res;"><span class="lineCounter-0-0-15">39</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">40</span><span class="token punctuation">}</span></div><br></code></pre><p>So what we have gained? We killed off the Notifier class (which wasn't shown, but also was just wrapping calls to the DataBuilder) in favor of the Rollbar object encapsulating the full callout. We got rid of a bunch of boilerplate related to initialization. We traded string constants for a <code>Rollbar.Level</code> enum which can easily be understood as the severity of the log being sent.</p><p>The astute reader might note that I'm not following the pattern I prescribed in <a href="/joys-of-apex/future-method-callout-callback/">Future Methods, Callouts &amp; Callbacks</a>. You'd be exactly right in saying that, but I was recently reminded of this age-old adage while reading <a href="https://jesseduffield.com/in-react-the-wrong-abstraction-kills-efficiency/">something that came up on the React subreddit</a>:</p><blockquote><p>Duplication is far cheaper than the wrong abstraction</p></blockquote><p>The Callout &amp; Callback pattern that I documented previously is great when you have many consumers whose post-callout behavior is tightly coupled to interactions with the database or further processing is necessary. In this case, however, it would be a mistake to try to shoehorn this specific logging implementation into an abstraction meant for post-processing ... especially because having the Http object as a member of the Rollbar class will prove helpful for fully testing everything out.</p><p>But I'm getting ahead of myself. What does this <code>DataBuilder</code> object look like?</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/DataBuilder.cls</span></span><div class="line-0-0-16 " data-content="public with sharing class DataBuilder {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">with</span> sharing <span class="token keyword">class</span> <span class="token class-name">DataBuilder</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public DataBuilder(Config config) {"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">public</span> <span class="token class-name">DataBuilder</span><span class="token punctuation">(</span><span class="token class-name">Config</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.config = config;"><span class="lineCounter-0-0-15">3</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">4</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">5</span></div><br><div class="line-0-0-16 " data-content="    public Map<String, Object> buildPayload(String level, String message)"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildPayload</span><span class="token punctuation">(</span><span class="token class-name">String</span> level<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    {"><span class="lineCounter-0-0-15">7</span>    <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return buildPayloadStructure(level, buildMessageBody(message), null);"><span class="lineCounter-0-0-15">8</span>        <span class="token keyword">return</span> <span class="token function">buildPayloadStructure</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> <span class="token function">buildMessageBody</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">9</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="    public Map<String, Object> buildPayload(Exception exc)"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildPayload</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exc<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    {"><span class="lineCounter-0-0-15">12</span>    <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return buildPayloadStructure('error', buildExceptionBody(exc), null);"><span class="lineCounter-0-0-15">13</span>        <span class="token keyword">return</span> <span class="token function">buildPayloadStructure</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token function">buildExceptionBody</span><span class="token punctuation">(</span>exc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">14</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">15</span></div><br><div class="line-0-0-16 " data-content="    public Map<String, Object> buildPayload(Exception exc, Map<String, Object> custom)"><span class="lineCounter-0-0-15">16</span>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildPayload</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exc<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> custom<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    {"><span class="lineCounter-0-0-15">17</span>    <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return buildPayloadStructure('error', buildExceptionBody(exc), custom);"><span class="lineCounter-0-0-15">18</span>        <span class="token keyword">return</span> <span class="token function">buildPayloadStructure</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token function">buildExceptionBody</span><span class="token punctuation">(</span>exc<span class="token punctuation">)</span><span class="token punctuation">,</span> custom<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">19</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">20</span></div><br><div class="line-0-0-16 " data-content="    public Map<String, Object> buildPayload(ExceptionData exData)"><span class="lineCounter-0-0-15">21</span>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildPayload</span><span class="token punctuation">(</span><span class="token class-name">ExceptionData</span> exData<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    {"><span class="lineCounter-0-0-15">22</span>    <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> custom = new Map<String, Object>();"><span class="lineCounter-0-0-15">23</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> custom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        custom.put('context', exData.context());"><span class="lineCounter-0-0-15">24</span>        custom<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'context'</span><span class="token punctuation">,</span> exData<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">25</span></div><br><div class="line-0-0-16 " data-content="        return buildPayloadStructure('error', buildTraceBody(exData), custom);"><span class="lineCounter-0-0-15">26</span>        <span class="token keyword">return</span> <span class="token function">buildPayloadStructure</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token function">buildTraceBody</span><span class="token punctuation">(</span>exData<span class="token punctuation">)</span><span class="token punctuation">,</span> custom<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">27</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">28</span></div><br><div class="line-0-0-16 " data-content="    private Map<String, Object> buildExceptionBody(Exception exc)"><span class="lineCounter-0-0-15">29</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildExceptionBody</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exc<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    {"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        if (exc.getCause() == null) {"><span class="lineCounter-0-0-15">31</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>exc<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            return buildTraceBody(exc);"><span class="lineCounter-0-0-15">32</span>            <span class="token keyword">return</span> <span class="token function">buildTraceBody</span><span class="token punctuation">(</span>exc<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        } else {"><span class="lineCounter-0-0-15">33</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            return buildTraceChainBody(exc);"><span class="lineCounter-0-0-15">34</span>            <span class="token keyword">return</span> <span class="token function">buildTraceChainBody</span><span class="token punctuation">(</span>exc<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15 prim">35</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">36</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">37</span></div><br><div class="line-0-0-16 " data-content="    private Map<String, Object> buildTraceChainBody(Exception exc)"><span class="lineCounter-0-0-15">38</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildTraceChainBody</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exc<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    {"><span class="lineCounter-0-0-15">39</span>    <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> outterExTrace = (Map<String, Object>)"><span class="lineCounter-0-0-15 prim">40</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> outterExTrace <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="            this.buildTraceBody(exc).get('trace');"><span class="lineCounter-0-0-15">41</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildTraceBody</span><span class="token punctuation">(</span>exc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'trace'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> innerExTrace = (Map<String, Object>)"><span class="lineCounter-0-0-15">42</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> innerExTrace <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="            this.buildTraceBody(exc.getCause()).get('trace');"><span class="lineCounter-0-0-15">43</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildTraceBody</span><span class="token punctuation">(</span>exc<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'trace'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">44</span></div><br><div class="line-0-0-16 " data-content="        List<Map<String, Object>> traceChainList = new List<Map<String, Object>>();"><span class="lineCounter-0-0-15 prim">45</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> traceChainList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        traceChainList.add(outterExTrace);"><span class="lineCounter-0-0-15">46</span>        traceChainList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outterExTrace<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        traceChainList.add(innerExTrace);"><span class="lineCounter-0-0-15">47</span>        traceChainList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>innerExTrace<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">48</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">49</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> body = new Map<String, Object>();"><span class="lineCounter-0-0-15 prim">50</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        body.put('trace_chain', traceChainList);"><span class="lineCounter-0-0-15">51</span>        body<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'trace_chain'</span><span class="token punctuation">,</span> traceChainList<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">52</span></div><br><div class="line-0-0-16 " data-content="        return body;"><span class="lineCounter-0-0-15">53</span>        <span class="token keyword">return</span> body<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">54</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">55</span></div><br><div class="line-0-0-16 " data-content="    private Map<String, Object> buildPayloadStructure("><span class="lineCounter-0-0-15">56</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildPayloadStructure</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        String level,"><span class="lineCounter-0-0-15">57</span>        <span class="token class-name">String</span> level<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> body,"><span class="lineCounter-0-0-15">58</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> body<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> custom"><span class="lineCounter-0-0-15">59</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> custom</div><br><div class="line-0-0-16 " data-content="    ) {"><span class="lineCounter-0-0-15 prim">60</span>    <span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> data = this.buildDataStructure("><span class="lineCounter-0-0-15">61</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildDataStructure</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="            level,"><span class="lineCounter-0-0-15">62</span>            level<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            this.config.environment(),"><span class="lineCounter-0-0-15">63</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">environment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            body,"><span class="lineCounter-0-0-15">64</span>            body<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            custom"><span class="lineCounter-0-0-15 prim">65</span>            custom</div><br><div class="line-0-0-16 " data-content="        );"><span class="lineCounter-0-0-15">66</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">67</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> structure = new Map<String, Object>();"><span class="lineCounter-0-0-15">68</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> structure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        structure.put('access_token', this.config.accessToken());"><span class="lineCounter-0-0-15">69</span>        structure<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'access_token'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">accessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        structure.put('data', data);"><span class="lineCounter-0-0-15 prim">70</span>        structure<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return structure;"><span class="lineCounter-0-0-15">71</span>        <span class="token keyword">return</span> structure<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">72</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">73</span></div><br><div class="line-0-0-16 " data-content="    private Map<String, Object> buildDataStructure("><span class="lineCounter-0-0-15">74</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildDataStructure</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        String level,"><span class="lineCounter-0-0-15 prim">75</span>        <span class="token class-name">String</span> level<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        String environment,"><span class="lineCounter-0-0-15">76</span>        <span class="token class-name">String</span> environment<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> body,"><span class="lineCounter-0-0-15">77</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> body<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> custom"><span class="lineCounter-0-0-15">78</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> custom</div><br><div class="line-0-0-16 " data-content="    ) {"><span class="lineCounter-0-0-15">79</span>    <span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">80</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> notifierMap = new Map<String, Object>();"><span class="lineCounter-0-0-15">81</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> notifierMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        notifierMap.put('name', Notifier.NAME);"><span class="lineCounter-0-0-15">82</span>        notifierMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token class-name">Notifier</span><span class="token punctuation">.</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        notifierMap.put('version', Notifier.VERSION);"><span class="lineCounter-0-0-15">83</span>        notifierMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'version'</span><span class="token punctuation">,</span> <span class="token class-name">Notifier</span><span class="token punctuation">.</span>VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">84</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> structure = new Map<String, Object>();"><span class="lineCounter-0-0-15 prim">85</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> structure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        structure.put('notifier', notifierMap);"><span class="lineCounter-0-0-15">86</span>        structure<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'notifier'</span><span class="token punctuation">,</span> notifierMap<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        structure.put('level', level);"><span class="lineCounter-0-0-15">87</span>        structure<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'level'</span><span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        structure.put('environment', environment);"><span class="lineCounter-0-0-15">88</span>        structure<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'environment'</span><span class="token punctuation">,</span> environment<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        structure.put('framework', 'apex');"><span class="lineCounter-0-0-15">89</span>        structure<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'framework'</span><span class="token punctuation">,</span> <span class="token string">'apex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        structure.put('body', body);"><span class="lineCounter-0-0-15 prim">90</span>        structure<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        structure.put('custom', custom);"><span class="lineCounter-0-0-15">91</span>        structure<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'custom'</span><span class="token punctuation">,</span> custom<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">92</span></div><br><div class="line-0-0-16 " data-content="        return structure;"><span class="lineCounter-0-0-15">93</span>        <span class="token keyword">return</span> structure<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">94</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">95</span></div><br><div class="line-0-0-16 " data-content="    private Map<String, Object> buildMessageBody(String message)"><span class="lineCounter-0-0-15">96</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildMessageBody</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    {"><span class="lineCounter-0-0-15">97</span>    <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> messageMap = new Map<String, Object>();"><span class="lineCounter-0-0-15">98</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> messageMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        messageMap.put('body', message);"><span class="lineCounter-0-0-15">99</span>        messageMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">100</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> body = new Map<String, Object>();"><span class="lineCounter-0-0-15">101</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        body.put('message', messageMap);"><span class="lineCounter-0-0-15">102</span>        body<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> messageMap<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">103</span></div><br><div class="line-0-0-16 " data-content="        return body;"><span class="lineCounter-0-0-15">104</span>        <span class="token keyword">return</span> body<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">105</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">106</span></div><br><div class="line-0-0-16 " data-content="    private Map<String, Object> buildTraceBody(ExceptionData exData)"><span class="lineCounter-0-0-15">107</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildTraceBody</span><span class="token punctuation">(</span><span class="token class-name">ExceptionData</span> exData<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    {"><span class="lineCounter-0-0-15">108</span>    <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<Map<String, Object>> framesList = new List<Map<String, Object>>();"><span class="lineCounter-0-0-15">109</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> framesList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">110</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> frameMap = new Map<String, Object>();"><span class="lineCounter-0-0-15">111</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> frameMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        frameMap.put('filename', exData.fileName());"><span class="lineCounter-0-0-15">112</span>        frameMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">,</span> exData<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        frameMap.put('class_name', exData.className());"><span class="lineCounter-0-0-15">113</span>        frameMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'class_name'</span><span class="token punctuation">,</span> exData<span class="token punctuation">.</span><span class="token function">className</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        frameMap.put('method', exData.fileName());"><span class="lineCounter-0-0-15">114</span>        frameMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'method'</span><span class="token punctuation">,</span> exData<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        frameMap.put('lineno', exData.line());"><span class="lineCounter-0-0-15 prim">115</span>        frameMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'lineno'</span><span class="token punctuation">,</span> exData<span class="token punctuation">.</span><span class="token function">line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        frameMap.put('colno', exData.column());"><span class="lineCounter-0-0-15">116</span>        frameMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'colno'</span><span class="token punctuation">,</span> exData<span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">117</span></div><br><div class="line-0-0-16 " data-content="        framesList.add(frameMap);"><span class="lineCounter-0-0-15">118</span>        framesList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>frameMap<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">119</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> excMap = new Map<String, Object>();"><span class="lineCounter-0-0-15 prim">120</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> excMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        excMap.put('class', exData.className());"><span class="lineCounter-0-0-15">121</span>        excMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> exData<span class="token punctuation">.</span><span class="token function">className</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        excMap.put('message', exData.message());"><span class="lineCounter-0-0-15">122</span>        excMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> exData<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">123</span></div><br><div class="line-0-0-16 " data-content="        return buildTraceStructure(excMap, framesList);"><span class="lineCounter-0-0-15">124</span>        <span class="token keyword">return</span> <span class="token function">buildTraceStructure</span><span class="token punctuation">(</span>excMap<span class="token punctuation">,</span> framesList<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">125</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">126</span></div><br><div class="line-0-0-16 " data-content="    private Map<String, Object> buildTraceBody(Exception exc)"><span class="lineCounter-0-0-15">127</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildTraceBody</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exc<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    {"><span class="lineCounter-0-0-15">128</span>    <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        List<Map<String, Object>> framesList = new List<Map<String, Object>>();"><span class="lineCounter-0-0-15">129</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> framesList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">130</span></div><br><div class="line-0-0-16 " data-content="        String[] frames = exc.getStackTraceString().split('\n');"><span class="lineCounter-0-0-15">131</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> frames <span class="token operator">=</span> exc<span class="token punctuation">.</span><span class="token function">getStackTraceString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        for (String frameStr : frames) {"><span class="lineCounter-0-0-15">132</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> frameStr <span class="token operator">:</span> frames<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            if (frameStr == '()') {"><span class="lineCounter-0-0-15">133</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>frameStr <span class="token operator">==</span> <span class="token string">'()'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                continue;"><span class="lineCounter-0-0-15">134</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            } else if (frameStr.toLowerCase() == 'caused by') {"><span class="lineCounter-0-0-15 prim">135</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frameStr<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'caused by'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                break;"><span class="lineCounter-0-0-15">136</span>                <span class="token keyword">break</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">137</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">138</span></div><br><div class="line-0-0-16 " data-content="            Map<String, Object> frameMap = new Map<String, Object>();"><span class="lineCounter-0-0-15">139</span>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> frameMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            frameMap.put('filename', frameStr);"><span class="lineCounter-0-0-15 prim">140</span>            frameMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">,</span> frameStr<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">141</span></div><br><div class="line-0-0-16 " data-content="            String className = frameStr.split(':')[0];"><span class="lineCounter-0-0-15">142</span>            <span class="token class-name">String</span> className <span class="token operator">=</span> frameStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            String methodName = '';"><span class="lineCounter-0-0-15">143</span>            <span class="token class-name">String</span> methodName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            if (className != 'AnonymousBlock') {"><span class="lineCounter-0-0-15">144</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">!=</span> <span class="token string">'AnonymousBlock'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                className = className.split('\\.')[1];"><span class="lineCounter-0-0-15 prim">145</span>                className <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="                methodName = frameStr.split(':')[0].split('\\.')[2];"><span class="lineCounter-0-0-15">146</span>                methodName <span class="token operator">=</span> frameStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">147</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">148</span></div><br><div class="line-0-0-16 " data-content="            frameMap.put('class_name', className);"><span class="lineCounter-0-0-15">149</span>            frameMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'class_name'</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            frameMap.put('method', methodName);"><span class="lineCounter-0-0-15 prim">150</span>            frameMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'method'</span><span class="token punctuation">,</span> methodName<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">151</span></div><br><div class="line-0-0-16 " data-content="            Pattern linePattern = Pattern.compile('line (\\d+)');"><span class="lineCounter-0-0-15">152</span>            <span class="token class-name">Pattern</span> linePattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">'line (\\d+)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            Matcher lineMatcher = linePattern.matcher(frameStr);"><span class="lineCounter-0-0-15">153</span>            <span class="token class-name">Matcher</span> lineMatcher <span class="token operator">=</span> linePattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>frameStr<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            lineMatcher.find();"><span class="lineCounter-0-0-15">154</span>            lineMatcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            frameMap.put('lineno', Integer.valueOf(lineMatcher.group(1)));"><span class="lineCounter-0-0-15 prim">155</span>            frameMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'lineno'</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>lineMatcher<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">156</span></div><br><div class="line-0-0-16 " data-content="            Pattern colPattern = Pattern.compile('column (\\d+)');"><span class="lineCounter-0-0-15">157</span>            <span class="token class-name">Pattern</span> colPattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">'column (\\d+)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            Matcher colMatcher = colPattern.matcher(frameStr);"><span class="lineCounter-0-0-15">158</span>            <span class="token class-name">Matcher</span> colMatcher <span class="token operator">=</span> colPattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>frameStr<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            colMatcher.find();"><span class="lineCounter-0-0-15">159</span>            colMatcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            frameMap.put('colno', Integer.valueOf(colMatcher.group(1)));"><span class="lineCounter-0-0-15 prim">160</span>            frameMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'colno'</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>colMatcher<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">161</span></div><br><div class="line-0-0-16 " data-content="            framesList.add(frameMap);"><span class="lineCounter-0-0-15">162</span>            framesList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>frameMap<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">163</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">164</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> excMap = new Map<String, Object>();"><span class="lineCounter-0-0-15 prim">165</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> excMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        excMap.put('class', exc.getTypeName());"><span class="lineCounter-0-0-15">166</span>        excMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> exc<span class="token punctuation">.</span><span class="token function">getTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        excMap.put('message', exc.getMessage());"><span class="lineCounter-0-0-15">167</span>        excMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> exc<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">168</span></div><br><div class="line-0-0-16 " data-content="        return buildTraceStructure(excMap, framesList);"><span class="lineCounter-0-0-15">169</span>        <span class="token keyword">return</span> <span class="token function">buildTraceStructure</span><span class="token punctuation">(</span>excMap<span class="token punctuation">,</span> framesList<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">170</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">171</span></div><br><div class="line-0-0-16 " data-content="    private Map<String, Object> buildTraceStructure("><span class="lineCounter-0-0-15">172</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildTraceStructure</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> exceptionMap,"><span class="lineCounter-0-0-15">173</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> exceptionMap<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        List<Map<String, Object>> framesList"><span class="lineCounter-0-0-15">174</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> framesList</div><br><div class="line-0-0-16 " data-content="    ) {"><span class="lineCounter-0-0-15 prim">175</span>    <span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> body = new Map<String, Object>();"><span class="lineCounter-0-0-15">176</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">177</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> traceMap = new Map<String, Object>();"><span class="lineCounter-0-0-15">178</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> traceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">179</span></div><br><div class="line-0-0-16 " data-content="        traceMap.put('exception', exceptionMap);"><span class="lineCounter-0-0-15 prim">180</span>        traceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'exception'</span><span class="token punctuation">,</span> exceptionMap<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        traceMap.put('frames', framesList);"><span class="lineCounter-0-0-15">181</span>        traceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'frames'</span><span class="token punctuation">,</span> framesList<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">182</span></div><br><div class="line-0-0-16 " data-content="        body.put('trace', traceMap);"><span class="lineCounter-0-0-15">183</span>        body<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'trace'</span><span class="token punctuation">,</span> traceMap<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">184</span></div><br><div class="line-0-0-16 " data-content="        return body;"><span class="lineCounter-0-0-15 prim">185</span>        <span class="token keyword">return</span> body<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">186</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">187</span></div><br><div class="line-0-0-16 " data-content="    private Config config;"><span class="lineCounter-0-0-15">188</span>    <span class="token keyword">private</span> <span class="token class-name">Config</span> config<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">189</span><span class="token punctuation">}</span></div><br></code></pre><p>Eep. Hopefully you just scrolled through that at a rapid staccato. We're using a strongly-typed language -- let's try to take advantage of that to cut down on some of the string maps here. We can also make use of the same <code>Rollbar.Level</code> enum introduced above, making it easier to differentiate between method arguments. Unfortunately, not everything will be able to be strongly typed -- if you'll notice, the JSON object that's being built here makes use of two properties, <code>exception</code> and <code>class</code>, both of which are <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_reserved_words.htm">reserved keywords in Apex</a>.</p><p>Again, since the JSON object that's being built is singularly constrained to use with Rollbar, I'm less concerned with the tight coupling between this DataBuilder object and the Rollbar class, and more concerned with how I'd like to refer to things within a "Rollbar namespace" -- in other words, let's put those strongly typed classes into the Rollbar class, and rename the "DataBuilder" so that it's the "RollbarDataBuilder". That's idomatic Apex -- typings to help us and our tests verify that things are being shaped correctly, with descriptive names to assist:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/Rollbar.cls</span></span><div class="line-0-0-16 " data-content="public class Message {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public String access_token { get; set; }"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> access_token <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public Data data { get; set; }"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">public</span> <span class="token class-name">Data</span> data <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">4</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">5</span></div><br><div class="line-0-0-16 " data-content="public class Data {"><span class="lineCounter-0-0-15">6</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Data</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public Data() {"><span class="lineCounter-0-0-15">7</span>    <span class="token keyword">public</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        notifier = new Notifier();"><span class="lineCounter-0-0-15">8</span>        notifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">9</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public Notifier notifier { get; set; }"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token keyword">public</span> <span class="token class-name">Notifier</span> notifier <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public String level { get; set; }"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> level <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public String environment { get; set; }"><span class="lineCounter-0-0-15">12</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> environment <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public String framework { get { set; }"><span class="lineCounter-0-0-15">13</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> framework <span class="token punctuation">{</span> get <span class="token punctuation">{</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public MessageBody body { get; set; }"><span class="lineCounter-0-0-15">14</span>    <span class="token keyword">public</span> <span class="token class-name">MessageBody</span> body <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">15</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">16</span></div><br><div class="line-0-0-16 " data-content="public class MessageBody {"><span class="lineCounter-0-0-15">17</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageBody</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    //trace can't be strongly typed because"><span class="lineCounter-0-0-15">18</span>    <span class="token comment">//trace can't be strongly typed because</span></div><br><div class="line-0-0-16 " data-content="    //it has a property named &quot;exception&quot;"><span class="lineCounter-0-0-15">19</span>    <span class="token comment">//it has a property named "exception"</span></div><br><div class="line-0-0-16 " data-content="    //which is a reserved word in Apex"><span class="lineCounter-0-0-15 prim">20</span>    <span class="token comment">//which is a reserved word in Apex</span></div><br><div class="line-0-0-16 " data-content="    //the &quot;exception&quot; property also has &quot;class&quot; and &quot;message&quot;"><span class="lineCounter-0-0-15">21</span>    <span class="token comment">//the "exception" property also has "class" and "message"</span></div><br><div class="line-0-0-16 " data-content="    //strings, and &quot;class&quot; is another reserved word"><span class="lineCounter-0-0-15">22</span>    <span class="token comment">//strings, and "class" is another reserved word</span></div><br><div class="line-0-0-16 " data-content="    public Map<String, Object> trace { get; set; }"><span class="lineCounter-0-0-15">23</span>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> trace <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public List<Map<String, Object>> trace_chain { get; set; }"><span class="lineCounter-0-0-15">24</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> trace_chain <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public InnerMessage message { get; set; }"><span class="lineCounter-0-0-15 prim">25</span>    <span class="token keyword">public</span> <span class="token class-name">InnerMessage</span> message <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">26</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">27</span></div><br><div class="line-0-0-16 " data-content="public class InnerMessage {"><span class="lineCounter-0-0-15">28</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InnerMessage</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public String body { get; set; }"><span class="lineCounter-0-0-15">29</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> body <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">30</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">31</span></div><br><div class="line-0-0-16 " data-content="public class Notifier {"><span class="lineCounter-0-0-15">32</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Notifier</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public String name { get; set;}"><span class="lineCounter-0-0-15">33</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> name <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public String version { get; set; }"><span class="lineCounter-0-0-15">34</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> version <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">35</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">36</span></div><br><div class="line-0-0-16 " data-content="public class ExceptionFrame {"><span class="lineCounter-0-0-15">37</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionFrame</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public String filename { get; set; }"><span class="lineCounter-0-0-15">38</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> filename <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public String class_name { get; set; }"><span class="lineCounter-0-0-15">39</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> class_name <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public String method { get; set; }"><span class="lineCounter-0-0-15 prim">40</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> method <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public Integer lineno { get; set; }"><span class="lineCounter-0-0-15">41</span>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> lineno <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public Integer colno { get; set; }"><span class="lineCounter-0-0-15">42</span>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> colno <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">43</span><span class="token punctuation">}</span></div><br></code></pre><p>So we get a bunch of <a href="https://en.wikipedia.org/wiki/Plain_old_Java_object">POJOs</a>, which thanks to IDE intellisense are going to prove enormously helpful in making clear the shape of the log objects being constructed.</p><p>And the much-reduced <code>RollbarDataBuilder</code>:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/RollbarDataBuilder.cls</span></span><div class="line-0-0-16 " data-content="public class RollbarDataBuilder {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RollbarDataBuilder</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public static final String FRAMEWORK = 'apex';"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FRAMEWORK <span class="token operator">=</span> <span class="token string">'apex'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    public static final String NAME = 'rollbar-sf-apex';"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> NAME <span class="token operator">=</span> <span class="token string">'rollbar-sf-apex'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    public static final String VERSION = '1.0.0';"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> VERSION <span class="token operator">=</span> <span class="token string">'1.0.0'</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">5</span></div><br><div class="line-0-0-16 " data-content="    public Rollbar.Message build(Rollbar.Level level, String message) {"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">public</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Message</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Level</span> level<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return buildPayloadStructure(level, buildMessageBody(message));"><span class="lineCounter-0-0-15">7</span>        <span class="token keyword">return</span> <span class="token function">buildPayloadStructure</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> <span class="token function">buildMessageBody</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">8</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">9</span></div><br><div class="line-0-0-16 " data-content="    public Rollbar.Message build(Exception ex) {"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token keyword">public</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Message</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        return buildPayloadStructure(Rollbar.Level.Error, buildExceptionBody(ex));"><span class="lineCounter-0-0-15">11</span>        <span class="token keyword">return</span> <span class="token function">buildPayloadStructure</span><span class="token punctuation">(</span><span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Level</span><span class="token punctuation">.</span><span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token function">buildExceptionBody</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">12</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">13</span></div><br><div class="line-0-0-16 " data-content="    private Rollbar.Message buildPayloadStructure("><span class="lineCounter-0-0-15">14</span>    <span class="token keyword">private</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Message</span> <span class="token function">buildPayloadStructure</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        Rollbar.Level level,"><span class="lineCounter-0-0-15 prim">15</span>        <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Level</span> level<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        Rollbar.MessageBody body) {"><span class="lineCounter-0-0-15">16</span>        <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Rollbar.Message message = new Rollbar.Message();"><span class="lineCounter-0-0-15">17</span>        <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        //wherever you store secrets, be it a custom setting, object, or metadata"><span class="lineCounter-0-0-15">18</span>        <span class="token comment">//wherever you store secrets, be it a custom setting, object, or metadata</span></div><br><div class="line-0-0-16 " data-content="        message.access_token = someValue;"><span class="lineCounter-0-0-15">19</span>        message<span class="token punctuation">.</span>access_token <span class="token operator">=</span> someValue<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        message.data = this.buildDataStructure(level, body);"><span class="lineCounter-0-0-15 prim">20</span>        message<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildDataStructure</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return message;"><span class="lineCounter-0-0-15">21</span>        <span class="token keyword">return</span> message<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">22</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">23</span></div><br><div class="line-0-0-16 " data-content="    private Rollbar.Data buildDataStructure(Rollbar.Level level,"><span class="lineCounter-0-0-15">24</span>    <span class="token keyword">private</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Data</span> <span class="token function">buildDataStructure</span><span class="token punctuation">(</span><span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Level</span> level<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        Rollbar.MessageBody body) {"><span class="lineCounter-0-0-15 prim">25</span>        <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Rollbar.Data data = new Rollbar.Data();"><span class="lineCounter-0-0-15">26</span>        <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Data</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        data.body = body;"><span class="lineCounter-0-0-15">27</span>        data<span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        //I didn't like using the Org name, preferring the granularity of the Org URL."><span class="lineCounter-0-0-15">28</span>        <span class="token comment">//I didn't like using the Org name, preferring the granularity of the Org URL.</span></div><br><div class="line-0-0-16 " data-content="        // You could realistically put any kind of domain-recognizable identifier here."><span class="lineCounter-0-0-15">29</span>        <span class="token comment">// You could realistically put any kind of domain-recognizable identifier here.</span></div><br><div class="line-0-0-16 " data-content="        data.environment = Url.getSalesforceBaseUrl().toExternalForm();"><span class="lineCounter-0-0-15 prim">30</span>        data<span class="token punctuation">.</span>environment <span class="token operator">=</span> <span class="token class-name">Url</span><span class="token punctuation">.</span><span class="token function">getSalesforceBaseUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toExternalForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        data.framework = FRAMEWORK;"><span class="lineCounter-0-0-15">31</span>        data<span class="token punctuation">.</span>framework <span class="token operator">=</span> FRAMEWORK<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        data.level = level.name().toLowerCase();"><span class="lineCounter-0-0-15">32</span>        data<span class="token punctuation">.</span>level <span class="token operator">=</span> level<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        data.notifier.name = NAME;"><span class="lineCounter-0-0-15">33</span>        data<span class="token punctuation">.</span>notifier<span class="token punctuation">.</span>name <span class="token operator">=</span> NAME<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        data.notifier.version = VERSION;"><span class="lineCounter-0-0-15">34</span>        data<span class="token punctuation">.</span>notifier<span class="token punctuation">.</span>version <span class="token operator">=</span> VERSION<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return data;"><span class="lineCounter-0-0-15 prim">35</span>        <span class="token keyword">return</span> data<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">36</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">37</span></div><br><div class="line-0-0-16 " data-content="    private Rollbar.MessageBody buildMessageBody(String messageBody) {"><span class="lineCounter-0-0-15">38</span>    <span class="token keyword">private</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span> <span class="token function">buildMessageBody</span><span class="token punctuation">(</span><span class="token class-name">String</span> messageBody<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Rollbar.InnerMessage innerMessage = new Rollbar.InnerMessage();"><span class="lineCounter-0-0-15">39</span>        <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">InnerMessage</span> innerMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">InnerMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        innerMessage.body = messageBody;"><span class="lineCounter-0-0-15 prim">40</span>        innerMessage<span class="token punctuation">.</span>body <span class="token operator">=</span> messageBody<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">41</span></div><br><div class="line-0-0-16 " data-content="        Rollbar.MessageBody body = new Rollbar.MessageBody();"><span class="lineCounter-0-0-15">42</span>        <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        body.message = innerMessage;"><span class="lineCounter-0-0-15">43</span>        body<span class="token punctuation">.</span>message <span class="token operator">=</span> innerMessage<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return body;"><span class="lineCounter-0-0-15">44</span>        <span class="token keyword">return</span> body<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15 prim">45</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">46</span></div><br><div class="line-0-0-16 " data-content="    private Rollbar.MessageBody buildExceptionBody(Exception ex) {"><span class="lineCounter-0-0-15">47</span>    <span class="token keyword">private</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span> <span class="token function">buildExceptionBody</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        if (ex.getCause() == null) {"><span class="lineCounter-0-0-15">48</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            return buildTraceMessage(ex);"><span class="lineCounter-0-0-15">49</span>            <span class="token keyword">return</span> <span class="token function">buildTraceMessage</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        } else {"><span class="lineCounter-0-0-15 prim">50</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            return buildTraceChainBody(ex);"><span class="lineCounter-0-0-15">51</span>            <span class="token keyword">return</span> <span class="token function">buildTraceChainBody</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">52</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">53</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">54</span></div><br><div class="line-0-0-16 " data-content="    private Rollbar.MessageBody buildTraceMessage(Exception ex) {"><span class="lineCounter-0-0-15 prim">55</span>    <span class="token keyword">private</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span> <span class="token function">buildTraceMessage</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        //note that while the typings have changed in this method"><span class="lineCounter-0-0-15">56</span>        <span class="token comment">//note that while the typings have changed in this method</span></div><br><div class="line-0-0-16 " data-content="        //the underlying logic I left alone."><span class="lineCounter-0-0-15">57</span>        <span class="token comment">//the underlying logic I left alone.</span></div><br><div class="line-0-0-16 " data-content="        List<Rollbar.ExceptionFrame> framesList = new List<Rollbar.ExceptionFrame>();"><span class="lineCounter-0-0-15">58</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">ExceptionFrame</span><span class="token punctuation">&gt;</span></span> framesList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">ExceptionFrame</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">59</span></div><br><div class="line-0-0-16 " data-content="        String[] frames = ex.getStackTraceString().split('\n');"><span class="lineCounter-0-0-15 prim">60</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> frames <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getStackTraceString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        for (String frameStr : frames) {"><span class="lineCounter-0-0-15">61</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> frameStr <span class="token operator">:</span> frames<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            if (frameStr == '()') {"><span class="lineCounter-0-0-15">62</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>frameStr <span class="token operator">==</span> <span class="token string">'()'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                continue;"><span class="lineCounter-0-0-15">63</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            } else if (frameStr.toLowerCase() == 'caused by') {"><span class="lineCounter-0-0-15">64</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frameStr<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'caused by'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                break;"><span class="lineCounter-0-0-15 prim">65</span>                <span class="token keyword">break</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">66</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">67</span></div><br><div class="line-0-0-16 " data-content="            Rollbar.ExceptionFrame frame = new Rollbar.ExceptionFrame();"><span class="lineCounter-0-0-15">68</span>            <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">ExceptionFrame</span> frame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">ExceptionFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            frame.filename = frameStr;"><span class="lineCounter-0-0-15">69</span>            frame<span class="token punctuation">.</span>filename <span class="token operator">=</span> frameStr<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">70</span></div><br><div class="line-0-0-16 " data-content="            String className = frameStr.split(':')[0];"><span class="lineCounter-0-0-15">71</span>            <span class="token class-name">String</span> className <span class="token operator">=</span> frameStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            String methodName = '';"><span class="lineCounter-0-0-15">72</span>            <span class="token class-name">String</span> methodName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            if (className != 'AnonymousBlock') {"><span class="lineCounter-0-0-15">73</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">!=</span> <span class="token string">'AnonymousBlock'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="                className = className.split('\\.')[1];"><span class="lineCounter-0-0-15">74</span>                className <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="                methodName = frameStr.split(':')[0].split('\\.')[2];"><span class="lineCounter-0-0-15 prim">75</span>                methodName <span class="token operator">=</span> frameStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\\.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            }"><span class="lineCounter-0-0-15">76</span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">77</span></div><br><div class="line-0-0-16 " data-content="            frame.class_name = className;"><span class="lineCounter-0-0-15">78</span>            frame<span class="token punctuation">.</span>class_name <span class="token operator">=</span> className<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            frame.method = methodName;"><span class="lineCounter-0-0-15">79</span>            frame<span class="token punctuation">.</span>method <span class="token operator">=</span> methodName<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">80</span></div><br><div class="line-0-0-16 " data-content="            Pattern linePattern = Pattern.compile('line (\\d+)');"><span class="lineCounter-0-0-15">81</span>            <span class="token class-name">Pattern</span> linePattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">'line (\\d+)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            Matcher lineMatcher = linePattern.matcher(frameStr);"><span class="lineCounter-0-0-15">82</span>            <span class="token class-name">Matcher</span> lineMatcher <span class="token operator">=</span> linePattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>frameStr<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            lineMatcher.find();"><span class="lineCounter-0-0-15">83</span>            lineMatcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            frame.lineno = Integer.valueOf(lineMatcher.group(1));"><span class="lineCounter-0-0-15">84</span>            frame<span class="token punctuation">.</span>lineno <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>lineMatcher<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">85</span></div><br><div class="line-0-0-16 " data-content="            Pattern colPattern = Pattern.compile('column (\\d+)');"><span class="lineCounter-0-0-15">86</span>            <span class="token class-name">Pattern</span> colPattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">'column (\\d+)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            Matcher colMatcher = colPattern.matcher(frameStr);"><span class="lineCounter-0-0-15">87</span>            <span class="token class-name">Matcher</span> colMatcher <span class="token operator">=</span> colPattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>frameStr<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            colMatcher.find();"><span class="lineCounter-0-0-15">88</span>            colMatcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="            frame.colno = Integer.valueOf(colMatcher.group(1));"><span class="lineCounter-0-0-15">89</span>            frame<span class="token punctuation">.</span>colno <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>colMatcher<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">90</span></div><br><div class="line-0-0-16 " data-content="            framesList.add(frame);"><span class="lineCounter-0-0-15">91</span>            framesList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">92</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">93</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> excMap = new Map<String, Object>();"><span class="lineCounter-0-0-15">94</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> excMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        excMap.put('class', exc.getTypeName());"><span class="lineCounter-0-0-15 prim">95</span>        excMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> exc<span class="token punctuation">.</span><span class="token function">getTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        excMap.put('message', exc.getMessage());"><span class="lineCounter-0-0-15">96</span>        excMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> exc<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">97</span></div><br><div class="line-0-0-16 " data-content="        return buildTraceBody(excMap, framesList);"><span class="lineCounter-0-0-15">98</span>        <span class="token keyword">return</span> <span class="token function">buildTraceBody</span><span class="token punctuation">(</span>excMap<span class="token punctuation">,</span> framesList<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">99</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">100</span></div><br><div class="line-0-0-16 " data-content="    private Rollbar.MessageBody buildTraceBody(Map<String, Object> exceptionMap,"><span class="lineCounter-0-0-15">101</span>    <span class="token keyword">private</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span> <span class="token function">buildTraceBody</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> exceptionMap<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        List<Rollbar.ExceptionFrame> framesList) {"><span class="lineCounter-0-0-15">102</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">ExceptionFrame</span><span class="token punctuation">&gt;</span></span> framesList<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Rollbar.MessageBody body = new Rollbar.MessageBody();"><span class="lineCounter-0-0-15">103</span>        <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        body.trace = new Map<String, Object>();"><span class="lineCounter-0-0-15">104</span>        body<span class="token punctuation">.</span>trace <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        body.trace.put('exception', exceptionMap);"><span class="lineCounter-0-0-15 prim">105</span>        body<span class="token punctuation">.</span>trace<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'exception'</span><span class="token punctuation">,</span> exceptionMap<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        body.trace.put('frames', framesList);"><span class="lineCounter-0-0-15">106</span>        body<span class="token punctuation">.</span>trace<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'frames'</span><span class="token punctuation">,</span> framesList<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return body;"><span class="lineCounter-0-0-15">107</span>        <span class="token keyword">return</span> body<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">108</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">109</span></div><br><div class="line-0-0-16 " data-content="    private Rollbar.MessageBody buildTraceChainBody(Exception ex) {"><span class="lineCounter-0-0-15 prim">110</span>    <span class="token keyword">private</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span> <span class="token function">buildTraceChainBody</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> outterExTrace = this.buildTraceMessage(ex).trace;"><span class="lineCounter-0-0-15">111</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> outterExTrace <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildTraceMessage</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">.</span>trace<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Map<String, Object> innerExTrace = this.buildTraceMessage(ex.getCause()).trace;"><span class="lineCounter-0-0-15">112</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> innerExTrace <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildTraceMessage</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trace<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">113</span></div><br><div class="line-0-0-16 " data-content="        List<Map<String, Object>> traceChainList = new List<Map<String, Object>>();"><span class="lineCounter-0-0-15">114</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> traceChainList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        traceChainList.add(outterExTrace);"><span class="lineCounter-0-0-15 prim">115</span>        traceChainList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outterExTrace<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        traceChainList.add(innerExTrace);"><span class="lineCounter-0-0-15">116</span>        traceChainList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>innerExTrace<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">117</span></div><br><div class="line-0-0-16 " data-content="        Rollbar.MessageBody body = new Rollbar.MessageBody();"><span class="lineCounter-0-0-15">118</span>        <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rollbar</span><span class="token punctuation">.</span><span class="token class-name">MessageBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        body.trace_chain = traceChainList;"><span class="lineCounter-0-0-15">119</span>        body<span class="token punctuation">.</span>trace_chain <span class="token operator">=</span> traceChainList<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return body;"><span class="lineCounter-0-0-15 prim">120</span>        <span class="token keyword">return</span> body<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">121</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">122</span><span class="token punctuation">}</span></div><br></code></pre><p>Because the DataBuilder class came with tests, it's easy to verify that this refactor, which cut the lines of code in half, is still doing exactly what we'd like it to. The tests themselves cleaned up nicely, because there was a heck of a lot less casting to <code>Map&lt;String, Object&gt;</code> happening. I also changed some method names; particularly for public methods, it's often a waste of characters to describe the return type in the name of the method -- intellisense will tell you the return type!</p><p>Lastly, I'll just touch on what I was talking about before -- using the Http member object on the Rollbar class to confirm end-to-end testing. Yes, we use <code>Test.setMock(System.HttpCalloutMock)</code> to properly mock API responses in tests, but in order to verify that our data is built correctly prior to sending out, having access to the body of the <code>HttpRequest</code> is paramount. Again, I typically don't like to utilize this kind of pattern, but because logging as an activity is something that's going to happen many layers deep into your application, sometimes it's necessary (as opposed to passing an object back up the entire stack):</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/Rollbar.cls</span></span><div class="line-0-0-16 " data-content="private final HttpWrapper http;"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpWrapper</span> http<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="private final RollbarDataBuilder dataBuilder;"><span class="lineCounter-0-0-15">2</span><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RollbarDataBuilder</span> dataBuilder<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="private Rollbar() {"><span class="lineCounter-0-0-15">4</span><span class="token keyword">private</span> <span class="token class-name">Rollbar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.dataBuilder = new RollbarDataBuilder();"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dataBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RollbarDataBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.http = new HttpWrapper();"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">7</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">8</span></div><br><div class="line-0-0-16 " data-content="//..."><span class="lineCounter-0-0-15">9</span><span class="token comment">//...</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="@testVisible private static HttpRequest testReq;"><span class="lineCounter-0-0-15">11</span><span class="token annotation punctuation">@testVisible</span> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">HttpRequest</span> testReq<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="private class HttpWrapper {"><span class="lineCounter-0-0-15">12</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">HttpWrapper</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final Http http;"><span class="lineCounter-0-0-15">13</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Http</span> http<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    public HttpWrapper() {"><span class="lineCounter-0-0-15">14</span>    <span class="token keyword">public</span> <span class="token class-name">HttpWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.http = new Http();"><span class="lineCounter-0-0-15 prim">15</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Http</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">16</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">17</span></div><br><div class="line-0-0-16 " data-content="    public HttpResponse send(HttpRequest req) {"><span class="lineCounter-0-0-15">18</span>    <span class="token keyword">public</span> <span class="token class-name">HttpResponse</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        testReq = req;"><span class="lineCounter-0-0-15">19</span>        testReq <span class="token operator">=</span> req<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return this.http.send(req);"><span class="lineCounter-0-0-15 prim">20</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">21</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">22</span><span class="token punctuation">}</span></div><br></code></pre><p>This exhibits two other important idiomatic Apex patterns:</p><ul><li>declaring instance variables as <code>final</code> whenever possible. Let the compiler enforce for you that no changes to these members can occur. This is true of many other strongly typed languages as well, regardless of what the nomenclature is; C# uses <code>readonly</code> to achieve the same effect, for example.</li><li>using <code>@TestVisible</code> (or <code>@testVisible</code>, Apex isn't case sensitive) when necessary to access deeply nested and otherwise certifiably private state variables can help to reduce test complexity and enforce that object consumers won't have access to things other than what they need in production. I always advise using this pattern <em>sparingly</em>, but there's no denying it's quite helpful.</li></ul><hr><h2 id="idiomatic-apex-wrap-up" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Idiomatic Apex Wrap-Up</h2><p>In the end, it's a shame that some of the JSON object being sent to Rollbar made use of reserved words in Apex. This isn't something that they, as a vendor, could have anticipated; they have many SDKS across a variety of commonly used languages, and planning out their object structure with deference to one specific language is a little much to ask of anybody. Still, it made the object structure less clean than I would have liked. That the real world demands us to do things we'd prefer to avoid doing is another important lesson.</p><p>I realize I'm just brushing the surface of an extremely broad topic -- "Idiomatic Apex" would be an enormous book, if printed, and Singleton initialization and strong typing is barely a start. Have some thoughts on other excellent idiomatic Apex examples? Feel free to <a href="https://www.jamessimone.net/contact/">reach out</a> -- perhaps your suggestions will inform more posts on this subject!</p><div class="contentnav-0-0-7" data-no-search=""><a href="#the-problem" class="h2" data-content-highlight="the-problem">The Problem</a><a href="#refactoring-into-idiomatic-apex" class="h2" data-content-highlight="refactoring-into-idiomatic-apex">Refactoring Into Idiomatic Apex</a><a href="#idiomatic-apex-wrap-up" class="h2" data-content-highlight="idiomatic-apex-wrap-up">Idiomatic Apex Wrap-Up</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/lwc-custom-path">LWC Custom Lead Path</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="l_ramArToo">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("l_ramArToo", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="nkjdxwbVVj">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("nkjdxwbVVj", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="aAtnaRxgzI">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("aAtnaRxgzI", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>