<!DOCTYPE html><html><head><title>Joys Of Apex | Future Methods, Callouts &amp; Callbacks</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/joys-of-apex/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/joys-of-apex/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/joys-of-apex/bundle/codedoc-bundle.js"></script><meta property="og:image" content="./img/joys-of-apex-thumbnail.png"><script>window.githubConfig={"repo":"james-coding-blog","user":"jamessimone"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Joys Of Apex | Future Methods, Callouts &amp; Callbacks"><meta property="og:type" content="article"><meta property="og:title" content="Joys Of Apex | Future Methods, Callouts &amp; Callbacks"></head><body><header style="margin-left: 1rem">Read more at <a href="https://wwww.jamessimone.net">jamessimone.net</a>, or return to the <a href="/joys-of-apex/">homepage</a></header><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"future-method-callout-callback.md","namespace":"/joys-of-apex","title":{"base":"Joys Of Apex","connector":" | "}}</script><div class="hero-0-0-8" style="margin-bottom: -156px"><img src="/joys-of-apex/img/the-joys-of-apex.png" class="image-0-0-9" data-hero=""><span class="caption-0-0-10"></span></div><marker><br>
<br>
<br>
<br>
<br>

</marker><h1 class="h-0-0-11 "><span style="color: green; 
      text-shadow: none; 
      font-size: 48px"><p>Future Methods, Callouts &amp; Callbacks</p></span></h1><script id="OMjdKBKRwQ">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("OMjdKBKRwQ", "kRzsgnV+B7EQTskbovy+YA==", {"src":"github","date":"2020-01-24T15:12:03.284Z"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><div hidden="" data-ignore-text="" data-meta-override-property="og:image"><p>./img/joys-of-apex-thumbnail.png</p></div><p>Today we're going to talk about "future" methods - Salesforce's way of handling asynchronous code. For many, your introduction to future methods happens the first time that you need to integrate with an external API. Salesforce prevents you from performing any kind of synchronous API calls following DML operations; this is the "invisible hand" of SFDC guiding you to do things the way that they want you to -- in other words, if you have begin your main thread operation with some kind of inserting / updating / upserting / deleting of SObject records, the code performing the API call needs to be pushed to another thread.</p><p>For many, future methods represent a distinct challenge when it comes to writing clean Apex code. They only accept primitive types, or collections; this means that most future methods end up taking in an <code>Id</code> or a <code>List&lt;Id&gt;</code> to then perform their work. That leads to tight coupling between the way API calls are being made, and the work that needs to be done once the call has finished. How can we batten down the hatches, write clean code, and still do work asynchronously?</p><h2 id="separating-the-concerns-in-async-apex-methods" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Separating the Concerns in Async Apex Methods</h2><p>At its heart, async work with API callouts can be broken down into three pieces:</p><ul><li>a future method must be static and can only accept object primitives: Strings, Integers, Ids, Lists, etc ...</li><li>a callout is performed</li><li>some kind of follow-up work is done</li></ul><p>Looking at the list like this, it's almost like there are 3 classes waiting to be born. The <em>truly</em> tightly coupled concepts, written another way:</p><ul><li>a wrapper object representing the information necessary for the HTTP call</li><li>a class that accepts that wrapper and holds itself responsible for HTTP calls</li><li>the additional work that needs to be done can also be encapsulated ... like a callback function in languages where functions are first-class citizens</li></ul><p>This is the kind of test I'd like to write, showcasing the first two objects:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/HttpCallout_Tests.cls</span></span><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15 prim">1</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class HttpCallout_Tests {"><span class="lineCounter-0-0-15">2</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">HttpCallout_Tests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">3</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_callout_successfully() {"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_callout_successfully</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Callout fakeCallout = new Callout('{parameter1: perhaps a serialized list or id!}',"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token class-name">Callout</span> fakeCallout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Callout</span><span class="token punctuation">(</span><span class="token string">'{parameter1: perhaps a serialized list or id!}'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="            new Url('https://api.com'), RestMethod.POST);"><span class="lineCounter-0-0-15">6</span>            <span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token string">'https://api.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        String jsonString = JSON.serialize(fakeCallout);"><span class="lineCounter-0-0-15">7</span>        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>fakeCallout<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">8</span></div><br><div class="line-0-0-16 " data-content="        Test.startTest();"><span class="lineCounter-0-0-15">9</span>        <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">startTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        HttpCallout.process(jsonString);"><span class="lineCounter-0-0-15 prim">10</span>        <span class="token class-name">HttpCallout</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Test.stopTest();"><span class="lineCounter-0-0-15">11</span>        <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">stopTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">12</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(1, Limits.getCallouts());"><span class="lineCounter-0-0-15">13</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Limits</span><span class="token punctuation">.</span><span class="token function">getCallouts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">14</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">15</span><span class="token punctuation">}</span></div><br></code></pre><h2 id="setting-up-callouts-and-http-class-wrappers" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Setting up Callouts and HTTP Class Wrappers</h2><p>The most basic implementations:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public class Callout {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Callout</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private static final Integer DEFAULT_TIMEOUT = 10000;"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> DEFAULT_TIMEOUT <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="    public Callout(String jsonString,"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">public</span> <span class="token class-name">Callout</span><span class="token punctuation">(</span><span class="token class-name">String</span> jsonString<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        Url endpoint,"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token class-name">Url</span> endpoint<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        RestMethod method,"><span class="lineCounter-0-0-15">6</span>        <span class="token class-name">RestMethod</span> method<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        Integer millisecondTimeout) {"><span class="lineCounter-0-0-15">7</span>        <span class="token class-name">Integer</span> millisecondTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.BodyString = jsonString;"><span class="lineCounter-0-0-15">8</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">BodyString</span> <span class="token operator">=</span> jsonString<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.Endpoint = endpoint.toExternalForm();"><span class="lineCounter-0-0-15">9</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Endpoint</span> <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">toExternalForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.RestMethod = method.name();"><span class="lineCounter-0-0-15 prim">10</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">RestMethod</span> <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.Timeout = millisecondTimeout;"><span class="lineCounter-0-0-15">11</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Timeout</span> <span class="token operator">=</span> millisecondTimeout<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">12</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">13</span></div><br><div class="line-0-0-16 " data-content="    public Callout(String jsonString, Url endpoint, RestMethod method) {"><span class="lineCounter-0-0-15">14</span>    <span class="token keyword">public</span> <span class="token class-name">Callout</span><span class="token punctuation">(</span><span class="token class-name">String</span> jsonString<span class="token punctuation">,</span> <span class="token class-name">Url</span> endpoint<span class="token punctuation">,</span> <span class="token class-name">RestMethod</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this(jsonString, endpoint, method, DEFAULT_TIMEOUT);"><span class="lineCounter-0-0-15 prim">15</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> method<span class="token punctuation">,</span> DEFAULT_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">16</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">17</span></div><br><div class="line-0-0-16 " data-content="    //sometimes an api key is supplied as part of the URL ..."><span class="lineCounter-0-0-15">18</span>    <span class="token comment">//sometimes an api key is supplied as part of the URL ...</span></div><br><div class="line-0-0-16 " data-content="    //because it's not always necessary, we make it a public member of the class"><span class="lineCounter-0-0-15">19</span>    <span class="token comment">//because it's not always necessary, we make it a public member of the class</span></div><br><div class="line-0-0-16 " data-content="    public String ApiKey { get; set; }"><span class="lineCounter-0-0-15 prim">20</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">ApiKey</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">21</span></div><br><div class="line-0-0-16 " data-content="    public String BodyString { get; private set; }"><span class="lineCounter-0-0-15">22</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">BodyString</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public String Endpoint { get; private set; }"><span class="lineCounter-0-0-15">23</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">Endpoint</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public String RestMethod { get; private set; }"><span class="lineCounter-0-0-15">24</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">RestMethod</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    public Integer Timeout { get; private set; }"><span class="lineCounter-0-0-15 prim">25</span>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token class-name">Timeout</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">26</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">27</span></div><br><div class="line-0-0-16 " data-content="public class HttpCallout {"><span class="lineCounter-0-0-15">28</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpCallout</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @future(callout = true)"><span class="lineCounter-0-0-15">29</span>    <span class="token annotation punctuation">@future</span><span class="token punctuation">(</span>callout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    public static void process(String calloutString) {"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> calloutString<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Callout calloutObj = (Callout)JSON.deserialize(calloutString, Callout.class);"><span class="lineCounter-0-0-15">31</span>        <span class="token class-name">Callout</span> calloutObj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Callout</span><span class="token punctuation">)</span>JSON<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>calloutString<span class="token punctuation">,</span> <span class="token class-name">Callout</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        HttpRequest req = setupHttpRequest(calloutObj);"><span class="lineCounter-0-0-15">32</span>        <span class="token class-name">HttpRequest</span> req <span class="token operator">=</span> <span class="token function">setupHttpRequest</span><span class="token punctuation">(</span>calloutObj<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        //this is the part you would try/catch"><span class="lineCounter-0-0-15">33</span>        <span class="token comment">//this is the part you would try/catch</span></div><br><div class="line-0-0-16 " data-content="        //in a more robuse implementation ..."><span class="lineCounter-0-0-15">34</span>        <span class="token comment">//in a more robuse implementation ...</span></div><br><div class="line-0-0-16 " data-content="        new Http().send(req);"><span class="lineCounter-0-0-15 prim">35</span>        <span class="token keyword">new</span> <span class="token class-name">Http</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">36</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">37</span></div><br><div class="line-0-0-16 " data-content="    private static HttpRequest setupHttpRequest(Callout callout) {"><span class="lineCounter-0-0-15">38</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">HttpRequest</span> <span class="token function">setupHttpRequest</span><span class="token punctuation">(</span><span class="token class-name">Callout</span> callout<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        HttpRequest req = new HttpRequest();"><span class="lineCounter-0-0-15">39</span>        <span class="token class-name">HttpRequest</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        req.setEndpoint(callout.Endpoint);"><span class="lineCounter-0-0-15 prim">40</span>        req<span class="token punctuation">.</span><span class="token function">setEndpoint</span><span class="token punctuation">(</span>callout<span class="token punctuation">.</span><span class="token class-name">Endpoint</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        req.setMethod(callout.RestMethod);"><span class="lineCounter-0-0-15">41</span>        req<span class="token punctuation">.</span><span class="token function">setMethod</span><span class="token punctuation">(</span>callout<span class="token punctuation">.</span><span class="token class-name">RestMethod</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        req.setTimeout(callout.Timeout);"><span class="lineCounter-0-0-15">42</span>        req<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>callout<span class="token punctuation">.</span><span class="token class-name">Timeout</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        req.setHeader('Content-Type', 'application/json');"><span class="lineCounter-0-0-15">43</span>        req<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        req.setBody(callout.BodyString);"><span class="lineCounter-0-0-15">44</span>        req<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>callout<span class="token punctuation">.</span><span class="token class-name">BodyString</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        if(String.isNotBlank(callout.ApiKey)) {"><span class="lineCounter-0-0-15 prim">45</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>callout<span class="token punctuation">.</span><span class="token class-name">ApiKey</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            req.setHeader('x-api-key', callout.ApiKey);"><span class="lineCounter-0-0-15">46</span>            req<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'x-api-key'</span><span class="token punctuation">,</span> callout<span class="token punctuation">.</span><span class="token class-name">ApiKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">47</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        return req;"><span class="lineCounter-0-0-15">48</span>        <span class="token keyword">return</span> req<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">49</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">50</span><span class="token punctuation">}</span></div><br></code></pre><p>So what do we achieve from this structure? We've successfully encapsulated the aspects surrounding an HTTP request. By itself, this isn't necessarily very impressive; in fact, the test doesn't even pass due to one of my favorite possible Apex exceptions:</p><p><code>System.TypeException: Methods defined as TestMethod do not support Web service callouts</code>.</p><p>Sigh. Luckily you only need one boilerplate implementation of Salesforce's included <code>HttpCalloutMock</code> interface in order to proceed. Unfortunately, it's only within that HttpCalloutMock class that you can assert against Salesforce's <code>Limits.getCallouts()</code> method to verify that a callout is indeed happening:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="//slightly re-working HttpCallout ..."><span class="lineCounter-0-0-15 prim">1</span><span class="token comment">//slightly re-working HttpCallout ...</span></div><br><div class="line-0-0-16 " data-content="@future(callout = true)"><span class="lineCounter-0-0-15">2</span><span class="token annotation punctuation">@future</span><span class="token punctuation">(</span>callout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="public static void process(String calloutString) {"><span class="lineCounter-0-0-15">3</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> calloutString<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    Callout calloutObj = (Callout)JSON.deserialize(calloutString, Callout.class);"><span class="lineCounter-0-0-15">4</span>    <span class="token class-name">Callout</span> calloutObj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Callout</span><span class="token punctuation">)</span>JSON<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>calloutString<span class="token punctuation">,</span> <span class="token class-name">Callout</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    HttpRequest req = setupHttpRequest(calloutObj);"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token class-name">HttpRequest</span> req <span class="token operator">=</span> <span class="token function">setupHttpRequest</span><span class="token punctuation">(</span>calloutObj<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    makeRequest(req);"><span class="lineCounter-0-0-15">6</span>    <span class="token function">makeRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">7</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">8</span></div><br><div class="line-0-0-16 " data-content="@testVisible"><span class="lineCounter-0-0-15">9</span><span class="token annotation punctuation">@testVisible</span></div><br><div class="line-0-0-16 " data-content="private static HttpResponse makeRequest(HttpRequest req) {"><span class="lineCounter-0-0-15 prim">10</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">HttpResponse</span> <span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    return new Http().send(req);"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Http</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">12</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">13</span></div><br><div class="line-0-0-16 " data-content="//in HttpCallout_Tests ..."><span class="lineCounter-0-0-15">14</span><span class="token comment">//in HttpCallout_Tests ...</span></div><br><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15 prim">15</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="static void it_should_properly_stub_response() {"><span class="lineCounter-0-0-15">16</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_properly_stub_response</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    Test.setMock(HttpCalloutMock.class, new MockHttpResponse(200, 'Success', '{}'));"><span class="lineCounter-0-0-15">17</span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">setMock</span><span class="token punctuation">(</span><span class="token class-name">HttpCalloutMock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MockHttpResponse</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'Success'</span><span class="token punctuation">,</span> <span class="token string">'{}'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    HttpResponse res = HttpCallout.makeRequest(new HttpRequest());"><span class="lineCounter-0-0-15">18</span>    <span class="token class-name">HttpResponse</span> res <span class="token operator">=</span> <span class="token class-name">HttpCallout</span><span class="token punctuation">.</span><span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    System.assertEquals(200, res.getStatusCode());"><span class="lineCounter-0-0-15">19</span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">20</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">21</span></div><br><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15">22</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="static void it_should_callout_successfully() {"><span class="lineCounter-0-0-15">23</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_callout_successfully</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    Callout fakeCallout = new Callout('{parameter1: perhaps a serialized list or id!}',"><span class="lineCounter-0-0-15">24</span>    <span class="token class-name">Callout</span> fakeCallout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Callout</span><span class="token punctuation">(</span><span class="token string">'{parameter1: perhaps a serialized list or id!}'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        new Url('https://api.com'), RestMethod.POST);"><span class="lineCounter-0-0-15 prim">25</span>        <span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token string">'https://api.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    String jsonString = JSON.serialize(fakeCallout);"><span class="lineCounter-0-0-15">26</span>    <span class="token class-name">String</span> jsonString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>fakeCallout<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">27</span></div><br><div class="line-0-0-16 " data-content="    Test.setMock(HttpCalloutMock.class, new MockHttpResponse(200, 'Success', '{}'));"><span class="lineCounter-0-0-15">28</span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">setMock</span><span class="token punctuation">(</span><span class="token class-name">HttpCalloutMock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MockHttpResponse</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'Success'</span><span class="token punctuation">,</span> <span class="token string">'{}'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">29</span></div><br><div class="line-0-0-16 " data-content="    Test.startTest();"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">startTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    HttpCallout.process(jsonString);"><span class="lineCounter-0-0-15">31</span>    <span class="token class-name">HttpCallout</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    Test.stopTest();"><span class="lineCounter-0-0-15">32</span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">stopTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">33</span></div><br><div class="line-0-0-16 " data-content="    System.assert(true, 'should make it here!');"><span class="lineCounter-0-0-15">34</span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'should make it here!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">35</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">36</span></div><br><div class="line-0-0-16 " data-content="public class MockHttpResponse implements HttpCalloutMock {"><span class="lineCounter-0-0-15">37</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MockHttpResponse</span> <span class="token keyword">implements</span> <span class="token class-name">HttpCalloutMock</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private final Integer code;"><span class="lineCounter-0-0-15">38</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private final String status;"><span class="lineCounter-0-0-15">39</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private final String body;"><span class="lineCounter-0-0-15 prim">40</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> body<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">41</span></div><br><div class="line-0-0-16 " data-content="    public MockHttpResponse(Integer code, String status, String body) {"><span class="lineCounter-0-0-15">42</span>    <span class="token keyword">public</span> <span class="token class-name">MockHttpResponse</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.code = code;"><span class="lineCounter-0-0-15">43</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.status = status;"><span class="lineCounter-0-0-15">44</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.body = body;"><span class="lineCounter-0-0-15 prim">45</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">46</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">47</span></div><br><div class="line-0-0-16 " data-content="    public HTTPResponse respond(HTTPRequest req) {"><span class="lineCounter-0-0-15">48</span>    <span class="token keyword">public</span> <span class="token class-name">HTTPResponse</span> <span class="token function">respond</span><span class="token punctuation">(</span><span class="token class-name">HTTPRequest</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(1, Limits.getCallouts());"><span class="lineCounter-0-0-15">49</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Limits</span><span class="token punctuation">.</span><span class="token function">getCallouts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        HttpResponse res = new HttpResponse();"><span class="lineCounter-0-0-15 prim">50</span>        <span class="token class-name">HttpResponse</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">51</span></div><br><div class="line-0-0-16 " data-content="        if(this.body != null) {"><span class="lineCounter-0-0-15">52</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            res.setBody(this.body);"><span class="lineCounter-0-0-15">53</span>            res<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">54</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        res.setStatusCode(this.code);"><span class="lineCounter-0-0-15 prim">55</span>        res<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        res.setStatus(this.status);"><span class="lineCounter-0-0-15">56</span>        res<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">57</span></div><br><div class="line-0-0-16 " data-content="        return res;"><span class="lineCounter-0-0-15">58</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">59</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">60</span><span class="token punctuation">}</span></div><br></code></pre><p>Encapsulating the details behind an HTTP request inside of the Callout object isn't, by itself, that impressive. You're saving on lines of code in setting up your HttpRequest objects that would otherwise have to be performed each time you wanted to make a callout. You're also reducing mental overhead by properly separating concerns; the HttpCallout object shown is very simple, but when you want to, say, add a try/catch block to your wrapper, you now know that there's only one single place in the system where it's necessary to try/catch for HttpRequests.</p><p>The real potential behind encapsulating your request information into the Callout object is what comes next -- typically, the purpose of a callout is not only to send information to other systems. Sometimes that's the case, and those cases are lucky -- no further processing is required! But most of the time, you're going to be getting information back from having made a callout in order to perform additional processing. This can typically lead to a lot of if/then statements, or perhaps a big switch statement following the HTTP section in your class.</p><p>In order to prevent our HttpCallout from growing in size beyond its concerns as the means of making HTTP requests, let's borrow some terminology from languages where methods, or functions, themselves are first-class citizens. There is no <code>System.Type</code> for the methods within your classes themselves; no way to represent them for internal or external purposes. You can't pass a function to your Callout object ... but you can pass a class!</p><h2 id="introducing-the-callback-object" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Introducing the Callback Object</h2><p>When making use of future methods, it used to be that options were a lot more limited in terms of what kind of processesing could occur. Because operating in read/write mode was limited to async methods, and because one future method couldn't call another future method, there wasn't much you could do (beyond helper classes designed to setup HttpRequests) to safely encapsulate HTTP-related logic. Furthermore, future methods must return void, effectively limiting that separation of concerns even more.</p><p>Thankfully, a few years ago, Salesforce introduced the <code>System.Queuable</code> interface -- a means of performing async work that could be called from within a future method. Defining a simple callback class becomes drop-dead simple, as a result:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public abstract class Callback implements System.Queueable {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Callback</span> <span class="token keyword">implements</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">Queueable</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private HttpResponse res;"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">private</span> <span class="token class-name">HttpResponse</span> res<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="    public abstract void execute();"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">5</span></div><br><div class="line-0-0-16 " data-content="    public void callback() {"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        System.enqueueJob(this);"><span class="lineCounter-0-0-15">7</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">enqueueJob</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">8</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">9</span></div><br><div class="line-0-0-16 " data-content="    public void callback(HttpResponse res) {"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.res = res;"><span class="lineCounter-0-0-15">11</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>res <span class="token operator">=</span> res<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.callback();"><span class="lineCounter-0-0-15">12</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">13</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">14</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">15</span></div><br><div class="line-0-0-16 " data-content="//and the basic test:"><span class="lineCounter-0-0-15">16</span><span class="token comment">//and the basic test:</span></div><br><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15">17</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class Callback_Tests {"><span class="lineCounter-0-0-15">18</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Callback_Tests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15">19</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_callback() {"><span class="lineCounter-0-0-15 prim">20</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        CallbackMock mock = new CallbackMock(null);"><span class="lineCounter-0-0-15">21</span>        <span class="token class-name">CallbackMock</span> mock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CallbackMock</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">22</span></div><br><div class="line-0-0-16 " data-content="        //have to wrap in start/stop test again to force async execution"><span class="lineCounter-0-0-15">23</span>        <span class="token comment">//have to wrap in start/stop test again to force async execution</span></div><br><div class="line-0-0-16 " data-content="        Test.startTest();"><span class="lineCounter-0-0-15">24</span>        <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">startTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        mock.callback();"><span class="lineCounter-0-0-15 prim">25</span>        mock<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Test.stopTest();"><span class="lineCounter-0-0-15">26</span>        <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">stopTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">27</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(true, WasCalled);"><span class="lineCounter-0-0-15">28</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">WasCalled</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">29</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">30</span></div><br><div class="line-0-0-16 " data-content="    static boolean WasCalled = false;"><span class="lineCounter-0-0-15">31</span>    <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token class-name">WasCalled</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    private virtual class CallbackMock extends Callback {"><span class="lineCounter-0-0-15">32</span>    <span class="token keyword">private</span> virtual <span class="token keyword">class</span> <span class="token class-name">CallbackMock</span> <span class="token keyword">extends</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">33</span></div><br><div class="line-0-0-16 " data-content="        public override void execute(System.QueueableContext context) {"><span class="lineCounter-0-0-15">34</span>        <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">QueueableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            WasCalled = true;"><span class="lineCounter-0-0-15 prim">35</span>            <span class="token class-name">WasCalled</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">36</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">37</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">38</span><span class="token punctuation">}</span></div><br></code></pre><p>Right. We're nearly there. Let's define the Callback member on our Callout object:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/Callout.cls</span></span><div class="line-0-0-16 " data-content="public class Callout {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Callout</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private static final Integer DEFAULT_TIMEOUT = 10000;"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> DEFAULT_TIMEOUT <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">3</span></div><br><div class="line-0-0-16 " data-content="    public Callout(String jsonString,"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">public</span> <span class="token class-name">Callout</span><span class="token punctuation">(</span><span class="token class-name">String</span> jsonString<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        Url endpoint,"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token class-name">Url</span> endpoint<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        RestMethod method,"><span class="lineCounter-0-0-15">6</span>        <span class="token class-name">RestMethod</span> method<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        Integer millisecondTimeout,"><span class="lineCounter-0-0-15">7</span>        <span class="token class-name">Integer</span> millisecondTimeout<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        Callback callback) {"><span class="lineCounter-0-0-15">8</span>        <span class="token class-name">Callback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.BodyString = jsonString;"><span class="lineCounter-0-0-15">9</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">BodyString</span> <span class="token operator">=</span> jsonString<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.Callback = callback;"><span class="lineCounter-0-0-15 prim">10</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Callback</span> <span class="token operator">=</span> callback<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.Endpoint = endpoint.toExternalForm();"><span class="lineCounter-0-0-15">11</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Endpoint</span> <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">toExternalForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.RestMethod = method.name();"><span class="lineCounter-0-0-15">12</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">RestMethod</span> <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.Timeout = millisecondTimeout;"><span class="lineCounter-0-0-15">13</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Timeout</span> <span class="token operator">=</span> millisecondTimeout<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">14</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">15</span></div><br><div class="line-0-0-16 " data-content="    public Callout(String jsonString, Url endpoint, RestMethod method, Callback callback) {"><span class="lineCounter-0-0-15">16</span>    <span class="token keyword">public</span> <span class="token class-name">Callout</span><span class="token punctuation">(</span><span class="token class-name">String</span> jsonString<span class="token punctuation">,</span> <span class="token class-name">Url</span> endpoint<span class="token punctuation">,</span> <span class="token class-name">RestMethod</span> method<span class="token punctuation">,</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this(jsonString, endpoint, method, DEFAULT_TIMEOUT, callback);"><span class="lineCounter-0-0-15">17</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> method<span class="token punctuation">,</span> DEFAULT_TIMEOUT<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">18</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    //..."><span class="lineCounter-0-0-15">19</span>    <span class="token comment">//...</span></div><br><div class="line-0-0-16 " data-content="    public Callback Callback { get; private set; }"><span class="lineCounter-0-0-15 prim">20</span>    <span class="token keyword">public</span> <span class="token class-name">Callback</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">21</span><span class="token punctuation">}</span></div><br></code></pre><p>And then in our wrapper object:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/HttpCallout.cls</span></span><div class="line-0-0-16 " data-content="public class HttpCallout {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpCallout</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @future(callout = true)"><span class="lineCounter-0-0-15">2</span>    <span class="token annotation punctuation">@future</span><span class="token punctuation">(</span>callout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    public static void process(String calloutString) {"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> calloutString<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Callout calloutObj = (Callout)JSON.deserialize(calloutString, Callout.class);"><span class="lineCounter-0-0-15">4</span>        <span class="token class-name">Callout</span> calloutObj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Callout</span><span class="token punctuation">)</span>JSON<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>calloutString<span class="token punctuation">,</span> <span class="token class-name">Callout</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        HttpRequest req = setupHttpRequest(calloutObj);"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token class-name">HttpRequest</span> req <span class="token operator">=</span> <span class="token function">setupHttpRequest</span><span class="token punctuation">(</span>calloutObj<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        HttpResponse res = makeRequest(req);"><span class="lineCounter-0-0-15">6</span>        <span class="token class-name">HttpResponse</span> res <span class="token operator">=</span> <span class="token function">makeRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        calloutObj.Callback.callback(res);"><span class="lineCounter-0-0-15">7</span>        calloutObj<span class="token punctuation">.</span><span class="token class-name">Callback</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">8</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="//..."><span class="lineCounter-0-0-15">9</span><span class="token comment">//...</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">10</span><span class="token punctuation">}</span></div><br></code></pre><p>To make things bullet-proof safe, we can even utilize the polymorphic empty object pattern for the Callback object once it's been received by the Callout:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/Callout.cls</span></span><div class="line-0-0-16 " data-content="public Callout(String jsonString,"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token class-name">Callout</span><span class="token punctuation">(</span><span class="token class-name">String</span> jsonString<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    Url endpoint,"><span class="lineCounter-0-0-15">2</span>    <span class="token class-name">Url</span> endpoint<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    RestMethod method,"><span class="lineCounter-0-0-15">3</span>    <span class="token class-name">RestMethod</span> method<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="     Integer millisecondTimeout,"><span class="lineCounter-0-0-15">4</span>     <span class="token class-name">Integer</span> millisecondTimeout<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="     Callback callback) {"><span class="lineCounter-0-0-15 prim">5</span>     <span class="token class-name">Callback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.BodyString = jsonString;"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">BodyString</span> <span class="token operator">=</span> jsonString<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.Callback = callback != null ? callback : new EmptyCallback();"><span class="lineCounter-0-0-15">7</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Callback</span> <span class="token operator">=</span> callback <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> callback <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">EmptyCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.Endpoint = endpoint.toExternalForm();"><span class="lineCounter-0-0-15">8</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Endpoint</span> <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">toExternalForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.RestMethod = method.name();"><span class="lineCounter-0-0-15">9</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">RestMethod</span> <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.Timeout = millisecondTimeout;"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Timeout</span> <span class="token operator">=</span> millisecondTimeout<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">11</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">12</span></div><br><div class="line-0-0-16 " data-content="public Callout (String jsonString, Url endpoint, RestMethod method) {"><span class="lineCounter-0-0-15">13</span><span class="token keyword">public</span> <span class="token class-name">Callout</span> <span class="token punctuation">(</span><span class="token class-name">String</span> jsonString<span class="token punctuation">,</span> <span class="token class-name">Url</span> endpoint<span class="token punctuation">,</span> <span class="token class-name">RestMethod</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this(jsonString, endpoint, method, null);"><span class="lineCounter-0-0-15">14</span>    <span class="token keyword">this</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">15</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="//..."><span class="lineCounter-0-0-15">16</span><span class="token comment">//...</span></div><br><div class="line-0-0-16 " data-content="private virtual class EmptyCallback extends Callback {"><span class="lineCounter-0-0-15">17</span><span class="token keyword">private</span> virtual <span class="token keyword">class</span> <span class="token class-name">EmptyCallback</span> <span class="token keyword">extends</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public override void execute(System.QueueableContext context) {}"><span class="lineCounter-0-0-15">18</span>    <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">QueueableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">19</span><span class="token punctuation">}</span></div><br></code></pre><p>Let's verify that a non-null callback can receive the HttpResponse and do something with it (the first test we wrote in HttpCallout_Tests covers the null callback case):</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="//in HttpCallout_Tests ..."><span class="lineCounter-0-0-15 prim">1</span><span class="token comment">//in HttpCallout_Tests ...</span></div><br><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15">2</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="static void it_should_callout_and_callback() {"><span class="lineCounter-0-0-15">3</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_callout_and_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    HttpCallback mockCallback = new HttpCallback();"><span class="lineCounter-0-0-15">4</span>    <span class="token class-name">HttpCallback</span> mockCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    Callout fakeCallout = new Callout("><span class="lineCounter-0-0-15 prim">5</span>    <span class="token class-name">Callout</span> fakeCallout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Callout</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        '{parameter1: perhaps a serialized list or id!}',"><span class="lineCounter-0-0-15">6</span>        <span class="token string">'{parameter1: perhaps a serialized list or id!}'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        new Url('https://api.com'),"><span class="lineCounter-0-0-15">7</span>        <span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token string">'https://api.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        RestMethod.POST,"><span class="lineCounter-0-0-15">8</span>        <span class="token class-name">RestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        mockCallback"><span class="lineCounter-0-0-15">9</span>        mockCallback</div><br><div class="line-0-0-16 " data-content="    );"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    String jsonString = Json.serialize(fakeCallout);"><span class="lineCounter-0-0-15">11</span>    <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token class-name">Json</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>fakeCallout<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">12</span></div><br><div class="line-0-0-16 " data-content="    Id fakeAccountId = TestingUtils.generateId(Account.SObjectType);"><span class="lineCounter-0-0-15">13</span>    <span class="token class-name">Id</span> fakeAccountId <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    Test.setMock(HttpCalloutMock.class,"><span class="lineCounter-0-0-15">14</span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">setMock</span><span class="token punctuation">(</span><span class="token class-name">HttpCalloutMock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        new MockHttpResponse(200, 'Success', '{ \&quot;&quot;AccountId\&quot;&quot; : &quot;'+ fakeAccountId +'&quot; } ')"><span class="lineCounter-0-0-15 prim">15</span>        <span class="token keyword">new</span> <span class="token class-name">MockHttpResponse</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'Success'</span><span class="token punctuation">,</span> <span class="token string">'{ \""AccountId\"" : "'</span><span class="token operator">+</span> fakeAccountId <span class="token operator">+</span><span class="token string">'" } '</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    );"><span class="lineCounter-0-0-15">16</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">17</span></div><br><div class="line-0-0-16 " data-content="    Test.startTest();"><span class="lineCounter-0-0-15">18</span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">startTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    HttpCallout.process(jsonString);"><span class="lineCounter-0-0-15">19</span>    <span class="token class-name">HttpCallout</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    Test.stopTest();"><span class="lineCounter-0-0-15 prim">20</span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">stopTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">21</span></div><br><div class="line-0-0-16 " data-content="    System.assertEquals(fakeAccountId, mockCallback.acc.Id);"><span class="lineCounter-0-0-15">22</span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>fakeAccountId<span class="token punctuation">,</span> mockCallback<span class="token punctuation">.</span>acc<span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">23</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="//..."><span class="lineCounter-0-0-15">24</span><span class="token comment">//...</span></div><br><div class="line-0-0-16 " data-content="private class HttpCallback extends Callback {"><span class="lineCounter-0-0-15 prim">25</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">HttpCallback</span> <span class="token keyword">extends</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public Account acc { get; private set; }"><span class="lineCounter-0-0-15">26</span>    <span class="token keyword">public</span> <span class="token class-name">Account</span> acc <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">27</span></div><br><div class="line-0-0-16 " data-content="    public override void execute(System.QueueableContext context) {"><span class="lineCounter-0-0-15">28</span>    <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">QueueableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        MockApiResponse mockRes ="><span class="lineCounter-0-0-15">29</span>        <span class="token class-name">MockApiResponse</span> mockRes <span class="token operator">=</span></div><br><div class="line-0-0-16 " data-content="            Json.deserialize(this.res.getBody(), MockApiResponse.class);"><span class="lineCounter-0-0-15 prim">30</span>            <span class="token class-name">Json</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MockApiResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.acc = new Account(Id = mockRes.AccountId);"><span class="lineCounter-0-0-15">31</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>acc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Id</span> <span class="token operator">=</span> mockRes<span class="token punctuation">.</span><span class="token class-name">AccountId</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        //do other work and perform DML ..."><span class="lineCounter-0-0-15">32</span>        <span class="token comment">//do other work and perform DML ...</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">33</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">34</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">35</span></div><br><div class="line-0-0-16 " data-content="private class MockApiResponse {"><span class="lineCounter-0-0-15">36</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">MockApiResponse</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public Id AccountId { get; set; }"><span class="lineCounter-0-0-15">37</span>    <span class="token keyword">public</span> <span class="token class-name">Id</span> <span class="token class-name">AccountId</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">38</span><span class="token punctuation">}</span></div><br></code></pre><p>Here I ran into my first snafu, as the test returns <code>System.SerializationException: Not Serializable: System.HttpResponse</code>. Circular references in JSON are fun! OK, let's try something a little simpler:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public abstract class Callback implements System.Queueable {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Callback</span> <span class="token keyword">implements</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">Queueable</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    protected string responseBody;"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">protected</span> string responseBody<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    //..."><span class="lineCounter-0-0-15">3</span>    <span class="token comment">//...</span></div><br><div class="line-0-0-16 " data-content="    public void callback(HttpResponse res) {"><span class="lineCounter-0-0-15">4</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.responseBody = res.getBody();"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>responseBody <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.callback();"><span class="lineCounter-0-0-15">6</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">7</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">8</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">9</span></div><br><div class="line-0-0-16 " data-content="//and in HttpCallout_Tests's HttpCallback object:"><span class="lineCounter-0-0-15 prim">10</span><span class="token comment">//and in HttpCallout_Tests's HttpCallback object:</span></div><br><div class="line-0-0-16 " data-content="public override void execute(System.QueueableContext context) {"><span class="lineCounter-0-0-15">11</span><span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">QueueableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    MockApiResponse mockRes = (MockApiResponse)"><span class="lineCounter-0-0-15">12</span>    <span class="token class-name">MockApiResponse</span> mockRes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MockApiResponse</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="        Json.deserialize(this.responseBody, MockApiResponse.class);"><span class="lineCounter-0-0-15">13</span>        <span class="token class-name">Json</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseBody<span class="token punctuation">,</span> <span class="token class-name">MockApiResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.acc = new Account(Id = mockRes.AccountId);"><span class="lineCounter-0-0-15">14</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>acc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Id</span> <span class="token operator">=</span> mockRes<span class="token punctuation">.</span><span class="token class-name">AccountId</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">15</span><span class="token punctuation">}</span></div><br></code></pre><p>This is where things started to get really weird. The test was still failing; the Account and its Id didn't seem to be getting set. I backed off from what I was doing and asserted that there had been a Queueable job added to the queue. That failed. Peering at the log, though, things seemed to differ:</p><p><img src="/joys-of-apex/img/apex-queueable-error.jpg" alt="How is Limits.getQueueableJobs() failing?"></p><p>I did a little reading on the subject and didn't come up with anything. I started debugging, and quickly ran into an issue that superceded what I had been looking into; namely, that the <code>HttpCallback</code> mock that I was initializing in my test wasn't getting called at all when the test was being run. At this point, my writing was interrupted by a quick flight, and during my time in the air I finally realized the obvious (which may have already occurred to you) -- namely that the serialization process for the Callback was losing the crucial pointer to the actual instance of the HttpCallback. When de-serialized, the only encoding that remained was for the dumbed-down abstract version of the Callback class. Bummer. There was no way to pass a specific instance for the Callback to the Callout object, after all. Or was there?</p><p>Undaunted, and with plenty of wifi-free time on my hands, I thought about my options. The entire point in writing this article was to explore how developers could move towards a more polymorphic approach to HTTP requests and their subsequent follow-up work. If the developer and team was confident that the Callout and HttpCallout objects were doing their part, testing could occur in isolation for concrete Callback implementations; reactions to different kinds of HTTP requests could be entirely decoupled from the fetching process. Not getting the callback idea to work would have been a big loss.</p><h2 id="callbacks-redux" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Callbacks, Redux</h2><p>It was time to re-engineer the Callback object. It still needed to abstract out the Queueable Apex implementation, but it also needed to play nice with serialization, and couldn't remain on the Callout object as a result. I went back to the drawing board:</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public virtual class Callback implements System.Queueable {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> virtual <span class="token keyword">class</span> <span class="token class-name">Callback</span> <span class="token keyword">implements</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">Queueable</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    private Type callbackType;"><span class="lineCounter-0-0-15">2</span>    <span class="token keyword">private</span> <span class="token class-name">Type</span> callbackType<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    protected string responseBody;"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">protected</span> string responseBody<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">4</span></div><br><div class="line-0-0-16 " data-content="    protected Callback() {}"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token keyword">protected</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">6</span></div><br><div class="line-0-0-16 " data-content="    public Callback(Type callbackType) {"><span class="lineCounter-0-0-15">7</span>    <span class="token keyword">public</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token class-name">Type</span> callbackType<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.callbackType = callbackType;"><span class="lineCounter-0-0-15">8</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>callbackType <span class="token operator">=</span> callbackType<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">9</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">10</span></div><br><div class="line-0-0-16 " data-content="    public void callback() {"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        System.enqueueJob(this);"><span class="lineCounter-0-0-15">12</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">enqueueJob</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">13</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">14</span></div><br><div class="line-0-0-16 " data-content="    public void callback(HttpResponse res) {"><span class="lineCounter-0-0-15 prim">15</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.responseBody = res.getBody();"><span class="lineCounter-0-0-15">16</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>responseBody <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        this.callback();"><span class="lineCounter-0-0-15">17</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">18</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">19</span></div><br><div class="line-0-0-16 " data-content="    public virtual void execute(System.QueueableContext context) {"><span class="lineCounter-0-0-15 prim">20</span>    <span class="token keyword">public</span> virtual <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">QueueableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        if(this.callbackType == null) {"><span class="lineCounter-0-0-15">21</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>callbackType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            this.callbackType = EmptyCallback.class;"><span class="lineCounter-0-0-15">22</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>callbackType <span class="token operator">=</span> <span class="token class-name">EmptyCallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">23</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="        ((Callback) this.callbackType.newInstance())"><span class="lineCounter-0-0-15">24</span>        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Callback</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callbackType<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="            .load(responseBody)"><span class="lineCounter-0-0-15 prim">25</span>            <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="            .execute(context);"><span class="lineCounter-0-0-15">26</span>            <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">27</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">28</span></div><br><div class="line-0-0-16 " data-content="    protected Callback load(String responseBody) {"><span class="lineCounter-0-0-15">29</span>    <span class="token keyword">protected</span> <span class="token class-name">Callback</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">String</span> responseBody<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        this.responseBody = responseBody;"><span class="lineCounter-0-0-15 prim">30</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>responseBody <span class="token operator">=</span> responseBody<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        return this;"><span class="lineCounter-0-0-15">31</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">32</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">33</span></div><br><div class="line-0-0-16 " data-content="    private class EmptyCallback extends Callback {"><span class="lineCounter-0-0-15">34</span>    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">EmptyCallback</span> <span class="token keyword">extends</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        public override void execute(System.QueueableContext context) {"><span class="lineCounter-0-0-15 prim">35</span>        <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">QueueableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            //do something like debug here"><span class="lineCounter-0-0-15">36</span>            <span class="token comment">//do something like debug here</span></div><br><div class="line-0-0-16 " data-content="            //or just do nothing, like the name suggests!"><span class="lineCounter-0-0-15">37</span>            <span class="token comment">//or just do nothing, like the name suggests!</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15">38</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">39</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">40</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">41</span></div><br><div class="line-0-0-16 " data-content="//and in the test ..."><span class="lineCounter-0-0-15">42</span><span class="token comment">//and in the test ...</span></div><br><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15">43</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="private class Callback_Tests {"><span class="lineCounter-0-0-15">44</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Callback_Tests</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @isTest"><span class="lineCounter-0-0-15 prim">45</span>    <span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="    static void it_should_callback() {"><span class="lineCounter-0-0-15">46</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Callback mock = new Callback(CallbackMock.class);"><span class="lineCounter-0-0-15">47</span>        <span class="token class-name">Callback</span> mock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token class-name">CallbackMock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">48</span></div><br><div class="line-0-0-16 " data-content="        Test.startTest();"><span class="lineCounter-0-0-15">49</span>        <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">startTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        mock.callback();"><span class="lineCounter-0-0-15 prim">50</span>        mock<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Test.stopTest();"><span class="lineCounter-0-0-15">51</span>        <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">stopTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">52</span></div><br><div class="line-0-0-16 " data-content="        System.assertEquals(true, MockWasCalled);"><span class="lineCounter-0-0-15">53</span>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">MockWasCalled</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">54</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15 prim">55</span></div><br><div class="line-0-0-16 " data-content="    static boolean MockWasCalled = false;"><span class="lineCounter-0-0-15">56</span>    <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token class-name">MockWasCalled</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    public virtual class CallbackMock extends Callback {"><span class="lineCounter-0-0-15">57</span>    <span class="token keyword">public</span> virtual <span class="token keyword">class</span> <span class="token class-name">CallbackMock</span> <span class="token keyword">extends</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        public override void execute(System.QueueableContext context) {"><span class="lineCounter-0-0-15">58</span>        <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">QueueableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="            MockWasCalled = true;"><span class="lineCounter-0-0-15">59</span>            <span class="token class-name">MockWasCalled</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        }"><span class="lineCounter-0-0-15 prim">60</span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">61</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">62</span><span class="token punctuation">}</span></div><br></code></pre><p>Now the empty callback itself is encapsulated within the Callback object -- which actually works much more nicely than the Callout being concerned with whether or not to add an empty callback. The addition of the <code>load</code> method is how we'll pass the results of the HttpRequests into callbacks which are concerned with responding to them; this is to get around the fact that the <code>newInstance()</code> Type method accepts no other arguments. While I haven't shown the code for it here, the astute reader might also note that zero-argument constructors play very nicely with the <a href="/joys-of-apex/dependency-injection-factory-pattern">Factory Pattern</a>, due to the fact that the Factory can be initialized <em>within</em> any object's constructor and <em>still</em> be over-ridden in tests.</p><p>I'll also just explicitly mention that the <code>callback()</code> method without arguments is meant for further re-use within your codebase. The Queuable interface is ideal for use cases where you don't want to perform Batch Apex (which, while powerful, is slow -- and requires way more boilerplate) but do need to push things async due to performing DML, and you'd like easy access to recursion. The <code>CallbackMock</code> just shown gives you an idea of how little code you need to write in order to start moving -- all you need to do if you're not concerned with HTTP is extend the Callback class and override the execute method. If you need recursion, you can just call <code>callback()</code> at the end of your execute method to get things re-queued up.</p><p>Of course, our HTTP consumers still need some code tweaks:</p><pre class="with-bar"><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span>classes/Callout.cls</span></span><div class="line-0-0-16 " data-content="public Callout("><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token class-name">Callout</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="    String jsonString,"><span class="lineCounter-0-0-15">2</span>    <span class="token class-name">String</span> jsonString<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    Url endpoint, RestMethod method,"><span class="lineCounter-0-0-15">3</span>    <span class="token class-name">Url</span> endpoint<span class="token punctuation">,</span> <span class="token class-name">RestMethod</span> method<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    Integer millisecondTimeout,"><span class="lineCounter-0-0-15">4</span>    <span class="token class-name">Integer</span> millisecondTimeout<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="    Type callbackType) {"><span class="lineCounter-0-0-15 prim">5</span>    <span class="token class-name">Type</span> callbackType<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this.BodyString = jsonString;"><span class="lineCounter-0-0-15">6</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">BodyString</span> <span class="token operator">=</span> jsonString<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    //Type.forName throws for nulls, alas"><span class="lineCounter-0-0-15">7</span>    <span class="token comment">//Type.forName throws for nulls, alas</span></div><br><div class="line-0-0-16 " data-content="    this.CallbackName = callbackType == null ? '' : callbackType.getName();"><span class="lineCounter-0-0-15">8</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">CallbackName</span> <span class="token operator">=</span> callbackType <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> callbackType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.Endpoint = endpoint.toExternalForm();"><span class="lineCounter-0-0-15">9</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Endpoint</span> <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">toExternalForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.RestMethod = method.name();"><span class="lineCounter-0-0-15 prim">10</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">RestMethod</span> <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    this.Timeout = millisecondTimeout;"><span class="lineCounter-0-0-15">11</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">Timeout</span> <span class="token operator">=</span> millisecondTimeout<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">12</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">13</span></div><br><div class="line-0-0-16 " data-content="public Callout(String jsonString, Url endpoint, RestMethod method, Type callbackType) {"><span class="lineCounter-0-0-15">14</span><span class="token keyword">public</span> <span class="token class-name">Callout</span><span class="token punctuation">(</span><span class="token class-name">String</span> jsonString<span class="token punctuation">,</span> <span class="token class-name">Url</span> endpoint<span class="token punctuation">,</span> <span class="token class-name">RestMethod</span> method<span class="token punctuation">,</span> <span class="token class-name">Type</span> callbackType<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this(jsonString, endpoint, method, DEFAULT_TIMEOUT, callbackType);"><span class="lineCounter-0-0-15 prim">15</span>    <span class="token keyword">this</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> method<span class="token punctuation">,</span> DEFAULT_TIMEOUT<span class="token punctuation">,</span> callbackType<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">16</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">17</span></div><br><div class="line-0-0-16 " data-content="public Callout (String jsonString, Url endpoint, RestMethod method) {"><span class="lineCounter-0-0-15">18</span><span class="token keyword">public</span> <span class="token class-name">Callout</span> <span class="token punctuation">(</span><span class="token class-name">String</span> jsonString<span class="token punctuation">,</span> <span class="token class-name">Url</span> endpoint<span class="token punctuation">,</span> <span class="token class-name">RestMethod</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    this(jsonString, endpoint, method, null);"><span class="lineCounter-0-0-15">19</span>    <span class="token keyword">this</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">20</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="//... and the member within Callout is also defined:"><span class="lineCounter-0-0-15">21</span><span class="token comment">//... and the member within Callout is also defined:</span></div><br><div class="line-0-0-16 " data-content="public String CallbackName { get; private set; }"><span class="lineCounter-0-0-15 prim">22</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">CallbackName</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br></code></pre><p>Which makes the HttpCallout class look like ...</p><pre class=""><code class="java code-0-0-14" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16 " data-content="public class HttpCallout {"><span class="lineCounter-0-0-15 prim">1</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpCallout</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    @future(callout = true)"><span class="lineCounter-0-0-15">2</span>    <span class="token annotation punctuation">@future</span><span class="token punctuation">(</span>callout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    public static void process(String calloutString) {"><span class="lineCounter-0-0-15">3</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> calloutString<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        Callout calloutObj = (Callout)JSON.deserialize(calloutString, Callout.class);"><span class="lineCounter-0-0-15">4</span>        <span class="token class-name">Callout</span> calloutObj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Callout</span><span class="token punctuation">)</span>JSON<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>calloutString<span class="token punctuation">,</span> <span class="token class-name">Callout</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        HttpRequest req = setupHttpRequest(calloutObj);"><span class="lineCounter-0-0-15 prim">5</span>        <span class="token class-name">HttpRequest</span> req <span class="token operator">=</span> <span class="token function">setupHttpRequest</span><span class="token punctuation">(</span>calloutObj<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        HttpResponse res = makeRequest(req);"><span class="lineCounter-0-0-15">6</span>        <span class="token class-name">HttpResponse</span> res <span class="token operator">=</span> <span class="token function">makeRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        Type callbackType = Type.forName(calloutObj.CallbackName);"><span class="lineCounter-0-0-15">7</span>        <span class="token class-name">Type</span> callbackType <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>calloutObj<span class="token punctuation">.</span><span class="token class-name">CallbackName</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        new Callback(callbackType).callback(res);"><span class="lineCounter-0-0-15">8</span>        <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span>callbackType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">9</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="//..."><span class="lineCounter-0-0-15 prim">10</span><span class="token comment">//...</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15">11</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">12</span></div><br><div class="line-0-0-16 " data-content="//and in HttpCallout_Tests:"><span class="lineCounter-0-0-15">13</span><span class="token comment">//and in HttpCallout_Tests:</span></div><br><div class="line-0-0-16 " data-content="@isTest"><span class="lineCounter-0-0-15">14</span><span class="token annotation punctuation">@isTest</span></div><br><div class="line-0-0-16 " data-content="static void it_should_callout_and_callback() {"><span class="lineCounter-0-0-15 prim">15</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">it_should_callout_and_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    Type callbackType = HttpCallbackMock.class;"><span class="lineCounter-0-0-15">16</span>    <span class="token class-name">Type</span> callbackType <span class="token operator">=</span> <span class="token class-name">HttpCallbackMock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    Callout fakeCallout = new Callout("><span class="lineCounter-0-0-15">17</span>    <span class="token class-name">Callout</span> fakeCallout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Callout</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        '{parameter1: perhaps a serialized list or id!}',"><span class="lineCounter-0-0-15">18</span>        <span class="token string">'{parameter1: perhaps a serialized list or id!}'</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        new Url('https://api.com'),"><span class="lineCounter-0-0-15">19</span>        <span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token string">'https://api.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        RestMethod.POST,"><span class="lineCounter-0-0-15 prim">20</span>        <span class="token class-name">RestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        callbackType);"><span class="lineCounter-0-0-15">21</span>        callbackType<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    String jsonString = Json.serialize(fakeCallout);"><span class="lineCounter-0-0-15">22</span>    <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token class-name">Json</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>fakeCallout<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">23</span></div><br><div class="line-0-0-16 " data-content="    Id accountId = TestingUtils.generateId(Account.SObjectType);"><span class="lineCounter-0-0-15">24</span>    <span class="token class-name">Id</span> accountId <span class="token operator">=</span> <span class="token class-name">TestingUtils</span><span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token class-name">SObjectType</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    Test.setMock("><span class="lineCounter-0-0-15 prim">25</span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">setMock</span><span class="token punctuation">(</span></div><br><div class="line-0-0-16 " data-content="        HttpCalloutMock.class,"><span class="lineCounter-0-0-15">26</span>        <span class="token class-name">HttpCalloutMock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span></div><br><div class="line-0-0-16 " data-content="        new MockHttpResponse(200, 'Success', '{ &quot;AccountId&quot; : &quot;' + accountId + '&quot;}')"><span class="lineCounter-0-0-15">27</span>        <span class="token keyword">new</span> <span class="token class-name">MockHttpResponse</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'Success'</span><span class="token punctuation">,</span> <span class="token string">'{ "AccountId" : "'</span> <span class="token operator">+</span> accountId <span class="token operator">+</span> <span class="token string">'"}'</span><span class="token punctuation">)</span></div><br><div class="line-0-0-16 " data-content="    );"><span class="lineCounter-0-0-15">28</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">29</span></div><br><div class="line-0-0-16 " data-content="    Test.startTest();"><span class="lineCounter-0-0-15 prim">30</span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">startTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    HttpCallout.process(jsonString);"><span class="lineCounter-0-0-15">31</span>    <span class="token class-name">HttpCallout</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="    Test.stopTest();"><span class="lineCounter-0-0-15">32</span>    <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token function">stopTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">33</span></div><br><div class="line-0-0-16 " data-content="    System.assertEquals(accountId, mockId);"><span class="lineCounter-0-0-15">34</span>    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>accountId<span class="token punctuation">,</span> mockId<span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">35</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">36</span></div><br><div class="line-0-0-16 " data-content="private static Id mockId;"><span class="lineCounter-0-0-15">37</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Id</span> mockId<span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="private class HttpCallbackMock extends Callback {"><span class="lineCounter-0-0-15">38</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">HttpCallbackMock</span> <span class="token keyword">extends</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    public override void execute(System.QueueableContext context) {"><span class="lineCounter-0-0-15">39</span>    <span class="token keyword">public</span> override <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">QueueableContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="        FakeApiResponse fakeResponse ="><span class="lineCounter-0-0-15 prim">40</span>        <span class="token class-name">FakeApiResponse</span> fakeResponse <span class="token operator">=</span></div><br><div class="line-0-0-16 " data-content="            (FakeApiResponse)Json.deserialize(this.responseBody, FakeApiResponse.class);"><span class="lineCounter-0-0-15">41</span>            <span class="token punctuation">(</span><span class="token class-name">FakeApiResponse</span><span class="token punctuation">)</span><span class="token class-name">Json</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseBody<span class="token punctuation">,</span> <span class="token class-name">FakeApiResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        mockId = fakeResponse.AccountId;"><span class="lineCounter-0-0-15">42</span>        mockId <span class="token operator">=</span> fakeResponse<span class="token punctuation">.</span><span class="token class-name">AccountId</span><span class="token punctuation">;</span></div><br><div class="line-0-0-16 " data-content="        //do other work and perform DML ..."><span class="lineCounter-0-0-15">43</span>        <span class="token comment">//do other work and perform DML ...</span></div><br><div class="line-0-0-16 " data-content="    }"><span class="lineCounter-0-0-15">44</span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">45</span><span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content=""><span class="lineCounter-0-0-15">46</span></div><br><div class="line-0-0-16 " data-content="private class FakeApiResponse {"><span class="lineCounter-0-0-15">47</span><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">FakeApiResponse</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16 " data-content="    Id AccountId { get; set; }"><span class="lineCounter-0-0-15">48</span>    <span class="token class-name">Id</span> <span class="token class-name">AccountId</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span></div><br><div class="line-0-0-16 " data-content="}"><span class="lineCounter-0-0-15 prim">49</span><span class="token punctuation">}</span></div><br></code></pre><p>If you've made it this far, none of this should come as a surprise. One thing that did come as a surprise to me -- though it makes sense thinking about it now -- is that the test classes extending Callback had to be public in order for them to be properly constructed by the <code>newInstance</code> Type method.</p><hr><h2 id="closing-thoughts-on-future-methods-callouts--callbacks" class="heading-0-0-12"><span class="anchor-0-0-13" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Closing Thoughts On Future Methods, Callouts &amp; Callbacks</h2><p>I have been wanting to incorporate this design into some of my orgs for a while, and while there were some hiccups along the way, I consider them valuable learning experiences.</p><p>The ability to decouple our HTTP-related code from how consumers needing to make API calls choose to respond to requests is extremely valuable; it lets us test our production-level code without having to keep re-testing the underlying basics (making the request, try/catching the response, etc ...). And while a future method can't call a future method, Queueable Apex can nearly endlessly be chained together (so long as your maximum enqueued jobs don't exceed 50, the Salesforce limit for Queueable Apex). This means your Callback objects can be encapsulating further callbacks in turn within their own <code>execute</code> methods ... a powerful combo, particularly if you need to interact with more than one API at a given time (you'll need to also implement <code>Database.AllowsCallouts</code> on the Callback object if you need to perform further API calls).</p><p>There are of course many different ways to implement future and Queueable methods within Apex; everybody has a different use case, as they say. Still, it's my hope that this article has gotten you thinking about how you might best create reusably async Apex within your own codebase(s). I've uploaded the example code shown here in various iterations on the <a href="https://github.com/jamessimone/apex-mocks-stress-test/tree/callout">Apex Mocks repo</a>, in the hopes that it will prove useful.</p><p>Thanks for staying with me and stay tuned for more on <a href="/joys-of-apex/">The Joys of Apex!</a></p><div class="contentnav-0-0-7" data-no-search=""><a href="#separating-the-concerns-in-async-apex-methods" class="h2" data-content-highlight="separating-the-concerns-in-async-apex-methods">Separating the Concerns in Async Apex Methods</a><a href="#setting-up-callouts-and-http-class-wrappers" class="h2" data-content-highlight="setting-up-callouts-and-http-class-wrappers">Setting up Callouts and HTTP Class Wrappers</a><a href="#introducing-the-callback-object" class="h2" data-content-highlight="introducing-the-callback-object">Introducing the Callback Object</a><a href="#callbacks-redux" class="h2" data-content-highlight="callbacks-redux">Callbacks, Redux</a><a href="#closing-thoughts-on-future-methods-callouts--callbacks" class="h2" data-content-highlight="closing-thoughts-on-future-methods-callouts--callbacks">Closing Thoughts On Future Methods, Callouts &amp; Callbacks</a></div></div><div id="-codedoc-toc" class="toc-0-0-4"><div class="content-0-0-5"><p><a href="/joys-of-apex/">Home</a>
<a href="/joys-of-apex/apex-logging-service">Apex Logging Service</a>
<a href="/joys-of-apex/apex-object-oriented-basics">Apex Object-Oriented Basics</a>
<a href="/joys-of-apex/batchable-and-queueable-apex">Batchable And Queueable Apex</a>
<a href="/joys-of-apex/building-a-better-singleton">Building A Better Singleton</a>
<a href="/joys-of-apex/continuous-integration-with-sfdx">Continuous Integration With SFDX</a>
<a href="/joys-of-apex/dependency-injection-factory-pattern">Dependency Injection &amp; Factory Pattern</a>
<a href="/joys-of-apex/enum-apex-class-gotchas">Enum Apex Class Gotchas</a>
<a href="/joys-of-apex/extendable-apis">Extendable Apis</a>
<a href="/joys-of-apex/future-method-callout-callback">Future Methods, Callouts &amp; Callbacks</a>
<a href="/joys-of-apex/idiomatic-salesforce-apex">Idiomatic Salesforce Apex</a>
<a href="/joys-of-apex/intro">Introduction &amp; Testing Philosophy</a>
<a href="/joys-of-apex/lazy-iterators">Lazy Iterators</a>
<a href="/joys-of-apex/lightweight-trigger-handler">Lightweight Trigger Handler</a>
<a href="/joys-of-apex/lwc-composable-modal">LWC Composable Modal</a>
<a href="/joys-of-apex/lwc-composable-pagination">LWC Composable Pagination</a>
<a href="/joys-of-apex/mocking-dml">Mocking DML</a>
<a href="/joys-of-apex/react-versus-lightning-web-components">React Versus Lightning Web Components</a>
<a href="/joys-of-apex/repository-pattern">Repository Pattern</a>
<a href="/joys-of-apex/sorting-and-performance-in-apex">Sorting And Performance In Apex</a>
<a href="/joys-of-apex/test-driven-development-example">Test Driven Development Example</a>
<a href="/joys-of-apex/writing-performant-apex-tests">Writing Performant Apex Tests</a></p><p><br><br></p><p><a href="https://www.jamessimone.net/">Read more tech articles</a></p></div></div><div class="footer-0-0-3"><div class="left"><script id="hvW_pGOAdE">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("hvW_pGOAdE", "BWW0vHR4333HbDOiwZ67JA==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="pvfkiwVVtJ">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("pvfkiwVVtJ", "6yEdMfRRlNsUBKSBOTazFg==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="dmOJmhsIrz">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("dmOJmhsIrz", "wh9V9isakhdwzlz9ZUjvyw==", {"namespace":"/joys-of-apex"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>